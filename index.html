<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—¶ç©ºå¸‚é›†">
    
    <title>å¯’å‡å­¦ä¹ æ‰“å¡ä»»åŠ¡ï¼ˆå¸‚é›†èåˆç‰ˆï¼‰v2.7</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥ Canvas Confetti ç”¨äºåº†ç¥ç‰¹æ•ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

	<!-- å¼•å…¥ ç”¨äºç«æ ‘é“¶èŠ±ç‰¹æ•ˆ -->
	<script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/fscreen%401.0.1.js'></script>
    <script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/Stage%400.1.4.js'></script>
    <script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/MyMath.js'></script>
	
	<!-- å¼•å…¥ OGL æ¸²æŸ“åº“ -->
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/ogl/dist/ogl.umd.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .text-stroke { text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }
        
        /* å¾½ç« æµå…‰ç‰¹æ•ˆ */
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .badge-legendary {
            background: linear-gradient(135deg, #a855f7 0%, #d8b4fe 50%, #a855f7 100%);
            background-size: 200% auto;
            animation: shine 3s linear infinite;
            will-change: background-position;
        }
        
        /* é‚ªæ¶è½¬ç›˜ç‰¹æ•ˆ */
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 10px rgba(220, 38, 38, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.8); }
            50% { box-shadow: 0 0 25px rgba(220, 38, 38, 0.8), inset 0 0 40px rgba(0, 0, 0, 0.9); }
        }
        .evil-glow {
            animation: pulse-red 3s infinite;
            will-change: box-shadow;
        }

		@keyframes rain {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(200px); opacity: 0; }
        }
        @keyframes snow {
            0% { transform: translateY(0) translateX(0); opacity: 1; }
            100% { transform: translateY(200px) translateX(20px); opacity: 0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* å‡çº§åŠ¨ç”»ç‰¹æ•ˆ */
        @keyframes level-up-ping {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-level-up {
            animation: level-up-ping 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            will-change: transform, opacity;
        }

        /* é¦–é¡µå¡ç‰‡æµå…‰è¾¹æ¡† */
        @keyframes border-flow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-border-flow {
            background-size: 200% 200%;
            animation: border-flow 4s ease infinite;
            will-change: background-position;
        }
        
        /* éšæœºäº‹ä»¶å¡ç‰‡æµ®åŠ¨ */
        @keyframes float-event {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float-event 3s ease-in-out infinite;
            will-change: transform;
        }

        /* æƒŠå–œå¤§è½¬ç›˜å°±ç»ªç‰¹æ•ˆ */
        @keyframes ready-pulse {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); transform: scale(1); }
        }
        .animate-ready-pulse {
            animation: ready-pulse 2s infinite;
            background: linear-gradient(45deg, #fffbeb, #fef3c7);
            border-color: #f59e0b;
            will-change: box-shadow, transform;
        }

        /* --- å¸‚é›†ç‰ˆæ–°å¢ç‰¹æ•ˆ --- */
        .frame-beast { border: 4px solid #78350f; border-style: dashed; box-shadow: 0 0 0 2px #d97706; }
        .frame-bronze { border: 4px solid #0f766e; border-style: double; box-shadow: 0 0 10px #2dd4bf; }

        /* --- æ–°ç‰ˆï¼šé«˜çº§ç‰¡ä¸¹æµå…‰ç‰¹æ•ˆ --- */
        /* 1. å¤´åƒæ¡†æµå…‰ (æœªé€‰ä¸­çŠ¶æ€) - åœ†å½¢æ—‹è½¬æµå…‰ */
        .frame-peony { 
            position: relative;
            border-radius: 50%;
            /* åŸºç¡€è¾¹æ¡†é€æ˜ï¼Œäº¤ç»™ä¼ªå…ƒç´ å¤„ç† */
            border: 2px solid transparent; 
            box-shadow: 0 0 10px rgba(219, 39, 119, 0.4); /* æŸ”å’Œçš„ç²‰è‰²å…‰æ™• */
        }
        /* æ—‹è½¬çš„æµå…‰ç¯ */
        .frame-peony::after {
            content: "";
            position: absolute;
            inset: -3px; /* å‘å¤–æ‰©å±•ä¸€ç‚¹ï¼ŒåŒ…å›´å¤´åƒ */
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, #be185d 60deg, #f472b6 120deg, transparent 180deg);
            animation: spin-glow 2s linear infinite;
            /* ä½¿ç”¨ mask è®©ä¸­é—´é•‚ç©ºï¼Œåªæ˜¾ç¤ºåœ†ç¯ */
            mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black calc(100% - 3px));
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), black calc(100% - 3px));
        }
        @keyframes spin-glow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ç‹¬ç«‹çš„ç‰¡ä¸¹æµå…‰èƒŒæ™¯å±‚ --- */
        .peony-bg-layer {
            position: absolute;
            inset: 0; /* é“ºæ»¡çˆ¶å…ƒç´  */
            border-radius: 1rem;
            overflow: hidden; /* å…³é”®ï¼šåªåœ¨è¿™é‡Œå‰ªè£ï¼Œä¸å½±å“çˆ¶å…ƒç´ å¤–éƒ¨çš„æ ‡ç­¾ */
            z-index: 0; /* æ”¾åœ¨æœ€åº•å±‚ */
            background: transparent;
        }

        /* æ—‹è½¬çš„æµå…‰ï¼ˆåº•å±‚ï¼‰ */
        .peony-bg-layer::before {
            content: "";
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            z-index: -2;
            background: conic-gradient(
                transparent 0deg,
                transparent 60deg,
                #db2777 100deg,
                #f9a8d4 120deg,
                #fff 125deg,
                transparent 130deg
            );
            animation: peony-border-spin 3s linear infinite;
        }

        /* ä¸­é—´å±‚ï¼šå¡ç‰‡æœ¬ä½“ï¼ˆèƒŒæ™¯å›¾ï¼‰ */
        .peony-bg-layer::after {
            content: "";
            position: absolute;
            /* inset: 3px å¿…é¡»ä¿ç•™ï¼è¿™æ˜¯ä¸ºäº†ç•™å‡ºç¼éš™ï¼Œè®©åº•ä¸‹çš„æµå…‰è¾¹æ¡†éœ²å‡ºæ¥ */
            inset: 3px; 
            
            /* èƒŒæ™¯å›¾è®¾ç½® */
            /* è¿™é‡Œä½¿ç”¨ linear-gradient åŠ äº†ä¸€å±‚åŠé€æ˜ç™½è‰²é®ç½© (0.85 -> 0.6) */
            /* è¿™æ ·æ—¢èƒ½çœ‹åˆ°ç‰¡ä¸¹åº•çº¹ï¼Œåˆä¸ä¼šå› ä¸ºå›¾ç‰‡å¤ªèŠ±è€ŒæŒ¡ä½ä¸Šé¢çš„é»‘è‰²æ–‡å­— */
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.3)), url('./mudan.jpg');
            
            background-size: cover;       /* è®©å›¾ç‰‡é“ºæ»¡ */
            background-position: center;  /* å±…ä¸­æ˜¾ç¤º */
            
            border-radius: calc(1rem - 3px); /* åœ†è§’ä¿æŒ */
            z-index: -1; 
        }

        @keyframes peony-border-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
		/* --- é«˜çº§é¥•é¤®å‘¼å¸èƒŒæ™¯ (ç‹¬ç«‹å±‚) --- */
        
        /* 1. èƒŒæ™¯å®¹å™¨ï¼šè´Ÿè´£è£å‰ªå›¾ç‰‡ï¼Œä½†ä¸è£å‰ªå¤–éƒ¨çš„æ ‡ç­¾ */
        .bronze-bg-layer {
            position: absolute;
            inset: 0;
            border-radius: 1rem;
            overflow: hidden; /* å…³é”®ï¼šåªè£å‰ªèƒŒæ™¯å›¾ */
            z-index: 0; /* åœ¨æœ€åº•å±‚ */
            background: #ffffff; /* ç™½è‰²åº•è‰² */
            /* è¾¹æ¡†å‘¼å¸ç¯ */
            border: 2px solid #b45309;
            box-shadow: 0 0 15px rgba(180, 83, 9, 0.5);
            animation: bronze-border-pulse 4s infinite ease-in-out;
        }

        /* 2. èƒŒæ™¯çº¹ç†å›¾ (å‘¼å¸åŠ¨ç”»ä¸»ä½“) */
        .bronze-bg-layer::after {
            content: "";
            position: absolute;
            inset: -10%; /* æ¯”å®¹å™¨å¤§ä¸€ç‚¹ï¼Œä¸ºäº†åšç¼©æ”¾åŠ¨ç”»æ—¶ä¸éœ²åº• */
            
            /* æ›¿æ¢ä¸ºä½ çš„é¥•é¤®çº¹ç†å›¾ç‰‡ */
            background-image: url('./taotie.png'); 
            background-size: cover;
            background-position: center;
            z-index: -2;
            
            /* æ ¸å¿ƒåŠ¨ç”»ï¼šèƒŒæ™¯å›¾æœ¬èº«åœ¨å‘¼å¸ */
            animation: bronze-texture-breathe 4s infinite ease-in-out;
        }

        /* 3. é®ç½©å±‚ (å¢å¼ºæ–‡å­—å¯¹æ¯”åº¦) */
        .bronze-bg-layer::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -1;
            /* é…åˆèƒŒæ™¯æ˜æš—å˜åŒ–çš„é®ç½© */
            background: rgba(0, 0, 0, 0.5); 
            animation: bronze-mask-breathe 4s infinite ease-in-out;
        }

        /* --- åŠ¨ç”»å®šä¹‰ --- */
        
        /* çº¹ç†å‘¼å¸ï¼šå¿½æ˜å¿½æš— + å¾®å¾®ç¼©æ”¾ */
        @keyframes bronze-texture-breathe {
            0%, 100% { 
                filter: brightness(0.6) sepia(0.3); /* æš—çŠ¶æ€ */
                transform: scale(1); 
            }
            50% { 
                filter: brightness(1.1) sepia(0); /* äº®çŠ¶æ€ */
                transform: scale(1.05); /* å¾®å¾®è†¨èƒ€ï¼Œæ¨¡æ‹Ÿå‘¼å¸æ„Ÿ */
            }
        }

        /* é®ç½©é…åˆï¼šèƒŒæ™¯äº®æ—¶é®ç½©æµ…ï¼Œé€å‡ºçº¹ç† */
        @keyframes bronze-mask-breathe {
            0%, 100% { background: rgba(0, 0, 0, 0.6); }
            50% { background: rgba(0, 0, 0, 0.3); }
        }

        /* è¾¹æ¡†é…åˆï¼šåŒæ­¥å‘å…‰ */
        @keyframes bronze-border-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(180, 83, 9, 0.3); border-color: #78350f; }
            50% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.6); border-color: #f59e0b; }
        }
		
        /* --- ä¼˜åŒ–åçš„ç«ç„°ç‰¹æ•ˆ v2.6 --- */
        @keyframes fire-ring-burn {
            0% { box-shadow: 0 0 0 0px rgba(255, 69, 0, 0.4), 0 0 5px 1px rgba(255, 140, 0, 0.6); }
            50% { box-shadow: 0 0 10px 2px rgba(255, 69, 0, 0.6), 0 0 20px 4px rgba(255, 0, 0, 0.4); border-color: #ff4500; }
            100% { box-shadow: 0 0 0 0px rgba(255, 69, 0, 0.4), 0 0 5px 1px rgba(255, 140, 0, 0.6); }
        }
        .avatar-fire-ring {
            animation: fire-ring-burn 1.5s infinite;
            border: 2px solid #ff8c00;
        }
        
        @keyframes text-burn-effect {
            0% { text-shadow: 0 0 4px #ff8c00, 0 -2px 8px #ff4500; color: #fff; transform: scale(1); }
            50% { text-shadow: 0 0 8px #ffd700, 0 -4px 12px #ff0000; color: #fff5e6; transform: scale(1.02); }
            100% { text-shadow: 0 0 4px #ff8c00, 0 -2px 8px #ff4500; color: #fff; transform: scale(1); }
        }
        .name-effect-fire { 
            font-weight: 900 !important;
            letter-spacing: 1px;
            animation: text-burn-effect 0.8s infinite alternate;
        }

        .name-effect-star { color: #7c3aed; text-shadow: 0 0 5px #c4b5fd, 0 0 10px #8b5cf6; }
        
        .npc-float { animation: float-event 4s ease-in-out infinite; }
		
		/* --- æ²‰æµ¸å¼åŠ¨æ€èƒŒæ™¯å±‚ --- */
        .atmosphere-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* ç¡®ä¿åœ¨æœ€åº•å±‚ï¼Œä½†åœ¨ body èƒŒæ™¯è‰²ä¹‹ä¸Š */
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸å½±å“æ“ä½œ */
            overflow: hidden;
        }
        /* é“¶æ²³ç‰¹æœ‰çš„æ·±é‚ƒæ¸å˜åº•è‰² */
        .bg-galaxy-gradient {
            background: linear-gradient(to bottom, #020617 0%, #0f172a 50%, #1e1b4b 100%);
        }
		/* --- æ–°å¢ï¼šæµæ˜Ÿé›¨ä¸“å±æ ·å¼ --- */
        /* æ·±é‚ƒåˆå¤œè“æ¸å˜ */
        .bg-meteor-gradient {
            background: linear-gradient(to bottom, #0f172a 0%, #1e1b4b 40%, #312e81 100%);
        }
        
        /* æ˜Ÿæ˜Ÿå‘¼å¸é—ªçƒ */
        @keyframes star-twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 4px rgba(255, 255, 255, 0.8); }
        }

        /* æµæ˜Ÿåˆ’è¿‡ (å¸¦æ‹–å°¾æ•ˆæœ) */
        @keyframes meteor-drop {
            0% { 
                transform: rotate(315deg) translateX(0); 
                opacity: 0; 
            }
            10% { 
                opacity: 1; 
            }
            100% { 
                transform: rotate(315deg) translateX(-100vh); 
                opacity: 0; 
            }
        }
		
		/* --- æ–°å¢ï¼šæåœ°ä¹‹å¤œÂ·æ¬§è‹¥æ‹‰ç‰¹æ•ˆ --- */
        /* 1. æ·±é‚ƒåŸºåº• */
        .bg-aurora-base {
            background: radial-gradient(circle at 50% 100%, #1e293b 0%, #020617 50%, #000000 100%);
        }

        /* 2. æå…‰å…‰å¸¦åŠ¨ç”»ï¼šæµåŠ¨ä¸å½¢å˜ */
        @keyframes aurora-flow-1 {
            0% { transform: translate(0%, 0%) scale(1) skewX(0deg); opacity: 0.6; }
            50% { transform: translate(-10%, -5%) scale(1.2) skewX(-10deg); opacity: 0.8; }
            100% { transform: translate(5%, 0%) scale(1) skewX(10deg); opacity: 0.6; }
        }
        @keyframes aurora-flow-2 {
            0% { transform: translate(0%, 0%) rotate(0deg); opacity: 0.4; }
            50% { transform: translate(10%, 5%) rotate(5deg); opacity: 0.7; }
            100% { transform: translate(-5%, 0%) rotate(0deg); opacity: 0.4; }
        }
        @keyframes aurora-float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0); }
        }
		
		/* --- æ–°å¢ï¼šä¸Šå…ƒç¯ç«Â·ç¥ˆæ„¿ç‰¹æ•ˆ --- */
        /* 1. æš–è‰²è°ƒå¤œå¹•çº¢èƒŒæ™¯ */
        .bg-lantern-gradient {
            background: linear-gradient(to bottom, #2b0a0a 0%, #4a1c1c 40%, #7f1d1d 100%);
        }

        /* 2. å­”æ˜ç¯é£˜å‡åŠ¨ç”» */
        @keyframes lantern-float {
            0% { 
                transform: translateY(120vh) scale(0.5); /* ä»æ›´ä½å¤„èµ·é£ */
                opacity: 0; 
            }
            10% { 
                opacity: 1; 
            }
            50% {
                transform: translateY(20vh) scale(1) translateX(20px); /* ä¸­é€”è¿˜åœ¨å±å¹•å†… */
                opacity: 1;
            }
            85% {
                opacity: 0.8; /* é£åˆ°é«˜ç©ºæ—¶ä¾ç„¶å¯è§ */
            }
            100% { 
                /* ç»ˆç‚¹ï¼šå®Œå…¨é£å‡ºå±å¹•ä¸Šæ–¹å¾ˆè¿œçš„åœ°æ–¹ */
                transform: translateY(-120vh) scale(0.6) translateX(-20px); 
                opacity: 0; 
            }
        }

        /* 3. ç¯ç«æ‘‡æ›³/å‘¼å¸æ•ˆæœ */
        @keyframes lantern-flicker {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 5px rgba(255, 165, 0, 0.6)); }
            50% { filter: brightness(1.3) drop-shadow(0 0 15px rgba(255, 200, 0, 0.9)); }
        }
		
		/* --- æ–°å¢ï¼šè¤ç«ä¹‹æ£®Â·å‘¼å¸ç‰¹æ•ˆ --- */
        /* --- è¤ç«è™«ç‰¹æ•ˆ (å¤åˆ»ç‰ˆ) --- */
        /* 1. èƒŒæ™¯ï¼šé«˜çº§å¤œå¹•é…è‰² (æ”¯æŒèƒŒæ™¯å›¾) */
        .bg-night-forest {
            /* é»˜è®¤æ˜¾ç¤ºæ·±é‚ƒè“é»‘å¾„å‘æ¸å˜ï¼Œæ¨¡æ‹Ÿæ·±å¤œçš„æ£®æ—/å¤œç©º */
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 2. è¤ç«è™«å®¹å™¨ */
        .firefly-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        /* 3. è¤ç«è™«ä¸»ä½“ (æ§åˆ¶å¤§èŒƒå›´ä½ç§») */
        .firefly {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0.4vw; /* ä¿æŒåŸç‰ˆæ¯”ä¾‹ */
            height: 0.4vw;
            margin: -0.2vw 0 0 9.8vw; /* å…³é”®åç§»ï¼Œé…åˆæ—‹è½¬äº§ç”Ÿå¤§åœ†å‘¨è¿åŠ¨ */
            animation: firefly-move 200s alternate infinite; /* ææ…¢çš„éšæœºè¿åŠ¨ */
        }

        /* 4. è¤ç«è™«å…‰æ™•ä¸æ ¸å¿ƒ (æ§åˆ¶æ—‹è½¬å’Œé—ªçƒ) */
        .firefly::before,
        .firefly::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform-origin: -10vw; /* å…³é”®ï¼šè®¾ç½®æ—‹è½¬ä¸­å¿ƒåœ¨è¿œå¤„ */
        }

        .firefly::before {
            background: black; /* æ ¸å¿ƒ */
            opacity: 0.4;
            animation: firefly-drift 10s ease alternate infinite;
        }

        .firefly::after {
            background: white; /* å‘å…‰ä½“ */
            opacity: 0;
            box-shadow: 0 0 0vw 0vw yellow;
            /* å åŠ æ—‹è½¬æ¼‚ç§»å’Œå‘¼å¸é—ªçƒ */
            animation: firefly-drift 10s ease alternate infinite, firefly-flash 3s ease infinite;
        }

        /* åŠ¨ç”»å…³é”®å¸§ï¼šæ¨¡æ‹Ÿå¤æ‚çš„éšæœºæ¼«æ¸¸ */
        @keyframes firefly-move {
            0% { transform: translateX(0vw) translateY(0vh) scale(1); }
            10% { transform: translateX(20vw) translateY(15vh) scale(0.8); }
            25% { transform: translateX(-30vw) translateY(-20vh) scale(1.2); }
            40% { transform: translateX(10vw) translateY(-40vh) scale(0.6); }
            55% { transform: translateX(-20vw) translateY(30vh) scale(1.1); }
            70% { transform: translateX(35vw) translateY(-10vh) scale(0.7); }
            85% { transform: translateX(-35vw) translateY(20vh) scale(1); }
            100% { transform: translateX(0vw) translateY(0vh) scale(0.9); }
        }

        @keyframes firefly-drift {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes firefly-flash {
            0%, 30%, 100% { opacity: 0; box-shadow: 0 0 0vw 0vw yellow; }
            5% { opacity: 1; box-shadow: 0 0 2vw 0.4vw yellow; }
        }
		
		/* --- ç”²éª¨æ–‡ä¼ ä¹¦ä¸“å±ç‰¹æ•ˆ --- */
        .oracle-container {
            background: linear-gradient(to bottom, #2c1810 0%, #4a2c20 100%);
            border: 2px solid #8B4513;
            box-shadow: 0 0 15px rgba(139, 69, 19, 0.6) inset, 0 4px 10px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        /* åŠ¨æ€èƒŒæ™¯çº¹ç† */
        .oracle-bg-pattern {
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); /* æœ¨çº¹æˆ–è£‚çº¹çº¹ç† */
            opacity: 0.3;
            mix-blend-mode: overlay;
        }
        /* æ¶ˆæ¯å¡ç‰‡ï¼šé¾Ÿç”²/éª¨ç‰‡é£æ ¼ */
        .oracle-bone-card {
            background: linear-gradient(135deg, #fdfbf7 0%, #e8dcc5 100%);
            border: 1px solid #d4c5a9;
            color: #5d4037;
            box-shadow: 1px 2px 5px rgba(0,0,0,0.2), inset 0 0 10px rgba(139, 69, 19, 0.1);
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        .oracle-bone-card::before {
            content: "";
            position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 1px dashed #c0a080;
            border-radius: 4px;
            pointer-events: none;
        }
        .oracle-bone-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 10;
        }
        /* é‡‘è‰²æµå…‰æ–‡å­— */
        .oracle-text-glow {
            background: linear-gradient(45deg, #8B4513, #d2691e, #8B4513);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 900;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
        }
        /* ç‡ƒçƒ§çš„ç«æ˜Ÿç²’å­åŠ¨ç”» */
        @keyframes ember-float {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-40px) scale(0); opacity: 0; }
        }
        .ember {
            position: absolute;
            width: 2px; height: 2px;
            background: #ffaa00;
            border-radius: 50%;
            pointer-events: none;
        }
		/* --- æ–°å¢ï¼šå¤«å­åº™å‰Â·é“¶æé›¨ç‰¹æ•ˆ --- */
        /* 1. å¤«å­åº™å‰Â·é“¶æé›¨èƒŒæ™¯ - ä¼˜åŒ–ç‰ˆï¼šæ·±ç§‹æš®è‰²ï¼Œè¡¬æ‰˜é‡‘å¶ */
        .bg-ginkgo-gradient {
            background: linear-gradient(to bottom, #fdfbf7 0%, #fef3c7 60%, #fae8b0 100%);
        }

        /* 2. é“¶æå¶é£˜è½åŠ¨ç”» (Yè½´ä¸‹è½ + Xè½´è½»å¾®æ‘†åŠ¨) */
        @keyframes ginkgo-fall {
            0% { 
                transform: translateY(-10vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            100% { 
                transform: translateY(110vh) translateX(20px) rotate(360deg);
                opacity: 0;
            }
        }

        /* 3. é“¶æå¶3Dç¿»æ»šåŠ¨ç”» (æ¨¡æ‹Ÿç©ºä¸­å—é£ç¿»è½¬) */
        @keyframes ginkgo-flip {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            50% { transform: rotateX(180deg) rotateY(90deg); }
            100% { transform: rotateX(360deg) rotateY(0deg); }
        }
		
		/* --- æ–°å¢ï¼šä¼ è¯´Â·ä¸‡è±¡å­—é˜µç‰¹æ•ˆ --- */
        /* 1. å®šä¹‰ç”²éª¨æ–‡å­—ä½“ (å‡è®¾å­—ä½“æ–‡ä»¶åœ¨åŒçº§ç›®å½•) */
        @font-face {
            font-family: 'OracleBone';
            src: url('æ–¹æ­£ç”²éª¨æ–‡.TTF') format('truetype');
        }

        /* 2. èƒŒæ™¯å®¹å™¨ï¼šæ·±é‚ƒè™šç©º */
        .bg-matrix-civilization {
            background-color: #0d0d0d; /* æ¥è¿‘çº¯é»‘çš„æ·±ç° */
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }
		
		/* --- æ–°å¢ï¼šæ–°æ˜¥é™å®šÂ·ç«æ ‘é“¶èŠ±ç‰¹æ•ˆ --- */
        /* 1. é™¤å¤•å¤œå¹•èƒŒæ™¯ (é¢œè‰²è°ƒäº®ï¼Œç¡®ä¿è‚‰çœ¼èƒ½çœ‹å‡ºæ¸å˜) */
        .bg-lunar-night {
            background: linear-gradient(to bottom, #1e3a8a 0%, #0f172a 60%, #4c0519 100%);
            position: relative;
            overflow: hidden;
        }

        /* 2. åº•éƒ¨å¾®å¼±çš„çº¢è‰²å…‰æ™• (æ¨¡æ‹ŸåŸå¸‚ç¯ç«) */
        .bg-lunar-night::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 35%;
            background: radial-gradient(ellipse at bottom, rgba(220, 50, 60, 0.2) 0%, transparent 70%);
            pointer-events: none;
        }
		
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const SettingsIcon = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M2 17h20"/><path d="M6 17v-3a6 3 0 0 1 12 0v3"/></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m7.1 10.27 1.11 1.11"/></IconBase>;
        const XIcon = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Target = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Flag = (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>;
        const Gift = (props) => <IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" x2="12" y1="22" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3" /></IconBase>;
        const Puzzle = (props) => <IconBase {...props}><path d="M19.439 15.424c-.58.586-1.545.586-2.126 0l-4.524-4.525c-.58-.586-.58-1.545 0-2.126.586-.58 1.546-.58 2.127 0l4.523 4.525c.581.58.581 1.54 0 2.126z" /><path d="M4.561 8.576c.58-.586 1.545-.586 2.126 0l4.524 4.525c.58.586.58 1.545 0 2.126-.586.58-1.546.58-2.127 0L4.561 10.702c-.581-.58-.581-1.54 0-2.126z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const ArrowUp = (props) => <IconBase {...props}><line x1="12" x2="12" y1="19" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const SortDesc = (props) => <IconBase {...props}><path d="M11 5h10"/><path d="M11 9h7"/><path d="M11 13h4"/><path d="M3 17l3 3 3-3"/><path d="M6 18V4"/></IconBase>;
        const Locate = (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Medal = (props) => <IconBase {...props}><path d="M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15"/><path d="M11 12 5.12 2.2"/><path d="m13 12 5.88-9.8"/><path d="M8 7h8"/><circle cx="12" cy="17" r="5"/><path d="M12 18v-2h-.5"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Palette = (props) => <IconBase {...props}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>;
        const Skull = (props) => <IconBase {...props}><path d="M14 16a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2M10 16a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1-2-2a2 2 0 0 1 2-2"/><path d="M12 2a10 10 0 0 1 10 10c0 1.5-.24 2.9-.62 4.24l-1.92 6.56a2 2 0 0 1-1.92 1.44H8.46a2 2 0 0 1-1.92-1.44l-1.92-6.56A10 10 0 0 1 2 12A10 10 0 0 1 12 2Z"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const Beaker = (props) => <IconBase {...props}><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 19v4"/><path d="M23 21h-4"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        // æ–°å¢å›¾æ ‡
        const ShoppingBag = (props) => <IconBase {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><line x1="3" x2="21" y1="6" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const MessageCircle = (props) => <IconBase {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Key = (props) => <IconBase {...props}><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1-9.19-9.19 6.5 6.5 0 0 1 9.19 9.19Z"/><path d="m21 2-2 2 2 2-2 2-2 2 2 2-2 2"/></IconBase>;

        // --- é¢œè‰²é…ç½®æ–¹æ¡ˆ ---
        const COLOR_PALETTES = {
            rose: { id: 'rose', name: 'ç«ç‘°çº¢', primary: 'text-rose-600', primaryBg: 'bg-rose-500', primaryBgHover: 'hover:bg-rose-600', lightBg: 'bg-rose-50', lightBorder: 'border-rose-100', border: 'border-rose-200', ring: 'ring-rose-300', accent: 'text-rose-500', gradient: 'from-rose-500 to-pink-400', softBg: 'bg-gradient-to-br from-rose-50 to-stone-50' },
            sky: { id: 'sky', name: 'å¤©ç©ºè“', primary: 'text-sky-600', primaryBg: 'bg-sky-500', primaryBgHover: 'hover:bg-sky-600', lightBg: 'bg-sky-50', lightBorder: 'border-sky-100', border: 'border-sky-200', ring: 'ring-sky-300', accent: 'text-sky-500', gradient: 'from-sky-500 to-blue-400', softBg: 'bg-gradient-to-br from-slate-50 to-blue-50' },
            amber: { id: 'amber', name: 'ç¥ç€é»„', primary: 'text-amber-600', primaryBg: 'bg-amber-500', primaryBgHover: 'hover:bg-amber-600', lightBg: 'bg-amber-50', lightBorder: 'border-amber-100', border: 'border-amber-200', ring: 'ring-amber-300', accent: 'text-amber-500', gradient: 'from-amber-500 to-yellow-400', softBg: 'bg-gradient-to-br from-orange-50 to-yellow-50' },
            emerald: { id: 'emerald', name: 'ç¿¡ç¿ ç»¿', primary: 'text-emerald-600', primaryBg: 'bg-emerald-500', primaryBgHover: 'hover:bg-emerald-600', lightBg: 'bg-emerald-50', lightBorder: 'border-emerald-100', border: 'border-emerald-200', ring: 'ring-emerald-300', accent: 'text-emerald-500', gradient: 'from-emerald-500 to-green-400', softBg: 'bg-gradient-to-br from-green-50 to-teal-50' },
            violet: { id: 'violet', name: 'ç´«ç½—å…°', primary: 'text-violet-600', primaryBg: 'bg-violet-500', primaryBgHover: 'hover:bg-violet-600', lightBg: 'bg-violet-50', lightBorder: 'border-violet-100', border: 'border-violet-200', ring: 'ring-violet-300', accent: 'text-violet-500', gradient: 'from-violet-500 to-purple-400', softBg: 'bg-gradient-to-br from-purple-50 to-fuchsia-50' }
        };

        // --- æˆå°±å¢™ç±»åˆ«é…è‰² ---
        const ACHIEVEMENT_THEMES = {
            'è£è€€': { title: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-100', cardBg: 'bg-white', iconBg: 'bg-indigo-100 text-indigo-500', ring: 'ring-indigo-100' },
            'æ¯…åŠ›': { title: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-100', cardBg: 'bg-white', iconBg: 'bg-blue-100 text-blue-500', ring: 'ring-blue-100' },
            'æ•ˆç‡': { title: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-100', cardBg: 'bg-white', iconBg: 'bg-emerald-100 text-emerald-500', ring: 'ring-emerald-100' },
            'ç²¾é€š': { title: 'text-violet-600', bg: 'bg-violet-50', border: 'border-violet-100', cardBg: 'bg-white', iconBg: 'bg-violet-100 text-violet-500', ring: 'ring-violet-100' },
            'è´¢å¯Œ': { title: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-100', cardBg: 'bg-white', iconBg: 'bg-amber-100 text-amber-500', ring: 'ring-amber-100' },
            'æ¢ç´¢': { title: 'text-rose-600', bg: 'bg-rose-50', border: 'border-rose-100', cardBg: 'bg-white', iconBg: 'bg-rose-100 text-rose-500', ring: 'ring-rose-100' },
        };

        // --- é»˜è®¤é…ç½® ---
        const DEFAULT_START_DATE = '2026-02-01';
        const DEFAULT_END_DATE = '2026-02-25';
        // ç§»é™¤é¢„è®¾å¯†ç 

        // --- å•†åº—å•†å“å®šä¹‰ ---
        const SHOP_ITEMS = [
            // ç¬¬ä¸€ç±»ï¼šæ—¶ç©ºæ³•å®
            { 
                id: 'item_fire', name: 'æ™®ç½—ç±³ä¿®æ–¯ä¹‹ç«', icon: 'ğŸ”¥', type: 'repair', 
                price: 50, era: 'è¿œå¤ä¹‹è·¯', minLevel: 2, 
                desc: 'è¡¥ç­¾å¡ã€‚å¯ä»¥ä¿®å¤è¿‡å»3å¤©å†…ä»»æ„ä¸€å¤©æœªå®Œæˆçš„æ‰“å¡è®°å½•ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_shield', name: 'é’é“œå®ˆæŠ¤ç›¾', icon: 'ğŸ›¡ï¸', type: 'passive_shield', 
                price: 80, era: 'æ–‡æ˜åˆæ›™', minLevel: 6, 
                desc: 'é˜²å¾¡å¡ã€‚åœ¨â€œé‚ªæ¶å¤§è½¬ç›˜â€æƒ©ç½šç”Ÿæ•ˆå‰è‡ªåŠ¨è§¦å‘ï¼ŒæŠµæ¶ˆä¸€æ¬¡æƒ©ç½šã€‚',
                category: 'tool'
            },
            { 
                id: 'item_skip', name: 'ç¿°æ—é™¢å…ä½œä¸šé‡‘ç‰Œ', icon: 'ğŸ“œ', type: 'skip', 
                price: 200, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 16, 
                desc: 'è·³è¿‡å¡ã€‚å¯ç›´æ¥å®Œæˆä»Šæ—¥ä¸€é¡¹ä»»åŠ¡å¹¶è·å¾—å…¨é¢å¥–åŠ±ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_hourglass', name: 'æ—¶ç©ºæ²™æ¼', icon: 'â³', type: 'extend_deadline', 
                price: 30, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å»¶æ—¶å¡ã€‚å°†æŸä¸ªä»»åŠ¡çš„æˆªæ­¢æ—¶é—´å‘åå»¶é•¿24å°æ—¶ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_harvest', name: 'åŒå€ä¸°æ”¶ç¬¦', icon: 'ğŸŒ¾', type: 'buff_xp_3', 
                price: 100, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 9, 
                desc: 'å¢ç›Šå¡ã€‚ä½¿ç”¨åï¼Œæ¥ä¸‹æ¥è¿ç»­3æ¬¡æ‰“å¡è·å¾—çš„ç»éªŒå€¼(XP)ç¿»å€ã€‚',
                category: 'tool'
            },
            // ç¬¬äºŒç±»ï¼šè£è€€è£…æ‰®
            { 
                id: 'frame_beast', name: 'å…½ç‰™é¡¹é“¾æ¡†', icon: 'ğŸ¦·', type: 'cosmetic_frame', 
                price: 150, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'ç²—çŠ·çš„é‡å…½ç‰™é½¿ä¸²æˆçš„è¾¹æ¡†ã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'frame_bronze', name: 'é¥•é¤®çº¹é“œæ¡†', icon: 'ğŸ—¿', type: 'cosmetic_frame', 
                price: 150, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 0, 
                desc: 'åº„é‡ç¥ç§˜çš„é’é“œå™¨çº¹è·¯ã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'frame_peony', name: 'ç‰¡ä¸¹æµå…‰æ¡†', icon: 'ğŸŒº', type: 'cosmetic_frame', 
                price: 150, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 0, 
                desc: 'é›å®¹åè´µï¼Œå¸¦æœ‰åŠ¨æ€æµå…‰æ•ˆæœã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'effect_name_fire', name: 'ç«ç„°åå­—ç‰¹æ•ˆ', icon: 'ğŸ”¥', type: 'cosmetic_name',
                price: 80, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'è®©åå­—å¸¦æœ‰ç‡ƒçƒ§çš„ç«ç„°ç‰¹æ•ˆï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰ã€‚',
                category: 'cosmetic',
                duration: 7
            },
			{ 
                id: 'bg_galaxy', name: 'æ˜Ÿæ²³é™è°§Â·é“¶æ²³æ˜Ÿç©º', icon: 'ğŸŒŒ', type: 'cosmetic_bg',
                price: 300, era: 'è¿œå¤ä¹‹è·¯', minLevel: 3, 
                desc: 'â€œæˆ‘ä»¬ä»å“ªé‡Œæ¥ï¼Ÿâ€å½“ç›´ç«‹äººç¬¬ä¸€æ¬¡ä»°æœ›æ˜Ÿç©ºï¼Œäººç±»çš„çµé­‚ä¾¿è¯ç”Ÿäº†ã€‚è£…å¤‡åï¼Œä¸»ç•Œé¢å°†åŒ–ä¸ºæ·±é‚ƒçš„åŠ¨æ€é“¶æ²³ã€‚',
                category: 'cosmetic'
            },			
			{ 
                id: 'bg_meteor', name: 'æ˜Ÿæ²³é™è°§Â·æµæ˜Ÿé›¨', icon: 'ğŸŒ ', type: 'cosmetic_bg',
                price: 300, era: 'è¿œå¤ä¹‹è·¯', minLevel: 3, 
                desc: 'â€œåœ¨é‚£å¯‚é™çš„æ·±å¤œï¼Œæ„¿ä½ çš„æ€ç»ªå¦‚æµæ˜Ÿèˆ¬é—ªè€€ã€‚â€è£…å¤‡åï¼ŒèƒŒæ™¯åŒ–ä¸ºæ·±é‚ƒçš„åˆå¤œè“ï¼Œæµæ˜Ÿåˆ’ç ´é•¿å¤œï¼ŒåŠ©ä½ åœ¨æ­¤åˆ»å¿ƒæ— æ—éª›ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_aurora', name: 'æåœ°ä¹‹å¤œÂ·æ¬§è‹¥æ‹‰', icon: 'ğŸŒŒ', type: 'cosmetic_bg',
                price: 250, era: 'è¿œå¤ä¹‹è·¯', minLevel: 5, 
                desc: 'â€œå†°æ²³ä¸–çºªçš„é•¿å¤œé‡Œï¼Œå…ˆç¥–äºæ´ç©´å£å‡è§†å¤©é™…ã€‚é‚£èˆåŠ¨çš„å…‰å¸¦æ˜¯ç¥çµçš„ä½è¯­ï¼Œè¿˜æ˜¯æœªçŸ¥çš„å¬å”¤ï¼Ÿâ€è£…å¤‡åï¼Œè·å¾—åŠ¨æ€æå…‰èƒŒæ™¯ï¼Œé€‚åˆæ·±åº¦ä¸“æ³¨ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_lantern', name: 'ä¸Šå…ƒç¯ç«Â·ç¥ˆæ„¿', icon: 'ğŸ®', type: 'cosmetic_bg',
                price: 800, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 16, 
                desc: 'â€œä¸œé£å¤œæ”¾èŠ±åƒæ ‘ã€‚â€é•¿å®‰ä¸Šå…ƒå¤œï¼Œä¸‡ç›ç¯ç«å¸¦ç€å­¦å­çš„å¿ƒæ„¿ç¼“ç¼“å‡ç©ºã€‚è£…å¤‡åï¼Œæš–æ©™è‰²çš„å­”æ˜ç¯å°†å……æ»¡å±å¹•ï¼Œä¸ºæ‚¨åº†ç¥æ¯ä¸€æ¬¡åŠªåŠ›åçš„è¾‰ç…Œæ—¶åˆ»ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_firefly', name: 'è¤ç«ä¹‹æ£®Â·å‘¼å¸', icon: 'ğŸŒ²', type: 'cosmetic_bg',
                price: 400, era: 'æ–‡æ˜åˆæ›™', minLevel: 6, 
                desc: 'â€œä¸‡ç‰©æœ‰çµï¼Œç”Ÿç”Ÿä¸æ¯ã€‚â€åœ¨éƒ¨è½æ–‡æ˜çš„é»æ˜ï¼Œäººç±»ä¸æ£®æ—å…±äº«å‘¼å¸ã€‚è£…å¤‡åï¼Œæ— æ•°æ²»æ„ˆçš„å¾®å…‰å°†åœ¨æš—ç»¿è‰²çš„æ—é—´å‡èµ·ï¼Œå¸¦ä½ é‡è¿”è‡ªç„¶çš„æ€€æŠ±ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_ginkgo', name: 'å¤«å­åº™å‰Â·é“¶æé›¨', icon: 'ğŸ‚', type: 'cosmetic_bg',
                price: 400, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 12, 
                desc: 'â€œç¤¼ä¹æ•™åŒ–ï¼Œæå›å¼¦æ­Œã€‚â€ä¸‰åƒå¼Ÿå­æ›¾äºæ ‘ä¸‹æ±‚å­¦ï¼Œå¦‚ä»Šé‡‘é»„çš„å¶ç‰‡åŒ–ä½œè¯—ç¯‡é£˜è½ã€‚è£…å¤‡åï¼Œè·å¾—æ·¡é›…çš„ç§‹æ—¥ä¹¦é™¢èƒŒæ™¯ï¼ŒåŠ©ä½ åœ¨æœ—æœ—ä¹¦å£°ä¸­å‡ç¥é™æ°”ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_matrix', name: 'ä¼ è¯´Â·ä¸‡è±¡å­—é˜µ', icon: 'ğŸ“œ', type: 'cosmetic_bg',
                price: 800, era: 'æ–‡æ˜åˆæ›™', minLevel: 7, 
                desc: 'â€œä»“é¢‰è§‚å¥æ˜Ÿåœ†æ›²ä¹‹åŠ¿ï¼Œå¯Ÿé¸Ÿå…½è¹„è¿œä¹‹è¿¹ï¼Œä¾ç±»è±¡å½¢ï¼Œå§‹åˆ›æ–‡å­—ã€‚â€å¤©åœ°ä¹‹ç§˜ï¼Œçš†å…¥å­—é˜µã€‚è¿™ä»“é¢‰çœ¼ä¸­çš„ä¸–ç•Œã€‚ä¸‡ç‰©åŒ–ä¸ºç¬¦å·ï¼Œåœ¨æ— å°½çš„çŸ©é˜µä¸­ç©¿æ¢­ã€é‡ç»„ã€æ¼”å˜ã€‚é™é™æ³¨è§†ï¼Œçœ‹å°½äº”åƒå¹´çš„æ²§æµ·æ¡‘ç”°ã€‚â€',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_oraclesands', name: 'ç§˜å¢ƒÂ·ç”²éª¨æµæ²™', icon: 'ğŸ“œ', type: 'cosmetic_bg',
                price: 800, era: 'æ–‡æ˜åˆæ›™', minLevel: 8, 
                desc: 'â€œå†å²åŸæœ¬æ˜¯å°˜å°çš„å²©å£ï¼Œç›´åˆ°ä½ çš„æŒ‡å°–è§¦ç¢°ï¼Œå®ƒä»¬ä¾¿åŒ–ä½œäº†æµåŠ¨çš„æ²™ã€‚â€è§¦æ‘¸å±å¹•ï¼Œä½ å°†æŒæ§æ–‡æ˜å‘¼å¸çš„èŠ‚å¥ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_firework', name: 'æ–°æ˜¥é™å®šÂ·ç«æ ‘é“¶èŠ±', icon: 'ğŸ†', type: 'cosmetic_bg',
                price: 1, era: 'å…¨çºªå…ƒé€šç”¨', minLevel: 1, 
                desc: 'â€œä¸œé£å¤œæ”¾èŠ±åƒæ ‘ï¼Œæ›´å¹è½ï¼Œæ˜Ÿå¦‚é›¨ã€‚â€æ— è®ºèº«å¤„è¿œå¤æ´ç©´è¿˜æ˜¯å¤§å”ç››ä¸–ï¼Œå¯¹å…‰ä¸çƒ­çš„å‘å¾€æ˜¯äººç±»å…±é€šçš„æƒ…æ„Ÿã€‚',
                category: 'cosmetic',
				// --- ã€æ–°å¢é…ç½®ã€‘ ---
                timeLimit: {
					type: 'api_holiday',
					holidayNames: ['æ˜¥èŠ‚', 'é™¤å¤•', 'å…ƒå®µ'],
					msg: 'æ˜¥èŠ‚/å…ƒå®µèŠ‚ å‰2å¤©å¼€å¯', // æ›´æ–°æç¤ºæ–‡æ¡ˆ
					fallbackStart: '2026-02-15',
					fallbackEnd: '2026-03-03'
				}
            },
			{ 
                id: 'bg_prismatic', name: 'ç™»ç§‘Â·ç‰ç’ƒåå…‰', icon: 'âœ¨', type: 'cosmetic_bg',
                price: 1200, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 16, 
                desc: 'â€œæ˜¥é£å¾—æ„é©¬è¹„ç–¾ï¼Œä¸€æ—¥çœ‹å°½é•¿å®‰èŠ±ã€‚â€æ±‡èšè¥¿åŸŸç‰ç’ƒä¹‹å½©ï¼Œç»½æ”¾é‡‘æ¦œé¢˜åä¹‹å…‰ï¼å½“è¥¿åŸŸçš„ç‰ç’ƒæŠ˜å°„å‡ºå¤§å”çš„é˜³å…‰ï¼Œé‚£æ˜¯æ–‡æ˜äº¤èçš„æè‡´è‰²å½©ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_timewarp', name: 'çºªå…ƒè·ƒè¿Â·æ—¶å…‰éš§é“', icon: 'ğŸŒŒ', type: 'cosmetic_bg',
                price: 1500, era: 'å…¨çºªå…ƒé€šç”¨', minLevel: 1, 
                desc: 'â€œæ—¶é—´å¹¶éä¸€æ¡ç›´çº¿ï¼Œè€Œæ˜¯ä¸€åœºæ— å°½çš„å è½ã€‚â€\nç³»å¥½å®‰å…¨å¸¦ï¼Œæ—¶ç©ºç©¿æ¢­å³å°†å¼€å§‹ï¼è¿™æ˜¯å±äºæ—¶ç©ºæ—…è€…çš„ç»ˆæè§†ç•Œã€‚è¿é¢æ‰‘æ¥çš„æµå…‰æ˜Ÿè½¨ï¼Œå¸¦ä½ è·¨è¶Šè¿œå¤ä¸æœªæ¥ã€‚',
                category: 'cosmetic'
            },
			{ 
                id: 'bg_hyperspeed', name: 'è™šç©ºè·ƒè¿Â·è¶…å…‰é€Ÿå¼•æ“', icon: 'ğŸš€', type: 'cosmetic_bg',
                price: 1500, era: 'å…¨çºªå…ƒé€šç”¨', minLevel: 1, 
                desc: 'â€œå½“é€Ÿåº¦è¶…è¶Šå…‰ï¼Œä¸–ç•Œåªå‰©ä¸‹çº¯ç²¹çš„çº¿ä¸ç»ˆç‚¹ã€‚â€\nè­¦å‘Šï¼šå³å°†çªç ´å…‰é€Ÿï¼Œè¯·å±è”½ä¸€åˆ‡å¹²æ‰°ï¼ä½“éªŒç¡¬æ ¸ç§‘å¹»ç”µå½±ä¸­çš„åŒæ¬¾æ›²ç‡è·ƒè¿ï¼è®©æ»¡å±çš„åˆºçœ¼æ˜Ÿè½¨å¸¦ä½ æ’•è£‚ç©ºé—´ã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'effect_name_star', name: 'æ˜Ÿå…‰åå­—ç‰¹æ•ˆ', icon: 'âœ¨', type: 'cosmetic_name',
                price: 80, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 0, 
                desc: 'è®©åå­—å¸¦æœ‰é—ªçƒçš„æ˜Ÿå…‰ç‰¹æ•ˆï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰ã€‚',
                category: 'cosmetic',
                duration: 7
            },
            // ç¬¬ä¸‰ç±»ï¼šç°å®å…‘æ¢
            { 
                id: 'real_soda', name: 'è‚¥å®…å¿«ä¹æ°´åˆ¸', icon: 'ğŸ¥¤', type: 'real', 
                price: 20, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å…‘æ¢ä¸€ç“¶æŒ‡å®šé¥®æ–™ã€‚æ¯å‘¨é™è´­2å¼ ã€‚',
                category: 'real', limit: 2
            },
            { 
                id: 'real_screen', name: 'å±å¹•æ—¶é—´åŠ æ²¹åŒ…', icon: 'ğŸ“±', type: 'real', 
                price: 150, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'é¢å¤–è·å¾—30åˆ†é’Ÿæ¸¸æˆ/iPadæ—¶é—´ã€‚é™å‘¨æœ«ä½¿ç”¨ã€‚',
                category: 'real'
            },
            { 
                id: 'real_chore', name: 'å…åšå®¶åŠ¡å¡', icon: 'ğŸ§¹', type: 'real', 
                price: 300, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'æŠµæ¶ˆä¸€æ¬¡å®¶åŠ¡åŠ³åŠ¨ã€‚',
                category: 'real', limit: 1
            },
            { 
                id: 'real_weekend', name: 'å‘¨æœ«è¯è¯­æƒ', icon: 'ğŸ¡', type: 'real', 
                price: 800, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å†³å®šå‘¨æœ«å…¨å®¶å»å“ªé‡Œç©çš„æœ€ç»ˆå†³å®šæƒã€‚',
                category: 'real'
            },
            // ç¬¬å››ç±»ï¼šç›²ç›’
            {
                id: 'box_relic', name: 'æ—¶ç©ºé—ç‰©ç›²ç›’', icon: 'ğŸ', type: 'box',
                price: 50, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'è¯•è¯•æ‰‹æ°”ï¼å¯èƒ½å¼€å‡ºå¤§é‡ç»éªŒã€é“å…·æˆ–éšè—æ¬¾çš®è‚¤ã€‚',
                category: 'box'
            },
            // ç¬¬äº”ç±»ï¼šç­–ç•¥ä¸è¾…åŠ©ï¼ˆé«˜é˜¶ç©å®¶ä¸“ç”¨ï¼‰
            { 
                id: 'item_freeze', name: 'å†°æ²³ä¸–çºªå›¾è…¾', icon: 'â„ï¸', type: 'freeze', 
                price: 60, era: 'è¿œå¤ä¹‹è·¯', minLevel: 3, 
                desc: 'å†»ç»“å¡ã€‚ä½¿ç”¨åï¼Œæ•´ä¸ªç³»ç»Ÿ"å†»ç»“"ä¸€å¤©ã€‚è¿™ä¸€å¤©ä¸æ‰“å¡ä¹Ÿä¸ä¼šæ–­æ‰"è¿ç»­æ‰“å¡å¤©æ•°"è®°å½•ï¼Œä¹Ÿä¸ä¼šè§¦å‘ä»»ä½•æƒ©ç½šï¼Œä½†åŒæ—¶ä¹Ÿæ— æ³•è·å¾—æ”¶ç›Šã€‚',
                category: 'tool'
            },
            { 
                id: 'item_alchemy', name: 'ç‚¼é‡‘æœ¯å£«çš„è¯•ç®¡', icon: 'âš—ï¸', type: 'alchemy', 
                price: 100, era: 'æ–‡æ˜åˆæ›™', minLevel: 7, 
                desc: 'èµ„æºè½¬åŒ–ã€‚è´­ä¹°åï¼Œç«‹å³å°†100é‡‘å…ƒå®è½¬åŒ–ä¸º500ç‚¹ç»éªŒå€¼ï¼ˆXPï¼‰ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_lucky', name: 'å¹¸è¿åŠ æŒç¬¦', icon: 'ğŸ€', type: 'lucky_buff', 
                price: 30, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 14, 
                desc: 'æ¦‚ç‡æå‡ã€‚ä½¿ç”¨åï¼Œä¸‹ä¸€æ¬¡è½¬åŠ¨"æƒŠå–œå¤§è½¬ç›˜"æ—¶ï¼Œå±è”½æ‰æœ€ä½æ¡£å¥–åŠ±ï¼ˆå¦‚5å…ƒå®ï¼‰ï¼Œæé«˜æŠ½ä¸­å¤§å¥–çš„æ¦‚ç‡ã€‚',
                category: 'tool'
            },
            // ç¬¬å…­ç±»ï¼šå®¶åº­äº’åŠ¨ä¸æ¶ä½œå‰§
            { 
                id: 'item_message', name: 'ç”²éª¨æ–‡ä¼ ä¹¦', icon: 'ğŸ“œ', type: 'message_board', 
                price: 10, era: 'æ–‡æ˜åˆæ›™', minLevel: 5, 
                desc: 'ç•™è¨€æ¿ã€‚è´­ä¹°åï¼Œå¯ä»¥åœ¨è½¯ä»¶çš„é¦–é¡µæœ€æ˜¾çœ¼å¤„ç•™ä¸‹ä¸€å¥è¯ï¼ˆå¦‚"ç¥å“¥å“¥ç”Ÿæ—¥å¿«ä¹"æˆ–"æˆ‘æ˜¯å…¨å®¶æœ€æ£’çš„"ï¼‰ï¼Œä¿ç•™24å°æ—¶ï¼Œæ‰€æœ‰å®¶åº­æˆå‘˜æ‰“å¼€éƒ½èƒ½çœ‹åˆ°ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_helper', name: 'ç¥ç¬”é©¬è‰¯ä½“éªŒåˆ¸', icon: 'ğŸ–Œï¸', type: 'parent_help', 
                price: 40, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å®¶é•¿ä»£å†™ã€‚è´­ä¹°åï¼Œå¯ä»¥æŒ‡å®šå®¶é•¿å¸®å¿™å®Œæˆä¸€é¡¹éå­¦ä¹ ç±»çš„æ‰‹å·¥ä»»åŠ¡æˆ–ç”»æŠ¥ä»»åŠ¡çš„"æœ€éš¾éƒ¨åˆ†"ï¼ˆæ¯”å¦‚å¸®å¿™å‰ªè£ç¡¬çº¸æ¿ï¼‰ã€‚',
                category: 'real'
            },
            // ç¬¬ä¸ƒç±»ï¼šç°å®ç¦åˆ©å‡çº§ç‰ˆ
            { 
                id: 'real_menu', name: 'å¾¡è†³æˆ¿ç‚¹èœæ—¨æ„', icon: 'ğŸ½ï¸', type: 'real', 
                price: 120, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 19, 
                desc: 'èœå•å†³å®šæƒã€‚è·å¾—æŒ‡å®šå½“å¤©æ™šé¤çš„ä¸€é“ä¸»èœï¼ˆå¦‚çº¢çƒ§è‚‰ã€æŠ«è¨ï¼‰çš„æƒåˆ©ï¼ŒæŒå‹ºå®¶é•¿å¿…é¡»æ‰§è¡Œã€‚',
                category: 'real'
            },
            { 
                id: 'real_night', name: 'ä¸Šå…ƒèŠ‚å¤œæ¸¸ä»¤', icon: 'ğŸŒ™', type: 'real', 
                price: 150, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 15, 
                desc: 'ç†¬å¤œæƒã€‚å…è®¸åœ¨å‘¨æœ«çš„æ™šä¸Šæ¨è¿Ÿ30åˆ†é’Ÿç¡è§‰ï¼Œç”¨äºçœ‹ä¹¦ã€å‘å‘†æˆ–ç©ç©å…·ï¼ˆä¸å«ç”µå­å±å¹•ï¼‰ã€‚',
                category: 'real'
            },
            { 
                id: 'real_book', name: 'ä¹¦é¦™é—¨ç¬¬è´­ä¹¦åˆ¸', icon: 'ğŸ“š', type: 'real', 
                price: 200, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 11, 
                desc: 'å®ç‰©å¥–åŠ±ã€‚å…‘æ¢ä¸€æœ¬ä»·æ ¼åœ¨30å…ƒä»¥å†…çš„è¯¾å¤–ä¹¦ï¼ˆæ¼«ç”»ã€å°è¯´ã€ç»˜æœ¬ä¸é™ï¼‰ï¼Œå®¶é•¿è´Ÿè´£ä¸‹å•ã€‚',
                category: 'real'
            },
            // ç¬¬å…«ç±»ï¼šæè‡´å¥¢å
            { 
                id: 'item_theme', name: 'ä¸ç»¸ä¹‹è·¯å¯»å®å›¾', icon: 'ğŸ—ºï¸', type: 'unlock_theme', 
                price: 1000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 20, 
                desc: 'è§£é”éšè—ä¸»é¢˜ã€‚è´­ä¹°åï¼Œè½¯ä»¶ä¼šè§£é”ä¸€å¥—éšè—çš„"è¥¿åŸŸæ•¦ç…Œ"ä¸»é¢˜çš®è‚¤ï¼ˆé‡‘è‰²ä¸å®çŸ³è“é…è‰²ï¼‰ï¼Œä¸”è‡ªå¸¦å¼‚åŸŸé£æƒ…çš„èƒŒæ™¯éŸ³ä¹ã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'real_dream', name: 'å°ç‹¼å±…èƒ¥', icon: 'ğŸ†', type: 'real', 
                price: 2000, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'æ„¿æœ›å¤§å¥–ã€‚å…‘æ¢ä¸€æ¬¡é•¿é€”æ—…è¡Œï¼ˆå¦‚è¿ªå£«å°¼ã€ç¯çƒå½±åŸæˆ–æµ·è¾¹åº¦å‡ï¼‰çš„ä¸€å¼ é—¨ç¥¨èµ„é‡‘èµåŠ©ï¼ˆæˆ–ä½œä¸ºå¯åŠ¨èµ„é‡‘ï¼‰ã€‚éœ€é›†é½æ‰€æœ‰"æ¯…åŠ›"ç±»å¾½ç« ã€‚',
                category: 'real'
            },
            // ç¬¬ä¹ç±»ï¼šè¶£å‘³ä¸å½©è›‹
            { 
                id: 'item_monitor', name: 'å­”å¤«å­çš„æˆ’å°º', icon: 'ğŸ“', type: 'parent_monitor', 
                price: 10, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 10, 
                desc: 'ç›‘ç£å¡ã€‚è´­ä¹°åï¼Œå¯ä»¥å°†è¿™å¼ å¡"è´´"ç»™å®¶é•¿ã€‚å¦‚æœå®¶é•¿å½“å¤©ç©æ‰‹æœºè¶…è¿‡1å°æ—¶ï¼Œå­©å­å¯ä»¥è¦æ±‚å®¶é•¿ç½šæ¬¾ï¼ˆå‘10å…ƒçº¢åŒ…ç»™å­©å­ï¼‰ã€‚',
                category: 'tool'
            },
            // ç¬¬åç±»ï¼šçºªå…ƒæŠ•èµ„è®¡åˆ’ï¼ˆæ”¶ç›Šç¿»å€å¡ï¼‰
            { 
                id: 'item_invest_2x', name: 'ä¸°æ”¶çš„çŸ³æ–§', icon: 'ğŸª“', type: 'invest_multiplier', 
                price: 40, era: 'è¿œå¤ä¹‹è·¯', minLevel: 2, 
                desc: 'æŠ•èµ„å¡ã€‚ç”Ÿæ•ˆæœŸé—´ï¼ˆ3å¤©ï¼‰ï¼Œæ‰€æœ‰ä»»åŠ¡æ‰“å¡å¥–åŠ±x2ã€‚ä¸ä»…èƒ½ç‹©çŒï¼Œè¿˜èƒ½æŒ–æ˜æ›´å¤šèµ„æºã€‚',
                category: 'tool',
                multiplier: 2,
                duration: 3
            },
            { 
                id: 'item_invest_3x', name: 'é’é“œå•†è´¸ä»¤', icon: 'ğŸª™', type: 'invest_multiplier', 
                price: 120, era: 'æ–‡æ˜åˆæ›™', minLevel: 6, 
                desc: 'æŠ•èµ„å¡ã€‚ç”Ÿæ•ˆæœŸé—´ï¼ˆ3å¤©ï¼‰ï¼Œæ‰€æœ‰ä»»åŠ¡æ‰“å¡å¥–åŠ±x3ã€‚å¼€å¯éƒ¨è½é—´çš„è´¸æ˜“è·¯çº¿ã€‚ä»·æ ¼è¾ƒé«˜ï¼Œå¦‚æœè¿™3å¤©æœ‰è¯¾å¤–ç­å¤ªå¿™æ²¡æ³•æ‰“å¡ï¼Œå¯èƒ½ä¼šäºæœ¬å“¦ï¼',
                category: 'tool',
                multiplier: 3,
                duration: 3
            },
            { 
                id: 'item_invest_4x', name: 'èšå®ç›†ï¼ˆä¹é¼ä¹‹ç¥ï¼‰', icon: 'ğŸº', type: 'invest_multiplier', 
                price: 300, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 11, 
                desc: 'æŠ•èµ„å¡ã€‚ç”Ÿæ•ˆæœŸé—´ï¼ˆ3å¤©ï¼‰ï¼Œä»»åŠ¡å¥–åŠ±x4ã€‚ä¼ è¯´ä¸­å¤§ç¦¹é“¸é€ çš„ä¹é¼ï¼Œæ‹¥æœ‰æ±‡èšå¤©ä¸‹è´¢å¯Œçš„èƒ½åŠ›ã€‚é€‚åˆå‘¨æœ«ï¼ˆä»»åŠ¡å¤šçš„æ—¶å€™ï¼‰ä½¿ç”¨ã€‚',
                category: 'tool',
                multiplier: 4,
                duration: 3
            },
            { 
                id: 'item_invest_5x', name: 'å¼€å…ƒé€šå®é“¸å¸æƒ', icon: 'ğŸ’°', type: 'invest_multiplier', 
                price: 600, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 18, 
                desc: 'æŠ•èµ„å¡ã€‚ç”Ÿæ•ˆæœŸé—´ï¼ˆ3å¤©ï¼‰ï¼Œä»»ä½•æ‰“å¡æ”¶å…¥ç›´æ¥x5ï¼è·å¾—æœå»·ç‰¹è®¸çš„é“¸å¸æƒã€‚é«˜é£é™©é«˜å›æŠ¥ï¼Œä¸€æ¬¡æˆåŠŸçš„æŠ•èµ„å¯ä»¥ä¹°ä¸‹æ•´ä¸ªå•†åº—ã€‚',
                category: 'tool',
                multiplier: 5,
                duration: 3
            },
            // ç¬¬åä¸€ç±»ï¼šå­¦ä¹ è¾…åŠ©ä¸ç‰¹æƒ
            { 
                id: 'item_help_card', name: 'è¯¸è‘›é”¦å›Šï¼ˆæ±‚åŠ©å¡ï¼‰', icon: 'ğŸ“¦', type: 'help_card', 
                price: 30, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å¬å”¤å®¶é•¿ã€‚å½“é‡åˆ°ä¸€é“å¾ˆéš¾çš„æ•°å­¦é¢˜æˆ–è‹±è¯­å¥å­æ—¶ï¼Œä½¿ç”¨æ­¤å¡ï¼Œå®¶é•¿å¿…é¡»è€å¿ƒè®²è§£10åˆ†é’Ÿï¼Œä¸”ç»å¯¹ä¸èƒ½å‘ç«ï¼Œä¸èƒ½è¯´"è¿™éƒ½ä¸ä¼š"ã€‚',
                category: 'real'
            },
            { 
                id: 'item_reduce', name: 'å¬å†™è±å…åˆ¸ï¼ˆå‡é‡å¡ï¼‰', icon: 'âœ‚ï¸', type: 'reduce_homework', 
                price: 80, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'æ‰“æŠ˜ã€‚å°†å½“å¤©çš„è‹±è¯­å•è¯å¬å†™æˆ–è¯­æ–‡ç”Ÿå­—é»˜å†™ä»»åŠ¡é‡å‡åŠï¼ˆä¾‹å¦‚ä»20ä¸ªå‡åˆ°10ä¸ªï¼‰ã€‚',
                category: 'real'
            },
            // ç¬¬åäºŒç±»ï¼šè§†è§‰ç‰¹æ•ˆå‡çº§
            { 
                id: 'effect_confetti', name: 'çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆ', icon: 'ğŸ†', type: 'cosmetic_confetti', 
                price: 100, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevel: 0, 
                desc: 'æ°¸ä¹…å‡çº§ã€‚è´­ä¹°åï¼Œæ¯æ¬¡å®Œæˆä»»åŠ¡æ‰“å¡æ—¶ï¼Œå±å¹•ä¸Šä¸å†æ˜¯æ™®é€šçš„å½©çº¸å±‘ï¼Œè€Œæ˜¯å–·å°„é‡‘å¸é›¨å’Œæ˜Ÿæ˜Ÿçš„æ··åˆç‰¹æ•ˆã€‚',
                category: 'cosmetic'
            },
            { 
                id: 'theme_cyber', name: 'èµ›åšæœ‹å…‹ä¸»é¢˜è‰²', icon: 'ğŸŒƒ', type: 'cosmetic_theme', 
                price: 500, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevel: 0, 
                desc: 'ç•Œé¢çš®è‚¤ã€‚è§£é”ä¸€å¥—é»‘åº•ã€éœ“è™¹ç²‰ã€ç”µå…‰è“é…è‰²çš„"èµ›åšå”æœ"ç•Œé¢ä¸»é¢˜ã€‚å½“å¤è€æ–‡æ˜é‡ä¸Šæœªæ¥ç§‘æŠ€ã€‚',
                category: 'cosmetic'
            },
            // ç¬¬åä¸‰ç±»ï¼šå®¶åº­åšå¼ˆä¸è¶£å‘³
            { 
                id: 'item_challenge', name: 'ç«æŠ€åœºæŒ‘æˆ˜ä¹¦', icon: 'âš”ï¸', type: 'challenge', 
                price: 50, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'å¯¹èµŒã€‚å‘èµ·è€…å‘å¦ä¸€ä¸ªå­©å­å‘èµ·æŒ‘æˆ˜ï¼ˆä¾‹å¦‚ï¼š"è°å…ˆå®Œæˆä»Šå¤©çš„æ•°å­¦ç²¾å‡†å­¦"ï¼‰ã€‚å®¶é•¿åšè£åˆ¤ã€‚èµ¢å®¶è·å¾—ç³»ç»Ÿå¥–åŠ±çš„100é‡‘å…ƒå®ï¼ˆå‘èµ·è€…å›æœ¬å¹¶èµš50ï¼‰ï¼Œè¾“å®¶æ— æƒ©ç½šï¼ˆä½†æ²¡é¢å­ï¼‰ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_silence', name: 'é™éŸ³å¡ï¼ˆç¦è¨€ä»¤ï¼‰', icon: 'ğŸ¤«', type: 'silence', 
                price: 60, era: 'è¿œå¤ä¹‹è·¯', minLevel: 0, 
                desc: 'è®©å¯¹æ–¹å®‰é™ã€‚å¦‚æœå…„å¦¹ä¹‹é—´åµæ¶ï¼Œæˆ–è€…å«Œå¯¹æ–¹å¤ªåµï¼Œå¯ä»¥ä½¿ç”¨æ­¤å¡ã€‚å®¶é•¿éœ€æ‰§è¡Œ"ç¦è¨€ä»¤"ï¼Œè¦æ±‚å¯¹æ–¹å®‰é™10åˆ†é’Ÿï¼ˆä¸èƒ½è¯´è¯ã€ä¸èƒ½åˆ¶é€ å™ªéŸ³ï¼‰ã€‚',
                category: 'tool'
            },
            { 
                id: 'item_undo', name: 'åæ‚”è¯æ°´ï¼ˆæ’¤é”€æ“ä½œï¼‰', icon: 'â®ï¸', type: 'undo', 
                price: 20, era: 'æ–‡æ˜åˆæ›™', minLevel: 0, 
                desc: 'å¦‚æœä¸å°å¿ƒè¯¯è§¦äº†"å…‘æ¢å¥–å“"æˆ–è€…ä¹°é”™äº†é“å…·ï¼Œå¯ä»¥ä½¿ç”¨æ­¤è¯æ°´æ’¤é”€æœ€è¿‘ä¸€æ¬¡ï¼ˆ5åˆ†é’Ÿå†…ï¼‰çš„å•†åº—æ“ä½œï¼Œå…¨é¢é€€æ¬¾ã€‚',
                category: 'tool'
            },
			{ 
                id: 'item_undo_advanced', name: 'é«˜çº§åæ‚”è¯æ°´', icon: 'ğŸ·', type: 'undo_advanced', 
                price: 50, era: 'æ–‡æ˜åˆæ›™', minLevel: 0, 
                desc: 'åæ‚”è¯å‡çº§ç‰ˆï¼ä½¿ç”¨åï¼Œä¼šåˆ—å‡ºä½ èƒŒåŒ…é‡Œçš„æ‰€æœ‰ç‰©å“ï¼Œä½ å¯ä»¥æŒ‡å®šä»»æ„ä¸€ä»¶è¿›è¡Œé€€è´§é€€æ¬¾ï¼ˆå¿…é¡»æ˜¯æœ‰è´­ä¹°è®°å½•çš„å•†å“ï¼‰ã€‚',
                category: 'tool'
            },
        ];

        // --- éšæœºäº‹ä»¶åº“å®šä¹‰ ---
        const RANDOM_EVENTS = [
            // --- ç¬¬ä¸€çºªå…ƒï¼šè¿œå¤ä¹‹è·¯ ---
            { id: 'era1_u_fire', type: 'unique', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èƒ½äºº', desc: 'åœ¨é’»æœ¨å–ç«æ—¶ï¼Œä¸€ç‚¹ç«æ˜Ÿè½å…¥å¹²è‰ï¼Œä½ æˆåŠŸå‡èµ·äº†ç¬¬ä¸€å †ç¯ç«ï¼é‡å…½ä¸æ•¢é è¿‘äº†ã€‚', rewardType: 'xp', rewardValue: 50, title: 'æ™®ç½—ç±³ä¿®æ–¯æ—¶åˆ»' },
            { id: 'era1_u_stars', type: 'unique', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'ç›´ç«‹äºº', desc: 'ä»Šå¤œæ˜Ÿæ²³ç’€ç’¨ï¼Œä½ èººåœ¨æ´ç©´å£ä»°æœ›ï¼Œè„‘æµ·ä¸­ç¬¬ä¸€æ¬¡è¯ç”Ÿäº†â€œä¸–ç•Œâ€è¿™ä¸ªæ¦‚å¿µã€‚', rewardType: 'xp', rewardValue: 40, title: 'ä»°æœ›æ˜Ÿç©º' },
            { id: 'era1_u_art', type: 'unique', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'æ™ºäºº', desc: 'ä½ ç”¨çº¢è‰²çŸ¿çŸ³ç²‰æœ«æ··åˆæ²¹è„‚ï¼Œåœ¨å²©å£ä¸Šç”»ä¸‹äº†ç‹©çŒé‡ç‰›çš„åœºæ™¯ï¼Œè¿™æ˜¯æœ€æ—©çš„è‰ºæœ¯ã€‚', rewardType: 'gold', rewardValue: 10, title: 'å¢™å£ä¸Šçš„è‰ºæœ¯' },
            { id: 'era1_u_obsidian', type: 'unique', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èƒ½äºº', desc: 'ä½ åœ¨æ²³è¾¹æ¡åˆ°ä¸€å—é”‹åˆ©çš„é»‘è‰²çŸ³å¤´ï¼ŒæŠŠå®ƒç»‘åœ¨æœ¨æ£ä¸Šï¼Œåšæˆäº†é”‹åˆ©çš„é•¿çŸ›ã€‚', rewardType: 'xp', rewardValue: 30, title: 'é»‘æ›œçŸ³' },
            { id: 'era1_r_berries', type: 'repeat', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èŒèŠ½ä¹‹è¯†', desc: 'åœ¨ä¸€ç‰‡çŒæœ¨ä¸›ä¸­å‘ç°äº†é…¸ç”œå¯å£çš„çº¢æµ†æœï¼Œé¥±é¤ä¸€é¡¿ï¼Œå¿ƒæƒ…å¤§å¥½ã€‚', rewardType: 'gold', rewardValue: 5, title: 'é‡‡é›†æµ†æœ' },
            { id: 'era1_r_tiger', type: 'repeat', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èŒèŠ½ä¹‹è¯†', desc: 'è‰ä¸›ä¸­çªç„¶çªœå‡ºä¸€åªå‰‘é½¿è™ï¼å¹¸å¥½ä½ åˆ©ç”¨å¯¹åœ°å½¢çš„ç†Ÿæ‚‰ï¼Œçˆ¬ä¸Šå¤§æ ‘é€ƒè¿‡ä¸€åŠ«ã€‚', rewardType: 'xp', rewardValue: 20, title: 'é™©è±¡ç¯ç”Ÿ' },
            { id: 'era1_r_rain', type: 'repeat', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èŒèŠ½ä¹‹è¯†', desc: 'çªç„¶å¤©é™æš´é›¨ï¼Œä½ å’Œæ—äººèº²åœ¨å±±æ´é‡Œç‘Ÿç‘Ÿå‘æŠ–ï¼Œå¥½åœ¨ç«å †æ²¡æœ‰ç†„ç­ã€‚', rewardType: 'xp', rewardValue: 10, title: 'æš´é›¨å¦‚æ³¨' },
            { id: 'era1_r_rabbit', type: 'repeat', era: 'è¿œå¤ä¹‹è·¯', minLevelName: 'èŒèŠ½ä¹‹è¯†', desc: 'è‰ä¸›é‡Œçªœå‡ºä¸€åªè‚¥ç¡•çš„é‡å…”ï¼Œä½ ä¸€è·¯ç‹‚å¥”ï¼Œç»ˆäºç”¨çŸ³å—å‡»ä¸­äº†å®ƒï¼', rewardType: 'gold', rewardValue: 5, title: 'è¿½é€é‡å…”' },

            // --- ç¬¬äºŒçºªå…ƒï¼šæ–‡æ˜åˆæ›™ ---
            { id: 'era2_u_knots', type: 'unique', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'éƒ¨è½æ°‘', desc: 'ä¸ºäº†è®°å½•çŒç‰©çš„æ•°é‡ï¼Œä½ å‘æ˜äº†åœ¨ç»³å­ä¸Šæ‰“ç»“çš„æ–¹æ³•ï¼Œè¿™æ˜¯æ•°å­¦çš„èŒèŠ½ï¼', rewardType: 'xp', rewardValue: 60, title: 'ç»“ç»³è®°äº‹' },
            { id: 'era2_u_pottery', type: 'unique', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'éƒ¨è½æ°‘', desc: 'åŸæœ¬ç”¨æ¥æ¶‚æŠ¹ç¼–ç»‡ç­çš„æ³¥å·´æ‰è¿›ç«å †ï¼Œæ„å¤–çƒ§æˆäº†åšç¡¬çš„é™¶ç¢—ã€‚ä½ å‘ç°äº†åˆ¶é™¶æœ¯ï¼', rewardType: 'gold', rewardValue: 15, title: 'é™¶å™¨çš„è¯ç”Ÿ' },
            { id: 'era2_u_herbs', type: 'unique', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'æ°æ—é•¿', desc: 'ä½ å‘ç°åš¼ç¢æŸç§è‰å¶æ•·åœ¨ä¼¤å£ä¸Šå¯ä»¥æ­¢è¡€ï¼Œæ—äººä»¬å°Šç§°ä½ ä¸ºç¥åŒ»ã€‚', rewardType: 'xp', rewardValue: 80, title: 'ç¥å†œå°ç™¾è‰' },
            { id: 'era2_u_totem', type: 'unique', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'æ°æ—é•¿', desc: 'ä½ å°†â€œé¾™â€ä½œä¸ºæ°æ—çš„å®ˆæŠ¤ç¥æ ‡å¿—ï¼Œæ—äººä»¬çš„å‡èšåŠ›ç©ºå‰é«˜æ¶¨ã€‚', rewardType: 'xp', rewardValue: 50, title: 'å›¾è…¾çš„ç¡®ç«‹' },
            { id: 'era2_u_silk', type: 'unique', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'å¤§é…‹é•¿', desc: 'ä½ åœ¨æ¡‘æ ‘ä¸Šå‘ç°äº†ç™½è‰²çš„è™«èŒ§ï¼ŒæŠ½å‡ºçš„ä¸çº¿ç«Ÿç„¶å¦‚æ­¤å¼ºéŸ§å…‰äº®ï¼Œå¯ä»¥ç»‡æˆè¡£ç‰©ã€‚', rewardType: 'gold', rewardValue: 20, title: 'å«˜ç¥–å…»èš•' },
            { id: 'era2_r_festival', type: 'repeat', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'éƒ¨è½æ°‘', desc: 'ä»Šæ™šéƒ¨è½ä¸¾è¡Œç››å¤§çš„ç¯ç«æ™šä¼šï¼Œåº†ç¥ç‹©çŒä¸°æ”¶ï¼Œä½ åˆ†åˆ°äº†ä¸€å—æœ€è‚¥ç¾çš„çƒ¤è‚‰ã€‚', rewardType: 'gold', rewardValue: 10, title: 'ä¸°æ”¶ç¥­å…¸' },
            { id: 'era2_r_conflict', type: 'repeat', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'æ°æ—é•¿', desc: 'éš”å£éƒ¨è½è¯•å›¾æŠ¢å æ°´æºï¼Œä½ å¸¦é¢†æ—äººæŒ¥èˆçŸ³æ–§ï¼ŒæˆåŠŸå“é€€äº†å…¥ä¾µè€…ã€‚', rewardType: 'xp', rewardValue: 30, title: 'éƒ¨è½å†²çª' },
            { id: 'era2_r_repair', type: 'repeat', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'éƒ¨è½æ°‘', desc: 'æ˜¨å¤œçš„å¤§é£å¹åäº†å±‹é¡¶çš„èŒ…è‰ï¼Œä½ çˆ¬ä¸Šå»é‡æ–°åŠ å›ºï¼Œæ–°å±‹é¡¶æ›´åŠ ç»“å®äº†ã€‚', rewardType: 'xp', rewardValue: 20, title: 'ä¿®è¡¥æˆ¿å±‹' },
            { id: 'era2_r_trade', type: 'repeat', era: 'æ–‡æ˜åˆæ›™', minLevelName: 'éƒ¨è½æ°‘', desc: 'ä½ ç”¨å¤šä½™çš„å…½çš®è·Ÿéš”å£é‚»å±…æ¢äº†ä¸€ç½èœ‚èœœï¼Œç”œç”œçš„å‘³é“è®©äººå¿ƒæƒ…æ„‰æ‚¦ã€‚', rewardType: 'gold', rewardValue: 5, title: 'äº¤æ¢ç‰©èµ„' },

            // --- ç¬¬ä¸‰çºªå…ƒï¼šå‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹ ---
            { id: 'era3_u_field', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'é‡äºº', desc: 'ä½ è´Ÿè´£è€•ä½œçš„â€œå…¬ç”°â€å’Œâ€œç§ç”°â€åˆ’åˆ†å¾—äº•äº•æœ‰æ¡ï¼Œä»Šå¹´çš„æ”¶æˆæ ¼å¤–å¥½ã€‚', rewardType: 'gold', rewardValue: 15, title: 'äº•ç”°åˆ¶' },
            { id: 'era3_u_rites', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å›½äºº', desc: 'å‘¨å…¬åˆ¶å®šäº†ä¸¥æ ¼çš„ç¤¼ä¹åˆ¶åº¦ï¼Œä½ å­¦ä¹ äº†ç¥­ç¥€çš„è§„çŸ©ï¼Œæ„Ÿåˆ°ç§©åºäº•ç„¶ã€‚', rewardType: 'xp', rewardValue: 60, title: 'åˆ¶ç¤¼ä½œä¹' },
            { id: 'era3_u_bronze', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å£«', desc: 'ä½œä¸ºå·¥åŒ ç›‘é€ ï¼Œä½ å‚ä¸é“¸é€ äº†ä¸€å£å·¨å¤§çš„å¸æ¯æˆŠé¼ï¼Œé“­æ–‡ç²¾ç¾ç»ä¼¦ã€‚', rewardType: 'xp', rewardValue: 100, title: 'é“¸é€ é’é“œé¼' },
            { id: 'era3_u_poems', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å£«', desc: 'é‡‡è¯—å®˜æ¥åˆ°ä¹¡é—´ï¼Œä½ éšå£å“¼å”±çš„åŠ³åŠ¨æ­Œè°£è¢«è®°å½•ä¸‹æ¥ï¼Œç¼–å…¥äº†ã€Šè¯—ç»ã€‹ã€‚', rewardType: 'gold', rewardValue: 20, title: 'è¯—ç»é‡‡é£' },
            { id: 'era3_u_100schools', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¤§å¤«', desc: 'ç¨·ä¸‹å­¦å®«é‡Œï¼Œä½ æ—å¬äº†å­Ÿå­ä¸è€å­çš„è¾©è®ºï¼Œå¯¹â€œäººæ€§æœ¬å–„â€è¿˜æ˜¯â€œæœ¬æ¶â€é™·å…¥æ·±æ€ã€‚', rewardType: 'xp', rewardValue: 150, title: 'ç™¾å®¶äº‰é¸£' },
            { id: 'era3_u_beacon', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¿', desc: 'å¬é—»å¹½ç‹ä¸ºäº†åšç¾äººä¸€ç¬‘ç‚¹ç‡ƒçƒ½ç«ï¼Œè¯¸ä¾¯ç©ºè·‘ä¸€è¶Ÿã€‚ä½ æ„Ÿå¹ï¼šæ— ä¿¡åˆ™ä¸ç«‹ã€‚', rewardType: 'xp', rewardValue: 50, title: 'çƒ½ç«æˆè¯¸ä¾¯' },
            { id: 'era3_u_jade', type: 'unique', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¿', desc: 'ä½œä¸ºä½¿è‡£å‡ºä½¿ç§¦å›½ï¼Œä½ å‡­å€Ÿæ™ºæ…§å’Œå‹‡æ°”ï¼Œä¿å…¨äº†å›½å®¶çš„å®ç‰å’Œå°Šä¸¥ã€‚', rewardType: 'gold', rewardValue: 30, title: 'å®Œç’§å½’èµµ' },
            { id: 'era3_r_archery', type: 'repeat', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å£«', desc: 'å›å­å…­è‰ºï¼Œå°„ä¸ºé‡ã€‚ä»Šæ—¥æ ¡åœºæ¼”ç»ƒï¼Œä½ ä¸‰å‘å…¨ä¸­é¶å¿ƒï¼', rewardType: 'xp', rewardValue: 40, title: 'ç»ƒä¹ å°„ç¤¼' },
            { id: 'era3_r_tribute', type: 'repeat', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¤§å¤«', desc: 'å°åœ°çš„å®¶è‡£é€æ¥äº†ä»Šå¹´çš„ç¨æ”¶ï¼Œæœ‰ä¸ç»¸ã€ç²®é£Ÿå’Œå°‘è®¸é“œå¸ã€‚', rewardType: 'gold', rewardValue: 15, title: 'é‡‡é‚‘çº³è´¡' },
            { id: 'era3_r_alliance', type: 'repeat', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¿', desc: 'éšå›½å›å‚åŠ ç›Ÿä¼šï¼Œå„å›½ä½¿èŠ‚æ­ƒè¡€ä¸ºç›Ÿï¼Œçº¦å®šäº’ä¸ä¾µçŠ¯ã€‚', rewardType: 'xp', rewardValue: 60, title: 'è¯¸ä¾¯ä¼šç›Ÿ' },
            { id: 'era3_r_reading', type: 'repeat', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å£«', desc: 'æ¸…æ™¨ï¼Œä½ å¤§å£°æœ—è¯µã€Šå°šä¹¦ã€‹ï¼Œç…ç…ä¹¦å£°å¼•æ¥äº†è·¯äººçš„é©»è¶³è†å¬ã€‚', rewardType: 'xp', rewardValue: 30, title: 'è¯µè¯»ç»å…¸' },
            { id: 'era3_r_pot', type: 'repeat', era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', minLevelName: 'å¥´', desc: 'å®´å¸­é—´ï¼Œå¤§å®¶ç©èµ·äº†æŠ•å£¶åŠ©å…´ã€‚ä½ æ‰‹æ„Ÿæä½³ï¼Œè¿ä¸­ä¸‰å…ƒï¼Œèµ¢å¾—äº†æ»¡å ‚å½©ï¼', rewardType: 'gold', rewardValue: 10, title: 'æŠ•å£¶æ¸¸æˆ' },

            // --- ç¬¬å››çºªå…ƒï¼šå”Â·ç™»ç§‘ä¹‹è·¯ ---
            { id: 'era4_u_printing', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ç™½èº«', desc: 'ä½ åœ¨ä¹¦è‚†çœ‹åˆ°ä¸€ç§æ–°å¼å°ä¹¦æ³•ï¼Œä¹¦ç±å˜å¾—ä¾¿å®œäº†ï¼Œä½ ä¹°äº†ä¸€æœ¬ã€Šé‡‘åˆšç»ã€‹ç ”è¯»ã€‚', rewardType: 'xp', rewardValue: 80, title: 'é›•ç‰ˆå°åˆ·' },
            { id: 'era4_u_tea', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ç§€æ‰', desc: 'åœ¨èŒ¶é¦†å¶é‡ä¸€ä½ç»“å·´è€è€…ç…®èŒ¶ï¼Œå“å°ååªè§‰ä¸¤è…‹ä¹ ä¹ æ¸…é£ç”Ÿï¼Œæ–¹çŸ¥æ˜¯é™†ç¾½ã€‚', rewardType: 'gold', rewardValue: 10, title: 'èŒ¶åœ£é™†ç¾½' },
            { id: 'era4_u_music', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'è¿›å£«', desc: 'çš‡å®«ä¼ å‡ºç„å®—æ–°åˆ¶çš„ä¹æ›²ï¼Œæ›²è°ƒå®›å¦‚å¤©ç±ï¼Œä½ åœ¨å¢™å¤–å¬å¾—å¦‚ç—´å¦‚é†‰ã€‚', rewardType: 'xp', rewardValue: 100, title: 'éœ“è£³ç¾½è¡£æ›²' },
            { id: 'era4_u_lidu', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'è¿›å£«', desc: 'åœ¨æ´›é˜³é…’æ¥¼ï¼Œä½ æœ‰å¹¸ç›®ç¹äº†æç™½ä¸æœç”«çš„ä¼šé¢ï¼Œè¿™æ˜¯ä¸­å›½è¯—å›æœ€ä¼Ÿå¤§çš„æ—¶åˆ»ï¼', rewardType: 'xp', rewardValue: 200, title: 'ææœç›¸é€¢' },
            { id: 'era4_u_envoy', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'æ ¡ä¹¦éƒ', desc: 'ä¸€ä½æ—¥æœ¬ç•™å­¦ç”Ÿé˜¿å€ä»²éº»å•å‘ä½ è¯·æ•™æ±‰å­—ä¹¦æ³•ï¼Œä½ è€å¿ƒæŒ‡ç‚¹ã€‚', rewardType: 'xp', rewardValue: 50, title: 'é£å”ä½¿æ¥è®¿' },
            { id: 'era4_u_silkroad', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'å‘˜å¤–éƒ', desc: 'è¥¿åŸŸçš„é©¼é˜Ÿå¸¦æ¥äº†é¦™æ–™å’Œå®çŸ³ï¼Œä½ ç”¨ç²¾ç¾çš„ä¸ç»¸æ¢å–äº†ä¸€å—å’Œç”°ç‰ã€‚', rewardType: 'gold', rewardValue: 30, title: 'ä¸ç»¸ä¹‹è·¯' },
            { id: 'era4_u_zhenguan', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ä¾éƒ', desc: 'æŸ¥çœ‹æˆ·éƒ¨è´¦å†Œï¼Œå‘ç°ä»Šå¹´äººå£å¢é•¿è¿…é€Ÿï¼Œå¤œä¸é—­æˆ·ï¼ŒçœŸä¹ƒç››ä¸–ï¼', rewardType: 'xp', rewardValue: 150, title: 'è´è§‚ä¹‹æ²»' },
            { id: 'era4_u_calligraphy', type: 'unique', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ä¾éƒ', desc: 'ä½ çš„ä¹¦æ³•æ—¥æ¸ç²¾è¿›ï¼Œç”šè‡³å¾—åˆ°äº†é¢œçœŸå¿å¤§äººçš„æŒ‡ç‚¹ï¼Œç¬”åŠ›åˆšåŠ²ã€‚', rewardType: 'gold', rewardValue: 20, title: 'é¢œç­‹æŸ³éª¨' },
            { id: 'era4_r_drink', type: 'repeat', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'è¿›å£«', desc: 'æ˜¥é£å¾—æ„é©¬è¹„ç–¾ï¼Œä½ ä¸åŒçª—åœ¨æ›²æ±Ÿæ± ç•”é¥®é…’èµ‹è¯—ï¼Œå¥½ä¸å¿«æ´»ã€‚', rewardType: 'gold', rewardValue: 15, title: 'æ›²æ±Ÿæµé¥®' },
            { id: 'era4_r_market', type: 'repeat', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ç™½èº«', desc: 'ä¸Šå…ƒèŠ‚å–æ¶ˆå®µç¦ï¼Œé•¿å®‰åŸç¯ç«å¦‚æ˜¼ï¼Œä½ çŒœä¸­äº†ç¯è°œï¼Œèµ¢å¾—äº†å½©å¤´ã€‚', rewardType: 'gold', rewardValue: 10, title: 'é•¿å®‰å¤œå¸‚' },
            { id: 'era4_r_court', type: 'repeat', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'å‘˜å¤–éƒ', desc: 'å¤©è¿˜æ²¡äº®å°±èµ·åºŠä¸Šæœï¼Œè™½è¾›è‹¦ï¼Œä½†æƒ³åˆ°èƒ½ä¸ºå›½åˆ†å¿§ï¼Œé¡¿æ—¶ç²¾ç¥ç™¾å€ã€‚', rewardType: 'xp', rewardValue: 80, title: 'å‹¤æ”¿æ®¿æ—©æœ' },
            { id: 'era4_r_letter', type: 'repeat', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ç™½èº«', desc: 'å®¶ä¹¡çš„ä¿¡ä½¿åˆ°äº†ï¼Œå¸¦æ¥äº†ä¸€å°å®¶ä¹¦å’Œä¸€åŒ…ç‰¹äº§ï¼Œè®©ä½ å€æ„Ÿæ¸©æš–ã€‚', rewardType: 'xp', rewardValue: 10, title: 'é©¿ç«™ä¼ ä¹¦' },
            { id: 'era4_r_polo', type: 'repeat', era: 'å”Â·ç™»ç§‘ä¹‹è·¯', minLevelName: 'ç™½èº«', desc: 'çš‡å®¤åœ¨çƒåœºä¸¾åŠé©¬çƒæ¯”èµ›ï¼Œéªé©¬é£é©°ï¼Œå°˜åœŸé£æ‰¬ï¼Œçœ‹å¾—ä½ çƒ­è¡€æ²¸è…¾ï¼', rewardType: 'gold', rewardValue: 15, title: 'è§‚æ‘©é©¬çƒ' },
        ];

        // --- ç­‰çº§ç³»ç»Ÿå®šä¹‰ ---
        const LEVELS = [
            // ç¬¬ä¸€çºªå…ƒï¼šè¿œå¤ä¹‹è·¯
            { level: 1, name: 'èŒèŠ½ä¹‹è¯†', xp: 0, era: 'è¿œå¤ä¹‹è·¯', desc: 'ç”Ÿå‘½çš„æœ€åˆå½¢æ€ï¼Œæ‹¥æœ‰æ— é™æ½œèƒ½ã€‚' },
            { level: 2, name: 'èƒ½äºº', xp: 100, era: 'è¿œå¤ä¹‹è·¯', desc: 'å­¦ä¼šäº†ä½¿ç”¨å·¥å…·ï¼Œè¿ˆå‡ºäº†è¿›åŒ–çš„ä¸€å¤§æ­¥ã€‚' },
            { level: 3, name: 'ç›´ç«‹äºº', xp: 500, era: 'è¿œå¤ä¹‹è·¯', desc: 'ç›´ç«‹è¡Œèµ°ï¼Œæ¢ç´¢æ›´å¹¿é˜”çš„ä¸–ç•Œï¼ŒæŒæ¡äº†ç«ã€‚' },
            { level: 4, name: 'æ™ºäºº', xp: 1000, era: 'è¿œå¤ä¹‹è·¯', desc: 'å¤§è„‘é«˜åº¦å‘è¾¾ï¼Œèƒ½å¤Ÿè¿›è¡Œå¤æ‚çš„æ€è€ƒã€‚' },
            // ç¬¬äºŒçºªå…ƒï¼šæ–‡æ˜åˆæ›™
            { level: 5, name: 'éƒ¨è½æ°‘', xp: 2000, era: 'æ–‡æ˜åˆæ›™', desc: 'èå…¥é›†ä½“ï¼Œæˆä¸ºæ—©æœŸç¤¾ä¼šçš„ä¸€å‘˜ã€‚' },
            { level: 6, name: 'æ°æ—é•¿', xp: 3000, era: 'æ–‡æ˜åˆæ›™', desc: 'å› æ™ºæ…§å’Œèƒ½åŠ›è¢«æ¨ä¸¾ä¸ºé¢†è¢–ï¼Œç®¡ç†æ—å†…äº‹åŠ¡ã€‚' },
            { level: 7, name: 'å¤§é…‹é•¿', xp: 5000, era: 'æ–‡æ˜åˆæ›™', desc: 'éƒ¨è½è”ç›Ÿçš„æœ€é«˜é¦–é¢†ï¼Œå¸¦é¢†äººæ°‘èµ°å‘ç»Ÿä¸€ã€‚' },
            // ç¬¬ä¸‰çºªå…ƒï¼šå‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹
            { level: 8, name: 'å¥´', xp: 7000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'ç¤¾ä¼šçš„æœ€åº•å±‚ï¼Œä½†ä¹Ÿæ˜¯ä¸€åˆ‡æ”¹å˜çš„èµ·ç‚¹ã€‚' },
            { level: 9, name: 'é‡äºº', xp: 10000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'æ‘†è„±äº†å¥´ç±ï¼Œæˆä¸ºåœ¨å›½éƒ½ä¹‹å¤–è€•ä½œçš„åŠ³åŠ¨è€…ã€‚' },
            { level: 10, name: 'å›½äºº', xp: 15000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'å±…ä½åœ¨éƒ½åŸï¼Œæ‹¥æœ‰å‚ä¸é›†ä¼šã€æœå…µå½¹çš„æƒåˆ©ã€‚' },
            { level: 11, name: 'å£«', xp: 20000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'è·»èº«è´µæ—é˜¶å±‚ï¼Œå­¦ä¹ å…­è‰ºï¼Œæ–‡æ­¦åŒå…¨ã€‚' },
            { level: 12, name: 'å¤§å¤«', xp: 26000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'æ‹¥æœ‰é‡‡é‚‘çš„ä¸–è¢­è´µæ—ï¼Œå›½å®¶çš„ä¸­åšåŠ›é‡ã€‚' },
            { level: 13, name: 'å¿', xp: 35000, era: 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', desc: 'è¾…ä½å›½å›å¤„ç†å›½å®¶å¤§äº‹çš„æœ€é«˜æ‰§æ”¿å®˜ã€‚' },
            // ç¬¬å››çºªå…ƒï¼šå”Â·ç™»ç§‘ä¹‹è·¯
            { level: 14, name: 'ç™½èº«', xp: 45000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'æ²¡æœ‰å®˜èŒçš„æ™®é€šäººï¼Œå¿ƒä¸­ç‡ƒèµ·ç™»ç§‘çš„æ¢¦æƒ³ã€‚' },
            { level: 15, name: 'ç§€æ‰', xp: 55000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'é€šè¿‡å·åºœè§£è¯•ï¼Œè·å¾—å‰å¾€äº¬åŸè€ƒè¯•çš„èµ„æ ¼ã€‚' },
            { level: 16, name: 'è¿›å£«', xp: 65000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'åŠç¬¬ç™»ç§‘ï¼Œå¤©å­é—¨ç”Ÿï¼Œæ— ä¸Šçš„è£è€€ã€‚' },
            { level: 17, name: 'æ ¡ä¹¦éƒ', xp: 75000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'åœ¨å¼˜æ–‡é¦†æ ¡å‹˜å…¸ç±ï¼Œä»•é€”çš„æ¸…è´µèµ·ç‚¹ã€‚' },
            { level: 18, name: 'å‘˜å¤–éƒ', xp: 85000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'å°šä¹¦å…­éƒ¨å„å¸å‰¯é•¿å®˜ï¼Œå¤„ç†å…·ä½“å›½å®¶æ”¿åŠ¡ã€‚' },
            { level: 19, name: 'ä¾éƒ', xp: 95000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'å…­éƒ¨å‰¯é•¿å®˜ï¼Œå®˜å±…ä¸‰å“ï¼Œå½±å“å›½å®¶æ”¿ç­–ã€‚' },
            { level: 20, name: 'å®°ç›¸', xp: 100000, era: 'å”Â·ç™»ç§‘ä¹‹è·¯', desc: 'ä½æäººè‡£ï¼Œè¾…ä½çš‡å¸ï¼Œä¸€äººä¹‹ä¸‹ä¸‡äººä¹‹ä¸Šã€‚' },
        ];
        
        // çºªå…ƒæè¿°
        const ERA_INFOS = {
            'è¿œå¤ä¹‹è·¯': { desc: 'ä»æ‡µæ‡‚çš„ç”Ÿå‘½åˆ°æ™ºæ…§çš„è§‰é†’ï¼Œæ¢ç´¢äººç±»èµ·æºçš„å¥¥ç§˜ã€‚', color: 'text-stone-600', bg: 'bg-stone-50', border: 'border-stone-200', textGradient: 'from-stone-500 to-stone-700' },
            'æ–‡æ˜åˆæ›™': { desc: 'ä»éƒ¨è½ç”Ÿæ´»åˆ°æ—©æœŸå›½å®¶å½¢æ€çš„æ¼”å˜ï¼Œè§è¯æ–‡æ˜çš„ç«ç§ã€‚', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', textGradient: 'from-orange-500 to-red-600' },
            'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹': { desc: 'è¿›å…¥å‘¨æœæ£®ä¸¥çš„å®—æ³•å¥´éš¶åˆ¶ç¤¾ä¼šï¼Œä½“éªŒä¸åŒé˜¶å±‚çš„èº«ä»½ã€‚', color: 'text-emerald-700', bg: 'bg-emerald-50', border: 'border-emerald-200', textGradient: 'from-emerald-600 to-teal-700' },
            'å”Â·ç™»ç§‘ä¹‹è·¯': { desc: 'åŒ–èº«å”æœä¸€ä»‹å¸ƒè¡£ï¼Œé€šè¿‡ç§‘ä¸¾è€ƒè¯•ï¼Œä¸€æ­¥æ­¥è¸å…¥æƒåŠ›ä¸­å¿ƒã€‚', color: 'text-purple-700', bg: 'bg-purple-50', border: 'border-purple-200', textGradient: 'from-purple-600 to-indigo-700' },
        };

        const ERA_COLORS = {
            'è¿œå¤ä¹‹è·¯': { bg: 'bg-stone-600', text: 'text-stone-100', border: 'border-stone-500', bar: 'bg-stone-500' },
            'æ–‡æ˜åˆæ›™': { bg: 'bg-orange-600', text: 'text-orange-100', border: 'border-orange-500', bar: 'bg-orange-500' },
            'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹': { bg: 'bg-emerald-700', text: 'text-emerald-100', border: 'border-emerald-600', bar: 'bg-emerald-600' },
            'å”Â·ç™»ç§‘ä¹‹è·¯': { bg: 'bg-purple-700', text: 'text-purple-100', border: 'border-purple-600', bar: 'bg-purple-600' },
        };

        // --- å¾½ç« å®šä¹‰ ---
        const BADGES = [
            // è£è€€ä¹‹è·¯
            { id: 'bronze_collector', name: 'é’é“œæ”¶è—å®¶', desc: 'ä½ çš„æ”¶è—ä¹‹æ—…å·²ç»æœ‰äº†å®Œç¾çš„å¼€ç«¯ï¼', rarity: 'rare', category: 'è£è€€' },
            { id: 'silver_master', name: 'ç™½é“¶å¤§å¸ˆ', desc: 'ç¨€æœ‰çš„å…‰èŠ’ï¼Œå› ä½ çš„åŠªåŠ›è€Œæ±‡é›†ã€‚', rarity: 'epic', category: 'è£è€€' },
            { id: 'golden_legend', name: 'é»„é‡‘ä¼ è¯´', desc: 'ä½ æ­£åœ¨ä¹¦å†™å±äºè‡ªå·±çš„é»„é‡‘ç¯‡ç« ï¼', rarity: 'legendary', category: 'è£è€€' },
            { id: 'perseverance_incarnate', name: 'æ¯…åŠ›åŒ–èº«', desc: 'åšæŒï¼Œæ˜¯ä½ æœ€å¼ºå¤§çš„è¶…èƒ½åŠ›ã€‚', rarity: 'epic', category: 'è£è€€' },
            { id: 'era_pioneer', name: 'æ—¶ä»£é¢†èˆªè€…', desc: 'æˆåŠŸè¿›åŒ–åˆ°ç¬¬å››çºªå…ƒâ€œå”Â·ç™»ç§‘ä¹‹è·¯â€', rarity: 'epic', category: 'è£è€€' },
            { id: 'grandmaster', name: 'å…¨èƒ½å®—å¸ˆ', desc: 'é›†é½â€œç²¾é€šâ€ç³»åˆ—çš„æ‰€æœ‰å¾½ç« ', rarity: 'legendary', category: 'è£è€€' },
            // æ¯…åŠ›ä¹‹å¿ƒ
            { id: 'first_blood', name: 'åˆè¯•é”‹èŠ’', desc: 'é¦–æ¬¡å®Œæˆä»»æ„ä¸€æ¬¡æ‰“å¡', rarity: 'common', category: 'æ¯…åŠ›' },
            { id: 'persistence', name: 'æŒä¹‹ä»¥æ’', desc: 'è¿ç»­7å¤©éƒ½æœ‰æ‰“å¡è®°å½•', rarity: 'rare', category: 'æ¯…åŠ›' },
            { id: 'iron_will', name: 'é’¢é“æ„å¿—', desc: 'è¿ç»­14å¤©éƒ½æœ‰æ‰“å¡è®°å½•', rarity: 'epic', category: 'æ¯…åŠ›' },
            { id: 'marathon', name: 'å‡æœŸé©¬æ‹‰æ¾', desc: 'æ•´ä¸ªå¯’å‡å…¨å‹¤æ‰“å¡', rarity: 'legendary', category: 'æ¯…åŠ›' },
            { id: 'perfect_10', name: 'åå…¨åç¾', desc: 'ç´¯è®¡å®Œæˆ10æ¬¡æ‰“å¡', rarity: 'common', category: 'æ¯…åŠ›' },
            { id: 'steeled', name: 'ç™¾ç‚¼æˆé’¢', desc: 'ç´¯è®¡å®Œæˆ100æ¬¡æ‰“å¡', rarity: 'rare', category: 'æ¯…åŠ›' },
            { id: 'weekend_warrior', name: 'å‘¨æœ«æˆ˜å£«', desc: 'è¿ç»­ä¸¤ä¸ªå‘¨æœ«éƒ½æœ‰æ‰“å¡è®°å½•', rarity: 'rare', category: 'æ¯…åŠ›' },
			{ id: 'dawn_knight', name: 'é»æ˜éª‘å£«', desc: 'åœ¨æ—©ä¸Š7:00å‰å®Œæˆä»»æ„ä¸€æ¬¡æ‰“å¡', rarity: 'epic', category: 'æ¯…åŠ›' },
            { id: 'repair_master', name: 'è¡¥æ•‘å¤§å¸ˆ', desc: 'ç´¯è®¡ä½¿ç”¨â€œæ™®ç½—ç±³ä¿®æ–¯ä¹‹ç«â€5æ¬¡', rarity: 'rare', category: 'æ¯…åŠ›' },
            { id: 'accumulation', name: 'ç§¯å°‘æˆå¤š', desc: 'ç´¯è®¡å®Œæˆ300æ¬¡æ‰“å¡', rarity: 'epic', category: 'æ¯…åŠ›' },
            { id: 'return_king', name: 'ç‹è€…å½’æ¥', desc: 'ä¸­æ–­æ‰“å¡3å¤©ä»¥ä¸Šåé‡æ–°æ‰“å¡', rarity: 'rare', category: 'æ¯…åŠ›' },
            // æ•ˆç‡ä¹‹æ˜Ÿ
            { id: 'early_bird', name: 'æ—©èµ·çš„é¸Ÿå„¿', desc: 'è¿ç»­3å¤©åœ¨ä¸Šåˆ9:00å‰å®Œæˆæ‰“å¡', rarity: 'rare', category: 'æ•ˆç‡' },
            { id: 'lightning', name: 'é—ªç”µå¿«æ‰‹', desc: 'æå‰3å¤©å®ŒæˆæŸé¡¹ä»»åŠ¡ç›®æ ‡', rarity: 'rare', category: 'æ•ˆç‡' },
            { id: 'daily_done', name: 'ä»Šæ—¥äº‹ä»Šæ—¥æ¯•', desc: 'ä¸€å¤©å†…å®Œæˆè½¬ç›˜æ‰€éœ€ä»»åŠ¡', rarity: 'epic', category: 'æ•ˆç‡' },
            // ç²¾é€šä¹‹è·¯
            { id: 'accomplished', name: 'å­¦æœ‰æ‰€æˆ', desc: 'å•é¡¹ä»»åŠ¡ç›®æ ‡å®Œæˆç‡100%', rarity: 'epic', category: 'ç²¾é€š' },
			{ id: 'chinese_master', name: 'è¯­æ–‡å¤§å¸ˆ', desc: 'ç´¯è®¡å®Œæˆè¯­æ–‡ç›¸å…³ä»»åŠ¡20æ¬¡', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'literary_giant', name: 'æ–‡å­¦å·¨åŒ ', desc: 'ç´¯è®¡å®Œæˆè¯­æ–‡ç›¸å…³ä»»åŠ¡50æ¬¡', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'literary_grandmaster', name: 'æ–‡å›å®—å¸ˆ', desc: 'ç´¯è®¡å®Œæˆè¯­æ–‡ç›¸å…³ä»»åŠ¡100æ¬¡', rarity: 'legendary', category: 'ç²¾é€š' },
			{ id: 'math_whiz', name: 'æ•°å­¦å°èƒ½æ‰‹', desc: 'ç´¯è®¡å®Œæˆæ•°å­¦ç›¸å…³ä»»åŠ¡20æ¬¡', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'logic_master', name: 'é€»è¾‘å¤§å¸ˆ', desc: 'ç´¯è®¡å®Œæˆæ•°å­¦ç›¸å…³ä»»åŠ¡50æ¬¡', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'math_god', name: 'æ•°ç†ä¹‹ç¥', desc: 'ç´¯è®¡å®Œæˆæ•°å­¦ç›¸å…³ä»»åŠ¡100æ¬¡', rarity: 'legendary', category: 'ç²¾é€š' },
            { id: 'english_ace', name: 'è‹±è¯­ä¼˜ç­‰ç”Ÿ', desc: 'ç´¯è®¡å®Œæˆè‹±è¯­ç›¸å…³ä»»åŠ¡20æ¬¡', rarity: 'rare', category: 'ç²¾é€š' },
			{ id: 'translation_master', name: 'ç¿»è¯‘å¤§å¸ˆ', desc: 'ç´¯è®¡å®Œæˆè‹±è¯­ç›¸å…³ä»»åŠ¡50æ¬¡', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'language_lord', name: 'è¯­è¨€é¢†ä¸»', desc: 'ç´¯è®¡å®Œæˆè‹±è¯­ç›¸å…³ä»»åŠ¡100æ¬¡', rarity: 'legendary', category: 'ç²¾é€š' },
			{ id: 'science_star', name: 'ç§‘å­¦æ–°æ˜Ÿ', desc: 'ç´¯è®¡å®Œæˆç§‘å­¦ç›¸å…³ä»»åŠ¡20æ¬¡', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'future_inventor', name: 'æœªæ¥å‘æ˜å®¶', desc: 'ç´¯è®¡å®Œæˆç§‘å­¦ç›¸å…³ä»»åŠ¡50æ¬¡', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'science_titan', name: 'ç§‘å­¦æ³°æ–—', desc: 'ç´¯è®¡å®Œæˆç§‘å­¦ç›¸å…³ä»»åŠ¡100æ¬¡', rarity: 'legendary', category: 'ç²¾é€š' },
            { id: 'artist', name: 'éŸ³ä¹è‰ºæœ¯å®¶', desc: 'ç´¯è®¡å®Œæˆçµç¶ä»»åŠ¡80%', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'all_rounder', name: 'å¤šé¢æ‰‹', desc: 'ä¸€å‘¨å†…åœ¨3ä¸ªä¸åŒä»»åŠ¡ä¸Šå„å®Œæˆ5æ¬¡æ‰“å¡', rarity: 'rare', category: 'ç²¾é€š' },
			{ id: 'polymath', name: 'åšè§ˆç¾¤ä¹¦', desc: 'ç´¯è®¡å®Œæˆè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ä¸‰é—¨ä¸»ç§‘ä»»åŠ¡å„50æ¬¡', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'six_arms', name: 'ä¸‰å¤´å…­è‡‚', desc: 'ä¸€å¤©ä¹‹å†…å®Œæˆ10é¡¹æˆ–ä»¥ä¸Šä¸åŒçš„ä»»åŠ¡', rarity: 'legendary', category: 'ç²¾é€š' },
            // è´¢å¯Œä¹‹æ—…
            { id: 'first_pot', name: 'ç¬¬ä¸€æ¡¶é‡‘', desc: 'ç´¯è®¡è·å¾—100é‡‘å…ƒå®', rarity: 'common', category: 'è´¢å¯Œ' },
            { id: 'tycoon', name: 'å°å¯Œç¿', desc: 'ç´¯è®¡è·å¾—1000é‡‘å…ƒå®', rarity: 'rare', category: 'è´¢å¯Œ' },
            { id: 'wealthy', name: 'è´¢æºæ»šæ»š', desc: 'ç´¯è®¡è·å¾—5000é‡‘å…ƒå®', rarity: 'epic', category: 'è´¢å¯Œ' },
			{ id: 'overnight_rich', name: 'ä¸€å¤œæš´å¯Œ', desc: 'å•æ—¥ç´¯è®¡è·å¾—è¶…è¿‡100é‡‘å…ƒå®', rarity: 'epic', category: 'è´¢å¯Œ' },
            { id: 'big_spender', name: 'æŒ¥é‡‘å¦‚åœŸ', desc: 'ç´¯è®¡æ¶ˆè´¹è¶…è¿‡500é‡‘å…ƒå®', rarity: 'common', category: 'è´¢å¯Œ' },
			{ id: 'money_bags', name: 'æ•£è´¢ç«¥å­', desc: 'ç´¯è®¡æ¶ˆè´¹è¶…è¿‡ 2000 å…ƒå®', rarity: 'rare', category: 'è´¢å¯Œ' },			
			{ id: 'whale_player', name: 'æ°ªé‡‘ç©å®¶', desc: 'ç´¯è®¡æ¶ˆè´¹è¶…è¿‡ 5000 å…ƒå®', rarity: 'epic', category: 'è´¢å¯Œ' },
            { id: 'market_owner', name: 'å¯Œå¯æ•Œå›½', desc: 'ç´¯è®¡æ¶ˆè´¹è¶…è¿‡ 10000 å…ƒå®', rarity: 'legendary', category: 'è´¢å¯Œ' },
            { id: 'shopaholic', name: 'è´­ç‰©ç‹‚', desc: 'åœ¨å¸‚é›†æ¶ˆè´¹æˆ–æŠ½å¥–ç´¯è®¡ 10 æ¬¡', rarity: 'common', category: 'è´¢å¯Œ' },
			{ id: 'hand_chopper', name: 'å‰æ‰‹å…š', desc: 'åœ¨å¸‚é›†æ¶ˆè´¹æˆ–æŠ½å¥–ç´¯è®¡ 50 æ¬¡', rarity: 'rare',category: 'è´¢å¯Œ' },
            { id: 'cart_clearer', name: 'æ¸…ç©ºè´­ç‰©è½¦', desc: 'åœ¨å¸‚é›†æ¶ˆè´¹æˆ–æŠ½å¥–ç´¯è®¡ 100 æ¬¡', rarity: 'legendary',category: 'è´¢å¯Œ' },			
            { id: 'high_roller', name: 'ä¸€æ·åƒé‡‘', desc: 'å•æ¬¡æ¶ˆè´¹(æˆ–æ‰£æ¬¾)è¶…è¿‡ 100 å…ƒå®', rarity: 'common', category: 'è´¢å¯Œ' },
			{ id: 'diamond_hands', name: 'é’»çŸ³æ‰‹', desc: 'å•æ¬¡æ¶ˆè´¹è¶…è¿‡ 300 å…ƒå®', rarity: 'rare',category: 'è´¢å¯Œ' },
            { id: 'bankruptcy', name: 'å€¾å®¶è¡äº§', desc: 'å•æ¬¡æ¶ˆè´¹è¶…è¿‡ 800 å…ƒå®', rarity: 'epic',category: 'è´¢å¯Œ' },			
            { id: 'investment_guru', name: 'æŠ•èµ„è¾¾äºº', desc: 'æˆåŠŸä½¿ç”¨â€œæŠ•èµ„å¡â€å¹¶è·å¾—è¶…è¿‡500é‡‘å…ƒå®çš„é¢å¤–æ”¶ç›Š', rarity: 'epic', category: 'è´¢å¯Œ' },
            { id: 'midas_touch', name: 'ç‚¹çŸ³æˆé‡‘', desc: 'ä¸ªäººæ‹¥æœ‰çš„é‡‘å…ƒå®æ•°é‡é¦–æ¬¡è¶…è¿‡2000', rarity: 'legendary', category: 'è´¢å¯Œ' },
            { id: 'lucky_star', name: 'å¹¸è¿ä¹‹æ˜Ÿ', desc: 'æŠ½ä¸­å¤§è½¬ç›˜æœ€é«˜å¥–åŠ±', rarity: 'epic', category: 'è´¢å¯Œ' },
            // æ¢ç´¢ä¹‹å…‰
            { id: 'curious', name: 'å¥½å¥‡å®å®', desc: 'å°è¯•æ¢ç´¢è®¾ç½®é¡µé¢', rarity: 'common', category: 'æ¢ç´¢' },
            { id: 'midnight', name: 'åˆå¤œæ´¾å¯¹', desc: 'æ™šä¸Š23:55åå®Œæˆæ‰“å¡', rarity: 'legendary', category: 'æ¢ç´¢' },
            { id: 'collector', name: 'ä¸»é¢˜æ”¶è—å®¶', desc: 'ä½“éªŒè¿‡æ‰€æœ‰é¢œè‰²ä¸»é¢˜', rarity: 'rare', category: 'æ¢ç´¢' },
            { id: 'archaeologist', name: 'è€ƒå¤å­¦å®¶', desc: 'åœ¨å¯’å‡ç¬¬ä¸€å¤©å®Œæˆæ‰“å¡', rarity: 'rare', category: 'æ¢ç´¢' },
            { id: 'deadline_master', name: 'å‹çº¿å¤§å¸ˆ', desc: 'æˆªæ­¢å‰5åˆ†é’Ÿå†…å®Œæˆä»»åŠ¡è§¦å‘è½¬ç›˜', rarity: 'legendary', category: 'æ¢ç´¢' },
            { id: 'gemini', name: 'åŒå­æ˜Ÿ', desc: 'ä¸¤äººåŒæ—¥è§£é”åŒä¸ªé«˜çº§å¾½ç« ', rarity: 'epic', category: 'æ¢ç´¢' },
            { id: 'indecisive', name: 'é€‰æ‹©å›°éš¾ç—‡', desc: 'æ‰“å¼€ä¸»é¢˜åˆ‡æ¢é¢æ¿ä½†æœªæ›´æ¢', rarity: 'common', category: 'æ¢ç´¢' },
			// --- ã€æ–°å¢ã€‘å¥¥æ•°æ€ç»´å¤©æ¢¯ç³»åˆ— (Math Olympiad) ---
            // ç¬¬ä¸€é˜¶æ®µï¼šå¯è’™ (1-4å­¦æœŸ)
            { id: 'mo_1_1', name: 'æ€ç»´å°ç«èŠ±', desc: 'å®Œæˆå¥¥æ•°ç¬¬1å­¦æœŸï¼šé»‘æš—ä¸­æ“¦äº®ç¬¬ä¸€æ ¹ç«æŸ´ï¼Œå‘ç°æ•°å­¦ä¹‹è¶£ã€‚', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'mo_1_2', name: 'æ•°è¶£æ¢ç´¢è€…', desc: 'å®Œæˆå¥¥æ•°ç¬¬2å­¦æœŸï¼šåœ¨æ•°å­—æµ·æ´‹æ¡æ‹¾è´å£³ï¼Œéš¾é¢˜çš†æ˜¯æƒŠå–œã€‚', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'mo_2_1', name: 'é€»è¾‘å°ä¾¦æ¢', desc: 'å®Œæˆå¥¥æ•°ç¬¬3å­¦æœŸï¼šåƒä¾¦æ¢ä¸€æ ·æŠ½ä¸å‰¥èŒ§ï¼Œå¯»æ‰¾çœŸç›¸ã€‚', rarity: 'rare', category: 'ç²¾é€š' },
            { id: 'mo_2_2', name: 'å·§ç®—å°èƒ½æ‰‹', desc: 'å®Œæˆå¥¥æ•°ç¬¬4å­¦æœŸï¼šæŒæ¡æ•°å­—è·³èˆçš„è§„å¾‹ï¼Œè®¡ç®—å˜æˆé­”æ³•ã€‚', rarity: 'rare', category: 'ç²¾é€š' },
            // ç¬¬äºŒé˜¶æ®µï¼šè¿›é˜¶ (5-8å­¦æœŸ)
            { id: 'mo_3_1', name: 'å›¾å½¢æ„é€ å¸ˆ', desc: 'å®Œæˆå¥¥æ•°ç¬¬5å­¦æœŸï¼šçº¿æ¡ä¸é¢ç§¯æœ‰äº†ç”Ÿå‘½ï¼Œå‡ ä½•å¤§é—¨æ•å¼€ã€‚', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'mo_3_2', name: 'è¿·å®«é¢†èˆªå‘˜', desc: 'å®Œæˆå¥¥æ•°ç¬¬6å­¦æœŸï¼šåœ¨é€»è¾‘è¿·å®«ä¸­ï¼Œæ€»èƒ½æ‰¾åˆ°å”¯ä¸€è·¯å¾„ã€‚', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'mo_4_1', name: 'æ•°è®ºæ½œè¡Œè€…', desc: 'å®Œæˆå¥¥æ•°ç¬¬7å­¦æœŸï¼šå¬æ‡‚è´¨æ•°ä¸åˆæ•°ä¹‹é—´éšç§˜çš„çªƒçªƒç§è¯­ã€‚', rarity: 'epic', category: 'ç²¾é€š' },
            { id: 'mo_4_2', name: 'ç ´å£å…ˆé”‹', desc: 'å®Œæˆå¥¥æ•°ç¬¬8å­¦æœŸï¼šé¢å¯¹æ‹¦è·¯è™ï¼Œä¸€æ¬¡æ¬¡æ’ç ´æ€ç»´çš„å¢™å£ã€‚', rarity: 'epic', category: 'ç²¾é€š' },
            // ç¬¬ä¸‰é˜¶æ®µï¼šå·…å³° (9-12å­¦æœŸ)
            { id: 'mo_5_1', name: 'å¥¥èµ›ç²¾è‹±', desc: 'å®Œæˆå¥¥æ•°ç¬¬9å­¦æœŸï¼šä»å­¦ä¹ è€…èœ•å˜ä¸ºç«äº‰è€…ï¼Œå´­éœ²å¤´è§’ã€‚', rarity: 'legendary', category: 'ç²¾é€š' },
            { id: 'mo_5_2', name: 'è§£é¢˜å¤§å®—å¸ˆ', desc: 'å®Œæˆå¥¥æ•°ç¬¬10å­¦æœŸï¼šé€è¿‡ç°è±¡çœ‹æœ¬è´¨å·²æˆä¸ºä½ çš„æœ¬èƒ½ã€‚', rarity: 'legendary', category: 'ç²¾é€š' },
            { id: 'mo_6_1', name: 'æ•°ç†æ™ºè€…', desc: 'å®Œæˆå¥¥æ•°ç¬¬11å­¦æœŸï¼šä¸å†åªæ˜¯è§£é¢˜ï¼Œè€Œæ˜¯æ¬£èµé€»è¾‘çš„ä¼˜ç¾ã€‚', rarity: 'legendary', category: 'ç²¾é€š' },
            { id: 'mo_6_2', name: 'å¥¥æ•°ä¹‹å† ', desc: 'å®Œæˆå¥¥æ•°ç¬¬12å­¦æœŸï¼šç«™åœ¨å°å­¦å¥¥æ•°é¡¶å³°ï¼Œè¿™æ˜¯çœŸç†ä¹‹æµ·çš„èµ·ç‚¹ã€‚', rarity: 'legendary', category: 'ç²¾é€š' },
        ];

		// --- ã€æ–°å¢ã€‘å­¦ä¸šç›®æ ‡é…ç½®æ¡†æ¶ ---
        // è¿™é‡Œçš„ key (å¦‚ math_olympiad) å°†ç”¨äºåç»­æ‰©å±•å…¶ä»–ç§‘ç›®
        const CURRICULUM_CONFIG = {
            math_olympiad: {
                id: 'math_olympiad',
                name: 'å¥¥æ•°æ€ç»´å¤©æ¢¯',
                totalSemesters: 12, // 6å¹´ * 2å­¦æœŸ
                // å®šä¹‰æ¯å­¦æœŸå¯¹åº”çš„å¾½ç« ID
                badges: [
                    'mo_1_1', 'mo_1_2', 'mo_2_1', 'mo_2_2', 
                    'mo_3_1', 'mo_3_2', 'mo_4_1', 'mo_4_2', 
                    'mo_5_1', 'mo_5_2', 'mo_6_1', 'mo_6_2'
                ],
                // è¾…åŠ©å‡½æ•°ï¼šè·å–å­¦æœŸåç§°
                getSemesterName: (index) => {
                    const grade = Math.floor(index / 2) + 1;
                    const term = index % 2 === 0 ? 'ä¸Š' : 'ä¸‹';
                    return `${grade}å¹´çº§${term}å­¦æœŸ`;
                }
            },
            // æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  english_reading: { ... }
        };

        const RARITY_COLORS = {
            common: { bg: 'bg-amber-700', text: 'text-amber-700', name: 'æ™®é€š', badge: 'bg-amber-100 text-amber-700' },
            rare: { bg: 'bg-slate-500', text: 'text-slate-600', name: 'ç¨€æœ‰', badge: 'bg-slate-100 text-slate-600' },
            epic: { bg: 'bg-yellow-500', text: 'text-yellow-600', name: 'å²è¯—', badge: 'bg-yellow-100 text-yellow-700' },
            legendary: { bg: 'bg-purple-600', text: 'text-purple-600', name: 'ä¼ è¯´', badge: 'bg-purple-100 text-purple-700' }
        };

        const DEFAULT_PROFILES = [
            { id: 'Yoly', name: 'Yoly', theme: 'rose', avatar: null },
            { id: 'Henry', name: 'Henry', theme: 'sky', avatar: null }
        ];

        const DEFAULT_TASKS = {
            Yoly: [
                { id: 'y1', name: 'æ•°ç²¾å‡†å­¦', reward: 2, targetCount: 25, completedReward: 50, deadline: '2026-02-25', startDate: '2026-02-01', targetGoal: 'å®Œæˆæ•°å­¦ç²¾å‡†å­¦æŒ‡å®šç« èŠ‚' },
                { id: 'y2', name: 'è‹±ç²¾å‡†å­¦', reward: 2, targetCount: 25, completedReward: 50, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'y3', name: 'ç§‘ç²¾å‡†å­¦', reward: 2, targetCount: 25, completedReward: 50, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'y4', name: 'è¯­æ–‡è¯¾æœ¬é¢„ä¹ ', reward: 3, targetCount: 15, completedReward: 30, deadline: '2026-02-20', startDate: '2026-02-01', targetGoal: 'å®Œæˆä¸€å¹´çº§ä¸‹å­¦æœŸè¯­æ–‡å…¨ä¹¦é¢„ä¹ ' },
                { id: 'y5', name: 'ç™¾è¯æ–©', reward: 1, targetCount: 25, completedReward: 20, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'y6', name: 'èƒŒé»˜è‹±èŒƒæ–‡', reward: 5, targetCount: 10, completedReward: 100, deadline: '2026-02-15', startDate: '2026-02-01' },
                { id: 'y7', name: 'é˜…è¯»ç»ƒä¹ ', reward: 3, targetCount: 20, completedReward: 40, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'y8', name: 'çµç¶', reward: 5, targetCount: 20, completedReward: 100, deadline: '2026-02-25', startDate: '2026-02-01' },
            ],
            Henry: [
                { id: 'h1', name: 'æ•°ç²¾å‡†å­¦ï¼ˆä¸‰ä¸Šï¼‰', reward: 2, targetCount: 25, completedReward: 50, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h2', name: 'åŸ¹ä¼˜Sï¼ˆ1ä¸ªè¯¾æ—¶ï¼‰', reward: 5, targetCount: 15, completedReward: 100, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h3', name: 'åŸ¹ä¼˜Sï¼ˆç¬¬2ä¸ªè¯¾æ—¶ï¼‰', reward: 5, targetCount: 15, completedReward: 100, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h4', name: 'è¯­æ–‡é˜…è¯»é¢˜', reward: 3, targetCount: 20, completedReward: 50, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h5', name: 'è¯­æ–‡ç²¾å‡†å­¦ï¼ˆä¸€ä¸‹ï¼‰', reward: 2, targetCount: 25, completedReward: 40, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h6', name: 'è‹±ç²¾å‡†å­¦ï¼ˆå­¦è€Œæ€ï¼‰', reward: 2, targetCount: 25, completedReward: 40, deadline: '2026-02-25', startDate: '2026-02-01' },
                { id: 'h7', name: 'è‹±å¬åŠ›ç»ƒä¹ ', reward: 1, targetCount: 25, completedReward: 20, deadline: '2026-02-25', startDate: '2026-02-01' },
            ]
        };

        const DEFAULT_WHEEL_CONFIG = [
            { id: 1, name: '5é‡‘å…ƒå®', value: 5, weight: 40, color: '#fb7185' },
            { id: 2, name: '10é‡‘å…ƒå®', value: 10, weight: 30, color: '#facc15' },
            { id: 3, name: '20é‡‘å…ƒå®', value: 20, weight: 15, color: '#38bdf8' },
            { id: 4, name: '50é‡‘å…ƒå®', value: 50, weight: 10, color: '#a78bfa' },
            { id: 5, name: '100é‡‘å…ƒå®', value: 100, weight: 5, color: '#f472b6' }
        ];
        
        const DEFAULT_WHEEL_SETTINGS = { deadlineHour: 18, thresholdType: 'percent', thresholdValue: 100 };

        // é»˜è®¤çš„é‚ªæ¶å¤§è½¬ç›˜é…ç½®
        const DEFAULT_EVIL_WHEEL_CONFIG = [
            { id: 1, name: 'æ‰£é™¤5å…ƒå®', value: -5, weight: 40, color: '#9CA3AF' }, // Gray
            { id: 2, name: 'æ‰£é™¤10å…ƒå®', value: -10, weight: 30, color: '#6B7280' }, // Darker Gray
            { id: 3, name: 'æ‰£é™¤20å…ƒå®', value: -20, weight: 15, color: '#4B5563' }, // Even Darker Gray
            { id: 4, name: 'æ‰£é™¤50å…ƒå®', value: -50, weight: 10, color: '#7F1D1D' }, // Deep Red
            { id: 5, name: 'æ‰£é™¤100å…ƒå®', value: -100, weight: 5, color: '#4C1D95' } // Deep Purple
        ];

		// ç»éªŒå€¼å¤§è½¬ç›˜
        const DEFAULT_XP_WHEEL_CONFIG = [
            { id: 1, name: '20 XP', value: 20, weight: 40, color: '#94a3b8' }, // é’›é“¶ç° (ä½è°ƒçš„åŸºç¡€å¥–åŠ±)
            { id: 2, name: '50 XP', value: 50, weight: 30, color: '#60a5fa' }, // å¤©é’è“ (æ¸…é€çš„è¿›é˜¶å¥–åŠ±)
            { id: 3, name: '100 XP', value: 100, weight: 15, color: '#a78bfa' }, // å¹»å½±ç´« (ç¥ç§˜çš„ç¨€æœ‰å¥–åŠ±)
            { id: 4, name: '200 XP', value: 200, weight: 10, color: '#f472b6' }, // è”·è–‡ç²‰ (åä¸½çš„å²è¯—å¥–åŠ±)
            { id: 5, name: '500 XP', value: 500, weight: 5, color: '#fbbf24' }  // ç¥ç€é‡‘ (è€€çœ¼çš„ä¼ è¯´å¥–åŠ±)
        ];

		// --- æ–°å¢ï¼šé«˜çº§çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆ ---
        const fireRoyalSalute = () => {
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                // 1. é‡‘å¸é›¨æ•ˆæœ (å·¦å³ä¸¤ä¾§å–·å°„)
                confetti(Object.assign({}, defaults, { 
                    particleCount, 
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
                    colors: ['#FFD700', '#FFA500', '#B8860B'], // é‡‘è‰²ç³»
                    shapes: ['circle', 'square']
                }));
                confetti(Object.assign({}, defaults, { 
                    particleCount, 
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
                    colors: ['#E6E6FA', '#9370DB', '#4B0082'], // ç´«è‰²ç³»(çš‡å®¤)
                    shapes: ['circle', 'square']
                }));

                // 2. æ ¸å¿ƒæ˜Ÿæ˜Ÿçˆ†ç‚¸
                if (Math.random() < 0.1) {
                     confetti({
                        particleCount: 30,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: ['#FF4500', '#FFD700'],
                        shapes: ['star'],
                        scalar: 1.5 // æ˜Ÿæ˜Ÿæ”¾å¤§
                     });
                }
            }, 250);
        };

        const getDatesInRange = (startDate, endDate) => {
            const dates = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);
            let count = 0;
            while (currentDate <= stopDate && count < 100) {
                // ã€ä¿®æ”¹ã€‘æ‰‹åŠ¨è·å–æœ¬åœ°å¹´æœˆæ—¥ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
                
                currentDate.setDate(currentDate.getDate() + 1);
                count++;
            }
            return dates;
        };

        const getLevelInfo = (xp) => {
            for (let i = LEVELS.length - 1; i >= 0; i--) {
                if (xp >= LEVELS[i].xp) return LEVELS[i];
            }
            return LEVELS[0];
        };

        const getNextLevelInfo = (level) => {
            return LEVELS.find(l => l.level === level + 1) || null;
        };
        
        // --- è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®çºªå…ƒåˆ†ç»„ ---
        const getLevelsByEra = () => {
            const grouped = {};
            LEVELS.forEach(level => {
                if (!grouped[level.era]) {
                    grouped[level.era] = [];
                }
                grouped[level.era].push(level);
            });
            return grouped;
        };

		// --- ã€æ–°å¢ã€‘é€šç”¨é™æ—¶/èŠ‚æ—¥å•†å“åˆ¤å®šæ¨¡å— ---
        // --- ä¿®æ”¹ checkItemRestriction å‡½æ•° (å¢åŠ  holidayData å‚æ•°)(æ”¯æŒé¢„æµ‹æ•°ç»„) ---
		const checkItemRestriction = (item, holidayForecast) => {
			// 1. æ— é™åˆ¶ç›´æ¥å¼€æ”¾
			if (!item.timeLimit) return { locked: false };

			const now = new Date();
			const year = now.getFullYear();
			const month = String(now.getMonth() + 1).padStart(2, '0');
			const day = String(now.getDate()).padStart(2, '0');
			const today = `${year}-${month}-${day}`;

			// --- API æ™ºèƒ½èŠ‚æ—¥åˆ¤å®š (æ”¯æŒæå‰2å¤©) ---
			if (item.timeLimit.type === 'api_holiday') {
				// æ£€æŸ¥é¢„æµ‹æ•°æ®æ˜¯å¦å­˜åœ¨
				if (holidayForecast && holidayForecast.length > 0) {
					// éå†æœªæ¥3å¤©çš„æ•°æ®ï¼Œåªè¦æœ‰ä¸€å¤©ç¬¦åˆæ¡ä»¶å³å¯è§£é”
					const isUpcomingHoliday = holidayForecast.some(data => {
						// å¿…é¡»æ˜¯çœŸæ­£çš„èŠ‚å‡æ—¥ (type=2 æˆ– holiday=true)ï¼Œæ’é™¤è°ƒä¼‘ (type=3)
						// æ ¹æ® API æ–‡æ¡£ï¼šholiday.holiday = true è¡¨ç¤ºæ˜¯èŠ‚æ—¥
						if (data.holiday && data.holiday.holiday === true) {
							const name = data.holiday.name;
							const target = data.holiday.target || name; // å¤„ç†å¯èƒ½çš„ç›®æ ‡èŠ‚æ—¥å­—æ®µ
							
							// æ£€æŸ¥èŠ‚æ—¥åç§°æ˜¯å¦åœ¨å•†å“çš„å…è®¸åˆ—è¡¨ä¸­
							return item.timeLimit.holidayNames.some(allowedName => target.includes(allowedName));
						}
						return false;
					});

					if (isUpcomingHoliday) {
						return { locked: false };
					}
				}

				// ä¿åº•æœºåˆ¶ï¼šAPI æŒ‚äº†æˆ–æœªåˆ°æ—¶é—´ï¼Œæ£€æŸ¥å›ºå®šæ—¥æœŸèŒƒå›´
				if (item.timeLimit.fallbackStart) {
					if (today >= item.timeLimit.fallbackStart && today <= item.timeLimit.fallbackEnd) {
						return { locked: false };
					}
				}

				return { locked: true, reason: item.timeLimit.msg || 'èŠ‚æ—¥ä¸´è¿‘æ—¶å¼€å¯' };
			}
            // 3. (å¯é€‰) æœªæ¥å¯æ‰©å±•ï¼šæ¯”å¦‚ type: 'weekend_only' (ä»…å‘¨æœ«å¯ä¹°)
            // if (item.timeLimit.type === 'weekend_only') {
            //     const dayOfWeek = now.getDay();
            //     if (dayOfWeek === 0 || dayOfWeek === 6) return { locked: false };
            //     return { locked: true, reason: 'å‘¨æœ«é™å®š' };
            // }

            return { locked: false };
        };

        // --- å­ç»„ä»¶ ---

        // å•†åº—æ¨¡æ€æ¡†ç»„ä»¶ (æ–°å¢)
        // å¤§äº‹çºª Modal
        const MilestonesModal = ({ show, onClose, milestones, profiles, theme }) => {
            if (!show) return null;
            
            const [filterType, setFilterType] = React.useState('all');
            const [filterMember, setFilterMember] = React.useState('all');
            
            const filtered = milestones
                .filter(m => filterType === 'all' || m.type === filterType)
                .filter(m => filterMember === 'all' || m.member === filterMember)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            const typeIcons = {
                levelup: 'â¬†ï¸',
                achievement: 'ğŸ†',
                event: 'âœ¨',
                milestone: 'ğŸ¯'
            };
            
            const typeNames = {
                levelup: 'å‡çº§',
                achievement: 'æˆå°±',
                event: 'å¥‡é‡',
                milestone: 'é‡Œç¨‹ç¢‘'
            };
            
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                        <div className="p-6 border-b bg-gradient-to-r from-purple-50 to-pink-50">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    ğŸ“œ å¤§äº‹çºª
                                </h2>
                                <button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full transition-colors">
                                    <XIcon className="w-6 h-6 text-gray-500" />
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                <div className="flex gap-2">
                                    {['all', 'levelup', 'achievement', 'event', 'milestone'].map(type => (
                                        <button
                                            key={type}
                                            onClick={() => setFilterType(type)}
                                            className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                                                filterType === type 
                                                    ? 'bg-purple-500 text-white' 
                                                    : 'bg-white text-gray-600 hover:bg-purple-100'
                                            }`}
                                        >
                                            {type === 'all' ? 'å…¨éƒ¨' : typeNames[type]}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setFilterMember('all')}
                                        className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                                            filterMember === 'all' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-white text-gray-600 hover:bg-blue-100'
                                        }`}
                                    >
                                        å…¨éƒ¨æˆå‘˜
                                    </button>
                                    {profiles.map(p => (
                                        <button
                                            key={p.id}
                                            onClick={() => setFilterMember(p.name)}
                                            className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                                                filterMember === p.name 
                                                    ? 'bg-blue-500 text-white' 
                                                    : 'bg-white text-gray-600 hover:bg-blue-100'
                                            }`}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            {filtered.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <div className="text-6xl mb-4">ğŸ’­</div>
                                    <div>æš‚æ— è®°å½•</div>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {filtered.map(m => (
                                        <div key={m.id} className="bg-gradient-to-r from-gray-50 to-white p-4 rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
                                            <div className="flex items-start gap-3">
                                                <div className="text-3xl">{m.icon || typeIcons[m.type]}</div>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="font-bold text-gray-800">{m.title}</span>
                                                        <span className="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">
                                                            {typeNames[m.type]}
                                                        </span>
                                                        <span className="text-xs text-gray-400">â€¢</span>
                                                        <span className="text-xs text-gray-500">{m.member}</span>
                                                    </div>
                                                    <p className="text-sm text-gray-600 mb-2">{m.description}</p>
                                                    <div className="text-xs text-gray-400">{m.date}</div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        // æ•°æ®å¤‡ä»½/æ¢å¤ Modal
        const BackupPanel = ({ show, onClose, theme }) => {
            if (!show) return null;
            
            const handleExport = () => {
                const data = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    tasks: localStorage.getItem('app_tasks_v2'),
                    checkins: localStorage.getItem('app_checkins_v2'),
                    wheelHistory: localStorage.getItem('app_wheel_history'),
                    xpHistory: localStorage.getItem('app_xp_history'),
                    profiles: localStorage.getItem('app_profiles_v1'),
                    achievements: localStorage.getItem('app_achievements_v1'),
                    stats: localStorage.getItem('app_stats_v1'),
                    inventory: localStorage.getItem('app_inventory_v1'),
                    activeBuffs: localStorage.getItem('app_active_buffs_v1'),
                    redeemedCoupons: localStorage.getItem('app_coupons_v1'),
                    equippedGear: localStorage.getItem('app_equipped_gear_v1'),
                    milestones: localStorage.getItem('app_milestones_v1'),
                    globalMessages: localStorage.getItem('app_global_messages_v2'),
                    globalDates: localStorage.getItem('app_global_dates'),
                    wheelConfig: localStorage.getItem('app_wheel_config'),
                    wheelSettings: localStorage.getItem('app_wheel_settings'),
                    evilWheelConfig: localStorage.getItem('app_evil_wheel_config'),
                    randomEventHistory: localStorage.getItem('app_random_event_history'),
                    dailyRandomCounts: localStorage.getItem('app_daily_random_counts'),
					userCity: localStorage.getItem('app_user_city_v1'),
                    curriculumProgress: localStorage.getItem('app_curriculum_progress_v1'),
                    xpWheelConfig: localStorage.getItem('app_xp_wheel_config'),
                    settingsPassword: localStorage.getItem('app_settings_password'),
                    testMode: localStorage.getItem('app_test_mode'),
                    weekendSettings: localStorage.getItem('app_weekend_settings'),
                    notifiedLevels: localStorage.getItem('app_notified_levels')
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ—¶ç©ºå¸‚é›†å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                localStorage.setItem('app_last_backup_date', new Date().toISOString());
                alert('âœ… å¤‡ä»½æˆåŠŸï¼\n\næ–‡ä»¶å·²ä¸‹è½½ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚');
            };
            
            const handleImport = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.version) {
                                alert('âš ï¸ æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶ï¼');
                                return;
                            }
                            
                            const confirmed = confirm('âš ï¸ è­¦å‘Šï¼šæ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼\n\nç¡®è®¤ç»§ç»­å—ï¼Ÿ');
                            if (!confirmed) return;
                            
                            Object.keys(data).forEach(key => {
                                if (key !== 'version' && key !== 'exportDate' && data[key]) {
                                    const storageKey = key === 'tasks' ? 'app_tasks_v2' :
                                                      key === 'checkins' ? 'app_checkins_v2' :
                                                      key === 'profiles' ? 'app_profiles_v1' :
                                                      key === 'achievements' ? 'app_achievements_v1' :
                                                      key === 'stats' ? 'app_stats_v1' :
                                                      key === 'inventory' ? 'app_inventory_v1' :
                                                      key === 'activeBuffs' ? 'app_active_buffs_v1' :
                                                      key === 'redeemedCoupons' ? 'app_coupons_v1' :
                                                      key === 'equippedGear' ? 'app_equipped_gear_v1' :
                                                      key === 'milestones' ? 'app_milestones_v1' :
                                                      key === 'globalMessages' ? 'app_global_messages_v2' :
                                                      key === 'globalDates' ? 'app_global_dates' :
                                                      key === 'wheelConfig' ? 'app_wheel_config' :
                                                      key === 'wheelSettings' ? 'app_wheel_settings' :
                                                      key === 'wheelHistory' ? 'app_wheel_history' :
                                                      key === 'xpHistory' ? 'app_xp_history' :
                                                      key === 'evilWheelConfig' ? 'app_evil_wheel_config' :
                                                      key === 'randomEventHistory' ? 'app_random_event_history' :
                                                      key === 'dailyRandomCounts' ? 'app_daily_random_counts' : null;
													  key === 'userCity' ? 'app_user_city_v1' :
                                                      key === 'curriculumProgress' ? 'app_curriculum_progress_v1' :
                                                      key === 'xpWheelConfig' ? 'app_xp_wheel_config' :
                                                      key === 'settingsPassword' ? 'app_settings_password' :
                                                      key === 'testMode' ? 'app_test_mode' :
                                                      key === 'weekendSettings' ? 'app_weekend_settings' :
                                                      key === 'notifiedLevels' ? 'app_notified_levels' : null;
                                    
                                    if (storageKey) {
                                        localStorage.setItem(storageKey, data[key]);
                                    }
                                }
                            });
                            
                            alert('âœ… æ•°æ®æ¢å¤æˆåŠŸï¼\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚');
                            window.location.reload();
                        } catch (err) {
                            alert('âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼\n\n' + err.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            const totalRecords = Object.keys(localStorage).filter(k => k.startsWith('app_')).length;
            const lastBackup = localStorage.getItem('app_last_backup_date');
            const daysSinceBackup = lastBackup ? Math.floor((Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24)) : null;
            
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl">
                        <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-cyan-50">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    ğŸ’¾ æ•°æ®å¤‡ä»½/æ¢å¤
                                </h2>
                                <button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full transition-colors">
                                    <XIcon className="w-6 h-6 text-gray-500" />
                                </button>
                            </div>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h3 className="font-bold text-blue-800 mb-3">ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                                <div className="grid grid-cols-2 gap-3 text-sm">
                                    <div className="bg-white p-3 rounded-lg">
                                        <div className="text-gray-500 text-xs">å­˜å‚¨é¡¹æ•°</div>
                                        <div className="text-2xl font-bold text-gray-800">{totalRecords}</div>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg">
                                        <div className="text-gray-500 text-xs">ä¸Šæ¬¡å¤‡ä»½</div>
                                        <div className="text-lg font-bold text-gray-800">
                                            {lastBackup ? `${daysSinceBackup}å¤©å‰` : 'æœªå¤‡ä»½'}
                                        </div>
                                    </div>
                                </div>
                                {(!lastBackup || daysSinceBackup > 7 || totalRecords > 100) && (
                                    <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
                                        âš ï¸ å»ºè®®ç«‹å³å¤‡ä»½æ•°æ®ï¼Œé˜²æ­¢æ„å¤–ä¸¢å¤±ï¼
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-3">
                                <button
                                    onClick={handleExport}
                                    className="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold hover:from-green-600 hover:to-emerald-600 transition-all shadow-lg flex items-center justify-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>
                                    å¯¼å‡ºå¤‡ä»½æ–‡ä»¶
                                </button>
                                
                                <button
                                    onClick={handleImport}
                                    className="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold hover:from-blue-600 hover:to-cyan-600 transition-all shadow-lg flex items-center justify-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                    ä»å¤‡ä»½æ–‡ä»¶æ¢å¤
                                </button>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-xl text-xs text-gray-600 space-y-2">
                                <div className="font-bold text-gray-700">ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</div>
                                <ul className="list-disc list-inside space-y-1 ml-2">
                                    <li>å¯¼å‡ºï¼šå°†æ‰€æœ‰æ•°æ®ä¿å­˜ä¸ºJSONæ–‡ä»¶</li>
                                    <li>æ¢å¤ï¼šä»å¤‡ä»½æ–‡ä»¶è¿˜åŸæ•°æ®ï¼ˆä¼šè¦†ç›–å½“å‰æ•°æ®ï¼‰</li>
                                    <li>å»ºè®®å®šæœŸå¤‡ä»½ï¼Œå¹¶å°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°äº‘ç›˜</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

		// --- æ–°å¢ï¼šé“¶æ²³æ˜Ÿç©º Canvas ç‰¹æ•ˆ ---
        const GalaxyEffect = () => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth;
                let height = window.innerHeight;
                let stars = [];
                let animationFrameId;

                canvas.width = width;
                canvas.height = height;

                const initStars = () => {
                    stars = [];
                    const starCount = Math.floor((width * height) / 1000); // æ ¹æ®å±å¹•é¢ç§¯è®¡ç®—æ˜Ÿæ˜Ÿæ•°é‡
                    for (let i = 0; i < starCount; i++) {
                        stars.push({
                            x: Math.random() * width,
                            y: Math.random() * height,
                            radius: Math.random() * 1.5,
                            alpha: Math.random(),
                            speed: Math.random() * 0.05 + 0.05 // ææ…¢çš„æ¼‚æµ®æ„Ÿ
                        });
                    }
                };

                const draw = () => {
                    ctx.clearRect(0, 0, width, height);
                    
                    // ç»˜åˆ¶æ˜Ÿç©º
                    stars.forEach(star => {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                        ctx.fill();
                        
                        // ç®€å•çš„é—ªçƒå’Œç§»åŠ¨é€»è¾‘
                        star.alpha += (Math.random() - 0.5) * 0.02;
                        if (star.alpha < 0) star.alpha = 0;
                        if (star.alpha > 1) star.alpha = 1;
                        
                        star.y -= star.speed; // ç¼“æ…¢å‘ä¸Šæ¼‚æµ®
                        if (star.y < 0) star.y = height; // å¾ªç¯
                    });

                    animationFrameId = requestAnimationFrame(draw);
                };

                const handleResize = () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    canvas.width = width;
                    canvas.height = height;
                    initStars();
                };

                initStars();
                draw();

                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationFrameId);
                };
            }, []);

            return (
                <div className="absolute inset-0 bg-galaxy-gradient transition-opacity duration-1000">
                    <canvas ref={canvasRef} className="absolute inset-0" />
                    {/* å åŠ ä¸€å±‚è½»å¾®çš„æš—è§’ï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ */}
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.4)_100%)]"></div>
                </div>
            );
        };

		// --- æ–°å¢ï¼šæµæ˜Ÿé›¨ CSS ç‰¹æ•ˆç»„ä»¶ ---
        const MeteorShower = () => {
            // ç”Ÿæˆé™æ€çš„æ˜Ÿæ˜Ÿæ•°æ® (åªç”Ÿæˆä¸€æ¬¡)
            const stars = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                top: Math.random() * 70 + '%', // æ˜Ÿæ˜Ÿä¸»è¦é›†ä¸­åœ¨ä¸­ä¸Šéƒ¨
                size: Math.random() * 2 + 1 + 'px',
                delay: Math.random() * 3 + 's',
                duration: Math.random() * 3 + 2 + 's'
            })), []);

            // ç”Ÿæˆæµæ˜Ÿæ•°æ®
            const meteors = useMemo(() => Array.from({ length: 6 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                top: Math.random() * 30 + '%', // æµæ˜Ÿä»ä¸Šæ–¹å‡ºç°
                delay: Math.random() * 10 + 's', // éšæœºå»¶è¿Ÿï¼Œé”™å¼€å‡ºç°æ—¶é—´
                duration: Math.random() * 1.5 + 2 + 's' // é€Ÿåº¦ç¨æ…¢ï¼Œæ›´æœ‰å®é™æ„Ÿ
            })), []);

            return (
                <div className="absolute inset-0 bg-meteor-gradient overflow-hidden animate-in fade-in duration-1000">
                    {/* 1. å‘¼å¸çš„æ˜Ÿæ˜Ÿ */}
                    {stars.map(s => (
                        <div key={s.id} className="absolute rounded-full bg-white" style={{
                            left: s.left, top: s.top, width: s.size, height: s.size,
                            animation: `star-twinkle ${s.duration} ease-in-out infinite ${s.delay}`
                        }} />
                    ))}
                    
                    {/* 2. åˆ’è¿‡çš„æµæ˜Ÿ */}
                    {meteors.map(m => (
                        <div key={m.id} className="absolute h-[2px] w-[120px] bg-gradient-to-r from-transparent via-white to-transparent rounded-full opacity-0" style={{
                            left: m.left, top: m.top,
                            boxShadow: '0 0 15px rgba(255,255,255,0.4)',
                            animation: `meteor-drop ${m.duration} linear infinite ${m.delay}`
                        }} />
                    ))}
                    
                    {/* 3. åº•éƒ¨å¾®å…‰é®ç½© (è®©åº•éƒ¨æ–‡å­—æ›´æ¸…æ™°) */}
                    <div className="absolute bottom-0 left-0 w-full h-1/3 bg-gradient-to-t from-[#0f172a] to-transparent opacity-80 pointer-events-none"></div>
                </div>
            );
        };

		// --- æ–°å¢ï¼šæåœ°ä¹‹å¤œÂ·æ¬§è‹¥æ‹‰ CSS ç‰¹æ•ˆç»„ä»¶ ---
        // --- æ–°å¢ï¼šæåœ°ä¹‹å¤œÂ·æ¬§è‹¥æ‹‰ç‰¹æ•ˆ (1:1 è¿˜åŸ WebGL ç‰ˆ) ---
        const AURORA_VERT = `#version 300 es
			in vec2 position;
			void main() {
			  gl_Position = vec4(position, 0.0, 1.0);
			}
			`;

					const AURORA_FRAG = `#version 300 es
			precision highp float;
			uniform float uTime;
			uniform float uAmplitude;
			uniform vec3 uColorStops[3];
			uniform vec2 uResolution;
			uniform float uBlend;
			out vec4 fragColor;

			vec3 permute(vec3 x) {
			  return mod(((x * 34.0) + 1.0) * x, 289.0);
			}

			float snoise(vec2 v){
			  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
			  vec2 i  = floor(v + dot(v, C.yy));
			  vec2 x0 = v - i + dot(i, C.xx);
			  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
			  vec4 x12 = x0.xyxy + C.xxzz;
			  x12.xy -= i1;
			  i = mod(i, 289.0);
			  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
			  vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);
			  m = m * m; m = m * m;
			  vec3 x = 2.0 * fract(p * C.www) - 1.0;
			  vec3 h = abs(x) - 0.5;
			  vec3 ox = floor(x + 0.5);
			  vec3 a0 = x - ox;
			  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
			  vec3 g;
			  g.x  = a0.x  * x0.x  + h.x  * x0.y;
			  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
			  return 130.0 * dot(m, g);
			}

			struct ColorStop {
			  vec3 color;
			  float position;
			};

			// ä½¿ç”¨å•è¡Œå®é˜²æ­¢ Babel è§£æè½¬ä¹‰ç¬¦å¤±è´¥
			#define COLOR_RAMP(colors, factor, finalColor) { int index = 0; for (int i = 0; i < 2; i++) { ColorStop currentColor = colors[i]; bool isInBetween = currentColor.position <= factor; index = int(mix(float(index), float(i), float(isInBetween))); } ColorStop currentColor = colors[index]; ColorStop nextColor = colors[index + 1]; float range = nextColor.position - currentColor.position; float lerpFactor = (factor - currentColor.position) / range; finalColor = mix(currentColor.color, nextColor.color, lerpFactor); }

			void main() {
			  vec2 uv = gl_FragCoord.xy / uResolution;

			  ColorStop colors[3];
			  colors[0] = ColorStop(uColorStops[0], 0.0);
			  colors[1] = ColorStop(uColorStops[1], 0.5);
			  colors[2] = ColorStop(uColorStops[2], 1.0);

			  vec3 rampColor;
			  COLOR_RAMP(colors, uv.x, rampColor);

			  float height = snoise(vec2(uv.x * 2.0 + uTime * 0.1, uTime * 0.25)) * 0.5 * uAmplitude;
			  height = exp(height);
			  height = (uv.y * 2.0 - height + 0.2);
			  float intensity = 0.6 * height;

			  float midPoint = 0.20;
			  float auroraAlpha = smoothstep(midPoint - uBlend * 0.5, midPoint + uBlend * 0.5, intensity);

			  vec3 auroraColor = intensity * rampColor;

			  fragColor = vec4(auroraColor * auroraAlpha, auroraAlpha);
			}
			`;

        const AuroraWebGL = (props) => {
            const { colorStops = ['#5227FF', '#7cff67', '#5227FF'], amplitude = 1.0, blend = 0.5, speed = 1.0 } = props;
            const propsRef = useRef({ colorStops, amplitude, blend, speed });
            
            useEffect(() => {
                propsRef.current = { colorStops, amplitude, blend, speed };
            }, [colorStops, amplitude, blend, speed]);
            
            const ctnDom = useRef(null);

            useEffect(() => {
                const ctn = ctnDom.current;
                if (!ctn) return;

                // åˆ›å»ºåŸç”Ÿ WebGL ç”»å¸ƒ
                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.display = 'block';
                canvas.style.backgroundColor = 'transparent';
                ctn.appendChild(canvas);

                // é‡‡ç”¨ WebGL2 æ¸²æŸ“ä¸Šä¸‹æ–‡
                const gl = canvas.getContext('webgl2', { alpha: true, premultipliedAlpha: true, antialias: true });
                if (!gl) {
                    console.warn("è®¾å¤‡ä¸æ”¯æŒ WebGL2ï¼Œæå…‰ç‰¹æ•ˆæ— æ³•æ¸²æŸ“");
                    return;
                }

                // ç¼–è¯‘ç€è‰²å™¨å·¥å…·
                const compileShader = (type, source) => {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);
                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                        console.error("Shader ç¼–è¯‘å¤±è´¥:", gl.getShaderInfoLog(shader));
                        gl.deleteShader(shader);
                        return null;
                    }
                    return shader;
                };

                const vs = compileShader(gl.VERTEX_SHADER, AURORA_VERT);
                const fs = compileShader(gl.FRAGMENT_SHADER, AURORA_FRAG);
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);

                const positionLoc = gl.getAttribLocation(program, 'position');
                const uTimeLoc = gl.getUniformLocation(program, 'uTime');
                const uAmplitudeLoc = gl.getUniformLocation(program, 'uAmplitude');
                const uBlendLoc = gl.getUniformLocation(program, 'uBlend');
                const uResolutionLoc = gl.getUniformLocation(program, 'uResolution');
                const uColorStopsLoc = gl.getUniformLocation(program, 'uColorStops');

                // ç»˜åˆ¶è¦†ç›–å…¨å±çš„å¤§ä¸‰è§’å½¢
                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([ -1, -1,  3, -1,  -1, 3 ]), gl.STATIC_DRAW);

                const vao = gl.createVertexArray();
                gl.bindVertexArray(vao);
                gl.enableVertexAttribArray(positionLoc);
                gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);

                gl.enable(gl.BLEND);
                gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);

                let animateId;
                const resize = () => {
                    // ä½¿ç”¨è§†çª—ä¿åº•æ–¹æ¡ˆï¼Œé˜²æ­¢åˆå§‹åŒ–æ—¶ div é«˜åº¦è®¡ç®—ä¸º 0 å¯¼è‡´é»‘å±
                    const width = ctn.offsetWidth || window.innerWidth;
                    const height = ctn.offsetHeight || window.innerHeight;
                    const dpr = window.devicePixelRatio || 1;
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                };
                window.addEventListener('resize', resize);
                resize();

                const hexToRgb = (hex) => {
                    let c = hex.replace(/^#/, '');
                    if (c.length === 3) c = c.split('').map(x => x + x).join('');
                    const num = parseInt(c, 16);
                    return [(num >> 16 & 255) / 255, (num >> 8 & 255) / 255, (num & 255) / 255];
                };

                const render = (t) => {
                    animateId = requestAnimationFrame(render);
                    const { speed, amplitude, blend, colorStops } = propsRef.current;
                    const time = t * 0.01;
                    
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);

                    gl.useProgram(program);
                    gl.bindVertexArray(vao);

                    gl.uniform1f(uTimeLoc, time * speed * 0.1);
                    gl.uniform1f(uAmplitudeLoc, amplitude);
                    gl.uniform1f(uBlendLoc, blend);
                    gl.uniform2f(uResolutionLoc, canvas.width, canvas.height);

                    // å°†é¢œè‰²è½¬ä¸º 9ä¸ªæµ®ç‚¹æ•°çš„ä¸€ç»´æ•°ç»„å¹¶å¼ºåˆ¶ä¼ å…¥ï¼Œé¿å¼€ OGL æºç å†…éƒ¨è§£æ Bug
                    const flatColors = colorStops.map(hexToRgb).reduce((acc, val) => acc.concat(val), []);
                    gl.uniform3fv(uColorStopsLoc, new Float32Array(flatColors));

                    gl.drawArrays(gl.TRIANGLES, 0, 3);
                };

                animateId = requestAnimationFrame(render);

                return () => {
                    cancelAnimationFrame(animateId);
                    window.removeEventListener('resize', resize);
                    if (ctn.contains(canvas)) ctn.removeChild(canvas);
                    gl.getExtension('WEBGL_lose_context')?.loseContext();
                };
            }, []);

            return <div ref={ctnDom} className="absolute inset-0 z-0 pointer-events-none" />;
        };

        const AuroraBorealis = () => {
            return (
                <div className="absolute inset-0 bg-aurora-base overflow-hidden animate-in fade-in duration-1000">
                    <AuroraWebGL 
                        colorStops={["#7cff67", "#B19EEF", "#5227FF"]} 
                        blend={0.5} 
                        amplitude={1.0} 
                        speed={1} 
                    />
                    
                    {/* ä¿ç•™ä½ åŸæœ¬æ˜Ÿç©ºç‚¹ç¼€ï¼Œå¢å¼ºæ²‰æµ¸æ„Ÿï¼Œå±‚çº§ç½®äºæå…‰ä¹‹ä¸Š */}
                    <div className="absolute inset-0 bg-black opacity-10 pointer-events-none z-10"></div>
                    <div className="absolute top-[20%] left-[15%] w-[3px] h-[3px] bg-white rounded-full opacity-90 animate-pulse z-10"></div>
                    <div className="absolute top-[35%] right-[25%] w-[4px] h-[4px] bg-white rounded-full opacity-70 animate-pulse z-10" style={{animationDelay: '2s'}}></div>
                    <div className="absolute top-[10%] left-[60%] w-[2px] h-[2px] bg-white rounded-full opacity-80 animate-pulse z-10" style={{animationDelay: '4s'}}></div>
                </div>
            );
        };

		// --- æ–°å¢ï¼šä¸Šå…ƒç¯ç«Â·ç¥ˆæ„¿ CSS ç‰¹æ•ˆç»„ä»¶ ---
        const LanternFestival = () => {
            // ç”Ÿæˆå­”æ˜ç¯æ•°æ®
            const lanterns = useMemo(() => Array.from({ length: 35 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                // å¤§å°ä¸ä¸€ï¼Œæ¨¡æ‹Ÿè¿œè¿‘æ™¯æ·±
                width: Math.random() * 15 + 10 + 'px', 
                // é€Ÿåº¦ææ…¢ï¼Œè¥é€ åº„é‡æ„Ÿ
                duration: Math.random() * 15 + 20 + 's', 
                delay: Math.random() * 15 + 's',
                // é¢œè‰²å¾®è°ƒï¼šæœ‰çš„åçº¢ï¼Œæœ‰çš„åé»„
                hue: Math.random() * 30 + 15 // Orange to Yellow
            })), []);

            return (
                <div className="absolute inset-0 bg-lantern-gradient overflow-hidden animate-in fade-in duration-1000">
                    {/* æ°›å›´é®ç½©ï¼šåº•éƒ¨æš—ï¼Œçªå‡ºç¯ç«äº®åº¦ */}
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom,transparent_0%,rgba(0,0,0,0.5)_100%)] pointer-events-none"></div>

                    {/* é£˜å‡çš„å­”æ˜ç¯ */}
                    {lanterns.map(l => (
                        <div key={l.id} 
                             className="absolute rounded-t-lg rounded-b-md opacity-90"
                             style={{
                                 left: l.left,
                                 width: l.width,
                                 height: `calc(${l.width} * 1.4)`, // ä¿æŒç¯ç¬¼æ¯”ä¾‹
                                 background: `linear-gradient(to top, hsl(${l.hue}, 90%, 50%), hsl(${l.hue}, 100%, 80%))`,
                                 animation: `lantern-float ${l.duration} linear infinite ${l.delay}, lantern-flicker 4s ease-in-out infinite alternate ${l.delay}`,
                                 bottom: '-50px' // èµ·å§‹ä½ç½®åœ¨å±å¹•ä¸‹æ–¹
                             }}
                        >
                            {/* å†…éƒ¨ç¯èŠ¯å¾®å…‰ */}
                            <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-1/2 h-1/2 bg-white blur-[2px] rounded-full opacity-60"></div>
                        </div>
                    ))}

                    {/* åº•éƒ¨æ¥¼é˜å‰ªå½± (CSSç»˜åˆ¶ç®€å•èµ·ä¼ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ) */}
                    <div className="absolute bottom-0 w-full h-44 bg-black opacity-90 blur-[0.5px] z-10" 
                         style={{ 
                             /* è°ƒæ•´äº†å¤šè¾¹å½¢æ¯”ä¾‹ï¼Œè®©å»ºç­‘çœ‹èµ·æ¥æ›´ä¿®é•¿ï¼Œé€‚åº”æ–°çš„é«˜åº¦ */
                             clipPath: 'polygon(0% 100%, 0% 88%, 5% 80%, 10% 88%, 15% 75%, 25% 92%, 35% 70%, 45% 88%, 55% 65%, 65% 88%, 75% 60%, 85% 88%, 90% 75%, 95% 88%, 100% 80%, 100% 100%)',
                             background: 'linear-gradient(to top, #000 0%, #1a0505 100%)' 
                         }}>
                    </div>
                </div>
            );
        };
		
		// --- ç»ˆæå¤åˆ»ç‰ˆï¼šè¤ç«ä¹‹æ£® (åŸç”Ÿæ•ˆæœ) ---
        const FireflyForest = () => {
            // ç”Ÿæˆè¤ç«è™«æ•°æ® (æ•°é‡é€‚ä¸­ï¼Œå› ä¸ºæ¯ä¸ªè¤ç«è™«çš„è¿åŠ¨èŒƒå›´éƒ½å¾ˆå¤§)
            const fireflies = useMemo(() => Array.from({ length: 50 }).map((_, i) => ({
                id: i,
                // éšæœºå»¶è¿Ÿï¼Œæ‰“æ•£è¿åŠ¨å’Œé—ªçƒèŠ‚å¥
                moveDelay: Math.random() * -200 + 's',
                flashDelay: Math.random() * -10 + 's',
                driftDelay: Math.random() * -10 + 's'
            })), []);

            return (
                <div className="absolute inset-0 bg-night-forest animate-in fade-in duration-1000">
                    {/* å¦‚æœä½ æœ‰èƒŒæ™¯å›¾ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ª img æ ‡ç­¾ï¼Œæˆ–è€…åœ¨ CSS .bg-night-forest é‡Œè®¾ç½® background-image */}
                    
                    <div className="firefly-container">
                        {fireflies.map(f => (
                            <div key={f.id} 
                                 className="firefly"
                                 style={{
                                     // åº”ç”¨éšæœºå»¶è¿Ÿï¼Œè®©æ¯åªè¤ç«è™«å¤„äºè½¨è¿¹çš„ä¸åŒä½ç½®
                                     animationDelay: f.moveDelay
                                 }}
                            >
                                {/* é€šè¿‡ä¼ªå…ƒç´ æ§åˆ¶å‘å…‰ï¼Œè¿™é‡Œä¸éœ€è¦å†…éƒ¨ contentï¼Œæ ·å¼ç”± CSS ç±»æ§åˆ¶ */}
                                <style dangerouslySetInnerHTML={{__html: `
                                    .firefly:nth-child(${f.id + 1})::before,
                                    .firefly:nth-child(${f.id + 1})::after {
                                        animation-delay: ${f.driftDelay}, ${f.flashDelay};
                                    }
                                `}} />
                            </div>
                        ))}
                    </div>

                    {/* åº•éƒ¨æ¤è¢«å‰ªå½± (ä¿ç•™ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ) */}
                    <div className="absolute bottom-0 w-full h-48 opacity-60 pointer-events-none"
                         style={{
                             background: 'linear-gradient(to top, #000 0%, transparent 100%)',
                             maskImage: 'linear-gradient(to top, black 50%, transparent 100%)',
                             WebkitMaskImage: 'linear-gradient(to top, black 50%, transparent 100%)'
                         }}>
                         {/* ç”¨ç®€å•çš„æ¸å˜æ¨¡æ‹Ÿè‰ä¸›æ ¹éƒ¨ */}
                         <div className="absolute bottom-0 w-full h-full" 
                              style={{ 
                                  background: 'repeating-linear-gradient(90deg, transparent 0, transparent 2px, #000 3px, #000 6px)',
                                  filter: 'blur(1px)'
                              }}>
                         </div>
                    </div>
                </div>
            );
        };
		
		// --- å¤«å­åº™å‰Â·é“¶æé›¨ CSS ç‰¹æ•ˆç»„ä»¶ ---
        // --- ä¼˜åŒ–ç‰ˆï¼šå¤«å­åº™å‰Â·é“¶æé›¨ CSS ç‰¹æ•ˆç»„ä»¶ ---
        const GinkgoRain = () => {
            // ç”Ÿæˆé“¶æå¶æ•°æ®
            // ã€ä¿®æ”¹ã€‘æ•°é‡å¢åŠ åˆ° 50 ç‰‡ï¼Œè¥é€ æ›´å¯†é›†çš„è½å¶é›¨
            const leaves = useMemo(() => Array.from({ length: 50 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + '%',
                size: Math.random() * 20 + 15 + 'px', // 15-35px å¤§å°
                duration: Math.random() * 10 + 8 + 's', // é£˜è½é€Ÿåº¦ç¨å¿«ä¸€ç‚¹
                delay: Math.random() * 10 + 's',
                flipDuration: Math.random() * 4 + 2 + 's', // ç¿»æ»šé€Ÿåº¦
                // ã€ä¿®æ”¹ã€‘é¢œè‰²å¾®è°ƒï¼šåŠ å…¥ä¸€ç‚¹ç‚¹æ©™è‰²ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ
                color: Math.random() > 0.6 ? '#fbbf24' : (Math.random() > 0.5 ? '#f59e0b' : '#fcd34d') 
            })), []);

            return (
                <div className="absolute inset-0 bg-ginkgo-gradient overflow-hidden animate-in fade-in duration-1000">
                    {/* æ°›å›´çº¹ç†ï¼šä¿ç•™å™ªç‚¹è´¨æ„Ÿ */}
                    <div className="absolute inset-0 opacity-10 pointer-events-none" 
                         style={{ backgroundImage: 'url("data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E")' }}>
                    </div>

                    {leaves.map(l => (
                        <div key={l.id} 
                             className="absolute"
                             style={{
                                 left: l.left,
                                 top: '-50px',
                                 width: l.size,
                                 height: l.size,
                                 animation: `ginkgo-fall ${l.duration} linear infinite ${l.delay}`
                             }}
                        >
                            <div className="w-full h-full"
                                 style={{
                                     animation: `ginkgo-flip ${l.flipDuration} ease-in-out infinite alternate`
                                 }}
                            >
                                <svg viewBox="0 0 1024 1024" fill={l.color} style={{ filter: 'drop-shadow(1px 2px 3px rgba(0,0,0,0.2))' }}>
                                    <path d="M512 832c0 0 128-256 256-256s192 64 192 64-64-256-192-320-256 0-256 0-128-64-256 0-192 320-192 320 64-64 192-64 256 256 256 256z M500 832l24 128-48 0 24-128z" />
                                </svg>
                            </div>
                        </div>
                    ))}

                    {/* ã€ä¿®æ”¹ã€‘åº•éƒ¨ä¹¦é™¢å‰ªå½±ï¼š
                        - é«˜åº¦ h-64 (256px)ï¼Œæ˜¾è‘—åŠ é«˜
                        - é¢œè‰²åŠ æ·±ï¼Œä½¿ç”¨æ·±è¤æ¸å˜ï¼Œä¸é‡‘è‰²è½å¶å½¢æˆå¼ºå¯¹æ¯”
                        - è½®å»“ä¼˜åŒ–ï¼Œæ›´åƒä¸­å›½å¤å»ºç­‘å±‹è„Š
                    */}
                    <div className="absolute bottom-0 w-full h-64 opacity-80 blur-[0.5px]" 
                         style={{ 
                             background: 'linear-gradient(to top, #451a03 0%, #78350f 100%)', // æ·±è¤è‰²ç³»
                             clipPath: 'polygon(0% 100%, 0% 85%, 5% 90%, 15% 75%, 25% 90%, 35% 80%, 50% 95%, 65% 80%, 75% 90%, 85% 75%, 95% 90%, 100% 85%, 100% 100%)'
                         }}>
                    </div>
                </div>
            );
        };

		// --- æ–°å¢ï¼šä¼ è¯´Â·ä¸‡è±¡å­—é˜µ (The Matrix of Civilization) ---
        // --- ç»ˆæå®Œç¾ç‰ˆï¼šä¼ è¯´Â·ä¸‡è±¡å­—é˜µ (åŒæ­¥ç½®æ¢å¾ªç¯) ---
        const MatrixCivilization = () => {
            const canvasRef = useRef(null);

            // é¢„è®¾å­—ç¬¦é›†
            const ORACLE_CHARS = "ä¹‹äººåˆ€å°‘ç›®åœŸæ—¥äº‘å…­å·¦å‘ç™½ç”²æ—¦ä¸æ­¢åŒ•ä¸Šé¼»æœ¨æœˆå…µä¸ƒåˆç«ä¹™æ˜æ­¥æ¯”å¤§ä¸‹èˆŒç¦¾æ˜Ÿæˆˆå…«å—åˆä¸™æ­£æ‰ä¿å¹¶å°è€³å±±ç±³è¾°æ­¦ä¹å®‰è±¹å†Œæ˜Œè¾°è‡­å¸å®¶é›·æ—…å¨˜æ˜ç‰›å“".split("");

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // --- é…ç½®å‚æ•° ---
                const CONFIG = {
                    font: '30px "OracleBone", sans-serif', 
                    spacing: 45,        // ç½‘æ ¼é—´è·
                    color: '#FFD700',   // é‡‘è‰²
                    pauseTime: 60,      // é™æ­¢æ—¶é•¿ (å¸§æ•°, çº¦1ç§’)
                    moveTime: 90,       // è¿åŠ¨æ—¶é•¿ (å¸§æ•°, çº¦1.5ç§’)
                    trailAlpha: 0.15    // æ‹–å°¾é€æ˜åº¦
                };

                let animationId;
                let shapes = [];
                let gridPoints = []; // å›ºå®šçš„ç½‘æ ¼åæ ‡æ± 
                let width = window.innerWidth;
                let height = window.innerHeight;
                
                // åŠ¨ç”»çŠ¶æ€æ§åˆ¶
                let frameCount = 0; 
                const totalCycle = CONFIG.pauseTime + CONFIG.moveTime;

                // --- ç¼“åŠ¨å‡½æ•° (è®©è¿åŠ¨èµ·æ­¢æ›´å¹³æ»‘) ---
                // EaseInOutCubic: æ…¢å¯åŠ¨ -> å¿«ä¸­é—´ -> æ…¢ç»“æŸ
                const easeInOut = (t) => {
                    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
                };

                // --- å½¢çŠ¶ç±» ---
                class Shape {
                    constructor(i, x, y) {
                        this.index = i;
                        // ä½ç½®çŠ¶æ€
                        this.x = x;       // å½“å‰å®æ—¶ä½ç½®
                        this.y = y;
                        this.sx = x;      // Start X: æœ¬æ¬¡è¿åŠ¨èµ·é£ç‚¹
                        this.sy = y;      // Start Y: æœ¬æ¬¡è¿åŠ¨èµ·é£ç‚¹
                        this.tx = x;      // Target X: æœ¬æ¬¡è¿åŠ¨ç›®æ ‡ç‚¹
                        this.ty = y;      // Target Y: æœ¬æ¬¡è¿åŠ¨ç›®æ ‡ç‚¹
                        
                        this.char = ORACLE_CHARS[Math.floor(Math.random() * ORACLE_CHARS.length)];
                        
                        // å­—ä½“å¤§å°å¾®è°ƒ
                        const size = 20 + Math.random() * 8;
                        this.font = `${size}px "OracleBone"`;
                    }

                    // è®¾ç½®æ–°çš„ç›®æ ‡
                    setTarget(targetX, targetY) {
                        this.sx = this.x; // å°†å½“å‰ä½ç½®è®¾ä¸ºèµ·é£ç‚¹
                        this.sy = this.y;
                        this.tx = targetX; // è®¾ç½®æ–°ç›®æ ‡
                        this.ty = targetY;
                    }

                    // æ ¹æ®è¿›åº¦æ›´æ–°ä½ç½® (0.0 ~ 1.0)
                    update(progress) {
                        // å¦‚æœè¿›åº¦ä¸º0ï¼Œä¿æŒä¸åŠ¨
                        if (progress <= 0) {
                            this.x = this.sx;
                            this.y = this.sy;
                            return;
                        }
                        // å¦‚æœè¿›åº¦å®Œæˆï¼Œé”å®šåœ¨ç›®æ ‡
                        if (progress >= 1) {
                            this.x = this.tx;
                            this.y = this.ty;
                            return;
                        }

                        // æ’å€¼è®¡ç®—
                        const easedProgress = easeInOut(progress);
                        this.x = this.sx + (this.tx - this.sx) * easedProgress;
                        this.y = this.sy + (this.ty - this.sy) * easedProgress;
                    }

                    draw(context) {
                        context.fillStyle = CONFIG.color;
                        context.font = this.font;
                        context.textAlign = 'center';
                        context.textBaseline = 'middle';
                        context.fillText(this.char, this.x, this.y);
                    }
                }

                // --- åˆå§‹åŒ–ç½‘æ ¼ä¸å­—ç¬¦ ---
                const init = () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    canvas.width = width;
                    canvas.height = height;

                    shapes = [];
                    gridPoints = [];

                    const cols = Math.floor(width / CONFIG.spacing);
                    const rows = Math.floor(height / CONFIG.spacing);
                    
                    // 1. ç”Ÿæˆæ ‡å‡†çš„ç½‘æ ¼åæ ‡ç³»ç»Ÿ
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const x = (c * CONFIG.spacing) + (width - cols * CONFIG.spacing) / 2 + CONFIG.spacing/2;
                            const y = (r * CONFIG.spacing) + (height - rows * CONFIG.spacing) / 2 + CONFIG.spacing/2;
                            gridPoints.push({ x, y });
                        }
                    }

                    // 2. åˆå§‹åŒ–å­—ç¬¦ (æ¯ä¸ªå­—ç¬¦å æ®ä¸€ä¸ªç½‘æ ¼ç‚¹)
                    gridPoints.forEach((p, i) => {
                        shapes.push(new Shape(i, p.x, p.y));
                    });
                };

                // --- æ´—ç‰Œç®—æ³• (Fisher-Yates Shuffle) ---
                // ç”¨äºæ‰“ä¹±ç½‘æ ¼åæ ‡ï¼Œåˆ†é…ç»™å­—ç¬¦
                const shuffleGrid = () => {
                    // å…‹éš†ä¸€ä»½ç½‘æ ¼åæ ‡
                    let shuffled = [...gridPoints];
                    
                    // éšæœºæ‰“ä¹±
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    
                    // å°†æ‰“ä¹±åçš„åæ ‡åˆ†é…ç»™å­—ç¬¦ä½œä¸ºæ–°ç›®æ ‡
                    shapes.forEach((shape, i) => {
                        if (shuffled[i]) {
                            shape.setTarget(shuffled[i].x, shuffled[i].y);
                        }
                    });
                };

                // --- åŠ¨ç”»å¾ªç¯ ---
                const animate = () => {
                    // åŠé€æ˜èƒŒæ™¯ï¼Œåˆ¶é€ æ‹–å°¾
                    ctx.fillStyle = `rgba(13, 13, 13, ${CONFIG.trailAlpha})`; 
                    ctx.fillRect(0, 0, width, height);

                    // è®¡ç®—å½“å‰å‘¨æœŸçš„è¿›åº¦
                    const cycleFrame = frameCount % totalCycle;

                    // --- é˜¶æ®µ 1: å‡†å¤‡èµ·é£ (åœ¨é™æ­¢æœŸçš„æœ€åä¸€å¸§è§¦å‘) ---
                    if (cycleFrame === CONFIG.pauseTime - 1) {
                        shuffleGrid(); // å…¨ä½“é‡æ–°åˆ†é…ç›®æ ‡
                    }

                    // --- é˜¶æ®µ 2: è¿åŠ¨ä¸­ ---
                    if (cycleFrame >= CONFIG.pauseTime) {
                        // è®¡ç®—è¿åŠ¨è¿›åº¦ (0.0 -> 1.0)
                        const rawProgress = (cycleFrame - CONFIG.pauseTime) / CONFIG.moveTime;
                        
                        shapes.forEach(shape => shape.update(rawProgress));
                    } 
                    // --- é˜¶æ®µ 3: é™æ­¢æœŸ ---
                    else {
                        // ä¿æŒåœ¨å½“å‰ä½ç½®ä¸åŠ¨ (å®é™…ä¸Š update(0) æˆ– update(1) éƒ½å¯ä»¥ï¼Œè¿™é‡Œä¸è°ƒç”¨ update èŠ‚çœæ€§èƒ½ï¼Œç›´æ¥ç”»)
                        // ä½†ä¸ºäº†é˜²æ­¢ resizing å¯¼è‡´çš„é”™ä½ï¼Œæˆ‘ä»¬è®© shape ä¿æŒåœ¨å®ƒçš„ç›®æ ‡ä½
                        // è¿™é‡Œä¸éœ€è¦é¢å¤–é€»è¾‘ï¼Œå› ä¸º update(1) å·²ç»åœ¨ä¸Šä¸€å‘¨æœŸçš„æœ«å°¾æ‰§è¡Œè¿‡äº†
                    }

                    // ç»˜åˆ¶æ‰€æœ‰å­—ç¬¦
                    shapes.forEach(shape => shape.draw(ctx));

                    frameCount++;
                    animationId = requestAnimationFrame(animate);
                };

                // --- äº‹ä»¶ç›‘å¬ ---
                const handleResize = () => {
                    init();
                    frameCount = 0; // é‡ç½®åŠ¨ç”»å‘¨æœŸ
                };
                window.addEventListener('resize', handleResize);

                // å¯åŠ¨
                init();
                animate();

                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationId);
                };
            }, []);

            return (
                <div className="absolute inset-0 bg-matrix-civilization animate-in fade-in duration-1000">
                    <canvas ref={canvasRef} className="block w-full h-full" />
                    {/* æ°›å›´é®ç½© */}
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.8)_100%)] pointer-events-none"></div>
                </div>
            );
        };
		
		// --- æ–°å¢ï¼šç»ˆæè§†è§‰ç‰ˆï¼šã€ç§˜å¢ƒÂ·ç”²éª¨æµæ²™ã€‘ (Oracle Sands)(ç‚¹é‡‘æˆçŸ³ç‰¹æ•ˆ) ---
        const MatrixOracleSands = () => {
            const canvasRef = useRef(null);
            
            // é¢„è®¾å­—ç¬¦é›†
            const ORACLE_CHARS = "ä¹‹äººåˆ€å°‘ç›®åœŸæ—¥äº‘å…­å·¦å‘ç™½ç”²æ—¦ä¸æ­¢åŒ•ä¸Šé¼»æœ¨æœˆå…µä¸ƒåˆç«ä¹™æ˜æ­¥æ¯”å¤§ä¸‹èˆŒç¦¾æ˜Ÿæˆˆå…«å—åˆä¸™æ­£æ‰ä¿å¹¶å°è€³å±±ç±³è¾°æ­¦ä¹å®‰è±¹å†Œæ˜Œè¾°è‡­å¸å®¶é›·æ—…å¨˜æ˜ç‰›å“".split("");

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // --- é…ç½®å‚æ•° ---
                const CONFIG = {
                    font: '30px "OracleBone", sans-serif', 
                    scale: 1,      
                    spacing: 40,   
                    // é¢œè‰²é…ç½®
                    baseColor: '#8c7853',   // åˆå§‹é¢œè‰²ï¼šç”Ÿé”ˆçš„é’é“œ (æš—æ·¡ä½†å¯è§)
                    activeColor: '#ffdd00', // æ¿€æ´»é¢œè‰²ï¼šè€€çœ¼çš„èµ¤é‡‘ (é«˜äº®)
                    mouseRadius: 150        // é¼ æ ‡å½±å“èŒƒå›´
                };

                let animationId;
                let shapes = [];
                let width = window.innerWidth;
                let height = window.innerHeight;

                const mouse = { x: width / 2, y: height / 2 };

                // --- è¾…åŠ©å‡½æ•°ï¼šé¢œè‰²æ’å€¼ (Lerp) ---
                // å°† hex é¢œè‰²è½¬æ¢ä¸º rgb å¹¶æ··åˆ
                const hexToRgb = (hex) => {
                    const bigint = parseInt(hex.slice(1), 16);
                    return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
                };
                
                const baseRgb = hexToRgb(CONFIG.baseColor);
                const activeRgb = hexToRgb(CONFIG.activeColor);

                const getBlendedColor = (energy) => {
                    // energy: 0.0 ~ 1.0
                    const r = Math.round(baseRgb[0] + (activeRgb[0] - baseRgb[0]) * energy);
                    const g = Math.round(baseRgb[1] + (activeRgb[1] - baseRgb[1]) * energy);
                    const b = Math.round(baseRgb[2] + (activeRgb[2] - baseRgb[2]) * energy);
                    return `rgb(${r}, ${g}, ${b})`;
                };

                // --- å½¢çŠ¶ç±» ---
                class Shape {
                    constructor(x, y, i) {
                        this.x = Math.random() * width; // éšæœºå‡ºç”Ÿ
                        this.y = Math.random() * height;
                        this.tx = x; // ç›®æ ‡ä½ç½®
                        this.ty = y;
                        this.index = i;
                        this.char = ORACLE_CHARS[Math.floor(Math.random() * ORACLE_CHARS.length)];
                        
                        const size = 20 + Math.random() * 20;
                        this.font = `${size}px "OracleBone"`;
                        
                        // èƒ½é‡å€¼ï¼š0 = é’é“œï¼Œ1 = èµ¤é‡‘
                        this.energy = 0; 
                    }

                    update() {
                        // 1. é£å…¥é€»è¾‘ (ç¼“åŠ¨è¿½é€)
                        const dx = this.tx - this.x;
                        const dy = this.ty - this.y;
                        this.x += dx * 0.05;
                        this.y += dy * 0.05;

                        // 2. é¼ æ ‡äº¤äº’ + èƒ½é‡æ³¨å…¥
                        const mouseDx = mouse.x - this.x;
                        const mouseDy = mouse.y - this.y;
                        const dist = Math.sqrt(mouseDx * mouseDx + mouseDy * mouseDy);

                        if (dist < CONFIG.mouseRadius) {
                            const angle = Math.atan2(mouseDy, mouseDx);
                            const force = (CONFIG.mouseRadius - dist) / CONFIG.mouseRadius;
                            const push = force * 20;

                            this.x -= Math.cos(angle) * push;
                            this.y -= Math.sin(angle) * push;
                            
                            // ã€å…³é”®ã€‘è¢«æ¨å¼€ç¬é—´ï¼Œèƒ½é‡ç¬é—´æ‹‰æ»¡
                            // force è¶Šå¤§ï¼ˆç¦»é¼ æ ‡è¶Šè¿‘ï¼‰ï¼Œèƒ½é‡è¶Šå¼º
                            this.energy = Math.max(this.energy, force); 
                        }

                        // 3. èƒ½é‡è‡ªç„¶è¡°å‡ (æ¨¡æ‹Ÿå†·å´)
                        // æ¯ä¸€å¸§è¡°å‡ 5%ï¼Œè®©é¢œè‰²æ…¢æ…¢å˜å›é’é“œ
                        this.energy *= 0.95;
                        if (this.energy < 0.01) this.energy = 0;
                    }

                    draw(context) {
                        // æ ¹æ®å½“å‰èƒ½é‡å€¼è®¡ç®—é¢œè‰²
                        context.fillStyle = getBlendedColor(this.energy);
                        
                        // å¦‚æœèƒ½é‡å¾ˆé«˜ï¼Œé¢å¤–åŠ ä¸€ä¸ªå‘å…‰æ•ˆæœ
                        if (this.energy > 0.5) {
                            context.shadowBlur = 10 * this.energy;
                            context.shadowColor = CONFIG.activeColor;
                        } else {
                            context.shadowBlur = 0;
                        }

                        context.font = this.font;
                        context.textAlign = 'center';
                        context.textBaseline = 'middle';
                        context.fillText(this.char, this.x, this.y);
                    }
                }

                // --- åˆå§‹åŒ–ä¸å¾ªç¯ ---
                const init = () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    canvas.width = width;
                    canvas.height = height;

                    shapes = [];
                    const cols = Math.floor(width / CONFIG.spacing);
                    const rows = Math.floor(height / CONFIG.spacing);
                    
                    let index = 0;
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const x = (c * CONFIG.spacing) + (width - cols * CONFIG.spacing) / 2;
                            const y = (r * CONFIG.spacing) + (height - rows * CONFIG.spacing) / 2;
                            shapes.push(new Shape(x, y, index++));
                        }
                    }
                };

                const animate = () => {
                    // åŠé€æ˜æ‹–å°¾
                    ctx.fillStyle = 'rgba(13, 13, 13, 0.1)'; 
                    ctx.fillRect(0, 0, width, height);

                    shapes.forEach(shape => {
                        shape.update();
                        shape.draw(ctx);
                    });

                    animationId = requestAnimationFrame(animate);
                };

                const handleResize = () => init();
                const handleMouseMove = (e) => { mouse.x = e.clientX; mouse.y = e.clientY; };
                const handleTouchMove = (e) => { if(e.touches.length > 0) { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; } };

                window.addEventListener('resize', handleResize);
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('touchmove', handleTouchMove);

                init();
                animate();

                return () => {
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('touchmove', handleTouchMove);
                    cancelAnimationFrame(animationId);
                };
            }, []);

            return (
                <div className="absolute inset-0 bg-matrix-civilization animate-in fade-in duration-1000">
                    <canvas ref={canvasRef} className="block w-full h-full" />
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.6)_100%)] pointer-events-none"></div>
                </div>
            );
        };
		
		// --- ç»ˆæç‰¹æ•ˆç‰ˆï¼šæ–°æ˜¥é™å®šÂ·ç«æ ‘é“¶èŠ± (ç›´é£+èºæ—‹å°¾+é‡‘ç²‰ç‰¹æ•ˆ) ---
        const LunarFireworks = () => {
            const containerRef = useRef(null);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;

                // 1. æ‰‹åŠ¨åˆ›å»º Canvas (é˜²æŠ¥é”™)
                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.cursor = 'crosshair';
                container.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                let width = window.innerWidth;
                let height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;

                // 2. æ ¸å¿ƒç‰©ç†å¼•æ“
                const COLOR = {
                    Red: '#ff0043', Green: '#14fc56', Blue: '#1e7fff', Purple: '#e60aff',
                    Gold: '#ffbf36', White: '#ffffff'
                };
                
                const MyMath = {
                    toRad: (deg) => deg * Math.PI / 180,
                    pointDist: (x1, y1, x2, y2) => Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2)),
                    random: (min, max) => Math.random() * (max - min) + min,
                    randomChoice: (arr) => arr[Math.floor(Math.random() * arr.length)]
                };

                /// [Shell]: å‡ç©ºçƒŸèŠ± (ç›´é£å¸¦ç‰©ç†æŠ–åŠ¨ + çœŸå®é‡‘ç²‰å°¾ç„°)
                class Shell {
                    constructor(options) {
                        Object.assign(this, options);
                        this.speed = options.speed || 12; // åˆå§‹é€Ÿåº¦
                        this.y = height; // å¼ºåˆ¶ä»åº•éƒ¨ç”Ÿæˆ
                        this.x = options.x; 
                        this.baseX = options.x; // è®°å½•åŸºç¡€Xï¼Œç”¨äºè®¡ç®—æŠ–åŠ¨åŸºå‡†
                        this.targetY = options.targetY;
                        
                        this.color = options.color || COLOR.Gold;
                        this.size = 3;
                    }

                    update() {
                        const dist = this.y - this.targetY;
                        this.y -= this.speed * (dist / (height - this.targetY) + 0.1);
                        
                        // 1. æœ¬ä½“å¾®å¼±æŠ–åŠ¨ï¼šæ¨¡æ‹Ÿç«è¯æ¨è¿›æ—¶çš„ä¸ç¨³å®šç‡ƒçƒ§ï¼Œä½¿å…¶ä¸é‚£ä¹ˆå‘†æ¿
                        // è®© x åæ ‡åœ¨ baseX å·¦å³ 2px èŒƒå›´å†…éšæœºæ¼‚ç§»
                        this.x = this.baseX + (Math.random() - 0.5) * 4; 

                        // 2. é‡‘ç²‰å°¾ç„°ï¼šæ¨¡æ‹Ÿæ¨è¿›å‰‚æ‰è½çš„ç«èŠ±ç¢å±‘
                        // æ¯ä¸€å¸§éšæœºç”Ÿæˆ 1~3 ç²’å‘ä¸‹æ–¹å–·å°„çš„ç»†å°ç«èŠ±
                        const sparkCount = Math.floor(Math.random() * 3) + 1;
                        for (let i = 0; i < sparkCount; i++) {
                            objects.push(new Spark({
                                x: this.x + (Math.random() - 0.5) * 4, // åœ¨å¼¹å¤´å‘¨å›´éšæœºæ•£å¼€
                                y: this.y,
                                // å°¾ç„°é¢œè‰²ï¼šå¤§éƒ¨åˆ†æ˜¯é‡‘è‰²ï¼Œå¶å°”å¤¹æ‚çƒŸèŠ±æœ¬è‰²æˆ–æé«˜äº®çš„ç™½è‰²
                                color: Math.random() > 0.7 ? this.color : (Math.random() > 0.5 ? COLOR.White : COLOR.Gold),
                                size: MyMath.random(0.5, 2), // ç¢å±‘å¤§å°ä¸ä¸€
                                life: MyMath.random(20, 45), // å­˜åœ¨æ—¶é—´è¾ƒçŸ­ï¼Œå½¢æˆå½—æ˜Ÿå°¾å·´çš„é”¥å½¢æ•ˆæœ
                                speed: MyMath.random(1, 3.5), // å–·å°„åˆé€Ÿåº¦
                                // è§’åº¦è®¾å®šï¼šMath.PI / 2 æ˜¯æ­£ä¸‹æ–¹ï¼ŒåŠ ä¸Šéšæœºå¾®è°ƒå½¢æˆæ‰‡å½¢å–·å°„
                                angle: Math.PI / 2 + (Math.random() - 0.5) * 0.8, 
                                grav: 0.05,
                                drag: 0.94
                            }));
                        }

                        // åˆ°è¾¾ç›®æ ‡åˆ¤æ–­
                        if (this.y <= this.targetY + 10) return true; 
                        return false;
                    }

                    draw(ctx) {
                        // ç»˜åˆ¶å¼¹å¤´é«˜å…‰ä¸­å¿ƒ (ç™½çƒ­åŒ–)
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size * 0.8, 0, 2 * Math.PI);
                        ctx.fillStyle = '#FFF'; 
                        ctx.fill();
                        
                        // ç»˜åˆ¶å¼¹å¤´è¾¹ç¼˜æ³›å…‰ (ä½“ç°çƒŸèŠ±é¢œè‰²)
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size * 2.5, 0, 2 * Math.PI);
                        ctx.fillStyle = this.color;
                        ctx.globalAlpha = 0.4;
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                }

                // [Star]: çˆ†ç‚¸ä¸»ç²’å­ (ä¿®æ”¹ä¸ºé‡‘ç²‰æ•£è½é€»è¾‘)
                class Star {
                    constructor(options) {
                        Object.assign(this, options);
                        this.life = options.life || 100;
                        this.maxLife = this.life;
                        
                        this.vx = Math.cos(options.angle) * options.speed;
                        this.vy = Math.sin(options.angle) * options.speed;
                        
                        // ã€ä¿®æ”¹ã€‘å…è®¸å¤–éƒ¨ä¼ å…¥é‡åŠ›å’Œé˜»åŠ›ï¼Œå®ç°ä¸åŒçƒŸèŠ±å½¢æ€
                        this.grav = options.grav !== undefined ? options.grav : 0.05; 
                        this.drag = options.drag !== undefined ? options.drag : 0.96; 
                    }

                    update() {
                        this.vx *= this.drag;
                        this.vy *= this.drag;
                        this.vy += this.grav;
                        this.x += this.vx;
                        this.y += this.vy;
                        this.life--;

                        // --- é‡‘ç²‰ç‰¹æ•ˆæ ¸å¿ƒé€»è¾‘ ---
                        // åœ¨é£è¡Œè¿‡ç¨‹ä¸­ï¼Œéšæœºæ‰è½ç»†å°çš„é‡‘è‰²ç«èŠ± (Spark)
                        // æ¦‚ç‡éšé€Ÿåº¦é™ä½è€Œé™ä½
                        if (Math.random() < 0.3 && this.life > 10) {
                            objects.push(new Spark({
                                x: this.x,
                                y: this.y,
                                color: this.color, // ç»§æ‰¿ä¸»ç²’å­é¢œè‰²ï¼Œæˆ–è€…å›ºå®šä¸ºé‡‘è‰² '#ffbf36'
                                size: MyMath.random(0.5, 1.2),
                                life: MyMath.random(10, 30), // æ¶ˆå¤±å¾—å¾ˆå¿«
                                speed: 0, // åŸåœ°åœç•™ï¼Œäº§ç”Ÿæ‹–å°¾æ„Ÿ
                                angle: 0
                            }));
                        }

                        return this.life <= 0;
                    }

                    draw(ctx) {
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI);
                        ctx.fillStyle = this.color;
                        // é—ªçƒæ•ˆæœ
                        const blink = Math.random() * 0.5 + 0.5;
                        ctx.globalAlpha = (this.life / this.maxLife) * blink;
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                }

                // [Spark]: ç»†å°çš„ç«èŠ±/é‡‘ç²‰ (ç”¨äºå°¾è¿¹å’Œé‡‘ç²‰æ•£è½)
                class Spark {
                    constructor(options) {
                        Object.assign(this, options);
                        this.vx = Math.cos(options.angle) * options.speed;
                        this.vy = Math.sin(options.angle) * options.speed;
                        this.grav = 0.02; // å¾ˆè½»
                        this.drag = 0.9;  // é˜»åŠ›å¤§ï¼Œå¾ˆå¿«åœä¸‹
                        this.maxLife = this.life;
                    }

                    update() {
                        this.vx *= this.drag;
                        this.vy *= this.drag;
                        this.vy += this.grav;
                        this.x += this.vx;
                        this.y += this.vy;
                        this.life--;
                        return this.life <= 0;
                    }

                    draw(ctx) {
                        ctx.fillStyle = this.color;
                        ctx.globalAlpha = (this.life / this.maxLife);
                        // ç»˜åˆ¶æˆå°æ–¹å—æ¯”åœ†å½¢æ€§èƒ½å¥½ï¼Œä¸”æœ‰â€œç²‰æœ«â€æ„Ÿ
                        ctx.fillRect(this.x, this.y, this.size, this.size);
                        ctx.globalAlpha = 1;
                    }
                }

                // [Burst]: çˆ†ç‚¸ç®¡ç†å™¨ (æ–°å¢å¤šç§é«˜çº§å½¢æ€)
                class Burst {
                    constructor(options) {
                        this.x = options.x;
                        this.y = options.y;
                        const color = options.color || MyMath.randomChoice(Object.values(COLOR));
                        
                        // éšæœºé€‰æ‹©çƒŸèŠ±ç±»å‹ï¼š0=ç»å…¸çƒå½¢, 1=é‡‘è‰²å‚æŸ³, 2=åŒå±‚å¸¦è•Šç‰¡ä¸¹
                        const type = Math.floor(Math.random() * 3);

                        if (type === 0) {
                            // å½¢æ€ 1ï¼šç»å…¸çƒå½¢ï¼ˆå¯†é›†ã€é€Ÿåº¦ä¸å‡ã€å¸¦é‡‘ç²‰æ‹–å°¾ï¼‰
                            const count = 120;
                            for (let i = 0; i < count; i++) {
                                const angle = MyMath.random(0, 2 * Math.PI);
                                const speed = Math.pow(Math.random(), 0.5) * 8.5; 
                                objects.push(new Star({
                                    x: this.x, y: this.y, color: color, angle: angle, speed: speed,
                                    size: MyMath.random(1.5, 3), life: MyMath.random(80, 150)
                                }));
                            }
                        } else if (type === 1) {
                            // å½¢æ€ 2ï¼šé‡‘è‰²å‚æŸ³ï¼ˆé‡åŠ›å¤§ã€å¯¿å‘½é•¿ã€åƒç€‘å¸ƒä¸€æ ·å è½ï¼‰
                            const count = 90;
                            for (let i = 0; i < count; i++) {
                                const angle = MyMath.random(0, 2 * Math.PI);
                                const speed = Math.pow(Math.random(), 0.5) * 5; // åˆé€Ÿåº¦æ…¢
                                objects.push(new Star({
                                    x: this.x, y: this.y, color: COLOR.Gold, angle: angle, speed: speed,
                                    size: MyMath.random(2, 3), life: MyMath.random(120, 220),
                                    grav: 0.08, drag: 0.97 // é‡åŠ›å¢åŠ ï¼Œé˜»åŠ›å‡å°(é£˜å¾—è¿œ)
                                }));
                            }
                        } else if (type === 2) {
                            // å½¢æ€ 3ï¼šåŒå±‚å¸¦è•Šç‰¡ä¸¹ï¼ˆçœŸå®æ„Ÿæå¼ºçš„åŒè‰²å åŠ ï¼Œå¸¦æœ‰è‡ªç„¶æ‰°åŠ¨ï¼‰
                            const outerCount = 90;
                            // 1. å¤–å±‚èŠ±ç“£ï¼ˆé€Ÿåº¦è®¾å®šéšæœºåŒºé—´ï¼Œæ‰“ç ´ç»å¯¹åœ†å½¢çš„è§„æ•´æ„Ÿï¼‰
                            for (let i = 0; i < outerCount; i++) {
                                const angle = MyMath.random(0, 2 * Math.PI);
                                const speed = MyMath.random(5, 9); // é€Ÿåº¦å‚å·®ä¸é½ï¼Œè¾¹ç¼˜è‡ªç„¶æ•£å¼€
                                objects.push(new Star({
                                    x: this.x, y: this.y, color: color, angle: angle, speed: speed,
                                    size: MyMath.random(1.5, 2.5), life: MyMath.random(80, 140),
                                    grav: 0.05, drag: 0.96 
                                }));
                            }
                            
                            // 2. å†…å±‚èŠ±è•Šï¼ˆè‡´å¯†ã€é€Ÿåº¦æ…¢ã€‚å¦‚æœå¤–å±‚æ˜¯é‡‘è‰²/ç™½è‰²ï¼Œå†…è•Šå°±ç”¨çº¢è‰²åè¡¬ï¼Œå¦åˆ™ç”¨é‡‘è‰²ï¼‰
                            const innerCount = 40;
                            const innerColor = (color === COLOR.Gold || color === COLOR.White) ? COLOR.Red : COLOR.Gold;
                            for (let i = 0; i < innerCount; i++) {
                                const angle = MyMath.random(0, 2 * Math.PI);
                                const speed = MyMath.random(1.5, 3.5); // çˆ†ç‚¸åŠ›å°ï¼Œèšé›†åœ¨ä¸­å¿ƒ
                                objects.push(new Star({
                                    x: this.x, y: this.y, color: innerColor, angle: angle, speed: speed,
                                    size: MyMath.random(1.5, 2), life: MyMath.random(60, 100),
                                    grav: 0.05, drag: 0.94 
                                }));
                            }
                        }
                    }
                    update() { return true; } 
                    draw() {}
                }

                // 3. åŠ¨ç”»å¾ªç¯
                const objects = [];
                let autoLaunchTimer = 0;
                let autoLaunchInterval = 1000;
                let animationId;

				// ã€æ–°å¢ã€‘ç”Ÿæˆ 150 é¢—èƒŒæ™¯ç¹æ˜Ÿï¼Œå¸¦æœ‰ä¸åŒçš„å¤§å°ã€äº®åº¦å’Œé—ªçƒé€Ÿåº¦
                const bgStars = Array.from({ length: 150 }, () => ({
                    xRatio: Math.random(), // å­˜å‚¨ 0~1 çš„å®½åº¦æ¯”ä¾‹
                    yRatio: Math.random() * 0.85, // å­˜å‚¨ 0~0.85 çš„é«˜åº¦æ¯”ä¾‹
                    size: Math.random() * 1.2 + 0.2,
                    alpha: Math.random(),
                    speed: Math.random() * 0.015 + 0.005,
                    dir: Math.random() > 0.5 ? 1 : -1
                }));

                const loop = () => {
                    // 1. æ‹–å°¾æ•ˆæœï¼šå¿…é¡»ç”¨ destination-out (æ©¡çš®æ“¦æ¨¡å¼)
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.25)'; // 0.25 æ§åˆ¶æ‹–å°¾é•¿åº¦
                    ctx.fillRect(0, 0, width, height);

                    // ã€æ–°å¢ã€‘ç»˜åˆ¶å‘¼å¸é—ªçƒçš„ç¹æ˜ŸèƒŒæ™¯
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = '#FFF';
                    bgStars.forEach(star => {
                        // å‘¼å¸é—ªçƒé€»è¾‘
                        star.alpha += star.speed * star.dir;
                        if (star.alpha > 0.7) { star.alpha = 0.7; star.dir = -1; }
                        if (star.alpha < 0.1) { star.alpha = 0.1; star.dir = 1; }
                        
                        ctx.globalAlpha = star.alpha;
                        ctx.beginPath();
                        ctx.arc(star.xRatio * width, star.yRatio * height, star.size, 0, 2 * Math.PI);
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1; // æ¢å¤é»˜è®¤é€æ˜åº¦

                    // 2. ç”»çƒŸèŠ±ï¼šå¿…é¡»åˆ‡å› lighter å åŠ å‘å…‰æ¨¡å¼
                    ctx.globalCompositeOperation = 'lighter';

                    // è‡ªåŠ¨å‘å°„
                    autoLaunchTimer += 16; 
                    if (autoLaunchTimer > autoLaunchInterval) {
                        // ã€ä¿®æ”¹ã€‘æ‹“å®½å‘å°„åŒºåŸŸï¼šä» 0.2~0.8 æ‰©å¤§åˆ° 0.05~0.95ï¼Œè¦†ç›–æ•´ä¸ªå±å¹•å·¦å³è¾¹ç¼˜
                        const targetX = MyMath.random(width * 0.05, width * 0.95);
                        // ã€ä¿®æ”¹é«˜åº¦èŒƒå›´ã€‘0.1 åˆ° 0.65ï¼Œè®©çƒŸèŠ±æœ‰é«˜æœ‰ä½ï¼Œé”™è½æœ‰è‡´
                        const targetY = MyMath.random(height * 0.1, height * 0.65);
                        
                        objects.push(new Shell({
                            x: targetX, // ç›´é£ï¼šèµ·ç‚¹X = ç»ˆç‚¹X
                            targetY: targetY,
                            color: MyMath.randomChoice(Object.values(COLOR))
                        }));
                        
                        autoLaunchTimer = 0;
                        autoLaunchInterval = MyMath.random(1200, 2500);
                    }

                    // æ›´æ–°æ‰€æœ‰å¯¹è±¡
                    for (let i = objects.length - 1; i >= 0; i--) {
                        const obj = objects[i];
                        if (obj.update()) {
                            // å¦‚æœæ˜¯ Shell å®Œæˆä»»åŠ¡ï¼Œå˜ä¸º Burst
                            if (obj instanceof Shell) {
                                new Burst({ x: obj.x, y: obj.y, color: obj.color });
                            }
                            // ç§»é™¤å·²å®Œæˆçš„å¯¹è±¡ (Shell æˆ– å¯¿å‘½è€—å°½çš„ç²’å­)
                            objects.splice(i, 1);
                        } else {
                            obj.draw(ctx);
                        }
                    }

                    animationId = requestAnimationFrame(loop);
                };

                // 4. äº¤äº’å¤„ç† (ç‚¹å‡»å“ªé‡Œï¼Œå°±å¾€å“ªé‡Œç›´é£)
                const handleInteraction = (e) => {
                    e.stopPropagation();
                    let clientX, clientY;
                    if (e.touches && e.touches.length > 0) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    objects.push(new Shell({
                        x: clientX, // ç›´é£åˆ°ç‚¹å‡»å¤„
                        targetY: clientY,
                        color: MyMath.randomChoice(Object.values(COLOR)),
                        speed: 15 // ç‚¹å‡»å‘å°„çš„ç¨å¾®å¿«ä¸€ç‚¹
                    }));
                };

                const handleResize = () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    canvas.width = width;
                    canvas.height = height;
                };

                window.addEventListener('resize', handleResize);
                canvas.addEventListener('mousedown', handleInteraction);
                canvas.addEventListener('touchstart', handleInteraction, { passive: false });

                loop();

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', handleResize);
                    if (container && container.contains(canvas)) {
                        container.removeChild(canvas);
                    }
                };
            }, []);

            return (
                <div 
                    ref={containerRef} 
                    className="absolute inset-0 bg-lunar-night animate-in fade-in duration-1000"
                    onMouseDown={e => e.stopPropagation()}
                    onTouchStart={e => e.stopPropagation()}
                ></div>
            );
        };
		
		// --- æ–°å¢ï¼šç™»ç§‘Â·ç‰ç’ƒåå…‰ç‰¹æ•ˆ (Prismatic Burst çº¯åŸç”ŸWebGLæ— ä¾èµ–ç‰ˆ) ---
        const PRISMATIC_VERT = `#version 300 es
			in vec2 position;
			void main() {
				gl_Position = vec4(position, 0.0, 1.0);
			}
			`;

					const PRISMATIC_FRAG = `#version 300 es
			precision highp float;
			precision highp int;
			out vec4 fragColor;

			uniform vec2  uResolution;
			uniform float uTime;
			uniform float uIntensity;
			uniform float uSpeed;
			uniform int   uAnimType;
			uniform vec2  uMouse;
			uniform int   uColorCount;
			uniform float uDistort;
			uniform vec2  uOffset;
			uniform sampler2D uGradient;
			uniform float uNoiseAmount;
			uniform int   uRayCount;

			float hash21(vec2 p){
				p = floor(p);
				float f = 52.9829189 * fract(dot(p, vec2(0.065, 0.005)));
				return fract(f);
			}

			mat2 rot30(){ return mat2(0.8, -0.5, 0.5, 0.8); }

			float layeredNoise(vec2 fragPx){
				vec2 p = mod(fragPx + vec2(uTime * 30.0, -uTime * 21.0), 1024.0);
				vec2 q = rot30() * p;
				float n = 0.0;
				n += 0.40 * hash21(q);
				n += 0.25 * hash21(q * 2.0 + 17.0);
				n += 0.20 * hash21(q * 4.0 + 47.0);
				n += 0.10 * hash21(q * 8.0 + 113.0);
				n += 0.05 * hash21(q * 16.0 + 191.0);
				return n;
			}

			vec3 rayDir(vec2 frag, vec2 res, vec2 offset, float dist){
				float focal = res.y * max(dist, 1e-3);
				return normalize(vec3(2.0 * (frag - offset) - res, focal));
			}

			float edgeFade(vec2 frag, vec2 res, vec2 offset){
				vec2 toC = frag - 0.5 * res - offset;
				float r = length(toC) / (0.5 * min(res.x, res.y));
				float x = clamp(r, 0.0, 1.0);
				float q = x * x * x * (x * (x * 6.0 - 15.0) + 10.0);
				float s = q * 0.5;
				s = pow(s, 1.5);
				float tail = 1.0 - pow(1.0 - s, 2.0);
				s = mix(s, tail, 0.2);
				float dn = (layeredNoise(frag * 0.15) - 0.5) * 0.0015 * s;
				return clamp(s + dn, 0.0, 1.0);
			}

			mat3 rotX(float a){ float c = cos(a), s = sin(a); return mat3(1.0,0.0,0.0, 0.0,c,-s, 0.0,s,c); }
			mat3 rotY(float a){ float c = cos(a), s = sin(a); return mat3(c,0.0,s, 0.0,1.0,0.0, -s,0.0,c); }
			mat3 rotZ(float a){ float c = cos(a), s = sin(a); return mat3(c,-s,0.0, s,c,0.0, 0.0,0.0,1.0); }

			vec3 sampleGradient(float t){
				t = clamp(t, 0.0, 1.0);
				return texture(uGradient, vec2(t, 0.5)).rgb;
			}

			vec2 rot2(vec2 v, float a){
				float s = sin(a), c = cos(a);
				return mat2(c, -s, s, c) * v;
			}

			float bendAngle(vec3 q, float t){
				float a = 0.8 * sin(q.x * 0.55 + t * 0.6)
						+ 0.7 * sin(q.y * 0.50 - t * 0.5)
						+ 0.6 * sin(q.z * 0.60 + t * 0.7);
				return a;
			}

			void main(){
				vec2 frag = gl_FragCoord.xy;
				float t = uTime * uSpeed;
				float jitterAmp = 0.1 * clamp(uNoiseAmount, 0.0, 1.0);
				vec3 dir = rayDir(frag, uResolution, uOffset, 1.0);
				float marchT = 0.0;
				vec3 col = vec3(0.0);
				float n = layeredNoise(frag);
				vec4 c = cos(t * 0.2 + vec4(0.0, 33.0, 11.0, 0.0));
				mat2 M2 = mat2(c.x, c.y, c.z, c.w);
				float amp = clamp(uDistort, 0.0, 50.0) * 0.15;
				mat3 rot3dMat = mat3(1.0);
				
				if(uAnimType == 1){
					vec3 ang = vec3(t * 0.31, t * 0.21, t * 0.17);
					rot3dMat = rotZ(ang.z) * rotY(ang.y) * rotX(ang.x);
				}
				
				mat3 hoverMat = mat3(1.0);
				if(uAnimType == 2){
					vec2 m = uMouse * 2.0 - 1.0;
					vec3 ang = vec3(m.y * 0.6, m.x * 0.6, 0.0);
					hoverMat = rotY(ang.y) * rotX(ang.x);
				}
				
				for (int i = 0; i < 44; ++i) {
					vec3 P = marchT * dir;
					P.z -= 2.0;
					float rad = length(P);
					vec3 Pl = P * (10.0 / max(rad, 1e-6));
					
					if(uAnimType == 0){
						Pl.xz *= M2;
					} else if(uAnimType == 1){
						Pl = rot3dMat * Pl;
					} else {
						Pl = hoverMat * Pl;
					}
					
					float stepLen = min(rad - 0.3, n * jitterAmp) + 0.1;
					float grow = smoothstep(0.35, 3.0, marchT);
					float a1 = amp * grow * bendAngle(Pl * 0.6, t);
					float a2 = 0.5 * amp * grow * bendAngle(Pl.zyx * 0.5 + 3.1, t * 0.9);
					vec3 Pb = Pl;
					Pb.xz = rot2(Pb.xz, a1);
					Pb.xy = rot2(Pb.xy, a2);
					
					float rayPattern = smoothstep(
						0.5, 0.7,
						sin(Pb.x + cos(Pb.y) * cos(Pb.z)) *
						sin(Pb.z + sin(Pb.y) * cos(Pb.x + t))
					);
					
					if (uRayCount > 0) {
						float ang = atan(Pb.y, Pb.x);
						float comb = 0.5 + 0.5 * cos(float(uRayCount) * ang);
						comb = pow(comb, 3.0);
						rayPattern *= smoothstep(0.15, 0.95, comb);
					}
					
					vec3 spectralDefault = 1.0 + vec3(
						cos(marchT * 3.0 + 0.0),
						cos(marchT * 3.0 + 1.0),
						cos(marchT * 3.0 + 2.0)
					);
					
					float saw = fract(marchT * 0.25);
					float tRay = saw * saw * (3.0 - 2.0 * saw);
					vec3 userGradient = 2.0 * sampleGradient(tRay);
					vec3 spectral = (uColorCount > 0) ? userGradient : spectralDefault;
					vec3 base = (0.05 / (0.4 + stepLen))
							  * smoothstep(5.0, 0.0, rad)
							  * spectral;
					col += base * rayPattern;
					marchT += stepLen;
				}
				col *= edgeFade(frag, uResolution, uOffset);
				col *= uIntensity;
				fragColor = vec4(clamp(col, 0.0, 1.0), 1.0);
			}
			`;

        const PrismaticBurstWebGL = (props) => {
            const { 
                intensity = 2, 
                speed = 0.5, 
                animationType = 'rotate3d', 
                colors = ['#ff007a', '#4d3dff', '#ffffff'], 
                distort = 0, 
                offset = { x: 0, y: 0 }, 
                hoverDampness = 0.25, 
                rayCount = 0
            } = props;
            
            const propsRef = useRef({ intensity, speed, animationType, colors, distort, offset, hoverDampness, rayCount });
            
            useEffect(() => {
                propsRef.current = { intensity, speed, animationType, colors, distort, offset, hoverDampness, rayCount };
            }, [intensity, speed, animationType, colors, distort, offset, hoverDampness, rayCount]);

            const ctnDom = useRef(null);

            useEffect(() => {
                const ctn = ctnDom.current;
                if (!ctn) return;

                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.display = 'block';
                canvas.style.backgroundColor = 'transparent';
                // å¯ç”¨åŸä»£ç ä¸­çš„ lighten å…‰æ•ˆå åŠ æ»¤é•œ
                canvas.style.mixBlendMode = 'lighten'; 
                ctn.appendChild(canvas);

                const gl = canvas.getContext('webgl2', { alpha: true, premultipliedAlpha: true, antialias: true });
                if (!gl) {
                    console.warn("è®¾å¤‡ä¸æ”¯æŒ WebGL2ï¼Œç‰ç’ƒåå…‰ç‰¹æ•ˆæ— æ³•æ¸²æŸ“");
                    return;
                }

                const compileShader = (type, source) => {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);
                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
                    return shader;
                };

                const vs = compileShader(gl.VERTEX_SHADER, PRISMATIC_VERT);
                const fs = compileShader(gl.FRAGMENT_SHADER, PRISMATIC_FRAG);
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);

                const locs = {
                    position: gl.getAttribLocation(program, 'position'),
                    uResolution: gl.getUniformLocation(program, 'uResolution'),
                    uTime: gl.getUniformLocation(program, 'uTime'),
                    uIntensity: gl.getUniformLocation(program, 'uIntensity'),
                    uSpeed: gl.getUniformLocation(program, 'uSpeed'),
                    uAnimType: gl.getUniformLocation(program, 'uAnimType'),
                    uMouse: gl.getUniformLocation(program, 'uMouse'),
                    uColorCount: gl.getUniformLocation(program, 'uColorCount'),
                    uDistort: gl.getUniformLocation(program, 'uDistort'),
                    uOffset: gl.getUniformLocation(program, 'uOffset'),
                    uGradient: gl.getUniformLocation(program, 'uGradient'),
                    uNoiseAmount: gl.getUniformLocation(program, 'uNoiseAmount'),
                    uRayCount: gl.getUniformLocation(program, 'uRayCount')
                };

                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([ -1, -1,  3, -1,  -1, 3 ]), gl.STATIC_DRAW);

                const vao = gl.createVertexArray();
                gl.bindVertexArray(vao);
                gl.enableVertexAttribArray(locs.position);
                gl.vertexAttribPointer(locs.position, 2, gl.FLOAT, false, 0, 0);
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);

                // ç”Ÿæˆç”¨äºç€è‰²å™¨é‡‡æ ·çš„ 1D é¢œè‰²è¿‡æ¸¡æ¸å˜çº¹ç†
                const gradientTex = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, gradientTex);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

                const hexToRgb01 = hex => {
                    let h = hex.trim().replace(/^#/, '');
                    if (h.length === 3) h = h.split('').map(x=>x+x).join('');
                    const intVal = parseInt(h, 16);
                    return [((intVal >> 16) & 255)/255, ((intVal >> 8) & 255)/255, (intVal & 255)/255];
                };

                const updateTexture = (cols) => {
                    if (!cols || cols.length === 0) return 0;
                    const count = Math.min(cols.length, 64);
                    const data = new Uint8Array(count * 4);
                    for(let i=0; i<count; i++){
                        const [r,g,b] = hexToRgb01(cols[i]);
                        data[i*4+0] = Math.round(r*255);
                        data[i*4+1] = Math.round(g*255);
                        data[i*4+2] = Math.round(b*255);
                        data[i*4+3] = 255;
                    }
                    gl.bindTexture(gl.TEXTURE_2D, gradientTex);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, count, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, data);
                    return count;
                };

                let animateId;
                let lastTime = performance.now();
                let accumTime = 0;
                const mouseSmooth = [0.5, 0.5];
                const mouseTarget = [0.5, 0.5];

                const resize = () => {
                    const width = ctn.offsetWidth || window.innerWidth;
                    const height = ctn.offsetHeight || window.innerHeight;
                    const dpr = Math.min(window.devicePixelRatio || 1, 2);
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                };
                window.addEventListener('resize', resize);
                resize();

                const onPointerMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / Math.max(rect.width, 1);
                    const y = (e.clientY - rect.top) / Math.max(rect.height, 1);
                    mouseTarget[0] = Math.min(Math.max(x, 0), 1);
                    mouseTarget[1] = Math.min(Math.max(y, 0), 1);
                };
                window.addEventListener('pointermove', onPointerMove);

                const render = (now) => {
                    const dt = Math.max(0, now - lastTime) * 0.001;
                    lastTime = now;
                    accumTime += dt;

                    const p = propsRef.current;
                    const tau = 0.02 + Math.max(0, Math.min(1, p.hoverDampness || 0.25)) * 0.5;
                    const alpha = 1 - Math.exp(-dt / tau);
                    mouseSmooth[0] += (mouseTarget[0] - mouseSmooth[0]) * alpha;
                    mouseSmooth[1] += (mouseTarget[1] - mouseSmooth[1]) * alpha;

                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.useProgram(program);
                    gl.bindVertexArray(vao);

                    gl.uniform2f(locs.uResolution, canvas.width, canvas.height);
                    gl.uniform1f(locs.uTime, accumTime);
                    gl.uniform1f(locs.uIntensity, p.intensity ?? 2);
                    gl.uniform1f(locs.uSpeed, p.speed ?? 0.5);
                    
                    const animTypeMap = { rotate: 0, rotate3d: 1, hover: 2 };
                    gl.uniform1i(locs.uAnimType, animTypeMap[p.animationType ?? 'rotate3d'] ?? 1);
                    gl.uniform2f(locs.uMouse, mouseSmooth[0], mouseSmooth[1]);
                    
                    const colorCount = updateTexture(p.colors);
                    gl.uniform1i(locs.uColorCount, colorCount);
                    gl.uniform1f(locs.uDistort, p.distort ?? 0);
                    
                    const ox = parseFloat(p.offset?.x) || 0;
                    const oy = parseFloat(p.offset?.y) || 0;
                    gl.uniform2f(locs.uOffset, ox, oy);
                    
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, gradientTex);
                    gl.uniform1i(locs.uGradient, 0);

                    gl.uniform1f(locs.uNoiseAmount, 0.8);
                    gl.uniform1i(locs.uRayCount, p.rayCount ?? 0);

                    gl.drawArrays(gl.TRIANGLES, 0, 3);
                    animateId = requestAnimationFrame(render);
                };
                animateId = requestAnimationFrame(render);

                return () => {
                    cancelAnimationFrame(animateId);
                    window.removeEventListener('resize', resize);
                    window.removeEventListener('pointermove', onPointerMove);
                    if (ctn.contains(canvas)) ctn.removeChild(canvas);
                    gl.getExtension('WEBGL_lose_context')?.loseContext();
                };
            }, []);

            return <div ref={ctnDom} className="absolute inset-0 z-0 pointer-events-none" />;
        };

        const PrismaticBackground = () => {
            return (
                <div className="absolute inset-0 bg-black overflow-hidden animate-in fade-in duration-1000">
                    <PrismaticBurstWebGL 
                        animationType="rotate3d"
                        intensity={2.5} 
                        speed={0.4}
                        distort={0}
                        offset={{ x: 0, y: 0 }}
                        hoverDampness={0.25}
                        rayCount={0}
                        // æ±‡èšè¥¿åŸŸç‰ç’ƒä¹‹å½©ï¼ˆå“çº¢/æµ·è“/ç™½/åŠ ä¸€ç‚¹ä»£è¡¨çš‡å®¤çš„å¤§å”é‡‘è‰²ï¼‰
                        colors={['#ff007a', '#4d3dff', '#ffffff', '#FFD700']} 
                    />
                    
                    {/* å¾®å…‰æ˜Ÿç‚¹å¢åŠ çºµæ·±æ„Ÿ */}
                    <div className="absolute inset-0 bg-black opacity-30 pointer-events-none z-10"></div>
                    <div className="absolute top-[20%] left-[15%] w-[3px] h-[3px] bg-white rounded-full opacity-90 animate-pulse z-10"></div>
                    <div className="absolute top-[35%] right-[25%] w-[4px] h-[4px] bg-yellow-200 rounded-full opacity-70 animate-pulse z-10" style={{animationDelay: '2s'}}></div>
                    <div className="absolute top-[10%] left-[60%] w-[2px] h-[2px] bg-white rounded-full opacity-80 animate-pulse z-10" style={{animationDelay: '4s'}}></div>
                </div>
            );
        };
		
		// --- æ–°å¢ï¼šçºªå…ƒè·ƒè¿Â·æ—¶å…‰éš§é“ç‰¹æ•ˆ (Grid Scan çº¯åŸç”Ÿ WebGL æ— ä¾èµ–ç‰ˆ) ---
        const TIMEWARP_VERT = `#version 300 es
			in vec2 position;
			void main() {
				gl_Position = vec4(position, 0.0, 1.0);
			}
			`;

					const TIMEWARP_FRAG = `#version 300 es
			precision highp float;
			out vec4 fragColor;

			uniform vec2 iResolution;
			uniform float iTime;
			uniform vec2 uMouse;
			uniform vec3 uLinesColor;
			uniform vec3 uScanColor;

			void main() {
				// å½’ä¸€åŒ–åæ ‡å¹¶å¤„ç†å±å¹•æ¯”ä¾‹
				vec2 uv = (gl_FragCoord.xy * 2.0 - iResolution.xy) / min(iResolution.x, iResolution.y);
				
				// é¼ æ ‡äº¤äº’ï¼šæ ¹æ®é¼ æ ‡ä½ç½®äº§ç”Ÿéš§é“çš„è½»å¾®åç§»é€è§†
				uv -= (uMouse - 0.5) * 0.8;
				
				// æ‘„åƒæœºé•œå¤´æ—‹è½¬æ™ƒåŠ¨ï¼Œå¢å¼ºå è½å¤±é‡æ„Ÿ
				float wobble = sin(iTime * 0.3) * 0.15;
				mat2 rot = mat2(cos(wobble), -sin(wobble), sin(wobble), cos(wobble));
				uv *= rot;
				
				// æåæ ‡è½¬æ¢æ„é€  3D é€è§†éš§é“ (æ— é™å è½)
				float r = length(uv);
				float a = atan(uv.y, uv.x);
				
				// zè½´çºµæ·± (ä¸­å¿ƒæ— é™è¿œ)
				float z = 1.0 / max(r, 0.005);
				
				// æ—¶ç©ºè·ƒè¿é€Ÿåº¦ (å‘å±å¹•å¤–å†²åˆº)
				float t = iTime * 4.0;
				
				// Grid Scanï¼šæŸ±çŠ¶æ˜ å°„è®¡ç®—ç½‘æ ¼çº¿
				vec2 gridUv = vec2(a / 3.14159265 * 5.0, z + t);
				vec2 grid = fract(gridUv);
				
				// å¹³æ»‘ç½‘æ ¼çº¿æ¡ï¼ŒæŠ—é”¯é½¿
				vec2 line = smoothstep(0.0, 0.08, grid) - smoothstep(0.92, 1.0, grid);
				float intensity = max(line.x, line.y);
				
				// æµå…‰æ‰«ææ³¢æ•ˆåº” (Grid Scan Wave)
				float scanWave = sin(z * 4.0 + iTime * 12.0) * 0.5 + 0.5;
				scanWave = pow(scanWave, 3.0); // è®©æ‰«æé«˜å…‰æ›´åŠ é”åˆ©
				
				// è‰²å½©æ··åˆï¼šåŸºç¡€ç½‘æ ¼è‰² + æ‰«æé«˜å…‰è‰²
				vec3 finalColor = mix(uLinesColor, uScanColor, scanWave * 0.9) * intensity;
				
				// ä¸­å¿ƒå¥‡ç‚¹ï¼šæ·±é‚ƒçš„é»‘æ´å‘å…‰æ ¸å¿ƒ
				float core = smoothstep(0.25, 0.0, r);
				finalColor += uScanColor * core * (sin(iTime * 5.0) * 0.2 + 0.8);
				
				// è¿œæ™¯é›¾åŒ– (Fog)ï¼Œå¢å¼ºç©ºé—´çºµæ·±æ„Ÿ
				float fog = smoothstep(0.0, 2.5, r);
				finalColor *= fog;
				
				// æé€Ÿè·ƒè¿çš„å…¨å±€æ‰«æçº¿æ»¤é•œ
				float screenScan = sin(gl_FragCoord.y * 3.0 - iTime * 20.0) * 0.05;
				finalColor += screenScan * fog;
				
				fragColor = vec4(finalColor, 1.0);
			}
			`;

        const TimeWarpWebGL = ({ linesColor = '#392e4e', scanColor = '#00ffff' }) => {
            const ctnDom = useRef(null);
            const propsRef = useRef({ linesColor, scanColor });

            useEffect(() => {
                propsRef.current = { linesColor, scanColor };
            }, [linesColor, scanColor]);

            useEffect(() => {
                const ctn = ctnDom.current;
                if (!ctn) return;

                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.display = 'block';
                canvas.style.backgroundColor = '#030008'; // æ·±é‚ƒå®‡å®™åº•è‰²
                ctn.appendChild(canvas);

                const gl = canvas.getContext('webgl2', { alpha: false, antialias: true });
                if (!gl) {
                    console.warn("è®¾å¤‡ä¸æ”¯æŒ WebGL2ï¼Œæ—¶å…‰éš§é“ç‰¹æ•ˆæ— æ³•æ¸²æŸ“");
                    return;
                }

                const compileShader = (type, source) => {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);
                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
                    return shader;
                };

                const vs = compileShader(gl.VERTEX_SHADER, TIMEWARP_VERT);
                const fs = compileShader(gl.FRAGMENT_SHADER, TIMEWARP_FRAG);
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);

                const locs = {
                    position: gl.getAttribLocation(program, 'position'),
                    iResolution: gl.getUniformLocation(program, 'iResolution'),
                    iTime: gl.getUniformLocation(program, 'iTime'),
                    uMouse: gl.getUniformLocation(program, 'uMouse'),
                    uLinesColor: gl.getUniformLocation(program, 'uLinesColor'),
                    uScanColor: gl.getUniformLocation(program, 'uScanColor')
                };

                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([ -1, -1,  3, -1,  -1, 3 ]), gl.STATIC_DRAW);

                const vao = gl.createVertexArray();
                gl.bindVertexArray(vao);
                gl.enableVertexAttribArray(locs.position);
                gl.vertexAttribPointer(locs.position, 2, gl.FLOAT, false, 0, 0);

                const hexToRgb01 = hex => {
                    let h = hex.trim().replace(/^#/, '');
                    if (h.length === 3) h = h.split('').map(x=>x+x).join('');
                    const intVal = parseInt(h, 16);
                    return [((intVal >> 16) & 255)/255, ((intVal >> 8) & 255)/255, (intVal & 255)/255];
                };

                let animateId;
                let lastTime = performance.now();
                let accumTime = 0;
                const mouseSmooth = [0.5, 0.5];
                const mouseTarget = [0.5, 0.5];

                const resize = () => {
                    const width = ctn.offsetWidth || window.innerWidth;
                    const height = ctn.offsetHeight || window.innerHeight;
                    const dpr = Math.min(window.devicePixelRatio || 1, 2);
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                };
                window.addEventListener('resize', resize);
                resize();

                const onPointerMove = (e) => {
                    const x = e.clientX / window.innerWidth;
                    const y = e.clientY / window.innerHeight;
                    mouseTarget[0] = Math.min(Math.max(x, 0), 1);
                    mouseTarget[1] = Math.min(Math.max(y, 0), 1);
                };
                window.addEventListener('pointermove', onPointerMove);

                const render = (now) => {
                    const dt = Math.max(0, now - lastTime) * 0.001;
                    lastTime = now;
                    accumTime += dt;

                    // é¼ æ ‡å¹³æ»‘ç¼“åŠ¨æ’å€¼
                    mouseSmooth[0] += (mouseTarget[0] - mouseSmooth[0]) * 5.0 * dt;
                    mouseSmooth[1] += (mouseTarget[1] - mouseSmooth[1]) * 5.0 * dt;

                    gl.useProgram(program);
                    gl.bindVertexArray(vao);

                    gl.uniform2f(locs.iResolution, canvas.width, canvas.height);
                    gl.uniform1f(locs.iTime, accumTime);
                    gl.uniform2f(locs.uMouse, mouseSmooth[0], mouseSmooth[1]);
                    
                    gl.uniform3fv(locs.uLinesColor, hexToRgb01(propsRef.current.linesColor));
                    gl.uniform3fv(locs.uScanColor, hexToRgb01(propsRef.current.scanColor));

                    gl.drawArrays(gl.TRIANGLES, 0, 3);
                    animateId = requestAnimationFrame(render);
                };
                animateId = requestAnimationFrame(render);

                return () => {
                    cancelAnimationFrame(animateId);
                    window.removeEventListener('resize', resize);
                    window.removeEventListener('pointermove', onPointerMove);
                    if (ctn.contains(canvas)) ctn.removeChild(canvas);
                    gl.getExtension('WEBGL_lose_context')?.loseContext();
                };
            }, []);

            return <div ref={ctnDom} className="absolute inset-0 z-0 pointer-events-none" />;
        };

        const TimeWarpBackground = () => {
            return (
                <div className="absolute inset-0 overflow-hidden animate-in fade-in duration-1000">
                    <TimeWarpWebGL 
                        linesColor="#392e4e"  // å¯¹åº”æ–‡æ¡£è®¾å®šçš„æ·±ç©ºæš—ç´«ç½‘æ ¼çº¿
                        scanColor="#FF9FFC"   // å¯¹åº”æ–‡æ¡£è®¾å®šçš„éœ“è™¹å“çº¢é«˜å…‰æ‰«æè‰²
                    />
                    {/* å¢åŠ ä¸€äº›å‰æ™¯æ è¿‡çš„â€œæµå…‰æ˜Ÿè½¨â€ç²’å­æŸï¼Œå¼ºåŒ–å è½çš„é€Ÿåº¦æ„Ÿ */}
                    <div className="absolute top-[10%] left-[20%] w-[2px] h-[60px] bg-cyan-300 opacity-80 blur-[1px] animate-[pulse_0.4s_infinite] transform rotate-45 z-10"></div>
                    <div className="absolute top-[80%] right-[30%] w-[3px] h-[80px] bg-[#FF9FFC] opacity-60 blur-[1px] animate-[pulse_0.6s_infinite] transform -rotate-45 z-10"></div>
                    <div className="absolute top-[40%] right-[10%] w-[2px] h-[40px] bg-white opacity-90 blur-[1px] animate-[pulse_0.3s_infinite] transform rotate-12 z-10"></div>
                    <div className="absolute inset-0 bg-black opacity-10 pointer-events-none z-10"></div>
                </div>
            );
        };
		
		// --- æ–°å¢ï¼šè™šç©ºè·ƒè¿Â·è¶…å…‰é€Ÿå¼•æ“ç‰¹æ•ˆ (Hyperspeed çº¯åŸç”Ÿ WebGL æ— ä¾èµ–ç‰ˆ) ---
        const HYPERSPEED_VERT = `#version 300 es
			in vec2 position;
			void main() {
				gl_Position = vec4(position, 0.0, 1.0);
			}
			`;

					const HYPERSPEED_FRAG = `#version 300 es
			precision highp float;
			out vec4 fragColor;

			uniform vec2 uResolution;
			uniform float uTime;

			// ä¼ªéšæœºæ•°ç”Ÿæˆå™¨
			float rand(vec2 n) { 
				return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);
			}

			void main() {
				// æé€Ÿè·ƒè¿çš„å±å¹•éœ‡é¢¤æ•ˆåº” (Camera Shake)
				vec2 shake = vec2(sin(uTime * 50.0), cos(uTime * 45.0)) * 0.003;
				vec2 uv = (gl_FragCoord.xy - 0.5 * uResolution.xy) / uResolution.y + shake;
				
				float r = length(uv);
				float a = atan(uv.y, uv.x);
				
				// æåæ ‡è½¬ç›´è§’åæ ‡æ˜ å°„ï¼Œç”¨äºåˆ¶é€ æµå…‰æ— é™å è½æ‹‰ä¼¸
				vec2 polar = vec2(a / 6.28318, 0.2 / r);
				
				vec3 col = vec3(0.0);
				
				// å¤šå±‚è¶…å…‰é€Ÿæ˜Ÿè½¨å åŠ  (å¤šç»´ç©ºé—´å…‰æŸ)
				for (float i = 0.0; i < 4.0; i++) {
					float t = uTime * (5.0 + i * 2.5); // æé«˜çš„è·ƒè¿é€Ÿåº¦
					vec2 grid = vec2(polar.x * (40.0 + i * 15.0), polar.y + t);
					vec2 id = floor(grid);
					vec2 f = fract(grid);
					
					float n = rand(id + i * 10.0); // æ¯ä¸€é“å…‰æŸçš„éšæœºç§å­
					
					// ç»˜åˆ¶æ˜Ÿè½¨çº¿æ¡
					float xDist = abs(f.x - 0.5);
					float line = smoothstep(0.1 * n, 0.0, xDist);
					
					// å¤´éƒ¨é«˜äº®ä¸é•¿å°¾æ‹–å½±
					float tail = smoothstep(1.0, 0.1, f.y);
					float head = smoothstep(0.0, 0.05, f.y);
					
					// ç§‘å¹»æ›²ç‡è°ƒè‰²æ¿ (å†°è“ã€å“çº¢ã€çº¯ç™½)
					vec3 c1 = vec3(0.0, 0.8, 1.0);
					vec3 c2 = vec3(1.0, 0.2, 0.8);
					vec3 trailColor = mix(c1, c2, rand(id + 1.5));
					// è®¾å®š 15% çš„é«˜èƒ½çº¯ç™½å…‰æŸï¼Œå¢åŠ åˆºçœ¼æ„Ÿ
					trailColor = mix(trailColor, vec3(1.0), step(0.85, rand(id + 2.5))); 
					
					// å…‰æŸé è¿‘å±å¹•è¾¹ç¼˜ï¼ˆrè¾ƒå¤§ï¼‰æ—¶å˜äº®å¹¶äº§ç”Ÿç•¸å˜ï¼Œå®Œç¾æ¨¡æ‹Ÿ 3D é€è§†å†²åˆºæ„Ÿ
					float intensity = line * tail * head * r * 12.0 * step(0.4, n);
					
					col += trailColor * intensity;
				}
				
				// ä¸­å¿ƒæ›²ç‡å¼•æ“çš„æ·±é‚ƒå¼ºå…‰ (Warp Core)
				float core = smoothstep(0.35, 0.0, r);
				col += vec3(0.3, 0.6, 1.0) * core * (sin(uTime * 30.0) * 0.2 + 0.8);
				
				// è¾¹ç¼˜å¤±çœŸä¸æ¸æš—ç¼©æ”¾ (Vignette)
				col *= smoothstep(1.5, 0.0, r);
				
				fragColor = vec4(col, 1.0);
			}
			`;

        const HyperspeedWebGL = () => {
            const ctnDom = useRef(null);

            useEffect(() => {
                const ctn = ctnDom.current;
                if (!ctn) return;

                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.display = 'block';
                canvas.style.backgroundColor = '#000000'; // çº¯ç²¹çš„è™šç©ºé»‘
                ctn.appendChild(canvas);

                const gl = canvas.getContext('webgl2', { alpha: false, antialias: true });
                if (!gl) {
                    console.warn("è®¾å¤‡ä¸æ”¯æŒ WebGL2ï¼Œè¶…å…‰é€Ÿç‰¹æ•ˆæ— æ³•æ¸²æŸ“");
                    return;
                }

                const compileShader = (type, source) => {
                    const shader = gl.createShader(type);
                    gl.shaderSource(shader, source);
                    gl.compileShader(shader);
                    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
                    return shader;
                };

                const vs = compileShader(gl.VERTEX_SHADER, HYPERSPEED_VERT);
                const fs = compileShader(gl.FRAGMENT_SHADER, HYPERSPEED_FRAG);
                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);

                const locs = {
                    position: gl.getAttribLocation(program, 'position'),
                    uResolution: gl.getUniformLocation(program, 'uResolution'),
                    uTime: gl.getUniformLocation(program, 'uTime'),
                };

                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([ -1, -1,  3, -1,  -1, 3 ]), gl.STATIC_DRAW);

                const vao = gl.createVertexArray();
                gl.bindVertexArray(vao);
                gl.enableVertexAttribArray(locs.position);
                gl.vertexAttribPointer(locs.position, 2, gl.FLOAT, false, 0, 0);

                let animateId;
                let lastTime = performance.now();
                let accumTime = 0;

                const resize = () => {
                    const width = ctn.offsetWidth || window.innerWidth;
                    const height = ctn.offsetHeight || window.innerHeight;
                    const dpr = Math.min(window.devicePixelRatio || 1, 2);
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                };
                window.addEventListener('resize', resize);
                resize();

                const render = (now) => {
                    const dt = Math.max(0, now - lastTime) * 0.001;
                    lastTime = now;
                    accumTime += dt;

                    gl.useProgram(program);
                    gl.bindVertexArray(vao);

                    gl.uniform2f(locs.uResolution, canvas.width, canvas.height);
                    gl.uniform1f(locs.uTime, accumTime);

                    gl.drawArrays(gl.TRIANGLES, 0, 3);
                    animateId = requestAnimationFrame(render);
                };
                animateId = requestAnimationFrame(render);

                return () => {
                    cancelAnimationFrame(animateId);
                    window.removeEventListener('resize', resize);
                    if (ctn.contains(canvas)) ctn.removeChild(canvas);
                    gl.getExtension('WEBGL_lose_context')?.loseContext();
                };
            }, []);

            return <div ref={ctnDom} className="absolute inset-0 z-0 pointer-events-none" />;
        };

        const HyperspeedBackground = () => {
            return (
                <div className="absolute inset-0 overflow-hidden animate-in zoom-in duration-700">
                    <HyperspeedWebGL />
                    
                    {/* æ·»åŠ æé€Ÿè·ƒè¿æ—¶çš„å±å¹•è¾¹ç¼˜è¿åŠ¨æ¨¡ç³Šä¸æš—è§’ï¼Œæå‡æ²‰æµ¸ä¸é€Ÿåº¦æ„Ÿ */}
                    <div className="absolute inset-0 shadow-[inset_0_0_150px_rgba(0,0,0,0.9)] pointer-events-none z-10"></div>
                    
                    {/* æ¨¡æ‹Ÿè¿é¢ç ¸æ¥çš„è¶…å¤§æ˜Ÿè½¨æ®‹å½± */}
                    <div className="absolute top-[50%] left-[5%] w-[100px] h-[2px] bg-white opacity-40 blur-[2px] animate-[pulse_0.1s_infinite] transform -rotate-12 z-10"></div>
                    <div className="absolute top-[20%] right-[10%] w-[150px] h-[3px] bg-cyan-300 opacity-50 blur-[3px] animate-[pulse_0.15s_infinite] transform rotate-12 z-10"></div>
                </div>
            );
        };
		
        // --- æ–°å¢ï¼šé€šç”¨æ°”æ°›èƒŒæ™¯å±‚ç®¡ç†å™¨ ---
        // åç»­æ–°å¢å•†å“åªéœ€åœ¨è¿™é‡Œæ·»åŠ  case å³å¯
        const AtmosphereLayer = ({ type }) => {
            if (!type) return null;

            return (
                <div className="atmosphere-layer animate-in fade-in duration-1000">
                    {/* é“¶æ²³ç‰¹æ•ˆ */}
                    {type === 'bg_galaxy' && <GalaxyEffect />}
                    
                    {/* ã€æ–°å¢ã€‘æµæ˜Ÿé›¨ç‰¹æ•ˆ */}
                    {type === 'bg_meteor' && <MeteorShower />}
					
					{/* ã€æ–°å¢ã€‘æ¬§è‹¥æ‹‰æå…‰ç‰¹æ•ˆ */}
                    {type === 'bg_aurora' && <AuroraBorealis />}
					
					{/* ã€æ–°å¢ã€‘ä¸Šå…ƒç¯ç«ç‰¹æ•ˆ */}
                    {type === 'bg_lantern' && <LanternFestival />}
					
					{/* ã€æ–°å¢ã€‘è¤ç«ä¹‹æ£®ç‰¹æ•ˆ */}
                    {type === 'bg_firefly' && <FireflyForest />}
					
					{/* ã€æ–°å¢ã€‘é“¶æé›¨ç‰¹æ•ˆ */}
                    {type === 'bg_ginkgo' && <GinkgoRain />}
					
					{/* ã€æ–°å¢ã€‘ä¼ è¯´Â·ä¸‡è±¡å­—é˜µç‰¹æ•ˆ */}
                    {type === 'bg_matrix' && <MatrixCivilization />}
					
					{/* ã€æ–°å¢ã€‘ç§˜å¢ƒÂ·ç”²éª¨æµæ²™ç‰¹æ•ˆ */}
                    {type === 'bg_oraclesands' && <MatrixOracleSands />}
					
					{/* ã€æ–°å¢ã€‘æ–°æ˜¥é™å®šÂ·ç«æ ‘é“¶èŠ± */}
                    {type === 'bg_firework' && <LunarFireworks />}
					
					{/* æ–°å¢ï¼šç™»ç§‘Â·ç‰ç’ƒåå…‰ */}
                    {type === 'bg_prismatic' && <PrismaticBackground />}
					
					{/* æ–°å¢ï¼šçºªå…ƒè·ƒè¿Â·æ—¶å…‰éš§é“ */}
                    {type === 'bg_timewarp' && <TimeWarpBackground />}
					
					{/* æ–°å¢ï¼šè™šç©ºè·ƒè¿Â·è¶…å…‰é€Ÿå¼•æ“ */}
                    {type === 'bg_hyperspeed' && <HyperspeedBackground />}
                </div>
            );
        };

        const ShopModal = ({ show, onClose, theme, totalGold, currentEra, onBuy, inventory, onUse, activeBuffs, redeemedCoupons, equippedGear, stats, activeChild, initialTab = 'buy', holidayData, holidayForecast, setShowTributeModal }) => {
		if (!show) return null;
		const [activeTab, setActiveTab] = useState(initialTab); // buy, inventory, real
            const [buyCategory, setBuyCategory] = useState('all'); // all, tool, cosmetic, real, box

			// æ–°å¢ï¼šæ¯æ¬¡æ‰“å¼€å¼¹çª—æ—¶ï¼Œç¡®ä¿åˆ‡æ¢åˆ°å¯¹åº”çš„ç›®æ ‡æ ‡ç­¾
			useEffect(() => {
				if (show) setActiveTab(initialTab);
			}, [show, initialTab]);

            const eraOrder = ['è¿œå¤ä¹‹è·¯', 'æ–‡æ˜åˆæ›™', 'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹', 'å”Â·ç™»ç§‘ä¹‹è·¯'];
            const myEraIdx = eraOrder.indexOf(currentEra);

            // æ¯æ—¥ç‰¹æƒ é€»è¾‘ï¼šåŸºäºæ—¥æœŸç§å­çš„ä¼ªéšæœº
            const todayStr = getLocalDateKey(0);
            const dateSeed = todayStr.split('-').reduce((a,b)=>parseInt(a)+parseInt(b), 0);
            const discountIndex = dateSeed % SHOP_ITEMS.length;
            const discountItem = SHOP_ITEMS[discountIndex];

            // åŠ¨æ€ç‰©ä»·ï¼šé€šè´§è†¨èƒ€
            const inflationRate = totalGold > 2000 ? 1.1 : 1.0;

            const filteredItems = SHOP_ITEMS.filter(item => {
                if (buyCategory === 'all') return true;
                return item.category === buyCategory;
            });

            return (
                 <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-3xl w-full max-w-4xl h-[85vh] shadow-2xl flex flex-col overflow-hidden relative">
                        {/* å¤´éƒ¨ */}
                        <div className={`p-4 bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center shrink-0 shadow-lg z-10`}>
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-white/20 rounded-full text-2xl">ğŸª</div>
                                <div>
                                    <h2 className="text-xl font-black">æ—¶ç©ºé›†å¸‚</h2>
                                    <p className="text-white/80 text-xs flex items-center gap-2">
                                        <Coins className="w-4 h-4 text-yellow-300" /> ä½™é¢: <span className="font-bold text-yellow-200 text-lg">{totalGold}</span>
                                        {inflationRate > 1 && <span className="text-[10px] bg-red-500/80 px-1 rounded">ç‰©ä»·ä¸Šæ¶¨10%</span>}
                                    </p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors"><XIcon className="w-6 h-6" /></button>
                        </div>

                        {/* å¯¼èˆªæ  */}
                        <div className="flex p-2 bg-gray-50 border-b border-gray-200 gap-2 overflow-x-auto">
                            <button onClick={() => setActiveTab('buy')} className={`px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition-all ${activeTab === 'buy' ? 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200' : 'text-gray-400 hover:text-gray-600'}`}>ğŸ›’ é€‰è´­å•†å“</button>
                            <button onClick={() => setActiveTab('inventory')} className={`px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition-all ${activeTab === 'inventory' ? 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200' : 'text-gray-400 hover:text-gray-600'}`}>ğŸ’ æˆ‘çš„èƒŒåŒ…</button>
                            <button onClick={() => setActiveTab('coupons')} className={`px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition-all ${activeTab === 'coupons' ? 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200' : 'text-gray-400 hover:text-gray-600'}`}>ğŸ« å…‘æ¢è®°å½•</button>
							<button onClick={() => setShowTributeModal(true)} className="px-3 py-1.5 bg-gradient-to-r from-yellow-300 to-yellow-500 text-yellow-900 rounded-lg text-sm font-bold shadow hover:scale-105 transition-transform">ğŸ‘‘ å‹å¥½é‚¦é‚»è¿›è´¡</button>
                        </div>

                        {/* å†…å®¹åŒº */}
                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50 relative">
                             {/* è£…é¥°èƒŒæ™¯ */}
                             <div className="absolute top-0 left-0 w-full h-full opacity-5 pointer-events-none" style={{backgroundImage: 'radial-gradient(#64748b 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                             
                             {activeTab === 'buy' && (
                                 <>
                                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2 relative z-10">
                                        {[
                                            {k:'all', n:'å…¨éƒ¨'}, {k:'tool', n:'æ—¶ç©ºæ³•å®'}, {k:'cosmetic', n:'è£è€€è£…æ‰®'}, {k:'real', n:'ç°å®å…‘æ¢'}, {k:'box', n:'ç¥ç§˜ç›²ç›’'}
                                        ].map(c => (
                                            <button key={c.k} onClick={()=>setBuyCategory(c.k)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${buyCategory === c.k ? 'bg-indigo-600 text-white' : 'bg-white text-gray-500 border border-gray-200'}`}>{c.n}</button>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 relative z-0">
                                        {filteredItems.map(item => {
                                            const itemEraIdx = eraOrder.indexOf(item.era);
                                            const isLocked = itemEraIdx > myEraIdx;
                                            const isDiscounted = item.id === discountItem.id;
                                            const basePrice = Math.floor(item.price * inflationRate);
                                            const finalPrice = isDiscounted ? Math.floor(basePrice * 0.8) : basePrice;
                                            const canAfford = totalGold >= finalPrice;

											// --- ã€æ–°å¢ã€‘æ£€æŸ¥é™æ—¶é™åˆ¶ ---
											const restriction = checkItemRestriction(item, holidayForecast); // è°ƒç”¨ç¬¬ä¸€æ­¥å†™çš„å‡½æ•°
											const isRestricted = restriction.locked;        // æ˜¯å¦è¢«é™åˆ¶

											// ã€æ–°å¢ã€‘åˆ¤æ–­æ˜¯å¦å·²æ‹¥æœ‰ï¼ˆé’ˆå¯¹ç‰¹æ•ˆå’Œè£…æ‰®ï¼‰
											// ã€ä¿®æ”¹ã€‘æ›´ç²¾å‡†çš„å·²æ‹¥æœ‰åˆ¤æ–­
                                            let isOwned = false;
                                            // 1. çš‡å®¶ç¤¼ç‚®ï¼šæ£€æŸ¥ stats çŠ¶æ€ï¼Œæˆ–è€…èƒŒåŒ…é‡Œæœ‰æ²¡æœ‰
                                            if (item.type === 'cosmetic_confetti') {
                                                isOwned = stats[activeChild]?.premiumConfetti || (inventory[item.id] > 0);
                                            } 
                                            // 2. è£è€€è£…æ‰®/è§†è§‰ç‰¹æ•ˆç±»ï¼šåªè¦åˆ†ç±»ååŒ…å« 'cosmetic' (å¦‚ cosmetic_frame, cosmetic_bg) å°±ç®—
                                            else if (item.category && item.category.includes('cosmetic')) {
                                                // æ£€æŸ¥èƒŒåŒ…æ˜¯å¦æœ‰ï¼Œæˆ–è€…æ˜¯å¦å·²è£…å¤‡
                                                const hasInInventory = (inventory[item.id] || 0) > 0;
                                                
                                                // æ£€æŸ¥æ˜¯å¦åœ¨å·²è£…å¤‡åˆ—è¡¨ä¸­ (éå†èº«ä¸Šæ‰€æœ‰éƒ¨ä½)
                                                let isEquipped = false;
                                                if (equippedGear && equippedGear[activeChild]) {
                                                     isEquipped = Object.values(equippedGear[activeChild]).includes(item.id);
                                                }
                                                isOwned = hasInInventory || isEquipped;
                                            }

                                            return (
                                                <div key={item.id} className={`bg-white rounded-2xl p-4 border transition-all relative overflow-hidden group ${isLocked ? 'border-gray-200 opacity-70 grayscale' : 'border-gray-100 hover:shadow-lg hover:-translate-y-1'}`}>
                                                    {isLocked && (
                                                        <div className="absolute inset-0 z-20 bg-gray-100/60 backdrop-blur-[2px] flex flex-col items-center justify-center text-center p-4">
                                                            <Lock className="w-8 h-8 text-gray-400 mb-2" />
                                                            <p className="text-xs font-bold text-gray-500">éœ€è¦åˆ°è¾¾<br/>ã€Œ{item.era}ã€</p>
                                                        </div>
                                                    )}
                                                    {isDiscounted && !isLocked && <div className="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse z-10">æ¯æ—¥ç‰¹æƒ  -20%</div>}
                                                    
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-3xl shadow-sm ${isLocked ? 'bg-gray-200' : 'bg-gradient-to-br from-indigo-50 to-blue-50'}`}>{item.icon}</div>
                                                        <div className={`px-2 py-1 rounded-lg text-xs font-black border flex items-center gap-1 ${canAfford ? 'bg-yellow-50 text-amber-600 border-amber-100' : 'bg-gray-100 text-gray-400 border-gray-200'}`}>
                                                            <Coins className="w-3 h-3" /> {finalPrice}
                                                        </div>
                                                    </div>
                                                    
                                                    <h3 className="font-bold text-gray-800 text-sm mb-1">{isLocked && itemEraIdx > myEraIdx ? '???' : item.name}</h3>
                                                    <p className="text-xs text-gray-500 leading-relaxed mb-4 h-16 overflow-y-auto">{isLocked ? 'è¯¥ç‰©å“æ¥è‡ªæ›´é«˜ç­‰çš„æ–‡æ˜...' : item.desc}</p>
                                                    
                                                    <button 
														// å¢åŠ  !isRestricted åˆ¤æ–­ï¼Œé™åˆ¶æœŸé—´ä¸å¯ç‚¹å‡»
														onClick={() => !isLocked && canAfford && !isRestricted && onBuy(item, finalPrice)} 
														// å¢åŠ  isRestricted ç¦ç”¨æ¡ä»¶
														disabled={isLocked || !canAfford || isOwned || isRestricted} 
														className={`w-full py-2 rounded-xl font-bold text-xs transition-all active:scale-95 ${
															isLocked ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 
															isOwned ? 'bg-green-100 text-green-600 cursor-default border border-green-200' : 
															// ã€æ–°å¢ã€‘é™æ—¶æœªå¼€å¯çš„æ ·å¼ (æ·¡çº¢è‰²è­¦å‘Š)
															isRestricted ? 'bg-gray-100 text-red-400 cursor-not-allowed border border-red-100' : 
															canAfford ? `${theme.primaryBg} text-white shadow-md hover:brightness-110` : 
															'bg-gray-200 text-gray-400 cursor-not-allowed'
														}`}
													>
														{/* æŒ‰é’®æ–‡å­—æ˜¾ç¤ºä¼˜å…ˆçº§ï¼šæœªè§£é” > å·²æ‹¥æœ‰ > é™æ—¶æç¤º > è´­ä¹°/ä½™é¢ä¸è¶³ */}
														{isLocked ? 'æœªè§£é”' : isOwned ? 'å·²æ‹¥æœ‰' : isRestricted ? restriction.reason : canAfford ? 'è´­ä¹°' : 'å…ƒå®ä¸è¶³'}
													</button>
                                                </div>
                                            )
                                        })}
                                    </div>
                                 </>
                             )}

                             {activeTab === 'inventory' && (
                                <div className="space-y-6">
                                    {/* çŠ¶æ€å±•ç¤º */}
                                    <div className="p-4 bg-indigo-50 border border-indigo-100 rounded-2xl flex flex-wrap gap-2">
                                        <div className="w-full text-xs font-bold text-indigo-400 mb-1">å½“å‰çŠ¶æ€</div>
                                        {activeBuffs.xpBoost > 1 ? (
                                            <span className="px-3 py-1 bg-indigo-500 text-white rounded-full text-xs font-bold flex items-center gap-1"><Zap className="w-3 h-3" />ç»éªŒå€¼ x{activeBuffs.xpBoost} (å‰©{activeBuffs.xpBoostCount}æ¬¡)</span>
                                        ) : <span className="text-xs text-gray-400">æ— ç»éªŒåŠ æˆ</span>}
                                        {(inventory['item_shield'] || 0) > 0 ? (
                                            <span className="px-3 py-1 bg-emerald-500 text-white rounded-full text-xs font-bold flex items-center gap-1">ğŸ›¡ï¸ é’é“œç›¾å·²æ¿€æ´» (å‰©{inventory['item_shield']})</span>
                                        ) : <span className="text-xs text-gray-400">æ— é˜²å¾¡æŠ¤ç›¾</span>}
                                        {activeBuffs.luckyBuff ? (
                                            <span className="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-bold flex items-center gap-1">ğŸ€ å¹¸è¿åŠ æŒä¸­</span>
                                        ) : null}
                                        {activeBuffs.investMultiplier > 1 ? (
                                            <span className="px-3 py-1 bg-amber-500 text-white rounded-full text-xs font-bold flex items-center gap-1">ğŸ’° æŠ•èµ„å¡ x{activeBuffs.investMultiplier} (è‡³{activeBuffs.investExpire})</span>
                                        ) : null}
										{/* ã€æ–°å¢ã€‘æ˜¾ç¤ºçš‡å®¶ç¤¼ç‚®çŠ¶æ€ */}
                                        {(stats[activeChild]?.premiumConfetti) && (
                                            <span className="px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full text-xs font-bold flex items-center gap-1 shadow-sm">
                                                ğŸ† çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆå·²æ¿€æ´»
                                            </span>
                                        )}
                                    </div>
									
                                    {Object.keys(inventory).length === 0 ? (
                                        <div className="text-center py-10 text-gray-400">
                                            <div className="text-4xl mb-2 grayscale opacity-50">ğŸ’</div>
                                            <p className="text-sm">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»é›†å¸‚çœ‹çœ‹å§ï¼</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            {Object.entries(inventory).map(([itemId, count]) => {
                                                if (count <= 0) return null;
                                                const item = SHOP_ITEMS.find(i => i.id === itemId);
                                                if (!item) return null; // é˜²æ­¢æ—§æ•°æ®æŠ¥é”™
                                                const isAutoUse = ['passive_shield', 'real'].includes(item.type);
                                                
                                                // æ£€æŸ¥è£…å¤‡çŠ¶æ€
                                                // ã€ä¿®æ”¹ã€‘æ‰©å±•è£…å¤‡æ£€æŸ¥é€»è¾‘ï¼Œæ”¯æŒèƒŒæ™¯
                                                let gearType = 'other';
                                                if (item.type === 'cosmetic_frame') gearType = 'frame';
                                                else if (item.type === 'cosmetic_name') gearType = 'nameEffect';
                                                else if (item.type === 'cosmetic_bg') gearType = 'background';

                                                const isEquipped = equippedGear?.[gearType] === item.id;
                                                const isCosmetic = ['cosmetic_frame', 'cosmetic_name', 'cosmetic_bg'].includes(item.type);
												
                                                return (
                                                    <div key={itemId} className={`bg-white p-3 rounded-xl border flex flex-col gap-2 ${isEquipped ? 'border-indigo-300 ring-2 ring-indigo-50' : 'border-gray-100 shadow-sm'}`}>
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-xl ${isEquipped ? 'bg-indigo-100' : 'bg-gray-50'}`}>{item.icon}</div>
                                                                <div>
                                                                    <h4 className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                                        {item.name}
                                                                        {isEquipped && <span className="text-[10px] bg-indigo-500 text-white px-1.5 rounded-full">å·²è£…å¤‡</span>}
                                                                    </h4>
                                                                    <div className="text-xs text-gray-500">æ‹¥æœ‰: <span className="font-bold text-indigo-600">{count}</span></div>
                                                                </div>
                                                            </div>
                                                            <button 
                                                                onClick={() => onUse(item)}
                                                                className={`px-3 py-1.5 rounded-lg font-bold text-xs border transition-colors ${
                                                                    isAutoUse ? 'border-gray-200 text-gray-400 bg-gray-50 cursor-default' : 
                                                                    isEquipped ? 'border-green-200 text-green-600 bg-green-50 hover:bg-green-100' :
                                                                    'border-indigo-100 text-indigo-600 hover:bg-indigo-50'
                                                                }`}
                                                                disabled={isAutoUse}
                                                            >
                                                                {item.type === 'passive_shield' ? 'è‡ªåŠ¨ç”Ÿæ•ˆ' : 
                                                                 isCosmetic ? (isEquipped ? 'å·²è£…å¤‡' : 'è£…å¤‡') :
                                                                 item.type === 'real' ? 'åœ¨èƒŒåŒ…ä¸­' : 'ä½¿ç”¨'}
                                                            </button>
                                                        </div>
                                                        <p className="text-xs text-gray-500 leading-relaxed px-1 h-12 overflow-y-auto">{item.desc}</p>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    )}
                                </div>
                             )}

                             {activeTab === 'coupons' && (
                                 <div className="space-y-3">
                                     <p className="text-xs text-gray-500 bg-yellow-50 p-2 rounded border border-yellow-100">è¯·å‘å®¶é•¿å‡ºç¤ºæ­¤é¡µé¢è¿›è¡Œå¥–åŠ±æ ¸é”€ã€‚</p>
                                     {redeemedCoupons.length === 0 ? (
                                         <div className="text-center text-gray-400 py-10 text-sm">æš‚æ— å…‘æ¢è®°å½•</div>
                                     ) : (
                                         redeemedCoupons.slice().reverse().map((coupon, idx) => (
                                             <div key={idx} className="bg-white p-3 rounded-xl border border-dashed border-gray-300 flex items-center justify-between relative overflow-hidden">
                                                 <div className="absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-slate-50 rounded-full"></div>
                                                 <div className="absolute -right-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-slate-50 rounded-full"></div>
                                                 <div className="flex gap-3 items-center">
                                                     <div className="text-2xl grayscale opacity-80">{coupon.icon}</div>
                                                     <div>
                                                         <div className="font-bold text-gray-800 text-sm">{coupon.name}</div>
                                                         <div className="text-[10px] text-gray-400">{coupon.date}</div>
                                                     </div>
                                                 </div>
                                                 <div className="text-xs font-bold text-green-600 border border-green-200 px-2 py-0.5 rounded bg-green-50">æœ‰æ•ˆå‡­è¯</div>
                                             </div>
                                         ))
                                     )}
                                 </div>
                             )}
                        </div>
                    </div>
                 </div>
            );
        };

        // NPC ç»„ä»¶ (æ–°å¢)
        const ShopNPC = ({ onClick, currentEra }) => {
            const [message, setMessage] = useState('');
            const [showBubble, setShowBubble] = useState(false);

            const messages = {
                'è¿œå¤ä¹‹è·¯': [
                    'æƒ³è¦ç‚¹ç«ç§å—ï¼Ÿ', 'è¿™æ ¹é•¿çŸ›å¾ˆé€‚åˆä½ ï¼', 'æ™šä¸Šçš„é‡å…½å¾ˆå‡¶çŒ›å“¦ã€‚',
                    'å†°æ²³ä¸–çºªå›¾è…¾èƒ½è®©ä½ ä¼‘æ¯ä¸€å¤©ï¼', 'ä¸°æ”¶çš„çŸ³æ–§ï¼ŒæŠ•èµ„å¥½å¸®æ‰‹ï¼',
                    'çœ‹çœ‹è¿™ä¸ªç¥ç¬”é©¬è‰¯ä½“éªŒåˆ¸ï¼', 'ç«æŠ€åœºæŒ‘æˆ˜ä¹¦ï¼Œæ•¢æ¥æ¯”è¯•å—ï¼Ÿ'
                ],
                'æ–‡æ˜åˆæ›™': [
                    'æ–°å‡ºç‚‰çš„é™¶å™¨çœ‹çœ‹å—ï¼Ÿ', 'éƒ¨è½éœ€è¦ä½ çš„è´¡çŒ®ã€‚', 'é’é“œç›¾å¯æ˜¯å¥½ä¸œè¥¿ã€‚',
                    'ç‚¼é‡‘æœ¯å£«çš„è¯•ç®¡ï¼Œè½¬åŒ–ç»éªŒå€¼ï¼', 'ç”²éª¨æ–‡ä¼ ä¹¦ï¼Œç•™ä¸‹ä½ çš„è¯ï¼',
                    'é’é“œå•†è´¸ä»¤ï¼Œ3å€æ”¶ç›Šï¼', 'åæ‚”è¯æ°´ï¼Œä¹°é”™äº†å¯ä»¥é€€å“¦ï¼'
                ],
                'å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹': [
                    'å®¢å®˜ï¼Œé‡Œé¢è¯·ï¼', 'å¾æœ‰è‰¯è¯ï¼Œå¯è§£å¿§æ„ã€‚', 'ç¤¼ä¹å´©åï¼Œå”¯æœ‰è¯»ä¹¦é«˜ã€‚',
                    'å‹å¥½é‚»é‚¦è¿›è´¡ï¼Œé€ç»™å‹å¥½é‚¦é‚»å…ƒå®å§ï¼', 'ä¹¦é¦™é—¨ç¬¬è´­ä¹¦åˆ¸ï¼Œè¯»ä¹¦å¥½å¤„å¤šï¼',
                    'èšå®ç›†ï¼Œ4å€æ”¶ç›Šï¼', 'å­”å¤«å­çš„æˆ’å°ºï¼Œç›‘ç£å®¶é•¿ç”¨ï¼',
                    'çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆï¼Œè®©æ‰“å¡æ›´ç‚«é…·ï¼'
                ],
                'å”Â·ç™»ç§‘ä¹‹è·¯': [
                    'å®¢å®˜è¿˜æ²¡ç¡ï¼Ÿæ¥ä¸ª"å…ä½œä¸šé‡‘ç‰Œ"ï¼Ÿ', 'ä¸œè¥¿å¸‚çš„æ–°è´§åˆ°äº†ï¼', 'å¬è¯´è¥¿åŸŸæ¥äº†å¥½ä¸œè¥¿ã€‚',
                    'å¹¸è¿åŠ æŒç¬¦ï¼Œè½¬ç›˜å¤§å¥–ç‡æå‡ï¼', 'å¾¡è†³æˆ¿ç‚¹èœæ—¨æ„ï¼Œä»Šæ™šåƒä»€ä¹ˆä½ è¯´äº†ç®—ï¼',
                    'ä¸Šå…ƒèŠ‚å¤œæ¸¸ä»¤ï¼Œå¤šç©30åˆ†é’Ÿï¼', 'å¼€å…ƒé€šå®é“¸å¸æƒï¼Œ5å€æ”¶ç›Šï¼',
                    'ä¸ç»¸ä¹‹è·¯å¯»å®å›¾ï¼Œè§£é”éšè—ä¸»é¢˜ï¼', 'èµ›åšæœ‹å…‹ä¸»é¢˜ï¼Œæœªæ¥ç§‘æŠ€æ„Ÿï¼'
                ]
            };

            // éšæœºè‡ªåŠ¨å¼¹å‡ºå¯¹è¯
            useEffect(() => {
                const randomTrigger = () => {
                    if (Math.random() < 0.3) { // 30%æ¦‚ç‡è§¦å‘
                        const eraMsgs = messages[currentEra] || messages['è¿œå¤ä¹‹è·¯'];
                        const msg = eraMsgs[Math.floor(Math.random() * eraMsgs.length)];
                        setMessage(msg);
                        setShowBubble(true);
                        setTimeout(() => setShowBubble(false), 4000);
                    }
                };
                
                const interval = setInterval(randomTrigger, 15000); // æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡
                return () => clearInterval(interval);
            }, [currentEra, messages]);

            const handleClick = () => {
                const eraMsgs = messages[currentEra] || messages['è¿œå¤ä¹‹è·¯'];
                const msg = eraMsgs[Math.floor(Math.random() * eraMsgs.length)];
                setMessage(msg);
                setShowBubble(true);
                onClick();
                setTimeout(() => setShowBubble(false), 3000);
            };

            return (
                <div className="fixed bottom-4 left-4 z-[100] flex items-end gap-2 cursor-pointer group npc-float">
                    {showBubble && (
                        <div className="bg-white px-3 py-2 rounded-xl rounded-bl-none shadow-lg text-xs font-bold text-gray-700 mb-2 animate-in fade-in slide-in-from-bottom-2 border border-gray-100 max-w-[180px]">
                            {message}
                        </div>
                    )}
                    <div onClick={handleClick} className="w-14 h-14 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 border-2 border-white shadow-lg flex items-center justify-center text-2xl transform transition-transform group-hover:scale-110">
                        ğŸ§™â€â™‚ï¸
                    </div>
                </div>
            );
        };

        // éšæœºäº‹ä»¶å¼¹çª—
        const RandomEventModal = ({ show, eventData, onClose, theme }) => {
            if (!show || !eventData) return null;
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-300" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative animate-in zoom-in-95 duration-300 animate-float" onClick={e => e.stopPropagation()}>
                        <div className={`h-32 bg-gradient-to-br ${ERA_INFOS[eventData.era]?.textGradient || theme.gradient} relative flex items-center justify-center overflow-hidden`}>
                            <div className="absolute inset-0 bg-white/10 mix-blend-overlay"></div>
                            <div className="text-6xl animate-bounce drop-shadow-lg filter backdrop-brightness-110">
                                {eventData.rewardType === 'gold' ? 'ğŸº' : 'ğŸ“œ'}
                            </div>
                            <div className="absolute bottom-2 right-2 text-white/50 text-xs font-bold tracking-widest uppercase">{eventData.era}</div>
                        </div>
                        <div className="p-6 text-center">
                            <h3 className="text-sm font-bold text-indigo-500 tracking-widest uppercase mb-1 flex items-center justify-center gap-1">
                                <Sparkles className="w-4 h-4" /> æ—¶ç©ºå¥‡é‡
                            </h3>
                            <h2 className="text-2xl font-black text-gray-800 mb-4">{eventData.title}</h2>
                            <p className="text-gray-600 leading-relaxed text-sm mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100 text-justify">
                                {eventData.desc}
                            </p>
                            <div className="mb-6 flex justify-center">
                                <div className={`px-6 py-2 rounded-full font-bold text-lg flex items-center gap-2 shadow-sm ${eventData.rewardType === 'gold' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'}`}>
                                    {eventData.rewardType === 'gold' ? '+' + eventData.rewardValue + ' é‡‘å…ƒå®' : '+' + eventData.rewardValue + ' XP'}
                                </div>
                            </div>
                            <button onClick={onClose} className={`w-full py-3 rounded-xl text-white font-bold shadow-lg transform active:scale-95 transition-all ${theme.primaryBg} ${theme.primaryBgHover}`}>
                                æ”¶ä¸‹è¿™ä»½é¦ˆèµ 
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å‡çº§é€šçŸ¥å¼¹çª—
        const LevelUpNotification = ({ show, onClose, levelInfo }) => {
            if (!show || !levelInfo) return null;
            return (
                 <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-500" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl flex flex-col items-center text-center relative overflow-hidden animate-level-up" onClick={e => e.stopPropagation()}>
                         <div className="absolute inset-0 bg-gradient-to-br from-yellow-100 to-white -z-10"></div>
                         <div className="text-4xl mb-4 animate-bounce">ğŸ†™</div>
                         <h2 className="text-2xl font-black text-gray-800 mb-2">è¿›åŒ–æˆåŠŸï¼</h2>
                         <p className="text-gray-500 mb-6">æ­å–œï¼ä½ å·²è¿›åŒ–ä¸º</p>
                         <div className={`text-3xl font-black mb-2 ${ERA_COLORS[levelInfo.era].text.replace('100', '600')}`}>{levelInfo.name}</div>
                         <div className={`px-3 py-1 rounded-full text-xs font-bold text-white mb-6 ${ERA_COLORS[levelInfo.era].bg}`}>Lv.{levelInfo.level} {levelInfo.era}</div>
                         <p className="text-gray-600 text-sm font-medium mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100 italic">"{levelInfo.desc}"</p>
                         <button onClick={onClose} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold shadow-lg hover:scale-105 transition-transform cursor-pointer">ç»§ç»­å¾ç¨‹</button>
                    </div>
                 </div>
            );
        };

        // è¿›åŒ–ä¹‹è·¯æ—¶é—´è½´
        const EvolutionPathModal = ({ show, onClose, currentXP, theme }) => {
            if (!show) return null;
            const currentLevel = getLevelInfo(currentXP);
            const groupedLevels = getLevelsByEra();
            
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in fade-in zoom-in duration-200">
                    <div className="bg-white rounded-3xl w-full max-w-4xl h-[90vh] shadow-2xl flex flex-col overflow-hidden relative">
                         <div className={`p-6 bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center shrink-0 shadow-lg relative z-10`}>
                            <div>
                                <h2 className="text-2xl font-black flex items-center gap-2"><TrendingUp className="w-8 h-8" /> è¿›åŒ–ä¹‹è·¯</h2>
                                <p className="text-white/90 text-xs mt-1">å½“å‰ç»éªŒ: {currentXP} XP (Lv.{currentLevel.level} {currentLevel.name})</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors"><XIcon className="w-6 h-6" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 bg-gray-50 scroll-smooth relative">
                            {Object.entries(groupedLevels).map(([era, levels]) => (
                                <div key={era} className="mb-8">
                                    {/* çºªå…ƒå¤´éƒ¨å¡ç‰‡ */}
                                    <div className={`rounded-xl overflow-hidden shadow-sm mb-4 border ${ERA_INFOS[era].border}`}>
                                        <div className={`p-4 ${ERA_INFOS[era].bg}`}>
                                            <h3 className={`text-xl font-black ${ERA_INFOS[era].color} flex items-center gap-2`}>
                                                <span className={`w-3 h-3 rounded-full ${ERA_COLORS[era].bg}`}></span>
                                                {era}
                                            </h3>
                                            <p className={`text-sm mt-1 ${ERA_INFOS[era].color} opacity-80`}>{ERA_INFOS[era].desc}</p>
                                        </div>
                                        {/* ç­‰çº§åˆ—è¡¨ */}
                                        <div className="bg-white p-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {levels.map((lvl) => {
                                                const isUnlocked = currentXP >= lvl.xp;
                                                const isCurrent = currentLevel.level === lvl.level;
                                                const eraColor = ERA_COLORS[lvl.era];
                                                
                                                let barWidth = '0%';
                                                if (currentXP >= lvl.xp) {
                                                    barWidth = '100%';
                                                } else if (lvl.level === currentLevel.level + 1) {
                                                    const prevXP = currentLevel.xp;
                                                    const total = lvl.xp - prevXP;
                                                    const current = currentXP - prevXP;
                                                    const p = Math.max(0, Math.min(100, Math.floor((current / total) * 100)));
                                                    barWidth = `${p}%`;
                                                }

                                                return (
                                                    <div key={lvl.level} className={`relative p-3 rounded-lg border transition-all ${isCurrent ? `border-${theme.id === 'yoly' ? 'rose' : 'sky'}-400 ring-2 ring-${theme.id === 'yoly' ? 'rose' : 'sky'}-100 bg-${theme.id === 'yoly' ? 'rose' : 'sky'}-50` : isUnlocked ? 'border-gray-200 bg-white' : 'border-gray-100 bg-gray-50 opacity-60'}`}>
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`text-xs font-bold px-2 py-0.5 rounded-full text-white ${eraColor.bg}`}>Lv.>Lv.{lvl.level}</span>
                                                                <h4 className={`font-bold text-gray-800`}>{lvl.name}</h4>
                                                            </div>
                                                            {isCurrent && <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold animate-pulse">å½“å‰</span>}
                                                        </div>
                                                        <p className="text-xs text-gray-500 leading-snug mb-2 min-h-[2.5em]">{lvl.desc}</p>
                                                        <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                                            <div className={`h-full ${eraColor.bg}`} style={{width: barWidth}}></div>
                                                        </div>
                                                        <div className="text-[10px] text-gray-400 text-right mt-1">{lvl.xp} XP</div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        // é‡‘å…ƒå®æ˜ç»†å¼¹çª—
        const GoldHistoryModal = ({ show, onClose, transactions, theme }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                        <div className={`p-4 border-b bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center rounded-t-2xl shrink-0 shadow-md`}>
                            <h3 className="font-bold flex items-center gap-2 text-lg"><FileText className="w-5 h-5" /> é‡‘å…ƒå®æ˜ç»†</h3>
                            <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full transition-colors"><XIcon className="w-6 h-6" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                            {transactions.length === 0 ? (
                                <div className="text-center text-gray-400 py-10">æš‚æ— è®°å½•</div>
                            ) : (
                                <div className="space-y-2">
                                    {transactions.map((t) => (
                                        <div key={t.id} className="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                                            <div>
                                                <div className="font-bold text-gray-800 text-sm">{t.name}</div>
                                                <div className="text-xs text-gray-400">{t.date}</div>
                                            </div>
                                            <div className={`font-black text-lg ${t.amount >= 0 ? 'text-amber-500' : 'text-red-500'}`}>
                                                {t.amount > 0 ? '+' : ''}{t.amount}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="p-3 border-t bg-gray-50 text-center text-xs text-gray-400 rounded-b-2xl shrink-0">
                            ä»…å±•ç¤ºè¿‘æœŸè®°å½•
                        </div>
                    </div>
                </div>
            );
        };

        // ç»éªŒå€¼æ˜ç»†å¼¹çª—
        const XPHistoryModal = ({ show, onClose, xpTransactions, theme }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                        <div className={`p-4 border-b bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center rounded-t-2xl shrink-0 shadow-md`}>
                            <h3 className="font-bold flex items-center gap-2 text-lg"><BookOpen className="w-5 h-5" /> ç»éªŒå€¼æ˜ç»†</h3>
                            <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full transition-colors"><XIcon className="w-6 h-6" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                            {xpTransactions.length === 0 ? (
                                <div className="text-center text-gray-400 py-10">æš‚æ— è®°å½•</div>
                            ) : (
                                <div className="space-y-2">
                                    {xpTransactions.map((t) => (
                                        <div key={t.id} className="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                                            <div>
                                                <div className="font-bold text-gray-800 text-sm">{t.name}</div>
                                                <div className="text-xs text-gray-400">{t.date}</div>
                                            </div>
                                            <div className="font-black text-lg text-blue-500">
                                                +{t.amount} XP
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="p-3 border-t bg-gray-50 text-center text-xs text-gray-400 rounded-b-2xl shrink-0">
                            è®°å½•æˆé•¿ç‚¹æ»´
                        </div>
                    </div>
                </div>
            );
        };

        const ThemeSelectionModal = ({ show, onClose, currentTheme, onSelectTheme }) => {
            if (!show) return null;
            
            const handleClose = () => {
                onClose(true); 
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl animate-in zoom-in-95">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">é€‰æ‹©ä¸ªæ€§ä¸»é¢˜</h3>
                            <button onClick={handleClose}><XIcon className="w-5 h-5 text-gray-400 hover:text-gray-600" /></button>
                        </div>
                        <div className="grid grid-cols-5 gap-3">
                            {Object.values(COLOR_PALETTES).map(p => (
                                <button key={p.id} onClick={() => onSelectTheme(p.id)} className={`flex flex-col items-center gap-2 group`}>
                                    <div className={`w-12 h-12 rounded-full border-4 transition-all shadow-sm ${p.primaryBg} ${currentTheme.id === p.id ? 'border-gray-800 scale-110 shadow-lg' : 'border-transparent group-hover:scale-105'}`}></div>
                                    <span className={`text-xs font-bold ${currentTheme.id === p.id ? 'text-gray-800' : 'text-gray-400'}`}>{p.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        // ä¿®æ”¹ç»„ä»¶å‚æ•°ï¼Œæ¥æ”¶æ–°å¢çš„ props
        const AchievementWallModal = ({ show, onClose, achievements, theme, checkins, tasks, activeChild, wheelHistory, stats, totalGold }) => {
            if (!show) return null;
            const categories = ['è£è€€', 'æ¯…åŠ›', 'æ•ˆç‡', 'ç²¾é€š', 'è´¢å¯Œ', 'æ¢ç´¢'];

            // --- æ–°å¢ï¼šè¿›åº¦è®¡ç®—é€»è¾‘ ---
            const getBadgeProgress = (badgeId) => {
                const childCheckins = checkins?.[activeChild] || {};
                const childTasks = tasks?.[activeChild] || [];
                
                // è¾…åŠ©ï¼šç»Ÿè®¡æ€»æ‰“å¡æ•°
                const totalCheckinsCount = Object.values(childCheckins).reduce((sum, taskRecord) => sum + Object.keys(taskRecord).length, 0);
                
                // è¾…åŠ©ï¼šç»Ÿè®¡ç‰¹å®šå­¦ç§‘æ‰“å¡æ•° (æ­£åˆ™åŒ¹é…ä»»åŠ¡å)
                const getSubjectCount = (regex) => {
                    let count = 0;
                    Object.entries(childCheckins).forEach(([taskId, dates]) => {
                        const taskName = childTasks.find(t => t.id === taskId)?.name || '';
                        if (regex.test(taskName)) count += Object.keys(dates).length;
                    });
                    return count;
                };

                // è¾…åŠ©ï¼šè®¡ç®—æœ€å¤§è¿ç»­å¤©æ•° (ç®€åŒ–ç‰ˆ)
                const getMaxStreak = () => {
                    const allDates = [];
                    Object.values(childCheckins).forEach(dates => allDates.push(...Object.keys(dates)));
                    const uniqueDates = [...new Set(allDates)].sort();
                    if (uniqueDates.length === 0) return 0;
                    let maxStreak = 0;
                    let currentStreak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const d1 = new Date(uniqueDates[i-1]);
                        const d2 = new Date(uniqueDates[i]);
                        const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
                        if (Math.round(diff) === 1) currentStreak++;
                        else { maxStreak = Math.max(maxStreak, currentStreak); currentStreak = 1; }
                    }
                    return Math.max(maxStreak, currentStreak);
                };
				
				// ğŸŸ¢ã€æ–°å¢ã€‘è¾…åŠ©ï¼šè®¡ç®—æŠ•èµ„è¾¾äººé¢å¤–æ”¶ç›Š (ç”¨äºè¿›åº¦æ¡å±•ç¤º)
                const getInvestmentStats = () => {
                    let extraInvestIncome = 0;
                    // éå†å½“å‰çš„è´¦å•è®°å½•
                    Object.keys(wheelHistory || {}).forEach(key => {
                        if (key.startsWith(`${activeChild}-TASK-`)) {
                            const parts = key.split('-');
                            const taskId = parts[2];
                            // childTasks åœ¨æœ¬å‡½æ•°ä½œç”¨åŸŸä¸Šæ–‡å·²å®šä¹‰
                            const task = childTasks.find(t => t.id === taskId);
                            const amount = wheelHistory[key];
                            
                            // å¦‚æœå®é™…è·å¾—é‡‘é¢ > åŸºç¡€å¥–åŠ±ï¼Œè¯´æ˜åƒåˆ°äº†æŠ•èµ„å¡å€ç‡
                            if (task && amount > task.reward) {
                                extraInvestIncome += (amount - task.reward);
                            }
                        }
                    });
                    return extraInvestIncome;
                };

				// è¾…åŠ©ï¼šè®¡ç®—æ¶ˆè´¹ç»Ÿè®¡æ•°æ® (ç”¨äºè¿›åº¦æ¡å±•ç¤º)
				const getSpendingStats = () => {
					let total = 0;
					let count = 0;
					let max = 0;
					Object.keys(wheelHistory || {}).forEach(key => {
						if (key.startsWith(`${activeChild}-`) && wheelHistory[key] < 0) {
							const val = Math.abs(wheelHistory[key]);
							total += val;
							count++;
							if (val > max) max = val;
						}
					});
					return { total, count, max };
				};
				const spendingStats = getSpendingStats(); // æ‰§è¡Œè®¡ç®—
                // æ ¹æ® Badge ID è¿”å›è¿›åº¦å¯¹è±¡ { current, target }
                switch (badgeId) {
                    case 'perfect_10': return { current: totalCheckinsCount, target: 10 };
                    case 'steeled': return { current: totalCheckinsCount, target: 100 };
                    case 'accumulation': return { current: totalCheckinsCount, target: 300 };
                    case 'persistence': return { current: getMaxStreak(), target: 7 };
                    case 'iron_will': return { current: getMaxStreak(), target: 14 };
                    case 'marathon': return { current: getMaxStreak(), target: 25 };
                    case 'weekend_warrior': return { current: stats?.[activeChild]?.weekendStreak || 0, target: 2 };
                    case 'repair_master': return { current: stats?.[activeChild]?.repair_count || 0, target: 5 };

                    // === ä¿®å¤è‹±è¯­åŒ¹é…ï¼šå¢åŠ â€œè¯â€ã€â€œå¬åŠ›â€ã€â€œå£è¯­â€ã€â€œRazâ€ç­‰ ===
                    case 'english_ace': return { current: getSubjectCount(/è‹±|å•è¯|è¯|è¯‘|å¬åŠ›|å£è¯­|raz|en|english/i), target: 20 };
                    case 'translation_master': return { current: getSubjectCount(/è‹±|å•è¯|è¯|è¯‘|å¬åŠ›|å£è¯­|raz|en|english/i), target: 50 };
                    case 'language_lord': return { current: getSubjectCount(/è‹±|å•è¯|è¯|è¯‘|å¬åŠ›|å£è¯­|raz|en|english/i), target: 100 };
                    
                    // === ä¿®å¤ç§‘å­¦åŒ¹é…ï¼šå¢åŠ â€œç¨‹â€(ç¼–ç¨‹)ã€â€œç”Ÿâ€(ç”Ÿç‰©)ã€â€œæœºå™¨â€ç­‰ ===
                    case 'science_star': return { current: getSubjectCount(/ç§‘|å®éªŒ|ç‰©ç†|åŒ–|ç”Ÿ|åœ°|ç¨‹|æœºå™¨|ç™¾ç§‘|stem/i), target: 20 };
                    case 'future_inventor': return { current: getSubjectCount(/ç§‘|å®éªŒ|ç‰©ç†|åŒ–|ç”Ÿ|åœ°|ç¨‹|æœºå™¨|ç™¾ç§‘|stem/i), target: 50 };
                    case 'science_titan': return { current: getSubjectCount(/ç§‘|å®éªŒ|ç‰©ç†|åŒ–|ç”Ÿ|åœ°|ç¨‹|æœºå™¨|ç™¾ç§‘|stem/i), target: 100 };

                    // === é¡ºä¾¿ä¼˜åŒ–è¯­æ–‡å’Œæ•°å­¦ï¼Œä¿æŒä¸€è‡´ ===
                    case 'chinese_master': return { current: getSubjectCount(/è¯­|æ–‡|è¯»|èƒŒ|å†™å­—|å¤è¯—|ç»ƒå­—/), target: 20 };
                    case 'literary_giant': return { current: getSubjectCount(/è¯­|æ–‡|è¯»|èƒŒ|å†™å­—|å¤è¯—|ç»ƒå­—/), target: 50 };
                    case 'literary_grandmaster': return { current: getSubjectCount(/è¯­|æ–‡|è¯»|èƒŒ|å†™å­—|å¤è¯—|ç»ƒå­—/), target: 100 };
                    
                    case 'math_whiz': return { current: getSubjectCount(/æ•°|ç®—|é€»è¾‘|å¥¥|åŸ¹ä¼˜|æ€ç»´/), target: 20 };
                    case 'logic_master': return { current: getSubjectCount(/æ•°|ç®—|é€»è¾‘|å¥¥|åŸ¹ä¼˜|æ€ç»´/), target: 50 };
                    case 'math_god': return { current: getSubjectCount(/æ•°|ç®—|é€»è¾‘|å¥¥|åŸ¹ä¼˜|æ€ç»´/), target: 100 };
					
                    case 'artist': return { current: getSubjectCount(/çµç¶|ç´|ç”»|éŸ³|æ£‹|ä¹¦|èˆ|ç¾/), target: 20 };
					// æŠ•èµ„è¾¾äººè¿›åº¦æ¡é…ç½®
					case 'investment_guru': return { current: getInvestmentStats(), target: 500 };

                    case 'first_pot': return { current: totalGold, target: 100 };
                    case 'tycoon': return { current: totalGold, target: 1000 };
                    case 'wealthy': return { current: totalGold, target: 5000 };
                    case 'midas_touch': return { current: totalGold, target: 2000 };
                    case 'big_spender': return { current: spendingStats.total, target: 500 };
					case 'money_bags': return { current: spendingStats.total, target: 2000 };
					case 'whale_player': return { current: spendingStats.total, target: 5000 };
					case 'market_owner': return { current: spendingStats.total, target: 10000 };

					case 'shopaholic': return { current: spendingStats.count, target: 10 };
					case 'hand_chopper': return { current: spendingStats.count, target: 50 };
					case 'cart_clearer': return { current: spendingStats.count, target: 100 };

					case 'high_roller': return { current: spendingStats.max, target: 100 };
					case 'diamond_hands': return { current: spendingStats.max, target: 300 };
					case 'bankruptcy': return { current: spendingStats.max, target: 800 };

                    case 'early_bird': return { current: stats?.[activeChild]?.early_bird_count || 0, target: 3 };

					case 'collector': return { 
						current: stats?.[activeChild]?.usedThemes?.length || 0, 
						target: Object.keys(COLOR_PALETTES).length 
					};

                    default: return null;
                }
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in fade-in zoom-in duration-200">
                    <div className="bg-white rounded-3xl w-full max-w-5xl h-[90vh] shadow-2xl flex flex-col overflow-hidden relative">
                        <div className={`p-6 bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center shrink-0 shadow-lg relative z-10`}>
                            <div>
                                <h2 className="text-3xl font-black flex items-center gap-3 drop-shadow-md"><Trophy className="w-10 h-10 text-yellow-300 drop-shadow-sm" /> æˆå°±è£èª‰å¢™</h2>
                                <p className="text-white/90 text-sm mt-1 font-medium tracking-wide">æ”¶é›†å¾½ç« ï¼Œè§è¯ä½ çš„æ¯ä¸€æ¬¡æˆé•¿ï¼</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors backdrop-blur-sm"><XIcon className="w-8 h-8 text-white" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 bg-gray-50 scroll-smooth">
                            {categories.map(cat => {
                                const catTheme = ACHIEVEMENT_THEMES[cat] || ACHIEVEMENT_THEMES['æ¯…åŠ›'];
                                return (
                                    <div key={cat} className={`mb-8 rounded-2xl ${catTheme.bg} border ${catTheme.border} p-5 shadow-sm`}>
                                        <h3 className={`text-xl font-black mb-6 flex items-center gap-2 ${catTheme.title}`}><span className="w-2 h-6 rounded-full bg-current"></span>{cat}ç³»åˆ—</h3>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                            {BADGES.filter(b => b.category === cat).map(badge => {
                                                const isUnlocked = achievements[badge.id];
                                                const rarity = RARITY_COLORS[badge.rarity];
                                                const isSecret = badge.category === 'æ¢ç´¢' && !isUnlocked;
                                                
                                                // è·å–è¿›åº¦æ•°æ®
                                                const progress = !isUnlocked && !isSecret ? getBadgeProgress(badge.id) : null;
                                                const percent = progress ? Math.min(100, Math.floor((progress.current / progress.target) * 100)) : 0;

                                                return (
                                                    <div key={badge.id} className={`group relative flex flex-col items-center p-4 rounded-xl border transition-all duration-300 ${isUnlocked ? 'bg-white border-white shadow-lg scale-100 ring-1 ring-black/5' : 'bg-white/60 border-transparent shadow-none opacity-80 grayscale hover:grayscale-0 hover:scale-105 hover:bg-white hover:shadow-md'}`}>
                                                        <div className={`absolute top-2 right-2 text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm ${isUnlocked ? rarity.badge : 'bg-gray-200 text-gray-400'}`}>{rarity.name}</div>
                                                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 text-4xl shadow-inner transition-transform duration-500 group-hover:rotate-12 ${isUnlocked ? (badge.rarity === 'legendary' ? 'badge-legendary shadow-purple-300' : `${catTheme.iconBg}`) : 'bg-gray-200 text-gray-300'}`}>
                                                            {isUnlocked ? (badge.rarity === 'legendary' ? 'ğŸ‘‘' : badge.rarity === 'epic' ? 'ğŸŒŸ' : badge.rarity === 'rare' ? 'ğŸ’' : 'ğŸ…') : (isSecret ? 'â“' : <Lock className="w-8 h-8" />)}
                                                        </div>
                                                        <h4 className={`font-bold text-base text-center mb-1 ${isUnlocked ? 'text-gray-800' : 'text-gray-500'}`}>{badge.name}</h4>
                                                        
                                                        {/* --- åŸè¯´æ˜æ–‡å­— (ä¿ç•™) --- */}
                                                        <div className={`text-xs text-center leading-tight px-1 h-8 flex items-center justify-center ${isUnlocked ? 'text-gray-500' : 'text-gray-400 italic'}`}>
                                                            {isSecret ? '??? (ç¥ç§˜éšè—æˆå°±)' : badge.desc}
                                                        </div>

                                                        {/* --- æ–°å¢ï¼šè¿›åº¦æ¡ (ä»…æœªè§£é”ä¸”æœ‰è¿›åº¦æ—¶æ˜¾ç¤º) --- */}
                                                        {progress && !isUnlocked && (
                                                            <div className="w-full mt-2 px-2">
                                                                <div className="flex justify-between text-[10px] text-gray-400 font-bold mb-1">
                                                                    <span>è¿›åº¦ {percent}%</span>
                                                                    <span>{progress.current}/{progress.target}</span>
                                                                </div>
                                                                <div className="w-full h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                                                    <div className={`h-full rounded-full transition-all duration-500 ${catTheme.title.replace('text', 'bg')}`} style={{ width: `${percent}%` }}></div>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {isUnlocked && <div className="mt-3 text-[10px] text-gray-400 bg-gray-50 px-2 py-0.5 rounded-md border border-gray-100">è§£é”äº {new Date(isUnlocked).getMonth()+1}/{new Date(isUnlocked).getDate()}</div>}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="p-4 bg-white border-t border-gray-100 flex justify-center shrink-0 shadow-[0_-4px_15px_rgba(0,0,0,0.05)] z-20">
                            <button onClick={onClose} className="px-12 py-3 rounded-full bg-gray-900 text-white font-bold text-lg shadow-lg hover:bg-gray-800 hover:scale-105 active:scale-95 transition-all">è¿”å›ä¸»ç•Œé¢</button>
                        </div>
                    </div>
                </div>
            );
        }

        const AchievementNotification = ({ unlockQueue, onClose }) => {
            if (unlockQueue.length === 0) return null;
            const badge = unlockQueue[0];
            const rarity = RARITY_COLORS[badge.rarity];
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl flex flex-col items-center text-center relative overflow-hidden animate-in zoom-in-50 duration-500" onClick={e => e.stopPropagation()}>
                        <div className={`absolute inset-0 opacity-20 ${badge.rarity === 'legendary' ? 'badge-legendary' : rarity.bg}`}></div>
                        <div className="relative z-10">
                            <div className="text-sm font-bold tracking-widest uppercase mb-2 text-gray-400">ACHIEVEMENT UNLOCKED</div>
                            <div className={`text-6xl mb-4 drop-shadow-xl animate-bounce`}>{badge.rarity === 'legendary' ? 'ğŸ‘‘' : badge.rarity === 'epic' ? 'ğŸŒŸ' : badge.rarity === 'rare' ? 'ğŸ’' : 'ğŸ…'}</div>
                            <h2 className={`text-2xl font-black mb-2 ${rarity.text === 'text-slate-600' ? 'text-slate-800' : rarity.text.replace('600', '800')}`}>{badge.name}</h2>
                            <div className={`inline-block px-3 py-1 rounded-full text-xs font-bold mb-4 ${rarity.badge}`}>{rarity.name}</div>
                            <p className="text-gray-600 font-medium">{badge.desc}</p>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); onClose(); }} className="mt-8 w-full py-3 bg-gray-900 text-white rounded-xl font-bold shadow-lg hover:scale-105 transition-transform cursor-pointer relative z-50">å¤ªæ£’äº†ï¼</button>
                    </div>
                </div>
            )
        }

        const WheelChoiceModal = ({ show, onClose, onSelect }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in zoom-in-95 duration-300">
                    <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden text-center">
                        <h2 className="text-2xl font-black text-gray-800 mb-2">ğŸ‰ ä»»åŠ¡å¤§æ»¡è´¯ï¼</h2>
                        <p className="text-gray-500 mb-6 text-sm">ç¢ç‰‡æ”¶é›†å®Œæˆï¼è¯·é€‰æ‹©ä½ çš„å¥–åŠ±ç±»å‹ï¼š</p>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => onSelect('gold')} className="group relative p-4 rounded-2xl bg-gradient-to-br from-amber-100 to-yellow-50 border-2 border-amber-200 hover:border-amber-400 hover:shadow-lg transition-all active:scale-95 flex flex-col items-center">
                                <div className="text-4xl mb-2 group-hover:scale-110 transition-transform">ğŸ’°</div>
                                <div className="font-black text-amber-700">é‡‘å…ƒå®è½¬ç›˜</div>
                                <div className="text-[10px] text-amber-600/70 mt-1">ç§¯ç´¯è´¢å¯Œ</div>
                            </button>
                            
                            <button onClick={() => onSelect('xp')} className="group relative p-4 rounded-2xl bg-gradient-to-br from-blue-100 to-indigo-50 border-2 border-indigo-200 hover:border-indigo-400 hover:shadow-lg transition-all active:scale-95 flex flex-col items-center">
                                <div className="text-4xl mb-2 group-hover:scale-110 transition-transform">ğŸ†™</div>
                                <div className="font-black text-indigo-700">ç»éªŒå€¼è½¬ç›˜</div>
                                <div className="text-[10px] text-indigo-600/70 mt-1">å¿«é€Ÿå‡çº§</div>
                            </button>
                        </div>
                        
                        <button onClick={onClose} className="mt-6 text-xs text-gray-400 hover:text-gray-600 underline">
                            æš‚ä¸å¼€å¯ (ç¨åå¯åœ¨åŠŸèƒ½åŒºæ‰‹åŠ¨å¼€å¯)
                        </button>
                    </div>
                </div>
            );
        };
		
        // ä¿®æ”¹ç»„ä»¶å‚æ•°ï¼ŒåŠ å…¥ wheelType
        const WheelModal = ({ showWheel, wheelResult, alreadyWon, theme, wheelConfig, pointerRotation, isDemoWheel, setShowWheel, setWheelResult, spinWheel, wheelSpinning, isExtraReward, wheelType }) => {
            if (!showWheel) return null;
            
            // æ ¹æ®ç±»å‹å†³å®šä¸»é¢˜è‰²å’Œå•ä½
            const isXP = wheelType === 'xp';
            const unit = isXP ? 'XP' : 'é‡‘å…ƒå®';
            
            // 1. ã€ä¿®æ”¹ã€‘èƒŒæ™¯ï¼šç»Ÿä¸€ä½¿ç”¨æµ…è‰²ï¼ˆè·Ÿéšä¸»é¢˜æˆ–é»˜è®¤æµ…ç°ï¼‰ï¼Œä¸å†åŒºåˆ† XP ç‰¹æ®ŠèƒŒæ™¯
            const bgGradient = theme.bgGradient || 'bg-gradient-to-b from-gray-200 to-transparent';
            
            // 2. ã€ä¿®æ”¹ã€‘æ–‡å­—é¢œè‰²ï¼šXP æ”¹å›æ·±é›è“è‰² (text-indigo-600)ï¼Œç¡®ä¿åœ¨æµ…èƒŒæ™¯ä¸Šæ¸…æ™°å¯è§
            // ä¹‹å‰æ˜¯ text-indigo-100 (æµ…ç™½)ï¼Œç°åœ¨å¿…é¡»æ”¹å›æ¥ï¼
            const primaryTextColor = isXP ? 'text-indigo-600' : theme.primary;
            
            // 3. æŒ‰é’®èƒŒæ™¯ï¼šXP ä¿æŒè“ç´«æ¸å˜ï¼Œé‡‘å…ƒå®ä¿æŒä¸»é¢˜è‰²
            const btnBg = isXP 
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg' 
                : `${theme.primaryBg} ${theme.primaryBgHover}`;
            
            // 4. å¤–åœˆ (Rim)ï¼šXP ä¿æŒé“¶æ²³è´¨æ„Ÿï¼ˆé’-è“-ç´«æµå…‰ï¼‰ï¼Œæ¯”è¾ƒå¥½çœ‹ä¸”èƒ½åŒºåˆ†
            const rimGradient = isXP 
                ? 'bg-gradient-to-br from-cyan-400 via-blue-500 to-purple-600' 
                : 'bg-gradient-to-b from-amber-200 via-yellow-400 to-amber-600';
            
            // 5. ä¸­å¿ƒæŒ‰é’®ï¼šXP ä¿æŒå‘å…‰çš„é’è‰²æ ¸å¿ƒ
            const centerBtnColor = isXP 
                ? 'bg-gradient-to-br from-cyan-300 to-blue-600 shadow-[0_0_15px_rgba(6,182,212,0.6)]' 
                : 'bg-gradient-to-br from-yellow-300 to-amber-500';

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                    <div className={`relative bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl overflow-hidden flex flex-col items-center ${wheelResult ? 'scale-105' : 'scale-100'} transition-all`}>
                        <div className={`absolute top-0 left-0 w-full h-32 ${bgGradient} -z-0`}></div>
                        <button onClick={() => { setShowWheel(false); setWheelResult(null); }} className="absolute top-4 right-4 z-10 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><XIcon className="w-5 h-5 text-gray-500" /></button>
                        <div className="z-10 text-center mb-6 mt-4">
                            <h2 className={`text-2xl font-black ${primaryTextColor} mb-1 flex items-center justify-center gap-2 drop-shadow-md`}>
                                {isXP ? <TrendingUp className="w-6 h-6 animate-bounce" /> : <Gift className="w-6 h-6 animate-bounce" />} 
                                {isDemoWheel ? `æ¼”ç¤º${isXP?'ç»éªŒ':'æƒŠå–œ'}è½¬ç›˜` : (isExtraReward ? `é¢å¤–${isXP?'ç»éªŒ':'æƒŠå–œ'}å¥–åŠ±ï¼` : `${isXP?'ç»éªŒ':'æƒŠå–œ'}å¤§æ”¾é€ï¼`)}
                            </h2>
                            <p className="text-gray-500 text-sm">{isDemoWheel ? 'æœ¬æ¬¡æŠ½å–ä»…ä¸ºæ¼”ç¤ºï¼Œä¸è®¡å…¥å¥–åŠ±' : `å¹¸è¿æ—¶åˆ»ï¼æŠ½å–ä½ çš„${isXP ? 'æˆé•¿å€¼' : 'è´¢å¯Œ'}å§ï¼`}</p>
                        </div>
                        {!wheelResult && !alreadyWon ? (
                            <>
                                <div className="relative w-80 h-80 mb-8 group">
                                    {/* å¤–åœˆé¢œè‰²åŠ¨æ€å˜åŒ– */}
                                    <div className={`absolute inset-0 rounded-full ${rimGradient} shadow-2xl transform translate-y-2`}></div>
                                    <div className="absolute inset-1.5 rounded-full bg-gradient-to-t from-gray-50 to-white shadow-sm p-1">
                                        <div className={`w-full h-full rounded-full relative overflow-hidden shadow-[inset_0_0_15px_rgba(0,0,0,0.15)] border-4 border-white`} style={{background: `conic-gradient(${wheelConfig.map((item, index) => `${item.color} ${(index / wheelConfig.length) * 100}% ${((index + 1) / wheelConfig.length) * 100}%`).join(', ')})`}}>
                                            <div className="absolute inset-0 rounded-full shadow-[inset_0_0_20px_rgba(0,0,0,0.1)] z-10 pointer-events-none"></div>
                                            {wheelConfig.map((item, index) => {
                                                const angleStep = 360 / wheelConfig.length;
                                                const rotateAngle = index * angleStep + angleStep / 2;
                                                return (<div key={item.id} className="absolute top-1/2 left-1/2 w-full h-full origin-top-left flex justify-center pt-4 pointer-events-none" style={{transform: `rotate(${rotateAngle}deg) translate(-50%, -50%)`}}><div className="text-white font-bold text-xs sm:text-sm drop-shadow-md tracking-wider mt-3" style={{textShadow: '0 1px 2px rgba(0,0,0,0.3)'}}>{item.name}</div></div>);
                                            })}
                                        </div>
                                    </div>
                                    <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none z-20" style={{transition: 'transform 3000ms cubic-bezier(0.25, 0.1, 0.25, 1)', transform: `rotate(${pointerRotation}deg)`}}>
                                        <div className="relative w-0 h-0 -mt-20"><div className="absolute -left-3 bottom-0 w-6 h-24 bg-gradient-to-t from-red-600 to-red-500 shadow-lg" style={{clipPath: 'polygon(50% 0, 0 100%, 100% 100%)'}}></div><div className="absolute -left-2 top-0 w-4 h-8 bg-red-700 rounded-b-full shadow-md"></div></div>
                                    </div>
                                    {/* ä¸­å¿ƒæŒ‰é’®é¢œè‰²åŠ¨æ€å˜åŒ– */}
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-gradient-to-br from-white to-gray-200 rounded-full border-4 border-gray-300 shadow-[0_4px_10px_rgba(0,0,0,0.2)] z-30 flex items-center justify-center">
                                        <div className={`w-8 h-8 ${centerBtnColor} rounded-full shadow-inner border border-white/50 flex items-center justify-center`}>
                                            <div className="w-3 h-3 bg-white rounded-full opacity-50 blur-[1px]"></div>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={spinWheel} disabled={wheelSpinning} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transform active:scale-95 transition-all ${wheelSpinning ? 'bg-gray-300 cursor-not-allowed' : `${btnBg} ring-4 ring-white/30`}`}>{wheelSpinning ? 'å¥½è¿æŠ½å–ä¸­...' : 'ç‚¹å‡»æ—‹è½¬æŒ‡é’ˆ'}</button>
                            </>
                        ) : (
                            <div className="text-center py-8 animate-in fade-in zoom-in duration-500">
                                <div className="text-6xl mb-4">{isXP ? 'ğŸ†™' : 'ğŸ’°'}</div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">æ­å–œè·å¾—</h3>
                                <div className={`text-4xl font-black ${primaryTextColor} mb-6`}>+{wheelResult?.value || alreadyWon} {unit}</div>
                                <button onClick={() => { setShowWheel(false); setWheelResult(null); }} className={`px-8 py-3 rounded-full text-white font-bold shadow-lg ${btnBg}`}>å¼€å¿ƒæ”¶ä¸‹</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EvilWheelModal = ({ show, onClose, wheelConfig, pointerRotation, spinWheel, wheelSpinning, result, isDemo }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="relative bg-slate-900 rounded-3xl w-full max-w-md p-6 shadow-2xl overflow-hidden flex flex-col items-center border border-red-900/50 evil-glow">
                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-red-900 to-transparent -z-0 opacity-50"></div>
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 p-2 bg-gray-800/50 rounded-full hover:bg-gray-700 text-gray-400"><XIcon className="w-5 h-5" /></button>
                        <div className="z-10 text-center mb-6 mt-4">
                            <h2 className="text-2xl font-black text-red-500 mb-1 flex items-center justify-center gap-2 tracking-widest uppercase"><Skull className="w-6 h-6 animate-pulse" /> {isDemo ? 'æµ‹è¯•æ¨¡å¼ (ä¸æ‰£åˆ†)' : 'å‘½è¿çš„å®¡åˆ¤'}</h2>
                            <p className="text-gray-400 text-xs tracking-wider">{isDemo ? 'ä»…ä¾›æµ‹è¯•è½¬ç›˜æ¦‚ç‡ä¸åŠ¨ç”»æ•ˆæœ' : 'æ¥å—æƒ©ç½šå§ï¼Œè¿™æ˜¯å¯¹æ‡’æƒ°çš„ä»£ä»·...'}</p>
                        </div>
                        {!result ? (
                            <>
                                <div className="relative w-80 h-80 mb-8 group">
                                    <div className="absolute inset-0 rounded-full bg-gradient-to-b from-slate-700 via-gray-900 to-black shadow-2xl transform translate-y-2"></div>
                                    <div className="absolute inset-1.5 rounded-full bg-gradient-to-t from-gray-800 to-gray-600 shadow-sm p-1">
                                        <div className="w-full h-full rounded-full relative overflow-hidden border-4 border-gray-700" style={{background: `conic-gradient(${wheelConfig.map((item, index) => `${item.color} ${(index / wheelConfig.length) * 100}% ${((index + 1) / wheelConfig.length) * 100}%`).join(', ')})`}}>
                                            <div className="absolute inset-0 rounded-full bg-black/20 pointer-events-none"></div>
                                            {wheelConfig.map((item, index) => {
                                                const angleStep = 360 / wheelConfig.length;
                                                const rotateAngle = index * angleStep + angleStep / 2;
                                                return (<div key={item.id} className="absolute top-1/2 left-1/2 w-full h-full origin-top-left flex justify-center pt-4 pointer-events-none" style={{transform: `rotate(${rotateAngle}deg) translate(-50%, -50%)`}}><div className="text-white font-bold text-xs sm:text-sm tracking-wider mt-3" style={{textShadow: '0 2px 4px black'}}>{item.name}</div></div>);
                                            })}
                                        </div>
                                    </div>
                                    <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center pointer-events-none z-20" style={{transition: 'transform 3000ms cubic-bezier(0.25, 0.1, 0.25, 1)', transform: `rotate(${pointerRotation}deg)`}}>
                                        <div className="relative w-0 h-0 -mt-20"><div className="absolute -left-3 bottom-0 w-6 h-28 bg-gradient-to-t from-gray-200 to-gray-400 shadow-lg" style={{clipPath: 'polygon(50% 0, 100% 100%, 0 100%)'}}></div><div className="absolute -left-4 bottom-0 w-8 h-2 bg-red-900 rounded-sm"></div></div>
                                    </div>
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-gray-800 rounded-full border-2 border-gray-600 shadow-xl z-30 flex items-center justify-center"><div className="w-2 h-2 bg-red-600 rounded-full animate-ping"></div></div>
                                </div>
                                <button onClick={spinWheel} disabled={wheelSpinning} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transform active:scale-95 transition-all ${wheelSpinning ? 'bg-gray-800 cursor-not-allowed' : 'bg-red-900 hover:bg-red-800 ring-2 ring-red-900/50'}`}>{wheelSpinning ? 'å‘½è¿è£å†³ä¸­...' : 'å¯åŠ¨å®¡åˆ¤'}</button>
                            </>
                        ) : (
                            <div className="text-center py-8 animate-in zoom-in duration-500">
                                <div className="text-6xl mb-4 grayscale">ğŸ’¸</div>
                                <h3 className="text-xl font-bold text-gray-300 mb-2">å®¡åˆ¤ç»“æœ</h3>
                                <div className="text-4xl font-black text-red-500 mb-6">{result.value} é‡‘å…ƒå®</div>
                                {result.usedShield && <div className="mb-4 text-green-400 font-bold bg-green-900/30 p-2 rounded-lg border border-green-800 animate-pulse">ğŸ›¡ï¸ é’é“œå®ˆæŠ¤ç›¾ç”Ÿæ•ˆï¼æƒ©ç½šå·²æŠµæ¶ˆï¼</div>}
                                <button onClick={onClose} className="px-8 py-3 rounded-full bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700">{isDemo ? 'å…³é—­æµ‹è¯•' : 'é»˜é»˜æ¥å—'}</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };		    
		
        const SettingsModal = ({ showSettings, setShowSettings, theme, globalDates, setGlobalDates, profiles, handleAddProfile, deleteProfile, handleAvatarUpload, updateProfileTheme, updateProfileGrade, curriculumProgress, handleVerifyCurriculum, wheelSettings, setWheelSettings, wheelConfig, setWheelConfig, setIsDemoWheel, setShowWheel, setWheelResult, activeChild, tasks, handleDeleteTask, updateTaskSetting, handleAddTask, evilWheelConfig, setEvilWheelConfig, onLaunchEvilWheel, onTestEvilWheel, settingsPassword, setSettingsPassword, isTestMode, setIsTestMode, setShowMilestones, setShowBackupPanel, handleSyncMilestones, onLaunchExtraWheel, weekendSettings, setWeekendSettings, handleTestSettlement, userCity, setUserCity, xpWheelConfig, setXpWheelConfig, onFixInventory }) => {
            if (!showSettings) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
                    <div className="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center shadow-sm shrink-0">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><SettingsIcon className={`w-5 h-5 ${theme.primary}`} /> ä»»åŠ¡ä¸è§„åˆ™è®¾ç½®</h2>
                      <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-gray-100 rounded-full"><XIcon className="w-6 h-6 text-gray-500" /></button>
                    </div>
                    <div className="p-6 space-y-8 flex-1 overflow-y-auto">
                        
                       {/* å®¶é•¿æ§åˆ¶åŒºåŸŸ (æ–°å¢) */}
                       <section className="bg-slate-100 p-5 rounded-2xl border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Shield className="w-5 h-5" /> å®¶é•¿æ§åˆ¶ (Parental Control)</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">è®¾ç½®/ä¿®æ”¹å®¶é•¿å¯†ç </label>
                                    <div className="flex items-center gap-2">
                                        <Key className="w-4 h-4 text-gray-400" />
                                        <input 
                                            type="text" 
                                            placeholder="ç•™ç©ºåˆ™æ— éœ€å¯†ç "
                                            value={settingsPassword} 
                                            onChange={e => setSettingsPassword(e.target.value)} 
                                            className="w-full p-2 bg-white border border-gray-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-slate-300" 
                                        />
                                    </div>
                                    <p className="text-[10px] text-gray-400 mt-1">è®¾ç½®åï¼Œä¸‹æ¬¡è¿›å…¥è®¾ç½®é¡µé¢éœ€è¾“å…¥æ­¤å¯†ç ã€‚</p>
                                </div>
                                <div className="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-200">
                                    <div>
                                        <div className="text-sm font-bold text-gray-700">å¯ç”¨æµ‹è¯•æ¨¡å¼ (æ»¡çº§è´¦å·)</div>
                                        <div className="text-xs text-gray-400">å¼€å¯åå°†æ·»åŠ ä¸€ä¸ªå…¨æ»¡çº§çš„â€œæµ‹è¯•å‘˜â€è´¦å·</div>
                                    </div>
                                    <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="test-mode-toggle" checked={isTestMode} onChange={(e) => setIsTestMode(e.target.checked)} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out transform translate-x-0 checked:translate-x-6 checked:border-green-400"/>
                                        <label htmlFor="test-mode-toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${isTestMode ? 'bg-green-400' : 'bg-gray-300'}`}></label>
                                    </div>
                                </div>
                            </div>
							{/* --- æ–°å¢ï¼šå¤©æ°”åŸå¸‚è®¾ç½® --- */}
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                                <h4 className="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                                    ğŸŒ¤ï¸ å¤©æ°”ä½ç½®è®¾ç½®
                                </h4>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="è¾“å…¥åŸå¸‚å (å¦‚: åŒ—äº¬ / Shanghai)" 
                                        value={userCity}
                                        onChange={(e) => setUserCity(e.target.value)}
                                        className="flex-1 px-3 py-2 text-xs border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300"
                                    />
                                    {/* è¿™é‡Œä¸éœ€è¦ç¡®å®šæŒ‰é’®ï¼Œå› ä¸º React çŠ¶æ€æ›´æ–°ä¼šç›´æ¥è§¦å‘ App é‡Œçš„ useEffect */}
                                </div>
                                <p className="text-[10px] text-blue-400 mt-1">
                                    * å¦‚æœå®šä½å¤±è´¥ï¼Œè¯·è¾“å…¥åŸå¸‚åï¼ˆæ”¯æŒä¸­æ–‡æˆ–æ‹¼éŸ³ï¼‰ã€‚ç•™ç©ºåˆ™å°è¯•è‡ªåŠ¨å®šä½ã€‚
                                </p>
                            </div>
							{/* --- ã€æ–°å¢ã€‘å‘¨æœ«è§„åˆ™è®¾ç½® --- */}
                            <div className="mt-4 pt-4 border-t border-slate-200">
                                <h4 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">ğŸ“… å‘¨æœ«è¾¾æ ‡è§„åˆ™è‡ªå®šä¹‰</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">â­ æ ¸å¿ƒä»»åŠ¡è¾¾æ ‡ç‡ ({weekendSettings.coreThreshold || 80}%)</label>
                                        <input 
                                            type="range" min="0" max="100" step="10"
                                            value={weekendSettings.coreThreshold || 80} 
                                            onChange={e => setWeekendSettings({...weekendSettings, coreThreshold: parseInt(e.target.value)})} 
                                            className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-amber-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">ğŸƒ æ—¥å¸¸ä»»åŠ¡è¾¾æ ‡ç‡ ({weekendSettings.dailyThreshold || 50}%)</label>
                                        <input 
                                            type="range" min="0" max="100" step="10"
                                            value={weekendSettings.dailyThreshold || 50} 
                                            onChange={e => setWeekendSettings({...weekendSettings, dailyThreshold: parseInt(e.target.value)})} 
                                            className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                        />
                                    </div>
                                </div>
                                <div className="mt-3 flex justify-between items-center bg-white p-3 rounded-xl border border-slate-200">
                                    <div>
                                        <div className="text-xs font-bold text-slate-700">ğŸ›¡ï¸ ç›‘æŠ¤äººè±å…å¡</div>
                                        <div className="text-[10px] text-gray-400">å½“å‰æŒæœ‰: {weekendSettings.guardianPassCount || 0} å¼ </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => handleTestSettlement && handleTestSettlement()}
                                            className="px-2 py-1 bg-gray-100 text-gray-500 rounded text-[10px] hover:bg-gray-200"
                                        >
                                            æµ‹è¯•ç»“ç®—
                                        </button>
                                        <button 
                                            onClick={() => setWeekendSettings(prev => ({...prev, guardianPassCount: (prev.guardianPassCount || 0) + 1}))}
                                            className="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-200"
                                        >
                                            + æˆäºˆä¸€å¼ 
                                        </button>
                                    </div>
                                </div>
                            </div>
                       </section>

                       <section className="bg-gray-50 p-5 rounded-2xl border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><CalendarIcon className="w-5 h-5" /> å…¨å±€æ—¥æœŸé…ç½®</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-gray-500 block mb-1">å¯’å‡å¼€å§‹</label><input type="date" value={globalDates.start} onChange={e => setGlobalDates({...globalDates, start: e.target.value})} className="w-full p-2 bg-white border border-gray-200 rounded-lg text-gray-700" /></div>
                                <div><label className="text-xs text-gray-500 block mb-1">å¯’å‡ç»“æŸ</label><input type="date" value={globalDates.end} onChange={e => setGlobalDates({...globalDates, end: e.target.value})} className="w-full p-2 bg-white border border-gray-200 rounded-lg text-gray-700" /></div>
                            </div>
                       </section>
                       
                       {/* å¤§äº‹çºªå’Œæ•°æ®å¤‡ä»½ */}
                       <section className="bg-purple-50/50 p-5 rounded-2xl border border-purple-100">
                            <h3 className="font-bold text-purple-800 mb-4 flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                å¤§äº‹çºªä¸æ•°æ®ç®¡ç†
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button 
                                    onClick={() => { setShowSettings(false); setTimeout(() => setShowMilestones(true), 100); }}
                                    className="p-4 bg-white rounded-xl border border-purple-200 hover:bg-purple-50 transition-colors text-left group"
                                >
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="text-2xl">ğŸ“œ</div>
                                        <div className="font-bold text-gray-800">æŸ¥çœ‹å¤§äº‹çºª</div>
                                    </div>
                                    <div className="text-xs text-gray-500">è®°å½•äº†æ‰€æœ‰é‡è¦æ—¶åˆ»ï¼šå‡çº§ã€æˆå°±ã€å¥‡é‡ç­‰</div>
                                </button>
                                <button 
                                    onClick={() => { setShowSettings(false); setTimeout(() => setShowBackupPanel(true), 100); }}
                                    className="p-4 bg-white rounded-xl border border-purple-200 hover:bg-purple-50 transition-colors text-left group"
                                >
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="text-2xl">ğŸ’¾</div>
                                        <div className="font-bold text-gray-800">æ•°æ®å¤‡ä»½/æ¢å¤</div>
                                    </div>
                                    <div className="text-xs text-gray-500">å¯¼å‡ºæˆ–å¯¼å…¥æ‰€æœ‰æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</div>
                                </button>
								{/* â†“â†“â†“ æ–°å¢ï¼šå•†å“æ‰¾å›æŒ‰é’® â†“â†“â†“ */}
                                <button 
									onClick={onFixInventory}
									className="mt-2 w-full p-3 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-sm font-bold hover:bg-amber-100 transition-colors flex items-center justify-center gap-2"
								>
									<ShoppingBag className="w-4 h-4" />
									æ‰«æè´¦å•å¹¶æ‰¾å›ä¸¢å¤±å•†å“
								</button>
								<button 
									onClick={handleSyncMilestones}
									className="mt-3 w-full p-3 bg-indigo-50 border border-indigo-200 rounded-xl text-indigo-700 text-sm font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2"
								>
									<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
									å¤§äº‹çºªæ•°æ®æ ¸å¯¹ä¸è¡¥å…¨
								</button>
                            </div>
		
                       </section>
                       
                       <section className="bg-blue-50/50 p-5 rounded-2xl border border-blue-100">
                            <h3 className="font-bold text-blue-800 mb-4 flex items-center gap-2"><Users className="w-5 h-5" /> æˆå‘˜ç®¡ç†</h3>
                            <div className="grid grid-cols-1 gap-3">
                                {profiles.map((profile) => (
                                    <div key={profile.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-blue-100 shadow-sm">
                                        <div className="relative group w-12 h-12">
                                            {profile.avatar ? <img src={profile.avatar} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm" /> : <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl ${COLOR_PALETTES[profile.theme]?.primaryBg || 'bg-gray-400'}`}>{profile.name[0]}</div>}
                                            <label className="absolute inset-0 flex items-center justify-center bg-black/30 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity"><Upload className="w-4 h-4 text-white" /><input type="file" accept="image/*" className="hidden" onChange={(e) => handleAvatarUpload(e, profile.id)} /></label>
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                {profile.name}
                                                {profile.id === 'TESTER' && <span className="bg-green-100 text-green-600 text-[10px] px-1.5 rounded border border-green-200">æµ‹è¯•å‘˜</span>}
                                            </div>
											{/* --- ã€æ–°å¢ã€‘å¹´çº§é€‰æ‹©å™¨ --- */}
                                            <div className="mt-2 flex items-center gap-2">
                                                <label className="text-[10px] text-gray-500 font-bold bg-white px-1 rounded">å½“å‰å°±è¯»</label>
                                                <select 
                                                    value={profile.grade || 1} 
                                                    onChange={(e) => updateProfileGrade(profile.id, parseInt(e.target.value))}
                                                    className="text-xs border border-blue-200 rounded px-1 py-0.5 bg-white text-blue-600 font-bold focus:outline-none"
                                                >
                                                    {[1,2,3,4,5,6].map(g => <option key={g} value={g}>{g}å¹´çº§</option>)}
                                                </select>
                                            </div>
											{/* --- ã€æ–°å¢ã€‘å³ä¾§åˆ é™¤æŒ‰é’® --- */}
                                                <div className="ml-2 flex flex-col justify-center">
                                                    {profiles.length > 1 && (
                                                        <button 
                                                            onClick={() => deleteProfile(profile.id)}
                                                            className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all"
                                                            title="åˆ é™¤è¯¥æˆå‘˜"
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                <path d="M3 6h18"></path>
                                                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                                            </svg>
                                                        </button>
                                                    )}
                                                </div>
                                            <div className="flex gap-1 mt-1">{Object.values(COLOR_PALETTES).map(p => (<button key={p.id} onClick={() => updateProfileTheme(profile.id, p.id)} className={`w-4 h-4 rounded-full border border-white shadow-sm ${p.primaryBg} ${profile.theme === p.id ? 'ring-2 ring-offset-1 ring-gray-300' : ''}`}></button>))}</div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={handleAddProfile} className="w-full py-2 border-2 border-dashed border-blue-200 rounded-xl text-blue-400 hover:bg-blue-50 font-bold text-sm">+ æ·»åŠ æ–°æˆå‘˜</button>
                            </div>
                       </section>
                       <section className="bg-gradient-to-r from-amber-50 to-orange-50 p-5 rounded-2xl border border-amber-100">
                            <h3 className="font-bold text-amber-800 mb-4 flex items-center gap-2"><Gift className="w-5 h-5" /> æƒŠå–œå¤§è½¬ç›˜é…ç½®</h3>
                            <div className="bg-white/80 p-4 rounded-xl border border-amber-100 mb-4">
                                <h4 className="text-sm font-bold text-amber-700 mb-3">è§¦å‘è§„åˆ™è®¾ç½®</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-xs text-gray-500 block mb-1">æ¯æ—¥æˆªæ­¢æ—¶é—´</label><div className="flex items-center gap-2"><input type="number" min="0" max="23" className="w-full p-2 bg-white border border-amber-200 rounded-lg text-amber-900 font-bold" value={wheelSettings.deadlineHour} onChange={e => setWheelSettings({...wheelSettings, deadlineHour: parseInt(e.target.value) || 18})} /><span className="text-sm text-gray-400">:00 å‰</span></div></div>
                                    <div><label className="text-xs text-gray-500 block mb-1">è§¦å‘é˜ˆå€¼</label><div className="flex gap-2 mb-2"><button onClick={() => setWheelSettings({...wheelSettings, thresholdType: 'percent'})} className={`flex-1 py-1.5 text-xs rounded-lg border ${wheelSettings.thresholdType === 'percent' ? 'bg-amber-100 border-amber-300 text-amber-800' : 'bg-white border-gray-200 text-gray-500'}`}>æŒ‰æ¯”ä¾‹</button><button onClick={() => setWheelSettings({...wheelSettings, thresholdType: 'fixed'})} className={`flex-1 py-1.5 text-xs rounded-lg border ${wheelSettings.thresholdType === 'fixed' ? 'bg-amber-100 border-amber-300 text-amber-800' : 'bg-white border-gray-200 text-gray-500'}`}>æŒ‰æ•°é‡</button></div><div className="flex items-center gap-2"><input type="number" className="w-full p-2 bg-white border border-amber-200 rounded-lg text-amber-900 font-bold" value={wheelSettings.thresholdValue} onChange={e => setWheelSettings({...wheelSettings, thresholdValue: parseInt(e.target.value) || 0})} /><span className="text-sm text-gray-400">{wheelSettings.thresholdType === 'percent' ? '% ä»»åŠ¡' : 'ä¸ªç¢ç‰‡'}</span></div></div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 gap-3">{wheelConfig.map((item, idx) => (<div key={item.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-amber-100 shadow-sm"><div className="w-6 h-6 rounded-full shrink-0 border-2 border-white shadow-sm" style={{backgroundColor: item.color}}></div><div className="flex-1 grid grid-cols-3 gap-2"><div><label className="text-xs text-gray-400 block">åç§°</label><input className="w-full font-bold text-gray-700 bg-transparent border-b border-dashed focus:outline-none" value={item.name} onChange={e => { const newConfig = [...wheelConfig]; newConfig[idx].name = e.target.value; setWheelConfig(newConfig); }} /></div><div><label className="text-xs text-gray-400 block">é‡‘å¸</label><input type="number" className="w-full font-bold text-amber-600 bg-transparent border-b border-dashed focus:outline-none" value={item.value} onChange={e => { const newConfig = [...wheelConfig]; newConfig[idx].value = parseInt(e.target.value) || 0; setWheelConfig(newConfig); }} /></div><div><label className="text-xs text-gray-400 block">æƒé‡</label><input type="number" className="w-full text-gray-600 bg-transparent border-b border-dashed focus:outline-none" value={item.weight} onChange={e => { const newConfig = [...wheelConfig]; newConfig[idx].weight = parseInt(e.target.value) || 0; setWheelConfig(newConfig); }} /></div></div></div>))}</div>
                            <div className="mt-4 pt-4 border-t border-amber-100 flex justify-end"><button onClick={() => onLaunchExtraWheel('gold', true)} className="px-4 py-2 bg-gradient-to-r from-blue-400 to-indigo-500 text-white text-sm font-bold rounded-lg shadow hover:shadow-lg transition flex items-center gap-2"><Play className="w-4 h-4" /> æ¼”ç¤ºå¤§è½¬ç›˜ (ä¸è®¡å…¥æ•°æ®)</button> <button onClick={onLaunchExtraWheel} className="px-4 py-2 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-sm font-bold rounded-lg shadow hover:shadow-lg transition flex items-center gap-2"><Gift className="w-4 h-4" /> å‘æ”¾é¢å¤–æƒŠå–œå¥–åŠ± (è®¡å…¥å…ƒå®)</button></div>
                       </section>
					   <section className="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-2xl border border-blue-100 mt-4">
                            <h3 className="font-bold text-indigo-800 mb-4 flex items-center gap-2"><TrendingUp className="w-5 h-5" /> ç»éªŒå€¼å¤§è½¬ç›˜é…ç½®</h3>
                            <div className="grid grid-cols-1 gap-3">
                                {xpWheelConfig.map((item, idx) => (
                                    <div key={item.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-blue-100 shadow-sm">
                                        <div className="w-6 h-6 rounded-full shrink-0 border-2 border-white shadow-sm" style={{backgroundColor: item.color}}></div>
                                        <div className="flex-1 grid grid-cols-3 gap-2">
                                            <div>
                                                <label className="text-xs text-gray-400 block">åç§°</label>
                                                <input className="w-full font-bold text-gray-700 bg-transparent border-b border-dashed focus:outline-none" value={item.name} onChange={e => { const newConfig = [...xpWheelConfig]; newConfig[idx].name = e.target.value; setXpWheelConfig(newConfig); }} />
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-400 block">XPå€¼</label>
                                                <input type="number" className="w-full font-bold text-blue-600 bg-transparent border-b border-dashed focus:outline-none" value={item.value} onChange={e => { const newConfig = [...xpWheelConfig]; newConfig[idx].value = parseInt(e.target.value) || 0; setXpWheelConfig(newConfig); }} />
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-400 block">æƒé‡</label>
                                                <input type="number" className="w-full text-gray-600 bg-transparent border-b border-dashed focus:outline-none" value={item.weight} onChange={e => { const newConfig = [...xpWheelConfig]; newConfig[idx].weight = parseInt(e.target.value) || 0; setXpWheelConfig(newConfig); }} />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-4 pt-4 border-t border-blue-100 flex justify-end gap-2">
                                <button onClick={() => onLaunchExtraWheel('xp', true)} className="px-4 py-2 bg-gradient-to-r from-gray-400 to-gray-500 text-white text-sm font-bold rounded-lg shadow hover:shadow-lg transition flex items-center gap-2">
                                    <Play className="w-4 h-4" /> æ¼”ç¤ºXPè½¬ç›˜(ä¸è®¡å…¥æ•°æ®)
                                </button> 
                                <button onClick={() => onLaunchExtraWheel('xp', false)} className="px-4 py-2 bg-gradient-to-r from-blue-400 to-indigo-500 text-white text-sm font-bold rounded-lg shadow hover:shadow-lg transition flex items-center gap-2">
                                    <Gift className="w-4 h-4" /> å‘æ”¾é¢å¤–XPå¥–åŠ±
                                </button>
                            </div>
                       </section>
                       <section>
                          <h3 className={`font-bold ${theme.primary} mb-4 flex items-center gap-2`}><Target className="w-5 h-5" /> æ¯æ—¥ä»»åŠ¡ ({activeChild})</h3>
                          <div className="space-y-4">
                            {(tasks[activeChild] || []).map((task) => (
                              <div key={task.id} className="border p-4 rounded-xl bg-gray-50 flex flex-col gap-3 relative group hover:shadow-md transition-all hover:bg-white">
                                <button onClick={() => handleDeleteTask(task.id)} className="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-1"><Trash2 className="w-4 h-4" /></button>
                                {/* ã€æ–°å¢ã€‘ä»»åŠ¡ç±»å‹åˆ‡æ¢æŒ‰é’® */}
                                <div className="flex gap-2 mb-1">
                                    <button 
                                        onClick={() => updateTaskSetting(task.id, 'type', task.type === 'core' ? 'daily' : 'core')}
                                        className={`px-2 py-0.5 text-[10px] rounded border font-bold ${task.type === 'core' ? 'bg-amber-100 text-amber-600 border-amber-200' : 'bg-emerald-100 text-emerald-600 border-emerald-200'}`}
                                    >
                                        {task.type === 'core' ? 'â­ æ ¸å¿ƒä»»åŠ¡' : 'ğŸƒ æ—¥å¸¸ä»»åŠ¡'}
                                    </button>
                                </div>
								{/* --- ã€æ–°å¢ã€‘å­¦ä¸šç›®æ ‡å…³è”ä¸æ ¸é”€åŒº --- */}
                                <div className="mt-3 pt-3 border-t border-dashed border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs font-bold text-indigo-500">ğŸ“ å­¦ä¸šç›®æ ‡å…³è”:</span>
                                            <select 
                                                value={task.linkedSubject || ''} 
                                                onChange={(e) => updateTaskSetting(task.id, 'linkedSubject', e.target.value)}
                                                className="text-xs border border-gray-200 rounded px-2 py-1 bg-white text-gray-600"
                                            >
                                                <option value="">æ— å…³è”</option>
                                                <option value="math_olympiad">å¥¥æ•°æ€ç»´å¤©æ¢¯</option>
                                                {/* åç»­æ·»åŠ è‹±è¯­ç­‰ */}
                                            </select>
                                        </div>
                                        
                                        {/* åªæœ‰é€‰æ‹©äº†å…³è”ç§‘ç›®æ‰æ˜¾ç¤ºè¿›åº¦æ ¸é”€ */}
                                        {task.linkedSubject && CURRICULUM_CONFIG[task.linkedSubject] && (
                                            <div className="flex items-center gap-2 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100">
                                                {(() => {
                                                    const subjectConfig = CURRICULUM_CONFIG[task.linkedSubject];
                                                    // è·å–å½“å‰å·²å®Œæˆåˆ°çš„ç´¢å¼•
                                                    const currentIdx = curriculumProgress[activeChild]?.[task.linkedSubject] !== undefined 
                                                        ? curriculumProgress[activeChild][task.linkedSubject] 
                                                        : -1;
                                                    const nextIdx = currentIdx + 1;
                                                    const isMax = nextIdx >= subjectConfig.totalSemesters;
                                                    
                                                    return (
                                                        <>
                                                            <div className="text-xs text-indigo-800">
                                                                å½“å‰: <span className="font-bold">{currentIdx === -1 ? 'æœªå¼€å§‹' : subjectConfig.getSemesterName(currentIdx)}</span>
                                                            </div>
                                                            {!isMax && (
                                                                <button 
                                                                    onClick={() => {
                                                                        if(confirm(`âš ï¸ å®¶é•¿ç¡®è®¤\n\nç¡®è®¤ ${activeChild} å·²ç»å®Œæˆäº†ã€${subjectConfig.getSemesterName(nextIdx)}ã€‘çš„å…¨éƒ¨å­¦ä¹ å†…å®¹å—ï¼Ÿ\n\nç¡®è®¤åå°†è§£é”å¯¹åº”æˆå°±ï¼`)) {
                                                                            handleVerifyCurriculum(activeChild, task.linkedSubject, nextIdx);
                                                                        }
                                                                    }}
                                                                    className="px-2 py-0.5 bg-indigo-500 text-white text-[10px] font-bold rounded hover:bg-indigo-600 transition-colors shadow-sm flex items-center gap-1"
                                                                >
                                                                    <CheckCircle2 className="w-3 h-3" />
                                                                    æ ¸é”€: {subjectConfig.getSemesterName(nextIdx)}
                                                                </button>
                                                            )}
                                                            {isMax && <span className="text-[10px] text-green-600 font-bold">ğŸ‰ å…¨é˜¶é€šå…³</span>}
                                                        </>
                                                    );
                                                })()}
                                            </div>
                                        )}
                                    </div>
                                </div>
								
								<div className="pr-8"><input type="text" value={task.name} onChange={(e) => updateTaskSetting(task.id, 'name', e.target.value)} className="font-bold text-lg bg-transparent border-b border-dashed border-gray-300 focus:border-indigo-500 focus:outline-none w-full mb-2" /><input type="text" value={task.targetGoal || ''} onChange={(e) => updateTaskSetting(task.id, 'targetGoal', e.target.value)} placeholder="è¾“å…¥å…·ä½“ç›®æ ‡å†…å®¹..." className="text-sm bg-transparent border-b border-dashed border-gray-200 w-full text-gray-500 focus:outline-none" /></div>
                                <div className="grid grid-cols-4 gap-2 text-sm"><div><label className="text-xs text-gray-400">å•æ¬¡å¥–åŠ±</label><input type="number" value={task.reward} onChange={(e) => updateTaskSetting(task.id, 'reward', parseInt(e.target.value)||0)} className="w-full bg-white border rounded p-1" /></div><div><label className="text-xs text-gray-400">ç›®æ ‡æ¬¡æ•°</label><input type="number" value={task.targetCount} onChange={(e) => updateTaskSetting(task.id, 'targetCount', parseInt(e.target.value)||0)} className="w-full bg-white border rounded p-1" /></div><div className="col-span-1"><label className="text-xs text-gray-400 text-blue-500 font-bold">å¼€å§‹æ—¥æœŸ</label><input type="date" value={task.startDate || globalDates.start} onChange={(e) => updateTaskSetting(task.id, 'startDate', e.target.value)} className="w-full bg-blue-50/50 border border-blue-100 rounded p-1 text-blue-600" /></div><div className="col-span-1"><label className="text-xs text-gray-400 text-red-500 font-bold">æˆªæ­¢æ—¥æœŸ</label><input type="date" value={task.deadline || globalDates.end} onChange={(e) => updateTaskSetting(task.id, 'deadline', e.target.value)} className="w-full bg-red-50/50 border border-red-100 rounded p-1 text-red-600" /></div></div>
                              </div>
                            ))}
                            <button onClick={handleAddTask} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 transition flex items-center justify-center gap-2"><Plus className="w-4 h-4" /> æ·»åŠ æ–°ä»»åŠ¡</button>
                          </div>
                      </section>
                      <section className="bg-slate-900 text-gray-300 p-5 rounded-2xl border border-red-900 mt-8">
                            <h3 className="font-bold text-red-500 mb-4 flex items-center gap-2"><Skull className="w-5 h-5" /> æƒ©ç½šæœºåˆ¶ (å®¶é•¿ä¸“ç”¨)</h3>
                            <p className="text-xs text-gray-500 mb-4">æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…ä¾›ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œè½¬å‡ºçš„ç»“æœå°†ç›´æ¥æ‰£é™¤é‡‘å…ƒå®ã€‚</p>
                            <div className="grid grid-cols-1 gap-3 mb-4">
                                {evilWheelConfig.map((item, idx) => (
                                    <div key={item.id} className="flex items-center gap-3 bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-sm">
                                        <div className="w-6 h-6 rounded-full shrink-0 border-2 border-gray-600 shadow-sm" style={{backgroundColor: item.color}}></div>
                                        <div className="flex-1 grid grid-cols-3 gap-2"><div><label className="text-xs text-gray-500 block">åç§°</label><input className="w-full font-bold text-gray-300 bg-transparent border-b border-gray-600 focus:border-red-500 focus:outline-none" value={item.name} onChange={e => { const newConfig = [...evilWheelConfig]; newConfig[idx].name = e.target.value; setEvilWheelConfig(newConfig); }} /></div><div><label className="text-xs text-gray-500 block">æ‰£é™¤å€¼(è´Ÿæ•°)</label><input type="number" className="w-full font-bold text-red-400 bg-transparent border-b border-gray-600 focus:border-red-500 focus:outline-none" value={item.value} onChange={e => { const newConfig = [...evilWheelConfig]; newConfig[idx].value = parseInt(e.target.value) || 0; setEvilWheelConfig(newConfig); }} /></div><div><label className="text-xs text-gray-500 block">æƒé‡</label><input type="number" className="w-full text-gray-300 bg-transparent border-b border-gray-600 focus:border-red-500 focus:outline-none" value={item.weight} onChange={e => { const newConfig = [...evilWheelConfig]; newConfig[idx].weight = parseInt(e.target.value) || 0; setEvilWheelConfig(newConfig); }} /></div></div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-end gap-3">
                                <button onClick={onTestEvilWheel} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold rounded-lg shadow-lg transition-all active:scale-95 border border-gray-600 flex items-center gap-2"><Beaker className="w-4 h-4" /> æµ‹è¯•è½¬ç›˜</button>
                                <button onClick={onLaunchEvilWheel} className="px-6 py-2 bg-red-900 hover:bg-red-800 text-white font-bold rounded-lg shadow-lg transition-all active:scale-95 border border-red-700 flex items-center gap-2"><Skull className="w-4 h-4" /> å¯åŠ¨é‚ªæ¶è½¬ç›˜</button>
                            </div>
                       </section>
                    </div>
                    <div className="p-4 border-t bg-gray-50 text-right sticky bottom-0 z-10 shrink-0"><button onClick={() => setShowSettings(false)} className={`px-8 py-2.5 ${theme.primaryBg} ${theme.primaryBgHover} text-white rounded-full font-medium shadow-lg transition transform active:scale-95`}>ä¿å­˜å¹¶é€€å‡º</button></div>
                  </div>
                </div>
            );
        };

        const TimeEntryModal = ({ editingEntry, tasks, activeChild, removeCheckin, setEditingEntry, saveCheckin, theme, inventory, useRepairCard }) => {
            if (!editingEntry) return null;
            const task = (tasks[activeChild] || []).find(t => t.id === editingEntry.taskId);
            const [val, setVal] = useState(editingEntry.duration);
            
            // å¸‚é›†åŠŸèƒ½ï¼šè¡¥ç­¾åˆ¤æ–­
            const hasRepairCard = (inventory['item_fire'] || 0) > 0;
            const isPast = new Date(editingEntry.date) < new Date(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                setVal(editingEntry.duration);
            }, [editingEntry]);

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 animate-in fade-in zoom-in duration-200">
                        <h3 className="text-center text-lg font-bold text-gray-800 mb-6">{task?.name} - {editingEntry.date}</h3>
                        <div className="mb-6 relative"><input type="number" autoFocus value={val} onChange={(e) => setVal(e.target.value)} className={`w-full text-center text-4xl font-black border-b-2 ${theme.primary} border-gray-200 focus:border-current focus:outline-none pb-2 placeholder-gray-200`} placeholder="30" /><span className="absolute right-4 bottom-3 text-gray-400 text-sm font-medium">åˆ†é’Ÿ</span></div>
                        
                        {/* è¡¥ç­¾åŠŸèƒ½æŒ‰é’® */}
                        {editingEntry.isNew && isPast && hasRepairCard && (
                             <button onClick={() => useRepairCard(editingEntry)} className="w-full mb-3 py-2 bg-amber-100 text-amber-700 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-amber-200"><span className="text-lg">ğŸ”¥</span> ä½¿ç”¨æ™®ç½—ç±³ä¿®æ–¯ä¹‹ç«è¡¥ç­¾</button>
                        )}
                        
                        <div className="flex gap-3">{!editingEntry.isNew && <button onClick={removeCheckin} className="flex-1 py-3 border border-red-200 text-red-500 rounded-xl hover:bg-red-50"><Trash2 className="w-4 h-4 inline" /> æ’¤é”€</button>}<button onClick={() => setEditingEntry(null)} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200">å–æ¶ˆ</button><button onClick={() => saveCheckin(val)} className={`flex-1 py-3 ${theme.primaryBg} text-white rounded-xl shadow-lg hover:opacity-90`}>ç¡®è®¤</button></div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, checkins, activeChild, globalDates, theme, inventory, onUseSkipCard, equippedGear }) => {
            const record = checkins[activeChild]?.[task.id] || {};
            const currentCount = Object.keys(record).length;
            const isCompleted = currentCount >= task.targetCount;
            const stats = (() => {
                    const totalMinutes = Object.values(record).reduce((a, b) => a + b, 0);
                    const avg = currentCount > 0 ? Math.round(totalMinutes / currentCount) : 0;
                    const targetDate = new Date(task.deadline || globalDates.end);
                    const progress = Math.min(100, (currentCount / task.targetCount) * 100);
                    const baseIncome = currentCount * task.reward;
                    let totalIncome = baseIncome;
                    if(isCompleted) totalIncome += task.completedReward; 
                    return { avg, targetDate, progress, totalIncome };
            })();

            // å¸‚é›†åŠŸèƒ½ï¼šè·³è¿‡å¡é€»è¾‘
            const hasSkipCard = (inventory['item_skip'] || 0) > 0;
            const today = getLocalDateKey(0);
            const isCheckedToday = !!record[today];
			
			// --- æ–°å¢ï¼šç‰¹æ®ŠèƒŒæ™¯ä¸‹çš„å¡ç‰‡æ ·å¼é€»è¾‘ ---
			const activeBg = equippedGear?.[activeChild]?.background;
			// æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦é«˜ä¸é€æ˜åº¦èƒŒæ™¯çš„è£…å¤‡ (ç”²éª¨æµæ²™ æˆ– ä¸‡è±¡å­—é˜µ)
			const isSolidBgNeeded = ['bg_oraclesands', 'bg_matrix'].includes(activeBg);
			// å¦‚æœæ˜¯ç‰¹æ®ŠèƒŒæ™¯ï¼Œä½¿ç”¨ bg-white/90 (90%ä¸é€æ˜åº¦)ï¼Œå¦åˆ™ä¿æŒåŸæ¥çš„ bg-amber-50/30 (åŠé€æ˜)
			const bgStyle = isSolidBgNeeded ? 'bg-white/90' : 'bg-amber-50/30';
			const completedBgStyle = isSolidBgNeeded ? 'bg-yellow-50/90' : 'bg-yellow-50/30'; // å®ŒæˆçŠ¶æ€ä¹ŸåŒæ­¥åŠ æ·±

            return (
                <div className={`p-4 rounded-2xl border shadow-sm relative overflow-hidden group hover:shadow-md transition-all ${isCompleted ? `border-yellow-200 ${completedBgStyle}` : task.type === 'core' ? `${bgStyle} border-amber-100` : `${bgStyle} border-stone-200`}`}>
                    {isCompleted && <div className="absolute -right-4 -top-4 w-16 h-16 bg-gradient-to-br from-yellow-300 to-amber-500 rounded-full flex items-end justify-start pl-3 pb-3 text-white shadow-lg"><Trophy className="w-6 h-6 animate-bounce" /></div>}
                    <div className="flex justify-between items-start mb-2 relative z-10"><h3 className="font-bold text-gray-800 truncate pr-2 text-lg flex items-center gap-1">
						{task.type === 'core' 
							? <span title="æ ¸å¿ƒä»»åŠ¡" className="text-amber-500 drop-shadow-sm">â­</span> 
							: <span title="æ—¥å¸¸ä»»åŠ¡" className="text-emerald-500 drop-shadow-sm">ğŸƒ</span>
						}
						{task.name}
					</h3><div className="text-right shrink-0"><span className="block text-2xl font-black text-amber-500 drop-shadow-sm">{stats.totalIncome}</span><span className="text-[10px] text-gray-400 font-medium uppercase tracking-wider">é‡‘å…ƒå®</span></div></div>
                    {task.targetGoal && <div className={`mb-3 text-sm ${theme.primary} ${theme.lightBg} p-2 rounded-lg border ${theme.lightBorder} flex items-start gap-2`}><Flag className="w-4 h-4 shrink-0 mt-0.5 opacity-70" /><span className="leading-snug opacity-90">{task.targetGoal}</span></div>}
                    <div className="space-y-3"><div><div className="flex justify-between text-xs text-gray-400 mb-1 font-medium"><span>è¿›åº¦ {currentCount}/{task.targetCount}</span><span>{Math.round(stats.progress)}%</span></div><div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className={`h-full rounded-full transition-all duration-700 ${isCompleted ? 'bg-gradient-to-r from-yellow-400 to-amber-500' : `bg-gradient-to-r ${theme.gradient}`}`} style={{ width: `${stats.progress}%` }}></div></div></div><div className="grid grid-cols-2 gap-2 text-xs text-gray-500"><div className="bg-gray-50 rounded-lg p-2 flex items-center gap-2"><Clock className="w-3.5 h-3.5 text-gray-400" /><span>å‡æ—¶: <span className="font-bold text-gray-700">{stats.avg}åˆ†</span></span></div><div className="bg-gray-50 rounded-lg p-2 flex items-center gap-2"><Target className="w-3.5 h-3.5 text-gray-400" /><span>æˆªæ­¢: <span className="font-bold text-gray-700">{stats.targetDate.getMonth()+1}/{stats.targetDate.getDate()}</span></span></div></div></div>
                    {hasSkipCard && !isCheckedToday && !isCompleted && (
                         <button onClick={() => onUseSkipCard(task)} className="mt-3 w-full py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold border border-indigo-100 hover:bg-indigo-100 transition-colors">ä½¿ç”¨å…ä½œä¸šé‡‘ç‰Œè·³è¿‡</button>
                    )}
                </div>
            );
        };

		// --- æ–°å¢ç»„ä»¶ï¼šè½»é‡çº§ SVG æŠ˜çº¿å›¾ ---
        const SimpleLineChart = ({ data, color, height = 250 }) => {
            if (!data || data.length === 0) return <div className={`h-[${height}px] flex items-center justify-center text-gray-300`}>æš‚æ— æ•°æ®</div>;
            
            // ä½¿ç”¨æ›´å®½çš„åæ ‡ç³» (1000x300) æ¥é¿å…å®½å±ä¸‹çš„æ‹‰ä¼¸å˜å½¢
            const VIEW_W = 1000;
            const VIEW_H = 300;
            
            const maxVal = Math.max(...data.map(d => d.value), 1); // é˜²æ­¢é™¤ä»¥0
            
            const pts = data.map((d, i) => {
                const x = (i / (data.length - 1)) * VIEW_W;
                // é¢„ç•™åº•éƒ¨ padding é˜²æ­¢ç‚¹è¢«åˆ‡æ‰
                const y = VIEW_H - (d.value / maxVal) * (VIEW_H * 0.8) - 20; 
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full relative" style={{ height: `${height}px` }}>
                    {/* preserveAspectRatio="none" å…è®¸è‡ªé€‚åº”å®½åº¦ï¼Œä½†é…åˆå¤§åæ ‡ç³»å˜å½¢ä¼šå¾ˆå° */}
                    <svg viewBox={`0 0 ${VIEW_W} ${VIEW_H}`} preserveAspectRatio="none" className="w-full h-full overflow-visible">
                        {/* èƒŒæ™¯ç½‘æ ¼çº¿ (3æ¡) */}
                        <line x1="0" y1={VIEW_H - 20} x2={VIEW_W} y2={VIEW_H - 20} stroke="#f3f4f6" strokeWidth="2" />
                        <line x1="0" y1={VIEW_H * 0.5} x2={VIEW_W} y2={VIEW_H * 0.5} stroke="#f3f4f6" strokeWidth="2" strokeDasharray="10,10" />
                        <line x1="0" y1="20" x2={VIEW_W} y2="20" stroke="#f3f4f6" strokeWidth="2" strokeDasharray="10,10" />
                        
                        {/* æ¸å˜å¡«å…… (å¯é€‰ï¼Œå¢åŠ é«˜çº§æ„Ÿ) */}
                        <defs>
                            <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor={color} stopOpacity="0.2" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        <polygon points={`0,${VIEW_H} ${pts} ${VIEW_W},${VIEW_H}`} fill="url(#chartGradient)" />

                        {/* æŠ˜çº¿ */}
                        <polyline points={pts} fill="none" stroke={color} strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />
                        
                        {/* æ•°æ®ç‚¹ */}
                        {data.map((d, i) => {
                            const x = (i / (data.length - 1)) * VIEW_W;
                            const y = VIEW_H - (d.value / maxVal) * (VIEW_H * 0.8) - 20;
                            return (
                                <g key={i} className="group">
                                    {/* éšå½¢ç‚¹å‡»åŒºåŸŸï¼Œæ–¹ä¾¿æ‰‹æŒ‡è§¦æ‘¸ */}
                                    <circle cx={x} cy={y} r="20" fill="transparent" /> 
                                    <circle cx={x} cy={y} r="6" fill="white" stroke={color} strokeWidth="3" />
                                    
                                    {/* æ‚¬åœæ˜¾ç¤ºæ•°å€¼ Tooltip (ä¼˜åŒ–æ ·å¼) */}
                                    <g className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                        <rect x={x - 30} y={y - 50} width="60" height="24" rx="4" fill="rgba(0,0,0,0.8)" />
                                        <text x={x} y={y - 38} fontSize="14" fill="white" textAnchor="middle" dominantBaseline="middle" fontWeight="bold">{d.value}m</text>
                                        {/* åº•éƒ¨æ—¥æœŸæ ‡ç­¾ */}
                                        <text x={x} y={VIEW_H + 30} fontSize="12" fill="#9ca3af" textAnchor="middle">{d.label}</text>
                                    </g>
                                </g>
                            );
                        })}
                    </svg>
                    {/* Xè½´æ ‡ç­¾ (åªæ˜¾ç¤ºé¦–å°¾ï¼Œé¿å…é‡å ) */}
                    <div className="absolute bottom-[-25px] left-0 w-full flex justify-between text-xs text-gray-400 font-bold px-1">
                        <span>{data[0]?.label}</span>
                        <span>{data[data.length - 1]?.label}</span>
                    </div>
                </div>
            );
        };

        // --- æ–°å¢ç»„ä»¶ï¼šç»Ÿè®¡å›¾è¡¨å¼¹çª— ---
        // --- ä¼˜åŒ–ç‰ˆç»„ä»¶ï¼šç»Ÿè®¡å›¾è¡¨å¼¹çª— ---
        const StatsModal = ({ show, onClose, checkins, tasks, activeChild, theme }) => {
            if (!show) return null;
            
            const [timeRange, setTimeRange] = useState('week'); // week, month, total
            const [selectedTask, setSelectedTask] = useState('all'); // all, or taskId

            // æ•°æ®å¤„ç†é€»è¾‘
            const statsData = useMemo(() => {
                const childCheckins = checkins[activeChild] || {};
                const today = getLocalDateKey(0); // ä½¿ç”¨æœ¬åœ°æ—¶é—´
                
                // 1. è®¡ç®—ä»Šæ—¥ç”¨æ—¶ (ã€ä¿®å¤ã€‘ï¼šæ ¹æ®æ˜¯å¦é€‰æ‹©ä»»åŠ¡æ¥åŠ¨æ€è®¡ç®—)
                let todayTotal = 0;
                if (selectedTask === 'all') {
                    Object.values(childCheckins).forEach(taskRecord => {
                        todayTotal += (taskRecord[today] || 0);
                    });
                } else {
                    todayTotal = (childCheckins[selectedTask]?.[today] || 0);
                }

                // 2. å‡†å¤‡æ—¥æœŸèŒƒå›´
                const dates = [];
                const now = new Date();
                const daysCount = timeRange === 'week' ? 7 : timeRange === 'month' ? 30 : 90; 
                
                for (let i = daysCount - 1; i >= 0; i--) {
                    // ä¼ å…¥ -i è¡¨ç¤ºå¾€å‰æ¨ i å¤©
                    dates.push(getLocalDateKey(-i));
                }

                // 3. ç”ŸæˆæŠ˜çº¿å›¾æ•°æ®
                const lineData = dates.map(date => {
                    let val = 0;
                    if (selectedTask === 'all') {
                        Object.values(childCheckins).forEach(taskRecord => {
                            val += (taskRecord[date] || 0);
                        });
                    } else {
                        val = (childCheckins[selectedTask]?.[date] || 0);
                    }
                    const dateObj = new Date(date);
                    const label = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                    return { label, value: val };
                });

                // 4. è®¡ç®—æ—¥å‡
                const rangeTotal = lineData.reduce((acc, cur) => acc + cur.value, 0);
                const dailyAvg = Math.round(rangeTotal / daysCount);

                return { todayTotal, dailyAvg, lineData };
            }, [checkins, activeChild, timeRange, selectedTask]);

            const childTasks = tasks[activeChild] || [];
            
            // ç®€å•çš„é¢œè‰²æå–
            let chartColor = '#6366f1'; // é»˜è®¤ indigo
            if (theme.primary.includes('rose')) chartColor = '#e11d48';
            else if (theme.primary.includes('sky')) chartColor = '#0284c7';
            else if (theme.primary.includes('amber')) chartColor = '#d97706';
            else if (theme.primary.includes('emerald')) chartColor = '#059669';
            else if (theme.primary.includes('violet')) chartColor = '#7c3aed';

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95" onClick={e => e.stopPropagation()}>
                        {/* å¤´éƒ¨ */}
                        <div className={`p-6 border-b bg-gradient-to-r ${theme.gradient} text-white flex justify-between items-center shrink-0`}>
                            <div>
                                <h2 className="text-2xl font-black flex items-center gap-2">
                                    <span className="text-3xl">ğŸ“Š</span> 
                                    å­¦ä¹ æ•°æ®ä¸­å¿ƒ
                                </h2>
                                <p className="text-white/80 text-xs mt-1">è®°å½• {activeChild} çš„æ¯ä¸€åˆ†åŠªåŠ›</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors">
                                <XIcon className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                            {/* é¡¶éƒ¨æ¦‚è§ˆå¡ç‰‡ */}
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center justify-center relative overflow-hidden">
                                    <div className={`absolute inset-0 opacity-5 ${theme.bgGradient}`}></div>
                                    <div className="text-gray-500 text-xs font-bold mb-1 z-10 flex items-center gap-1">
                                        {selectedTask === 'all' ? 'ä»Šæ—¥æ€»æŠ•å…¥' : `ä»Šæ—¥ ${childTasks.find(t=>t.id===selectedTask)?.name || 'é¡¹ç›®'} æŠ•å…¥`}
                                    </div>
                                    <div className={`text-4xl font-black z-10 ${theme.primary} drop-shadow-sm`}>
                                        {statsData.todayTotal}<span className="text-base ml-1 font-bold text-gray-400">åˆ†é’Ÿ</span>
                                    </div>
                                    {statsData.todayTotal > 0 && (
                                        <div className="text-[10px] text-green-600 font-bold mt-2 bg-green-100 px-2 py-0.5 rounded-full flex items-center gap-1">
                                            ğŸ”¥ ä¿æŒä¸“æ³¨
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center justify-center">
                                    <div className="text-gray-500 text-xs font-bold mb-1">å¹³å‡æ¯æ—¥ (è¿‘{timeRange === 'week' ? '7' : timeRange === 'month' ? '30' : '90'}å¤©)</div>
                                    <div className="text-4xl font-black text-gray-700">
                                        {statsData.dailyAvg}<span className="text-base ml-1 font-bold text-gray-400">åˆ†é’Ÿ</span>
                                    </div>
                                    <div className="text-[10px] text-gray-400 mt-2">
                                        æŒç»­ç§¯ç´¯ä¸­...
                                    </div>
                                </div>
                            </div>

                            {/* --- ä¼˜åŒ–åçš„æ§åˆ¶æ ï¼šåˆ†å±‚æ ‡ç­¾äº‘å¸ƒå±€ --- */}
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mb-6 flex flex-col gap-5">
                                
                                {/* 1. é¡¹ç›®é€‰æ‹©åŒº (æ”¹ä¸ºè‡ªåŠ¨æ¢è¡Œï¼Œç¡®ä¿æ‰€æœ‰é¡¹ç›®å¯è§) */}
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="text-xs text-gray-400 font-bold flex items-center gap-2">
                                            <span className={`w-1.5 h-4 rounded-full ${theme.primaryBg}`}></span>
                                            ç»Ÿè®¡ç»´åº¦
                                        </div>
                                        <div className="text-[10px] text-gray-300 font-medium">
                                            å…± {childTasks.length + 1} ä¸ªç»´åº¦
                                        </div>
                                    </div>
                                    
                                    <div className="flex flex-wrap gap-2">
                                        <button 
                                            onClick={() => setSelectedTask('all')}
                                            className={`relative px-4 py-2 rounded-xl text-xs font-bold transition-all duration-300 border 
                                                ${selectedTask === 'all' 
                                                    ? `${theme.primaryBg} border-transparent text-white shadow-lg shadow-indigo-200 transform scale-105 z-10` 
                                                    : 'bg-slate-50 border-slate-100 text-slate-500 hover:bg-slate-100 hover:border-slate-200'
                                                }`}
                                        >
                                            å…¨è§ˆè§†å›¾
                                            {selectedTask === 'all' && <span className="absolute -top-1 -right-1 flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>}
                                        </button>
                                        
                                        {childTasks.map(t => (
                                            <button 
                                                key={t.id} 
                                                onClick={() => setSelectedTask(t.id)}
                                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all duration-300 border 
                                                    ${selectedTask === t.id 
                                                        ? `${theme.primaryBg} border-transparent text-white shadow-lg shadow-indigo-200 transform scale-105 z-10` 
                                                        : 'bg-slate-50 border-slate-100 text-slate-500 hover:bg-slate-100 hover:border-slate-200'
                                                    }`}
                                            >
                                                {t.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* åˆ†éš”çº¿ */}
                                <div className="h-px w-full bg-gradient-to-r from-transparent via-gray-100 to-transparent"></div>

                                {/* 2. æ—¶é—´èŒƒå›´é€‰æ‹© (æ”¹ä¸ºèƒ¶å›Šåˆ‡æ¢å™¨) */}
                                <div>
                                    <div className="text-xs text-gray-400 font-bold mb-3 flex items-center gap-2">
                                        <Clock className="w-3 h-3" />
                                        æ—¶é—´è·¨åº¦
                                    </div>
                                    <div className="flex bg-slate-100 p-1 rounded-xl w-full sm:w-fit">
                                        {['week', 'month', 'total'].map(r => (
                                            <button
                                                key={r}
                                                onClick={() => setTimeRange(r)}
                                                className={`flex-1 sm:flex-none px-6 py-1.5 rounded-lg text-xs font-bold transition-all duration-300 
                                                    ${timeRange === r 
                                                        ? 'bg-white text-gray-800 shadow-sm scale-[1.02]' 
                                                        : 'text-gray-400 hover:text-gray-600'
                                                    }`}
                                            >
                                                {r === 'week' ? 'è¿‘7å¤©' : r === 'month' ? 'è¿‘30å¤©' : 'å…¨éƒ¨è®°å½•'}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* å›¾è¡¨åŒºåŸŸ */}
                            <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm mb-6">
                                <h3 className="text-sm font-bold text-gray-700 mb-6 flex items-center gap-2">
                                    <span className={`w-2 h-2 rounded-full ${theme.primaryBg}`}></span>
                                    {selectedTask === 'all' ? 'æ€»æŠ•å…¥æ—¶é—´è¶‹åŠ¿' : 'å•é¡¹æŠ•å…¥è¶‹åŠ¿'}
                                </h3>
                                <div>
                                    <SimpleLineChart data={statsData.lineData} color={chartColor} height={250} />
                                </div>
                            </div>

                            {/* é¼“åŠ±è¯­ */}
                            <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 flex items-start gap-3">
                                <div className="text-2xl">ğŸ’¡</div>
                                <div>
                                    <h4 className="font-bold text-indigo-900 text-sm">æ•°æ®ä¼šè¯´è¯</h4>
                                    <p className="text-xs text-indigo-700 mt-1 leading-relaxed">
                                        {selectedTask === 'all' 
                                            ? 'è§‚å¯Ÿä½ çš„æ³¢å³°å’Œæ³¢è°·ï¼Œæ‰¾åˆ°æ•ˆç‡æœ€é«˜çš„é‚£ä¸€å¤©ï¼ä¿æŒç¨³å®šçš„æ¯æ—¥æŠ•å…¥æ¯”çªå‡»æ›´é‡è¦å“¦ã€‚' 
                                            : `åœ¨"${childTasks.find(t=>t.id===selectedTask)?.name}"ä¸Šï¼Œä½ å·²ç»ç´¯è®¡æŠ•å…¥äº† ${statsData.lineData.reduce((a,b)=>a+b.value,0)} åˆ†é’Ÿï¼Œç»§ç»­åŠ æ²¹ï¼`}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

		// --- è·å–æœ¬åœ°æ—¶é—´ YYYY-MM-DD çš„å·¥å…·å‡½æ•° ---
		// è§£å†³å‡Œæ™¨0-8ç‚¹æ—¥æœŸåˆ¤å®šé”™è¯¯çš„é—®é¢˜
		const getLocalDateKey = (offsetDays = 0) => {
			const d = new Date();
			d.setDate(d.getDate() + offsetDays);
			const year = d.getFullYear();
			// getMonth() ä»0å¼€å§‹ï¼Œæ‰€ä»¥è¦+1ï¼ŒpadStartä¿è¯æ˜¯ä¸¤ä½æ•°(02æœˆ)
			const month = String(d.getMonth() + 1).padStart(2, '0');
			const day = String(d.getDate()).padStart(2, '0');
			return `${year}-${month}-${day}`;
		};
		
		// --- [2026-2028ç‰ˆ] æ™ºèƒ½èŠ‚æ—¥ä¸å…¨æ é…è‰²é€»è¾‘ ---
        const getHolidayInfo = (dateObj) => {
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const year = dateObj.getFullYear();
            const dateStr = `${month}-${day}`;
            const fullDateStr = `${year}-${month}-${day}`;

            // A. å†œå†/ç‰¹æ®ŠèŠ‚æ—¥è¡¨ (2026-2028)
            const lunarHolidays = {
                // 2026
                '2026-2-16': 'é™¤å¤•', '2026-2-17': 'æ˜¥èŠ‚', '2026-3-3': 'å…ƒå®µèŠ‚',
                '2026-4-5': 'æ¸…æ˜èŠ‚', '2026-6-19': 'ç«¯åˆèŠ‚', '2026-9-25': 'ä¸­ç§‹èŠ‚',
                // 2027
                '2027-2-5': 'é™¤å¤•', '2027-2-6': 'æ˜¥èŠ‚', '2027-2-20': 'å…ƒå®µèŠ‚',
                '2027-4-5': 'æ¸…æ˜èŠ‚', '2027-6-9': 'ç«¯åˆèŠ‚', '2027-9-15': 'ä¸­ç§‹èŠ‚',
                // 2028
                '2028-1-25': 'é™¤å¤•', '2028-1-26': 'æ˜¥èŠ‚', '2028-2-9': 'å…ƒå®µèŠ‚',
                '2028-4-4': 'æ¸…æ˜èŠ‚', '2028-5-28': 'ç«¯åˆèŠ‚', '2028-10-3': 'ä¸­ç§‹èŠ‚',
            };

            // B. å›ºå®šå…¬å†èŠ‚æ—¥
            const solarHolidays = {
                '1-1': 'å…ƒæ—¦', '3-8': 'å¦‡å¥³èŠ‚', '3-12': 'æ¤æ ‘èŠ‚', '5-1': 'åŠ³åŠ¨èŠ‚',
                '5-4': 'é’å¹´èŠ‚', '6-1': 'å„¿ç«¥èŠ‚', '7-1': 'å»ºå…šèŠ‚', '8-1': 'å»ºå†›èŠ‚',
                '9-10': 'æ•™å¸ˆèŠ‚', '10-1': 'å›½åº†èŠ‚', '12-25': 'åœ£è¯èŠ‚'
            };

            if (lunarHolidays[fullDateStr]) return { name: lunarHolidays[fullDateStr], isMajor: true };
            if (solarHolidays[dateStr]) {
                const name = solarHolidays[dateStr];
                const majorOnes = ['å…ƒæ—¦', 'åŠ³åŠ¨èŠ‚', 'å›½åº†èŠ‚', 'å„¿ç«¥èŠ‚', 'å»ºå†›èŠ‚', 'å»ºå…šèŠ‚'];
                return { name: name, isMajor: majorOnes.includes(name) };
            }
            return null;
        };

        // è·å–æ•´ä¸ªHeaderçš„ä¸»é¢˜è‰²
        const getHeaderTheme = (dateObj, holiday) => {
            // 1. èŠ‚æ—¥é™å®š (å…¨å±æ¸å˜)
            if (holiday) {
                if (['æ˜¥èŠ‚', 'é™¤å¤•', 'å…ƒæ—¦', 'å…ƒå®µèŠ‚', 'å›½åº†èŠ‚', 'å»ºå…šèŠ‚'].includes(holiday.name)) {
                    return { gradient: 'from-red-700 via-red-600 to-amber-600', text: 'text-amber-50', icon: 'ğŸ§§' };
                }
                if (holiday.name === 'ç«¯åˆèŠ‚') return { gradient: 'from-emerald-700 via-teal-600 to-cyan-600', text: 'text-emerald-50', icon: 'ğŸ›¶' };
                if (holiday.name === 'ä¸­ç§‹èŠ‚') return { gradient: 'from-slate-900 via-indigo-900 to-blue-900', text: 'text-amber-50', icon: 'ğŸŒ•' }; // æ·±é‚ƒå¤œç©º
                if (holiday.name === 'å„¿ç«¥èŠ‚') return { gradient: 'from-pink-500 via-purple-500 to-indigo-500', text: 'text-white', icon: 'ğŸˆ' };
                if (holiday.name === 'åŠ³åŠ¨èŠ‚') return { gradient: 'from-orange-600 via-amber-600 to-yellow-500', text: 'text-white', icon: 'ğŸ› ï¸' };
                if (holiday.name === 'å¦‡å¥³èŠ‚') return { gradient: 'from-rose-500 via-pink-500 to-fuchsia-500', text: 'text-white', icon: 'ğŸŒ¹' };
            }
            
            // 2. æ—¥å¸¸æ˜ŸæœŸé…è‰² (å…¨å±æ¸å˜)
            const weekThemes = [
                { gradient: 'from-orange-500 via-amber-500 to-yellow-400', icon: 'â˜€ï¸' }, // å‘¨æ—¥ï¼šé˜³å…‰
                { gradient: 'from-blue-700 via-blue-600 to-indigo-500', icon: 'ğŸš€' },     // å‘¨ä¸€ï¼šå•†åŠ¡è“
                { gradient: 'from-cyan-600 via-sky-500 to-blue-500', icon: 'ğŸ’»' },       // å‘¨äºŒï¼šä¸“æ³¨
                { gradient: 'from-emerald-600 via-green-500 to-teal-500', icon: 'ğŸŒ±' },  // å‘¨ä¸‰ï¼šæ¸…æ–°
                { gradient: 'from-amber-600 via-orange-500 to-red-500', icon: 'ğŸ”¥' },    // å‘¨å››ï¼šèƒ½é‡
                { gradient: 'from-violet-600 via-purple-600 to-fuchsia-500', icon: 'ğŸ‰' }, // å‘¨äº”ï¼šç‹‚æ¬¢
                { gradient: 'from-rose-600 via-pink-500 to-red-400', icon: 'ğŸ¡' },       // å‘¨å…­ï¼šæ„‰æ‚¦
            ];
            
            const theme = weekThemes[dateObj.getDay()];
            return { ...theme, text: 'text-white' };
        };
		
		// --- ã€æ–°å¢ç»„ä»¶ã€‘å‘¨æœ«åŠ¨æ€ä»ªè¡¨ç›˜ ---
        const WeekendDashboard = ({ tasks, checkins, activeChild, settings, theme }) => {
            const today = new Date();
            const day = today.getDay();
            const isWeekend = day === 0 || day === 6; // å‘¨å…­æˆ–å‘¨æ—¥
            
            if (!isWeekend) return null;

            const dateKey = getLocalDateKey(0);
            const childTasks = tasks[activeChild] || [];
            const childCheckins = checkins[activeChild] || {};

            // åˆ†ç±»ç»Ÿè®¡
            const coreTasks = childTasks.filter(t => t.type === 'core');
            const dailyTasks = childTasks.filter(t => t.type !== 'core'); // é»˜è®¤ä¸ºæ—¥å¸¸

            const calcProgress = (taskList) => {
                if (taskList.length === 0) return { count: 0, total: 0, percent: 0, isMet: false };
                let completed = 0;
                taskList.forEach(t => {
                    const record = childCheckins[t.id]?.[dateKey];
                    // åªè¦ä»Šå¤©æœ‰æ‰“å¡è®°å½•å°±ç®—å®Œæˆ (æˆ–è€…æ ¹æ®æ‚¨çš„é€»è¾‘åˆ¤æ–­ targetCount)
                    // è¿™é‡Œç®€åŒ–ä¸ºï¼šåªè¦ä»Šå¤©æ‰“äº†å¡å°±ç®—è¯¥é¡¹â€œæ¨è¿›äº†â€
                    if (record) completed++; 
                });
                return { 
                    count: completed, 
                    total: taskList.length, 
                    percent: Math.round((completed / taskList.length) * 100)
                };
            };

            const coreStats = calcProgress(coreTasks);
            const dailyStats = calcProgress(dailyTasks);
            
            const coreMet = coreStats.percent >= settings.coreThreshold;
            const dailyMet = dailyStats.percent >= settings.dailyThreshold;
            const isPerfect = coreStats.percent === 100 && dailyStats.percent === 100;

            return (
                <div className="mb-6 mx-4 relative overflow-hidden rounded-2xl shadow-xl animate-in slide-in-from-top-4 duration-700">
                    {/* åŠ¨æ€èƒŒæ™¯ */}
                    <div className={`absolute inset-0 bg-gradient-to-r ${isPerfect ? 'from-purple-600 via-pink-500 to-amber-500' : 'from-indigo-900 via-blue-800 to-indigo-900'} opacity-90`}></div>
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20 mix-blend-overlay"></div>
                    
                    {/* è£…é¥°å…‰æ•ˆ */}
                    <div className="absolute -top-10 -right-10 w-32 h-32 bg-white/20 rounded-full blur-3xl animate-pulse"></div>
                    
                    <div className="relative z-10 p-5 text-white">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-lg font-black flex items-center gap-2">
                                    {isPerfect ? 'ğŸ‰ å®Œç¾å‘¨æœ«è¾¾æˆï¼' : 'ğŸš€ å‘¨æœ«å†²åˆºæ¨¡å¼'}
                                    <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded-full border border-white/30 uppercase tracking-wider">Weekend Vibes</span>
                                </h3>
                                <p className="text-xs text-white/80 mt-1">
                                    {isPerfect 
                                        ? 'ä½ çœŸæ˜¯å¤ªæ£’äº†ï¼äº«å—ä½ çš„è£è€€æ—¶åˆ»å§ï¼' 
                                        : `ç›®æ ‡ï¼šæ ¸å¿ƒä»»åŠ¡ ${settings.coreThreshold}% + æ—¥å¸¸ä»»åŠ¡ ${settings.dailyThreshold}%`}
                                </p>
                            </div>
                            <div className="text-right">
                                <div className="text-xs font-bold opacity-70">è¿ç»­è¾¾æ ‡</div>
                                <div className="text-2xl font-black text-yellow-300 drop-shadow-md">ä¿æŒä¸­ğŸ”¥</div>
                            </div>
                        </div>

                        {/* è¿›åº¦æ¡åŒºåŸŸ */}
                        <div className="space-y-3">
                            {/* æ ¸å¿ƒä»»åŠ¡è¿›åº¦ */}
                            <div>
                                <div className="flex justify-between text-xs font-bold mb-1">
                                    <span className="flex items-center gap-1 text-yellow-200"><span className="text-sm">â­</span> æ ¸å¿ƒä»»åŠ¡ ({coreStats.count}/{coreStats.total})</span>
                                    <span className={coreMet ? 'text-green-300' : 'text-white/60'}>{coreStats.percent}% {coreMet && 'âœ” å·²è¾¾æ ‡'}</span>
                                </div>
                                <div className="h-3 bg-black/30 rounded-full overflow-hidden border border-white/10 backdrop-blur-sm">
                                    <div 
                                        className={`h-full transition-all duration-1000 ease-out relative ${coreMet ? 'bg-gradient-to-r from-yellow-400 to-amber-600' : 'bg-white/30'}`} 
                                        style={{ width: `${coreStats.percent}%` }}
                                    >
                                        {coreStats.percent >= 100 && <div className="absolute inset-0 bg-white/50 animate-[shine_1s_infinite]"></div>}
                                    </div>
                                </div>
                            </div>

                            {/* æ—¥å¸¸ä»»åŠ¡è¿›åº¦ */}
                            <div>
                                <div className="flex justify-between text-xs font-bold mb-1">
                                    <span className="flex items-center gap-1 text-emerald-200"><span className="text-sm">ğŸƒ</span> æ—¥å¸¸ä»»åŠ¡ ({dailyStats.count}/{dailyStats.total})</span>
                                    <span className={dailyMet ? 'text-green-300' : 'text-white/60'}>{dailyStats.percent}% {dailyMet && 'âœ” å·²è¾¾æ ‡'}</span>
                                </div>
                                <div className="h-3 bg-black/30 rounded-full overflow-hidden border border-white/10 backdrop-blur-sm">
                                    <div 
                                        className={`h-full transition-all duration-1000 ease-out relative ${dailyMet ? 'bg-gradient-to-r from-emerald-400 to-teal-500' : 'bg-white/30'}`} 
                                        style={{ width: `${dailyStats.percent}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
		
		const WeekendSettlementModal = ({ state, onClose, onUseExemption, settings }) => {
            if (!state) return null;
            const { type, coreStats, dailyStats, reward } = state;

            // æ ¹æ®ç»“æœç±»å‹é…ç½®æ ·å¼
            const config = {
                perfect: { bg: 'bg-gradient-to-br from-purple-900 to-indigo-900', icon: 'ğŸ†', title: 'å®Œç¾å‘¨æœ«ï¼', textColor: 'text-yellow-300' },
                pass: { bg: 'bg-gradient-to-br from-green-600 to-emerald-700', icon: 'ğŸ‰', title: 'å‘¨æœ«è¾¾æ ‡', textColor: 'text-white' },
                fail: { bg: 'bg-gradient-to-br from-slate-700 to-gray-800', icon: 'ğŸ¥€', title: 'æœªè¾¾æ ‡', textColor: 'text-gray-300' }
            }[type];

            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in zoom-in-95 duration-500">
                    <div className={`w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative ${config.bg} text-white border border-white/10`}>
                        {type === 'perfect' && <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>}
                        
                        <div className="p-8 text-center relative z-10">
                            <div className="text-6xl mb-4 animate-bounce">{config.icon}</div>
                            <h2 className={`text-3xl font-black mb-2 ${config.textColor}`}>{config.title}</h2>
                            <div className="flex justify-center gap-4 mb-6 text-sm font-medium opacity-80">
                                <span>â­ æ ¸å¿ƒ: {coreStats.percent}%</span>
                                <span>ğŸƒ æ—¥å¸¸: {dailyStats.percent}%</span>
                            </div>
                            
                            <p className="text-sm leading-relaxed opacity-90 mb-8 bg-black/20 p-4 rounded-xl backdrop-blur-sm">
                                {type === 'perfect' && "ä¸å¯æ€è®®ï¼ä½ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼è·å¾—äº†ã€å®Œç¾å‘¨æœ«ç¤¼åŒ…ã€‘+100é‡‘å…ƒå®ï¼"}
                                {type === 'pass' && "æ­å–œï¼ä½ è¾¾åˆ°äº†è®¾å®šçš„ç›®æ ‡ã€‚è¿èƒœç»§ç»­ï¼Œè·å¾—60é‡‘å…ƒå®å¥–åŠ±ï¼"}
                                {type === 'fail' && "å¾ˆé—æ†¾ï¼Œä»Šå¤©çš„ä»»åŠ¡æ²¡æœ‰è¾¾æ ‡ã€‚è¿èƒœè®°å½•å·²ä¸­æ–­..."}
                            </p>

                            {type === 'fail' ? (
                                <div className="space-y-3">
                                    <button onClick={onClose} className="w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-bold transition-all">
                                        æ¥å—ç»“æœ
                                    </button>
                                    {settings.guardianPassCount > 0 && (
                                        <button onClick={onUseExemption} className="w-full py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold shadow-lg animate-pulse hover:scale-105 transition-transform flex items-center justify-center gap-2">
                                            <Shield className="w-4 h-4" /> ä½¿ç”¨ç›‘æŠ¤äººè±å… (å‰©ä½™{settings.guardianPassCount})
                                        </button>
                                    )}
                                </div>
                            ) : (
                                <button onClick={onClose} className="w-full py-3 rounded-xl bg-white text-gray-900 font-bold shadow-lg hover:scale-105 transition-transform">
                                    {type === 'perfect' ? 'å¼€å¯ç¤¼åŒ…' : 'é¢†å–å¥–åŠ±'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
		
		// --- [æ–°å¢] WMO å¤©æ°”ä»£ç è½¬æ¢å™¨ ---
        // å°† Open-Meteo çš„æ•°å­—ä»£ç è½¬æ¢ä¸ºæˆ‘ä»¬çš„å¤©æ°”ç±»å‹
        const convertWMOToType = (code) => {
            // 0: æ™´å¤©
            if (code === 0) return 'sunny';
            // 1, 2, 3: å¤šäº‘
            if ([1, 2, 3, 45, 48].includes(code)) return 'cloudy';
            // 51-67, 80-82: é›¨
            if ([51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(code)) return 'rainy';
            // 71-77, 85-86: é›ª
            if ([71, 73, 75, 77, 85, 86].includes(code)) return 'snowy';
            
            return 'sunny'; // é»˜è®¤
        };
		
		// --- [æ–°å¢] æ™ºèƒ½å¤©æ°”æ¨¡æ‹Ÿç³»ç»Ÿ ---
        const getWeatherInfo = (dateObj) => {
            const hour = dateObj.getHours();
            const month = dateObj.getMonth() + 1;
            const isNight = hour < 6 || hour >= 18;
            
            // å­£èŠ‚åˆ¤æ–­
            let season = 'spring';
            if (month >= 6 && month <= 8) season = 'summer';
            else if (month >= 9 && month <= 11) season = 'autumn';
            else if (month === 12 || month <= 2) season = 'winter';

            // åŸºäºå­£èŠ‚çš„éšæœºå¤©æ°”æƒé‡ (æ¨¡æ‹Ÿ)
            // è¿™é‡Œä½¿ç”¨ç®€å•çš„å“ˆå¸Œç®—æ³•è®©åŒä¸€å¤©å†…çš„å¤©æ°”ç›¸å¯¹ç¨³å®šï¼Œé¿å…æ¯ç§’è·³å˜
            const dateSeed = dateObj.getDate() + month * 100 + dateObj.getFullYear() * 10000;
            // ç®€å•çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ (0-99)
            const random = (dateSeed * 9301 + 49297) % 233280 / 233280 * 100;

            let type = 'sunny';
            let tempBase = 20;

            if (season === 'summer') {
                tempBase = 30;
                if (random < 60) type = 'sunny';
                else if (random < 80) type = 'cloudy';
                else type = 'rainy';
            } else if (season === 'winter') {
                tempBase = 5;
                if (random < 40) type = 'sunny';
                else if (random < 70) type = 'cloudy';
                else if (random < 90) type = 'snowy';
                else type = 'rainy';
            } else {
                // æ˜¥ç§‹
                if (random < 50) type = 'sunny';
                else if (random < 80) type = 'cloudy';
                else type = 'rainy';
            }

            // ä¿®æ­£æ˜¼å¤œå›¾æ ‡
            if (isNight && type === 'sunny') type = 'clear_night';

            // æ¸©åº¦å¾®è°ƒ (æ—©æ™šå‡‰ï¼Œä¸­åˆçƒ­)
            let currentTemp = tempBase;
            if (hour >= 12 && hour <= 15) currentTemp += 3;
            else if (hour < 6 || hour > 20) currentTemp -= 5;
            
            // å¤©æ°”å…ƒæ•°æ®
            const weatherMap = {
                sunny: { icon: 'â˜€ï¸', text: 'æ™´æœ—', animation: 'sunny-effect', bg: 'from-blue-400 via-sky-400 to-cyan-300' },
                clear_night: { icon: 'ğŸŒ™', text: 'æ™´å¤œ', animation: 'starry-effect', bg: 'from-slate-900 via-indigo-900 to-slate-800' },
                cloudy: { icon: 'â˜ï¸', text: 'å¤šäº‘', animation: 'cloudy-effect', bg: 'from-slate-400 via-gray-400 to-slate-300' },
                rainy: { icon: 'ğŸŒ§ï¸', text: 'å°é›¨', animation: 'rainy-effect', bg: 'from-slate-700 via-slate-600 to-gray-500' },
                snowy: { icon: 'â„ï¸', text: 'ä¸‹é›ª', animation: 'snowy-effect', bg: 'from-indigo-100 via-blue-100 to-white' }
            };

            return { ...weatherMap[type], temp: Math.round(currentTemp) };
        };

        // --- [æ–°å¢] å¤©æ°”ç‰¹æ•ˆå›¾å±‚ç»„ä»¶ ---
        const WeatherEffects = ({ type }) => {
            if (type === 'sunny-effect') {
                return (
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-[-50%] left-[-20%] w-[150%] h-[150%] bg-gradient-to-br from-yellow-300/20 to-transparent rounded-full blur-3xl animate-[pulse_4s_infinite]"></div>
                        {/* ä¸è¾¾å°”å…‰æŸæ¨¡æ‹Ÿ */}
                        <div className="absolute top-0 right-0 w-full h-full bg-[linear-gradient(45deg,transparent_45%,rgba(255,255,255,0.1)_50%,transparent_55%)] bg-[length:200%_200%] animate-[shine_8s_linear_infinite]"></div>
                        <div className="absolute top-10 right-10 w-20 h-20 bg-yellow-400/30 rounded-full blur-xl animate-bounce" style={{animationDuration: '3s'}}></div>
                    </div>
                );
            }
            if (type === 'rainy-effect') {
                return (
                    <div className="absolute inset-0 overflow-hidden pointer-events-none weather-rain-container">
                        {/* ä½¿ç”¨ CSS ç”Ÿæˆå¤§é‡é›¨æ»´ */}
                        {[...Array(20)].map((_, i) => (
                            <div key={i} className="absolute bg-white/40 w-0.5 h-6 rounded-full animate-[rain_1s_linear_infinite]" 
                                style={{
                                    left: `${Math.random() * 100}%`,
                                    top: `-20px`,
                                    animationDuration: `${0.5 + Math.random() * 0.5}s`,
                                    animationDelay: `${Math.random()}s`
                                }}>
                            </div>
                        ))}
                    </div>
                );
            }
            if (type === 'snowy-effect') {
                return (
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        {[...Array(30)].map((_, i) => (
                            <div key={i} className="absolute bg-white/80 w-1.5 h-1.5 rounded-full animate-[snow_3s_linear_infinite]" 
                                style={{
                                    left: `${Math.random() * 100}%`,
                                    top: `-10px`,
                                    animationDuration: `${2 + Math.random() * 3}s`,
                                    animationDelay: `${Math.random() * 2}s`
                                }}>
                            </div>
                        ))}
                    </div>
                );
            }
             if (type === 'cloudy-effect') {
                return (
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-5 left-10 text-6xl opacity-20 animate-[float_6s_ease-in-out_infinite]">â˜ï¸</div>
                        <div className="absolute top-1/2 right-20 text-8xl opacity-10 animate-[float_8s_ease-in-out_infinite_reverse]">â˜ï¸</div>
                    </div>
                );
            }
            if (type === 'starry-effect') {
                return (
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                         {[...Array(30)].map((_, i) => (
                            <div key={i} className="absolute bg-white w-0.5 h-0.5 rounded-full animate-pulse" 
                                style={{
                                    left: `${Math.random() * 100}%`,
                                    top: `${Math.random() * 100}%`,
                                    animationDelay: `${Math.random() * 2}s`
                                }}>
                            </div>
                        ))}
                         <div className="absolute top-10 right-20 text-yellow-100/20 text-6xl animate-pulse">âœ¨</div>
                    </div>
                );
            }
            return null;
        };
		
		    // --- è‡ªå®šä¹‰ Hookï¼šæŒä¹…åŒ– State ---
            const useStickyState = (defaultValue, key) => {
                const [value, setValue] = useState(() => {
                    try {
                        const stickyValue = localStorage.getItem(key);
                        return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                    } catch (e) {
                        return defaultValue;
                    }
                });
                useEffect(() => {
                    try {
                        window.localStorage.setItem(key, JSON.stringify(value));
                    } catch (error) {
                        console.warn(`Error setting localStorage key â€œ${key}â€:`, error);
                    }
                }, [key, value]);
                return [value, setValue];
            };
		
		// --- ã€ä¿®æ”¹åã€‘ä¸Šå¸æ¨¡å¼æ§åˆ¶å°ç»„ä»¶ (æ‚¬æµ®çª—ç‰ˆ) ---
		const TesterDashboard = ({ 
			activeChild, 
			currentXP, 
			setXpHistory, 
			setWheelHistory, 
			checkAchievements, 
			tasks, 
			checkins, 
			setCheckins,
			setShowRandomEvent, 
			setCurrentRandomEvent,
			achievements,
			setAchievements, // æ–°å¢ï¼šç”¨äºæ¸…ç©ºæˆå°±
			setInventory,
			setMilestones,    // æ–°å¢ï¼šç”¨äºæ¸…ç©ºå¤§äº‹çºª
			setNotifiedLevels,
			setActiveBuffs,   // ç”¨äºæ¸…é™¤ Buff å’Œ æŠ•èµ„è®¡åˆ’
            setEquippedGear,  // ç”¨äºæ¸…é™¤ å·²è£…å¤‡çš„å¤–è§‚
            setStats,          // ç”¨äºæ¸…é™¤ çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆç­‰çŠ¶æ€
			wheelHistory,
			setCurriculumProgress,
            setRedeemedCoupons,
            setRandomEventHistory
		}) => {
			// åªæœ‰æµ‹è¯•å‘˜æ‰æ˜¾ç¤º
			if (activeChild !== 'æµ‹è¯•å‘˜') return null;

			const [isOpen, setIsOpen] = React.useState(false);

			// 1. æ¨¡æ‹Ÿå‡çº§
			const handleLevelUp = () => {
				const currentLevel = getLevelInfo(currentXP); 
				const nextLevel = LEVELS.find(l => l.level === currentLevel.level + 1);
				if (nextLevel) {
					const needed = nextLevel.xp - currentXP;
                    
					const key = `${activeChild}-GOD_MODE-${Date.now()}`;
					setXpHistory(prev => ({ ...prev, [key]: needed }));
                    
                    // ã€æ–°å¢ã€‘å¢åŠ ä¸€ä¸ªæ‰‹åŠ¨å¼¹çª—æç¤º
                    // å› ä¸ºä¸»ç¨‹åºå¯¹â€œåˆšç™»é™†æ—¶çš„é¦–æ¬¡å‡çº§â€æœ‰é˜²éªšæ‰°é™é»˜é€»è¾‘ï¼Œå¯èƒ½ä¸ä¼šå¼¹ç³»ç»Ÿé€šçŸ¥ï¼Œ
                    // è¿™é‡Œç›´æ¥å¼¹çª—åé¦ˆï¼Œè®©æ“ä½œè€…çŸ¥é“å‡çº§æˆåŠŸäº†
                    // alert(`ğŸš€ å‡çº§æŒ‡ä»¤å·²æ‰§è¡Œï¼\n\nå·²è¡¥è¶³ ${needed} XP\nå½“å‰ç­‰çº§ï¼šLv.${nextLevel.level} ${nextLevel.name}`);
				} else {
					alert("å·²è¾¾æœ€é«˜ç­‰çº§ï¼");
				}
			};

			// 2. è§¦å‘éšæœºäº‹ä»¶
			const handleForceEvent = (targetEra) => {
				let availableEvents = RANDOM_EVENTS;
				if (targetEra) {
					availableEvents = availableEvents.filter(e => e.era === targetEra);
				}
				if (availableEvents.length === 0) {
					alert("æ— å¯ç”¨äº‹ä»¶");
					return;
				}
				const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
				setCurrentRandomEvent(event);
				setShowRandomEvent(true);
			};

			// 3. èµ„æºç®¡ç†
			const addResource = (type, amount) => {
				const key = `${activeChild}-GOD_${type.toUpperCase()}-${Date.now()}`;
				
                if (type === 'gold') {
					// 1. åŸºäºä¼ è¿›æ¥çš„ wheelHistory æ„å»ºæœ€æ–°çš„è´¦å•
                    const newHistory = { ...wheelHistory, [key]: amount };
                    
                    // 2. æ›´æ–°çŠ¶æ€
                    setWheelHistory(newHistory);
                    
                    // 3. ã€å…³é”®ã€‘ç«‹å³æ‹¿ç€è¿™ä»½æœ€æ–°çš„è´¦å•å»æ£€æŸ¥æˆå°±ï¼
                    // è¿™æ ·â€œç¬¬ä¸€æ¡¶é‡‘â€ã€â€œå°å¯Œç¿â€ã€â€œè´¢æºæ»šæ»šâ€ç­‰æˆå°±ä¼šç«‹åˆ»å¼¹å‡º
                    checkAchievements('gold_earn', {}, { wheelHistory: newHistory });
				} else {
					setXpHistory(prev => ({ ...prev, [key]: amount }));
                    // alert(`å·²æ·»åŠ  ${amount} XP`);
				}
			};
			
			// 4. å¡«å……èƒŒåŒ…
			const fillInventory = () => {
				const allItems = {};
				SHOP_ITEMS.forEach(item => { allItems[item.id] = 5; });
				setInventory(prev => ({ ...prev, 'æµ‹è¯•å‘˜': allItems }));
			};

			// 5. ã€å‡çº§ç‰ˆã€‘æ¸…ç©ºæ‰€æœ‰æ•°æ®
			const handleClearData = () => {
				if(confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦é‡ç½®æµ‹è¯•å‘˜çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nå°†æ¸…ç©ºï¼š\n- ç»éªŒå€¼/ç­‰çº§\n- é‡‘å…ƒå®/è´¦å•\n- èƒŒåŒ…é“å…·\n- æ‰“å¡è®°å½•\n- å·²è§£é”æˆå°±\n- å¤§äº‹çºªè®°å½•')) {
					
                    // ã€ä¿®æ”¹ã€‘æ¸…é™¤è¿‡æ»¤å™¨ï¼šä¸ä»…åˆ é™¤ "TESTER" å¼€å¤´çš„ï¼Œä¹Ÿè¦åˆ é™¤ activeChild (å³ "æµ‹è¯•å‘˜") å¼€å¤´çš„
                    // è¿™æ ·æ‰èƒ½åˆ æ‰è½¬ç›˜ã€å¥‡é‡ç­‰äº§ç”Ÿçš„æ­£å¸¸æ•°æ®
					const clearFilter = (prev) => { 
						const n={...prev}; 
						Object.keys(n).forEach(k => {
                            // åˆ é™¤ä»¥ "TESTER" å¼€å¤´ (æ—§å…¼å®¹) æˆ– å½“å‰åå­— (å¦‚ "æµ‹è¯•å‘˜") å¼€å¤´çš„è®°å½•
                            if (k.startsWith('TESTER') || k.startsWith(activeChild)) {
                                delete n[k];
                            }
                        }); 
						return n; 
					};
					
					setXpHistory(clearFilter);
					setWheelHistory(clearFilter);
					
					// æ¸…ç©ºæ‰“å¡ã€èƒŒåŒ…ã€æˆå°± (å°†å¯¹åº”åå­—ä¸‹çš„æ•°æ®é‡ç½®ä¸ºç©ºå¯¹è±¡)
					setCheckins(prev => ({...prev, [activeChild]: {}}));
					setInventory(prev => ({...prev, [activeChild]: {}}));
					setAchievements(prev => ({...prev, [activeChild]: {}}));
					
					// æ¸…ç©ºå¤§äº‹çºª (è¿‡æ»¤æ‰ member ä¸º "TESTER" æˆ– "æµ‹è¯•å‘˜" çš„è®°å½•)
					setMilestones(prev => prev.filter(m => m.member !== 'TESTER' && m.member !== activeChild));
					
					// ã€æ–°å¢ã€‘é‡ç½®å·²é€šçŸ¥ç­‰çº§ï¼Œè¿™æ ·ä¸‹æ¬¡å‡çº§æ—¶æ‰ä¼šå†æ¬¡å¼¹å‡ºé€šçŸ¥
                    setNotifiedLevels(prev => ({...prev, [activeChild]: 0}));
					
					// 1. æ¸…é™¤æ‰€æœ‰ç”Ÿæ•ˆçš„ Buff (åŒ…å«åŒå€ç»éªŒã€æŠ•èµ„è®¡åˆ’ã€å¹¸è¿åŠ æŒ)
                    setActiveBuffs(prev => ({ ...prev, [activeChild]: {} }));

                    // 2. æ¸…é™¤å·²è£…å¤‡çš„å¤–è§‚ (åŒ…å«å¤´åƒæ¡†ã€åå­—ç‰¹æ•ˆã€èƒŒæ™¯)
                    setEquippedGear(prev => ({ ...prev, [activeChild]: {} }));

                    // 3. æ¸…é™¤ç‰¹æ®ŠçŠ¶æ€ (åŒ…å«çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆã€è§£é”çš„ä¸»é¢˜ã€ç»Ÿè®¡æ•°æ®)
                    setStats(prev => ({ ...prev, [activeChild]: {} }));
					
					// ã€æ–°å¢ã€‘å½»åº•æ¸…é™¤å­¦ä¸šè¿›åº¦ã€å…‘æ¢è®°å½•å’Œå¥‡é‡å†å²ï¼Œåˆ‡æ–­æˆå°±è¿ç¯è§¦å‘çš„æºå¤´
					if(setCurriculumProgress) setCurriculumProgress(prev => ({ ...prev, [activeChild]: {} }));
					if(setRedeemedCoupons) setRedeemedCoupons(prev => ({ ...prev, [activeChild]: [] }));
					if(setRandomEventHistory) setRandomEventHistory(prev => ({ ...prev, [activeChild]: [] }));
					
					alert('â™»ï¸ æ•°æ®å·²å½»åº•é‡ç½®');
				}
			};

			return (
				<>
					{/* æ‚¬æµ®çƒ (ç‚¹å‡»åˆ‡æ¢å¼€å…³) */}
					<button 
						onClick={() => setIsOpen(!isOpen)}
						className={`fixed bottom-24 right-4 z-[90] w-12 h-12 rounded-full shadow-2xl border-2 flex items-center justify-center font-bold text-xl transition-all duration-300 ${isOpen ? 'bg-slate-800 border-red-500 text-red-500 rotate-45' : 'bg-black border-green-500 text-green-400 hover:scale-110 animate-pulse'}`}
						title="ä¸Šå¸æ¨¡å¼æ§åˆ¶å°"
					>
						{isOpen ? 'ï¼‹' : <span className="font-mono text-xs">GM</span>}
					</button>

					{/* æ‚¬æµ®èœå• (æ”¹ä¸ºç»å¯¹å®šä½çš„ Popoverï¼Œä¸å†å…¨å±é®æŒ¡) */}
					{isOpen && (
						<div className="fixed bottom-40 right-4 z-[89] w-64 bg-slate-900/95 backdrop-blur-md rounded-2xl border border-green-500/30 shadow-2xl overflow-hidden animate-in slide-in-from-bottom-5 fade-in duration-200 flex flex-col">
							{/* å¤´éƒ¨ */}
							<div className="p-3 bg-slate-800/50 flex justify-between items-center border-b border-green-900/50">
								<h3 className="text-green-400 font-mono font-bold text-xs flex items-center gap-2">
									<span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-ping"></span>
									GOD_MODE
								</h3>
								<div className="text-[10px] text-gray-500 font-mono">v3.0</div>
							</div>

							{/* åŠŸèƒ½åŒº (ç´§å‡‘å¸ƒå±€) */}
							<div className="p-3 grid grid-cols-2 gap-2 max-h-[60vh] overflow-y-auto custom-scrollbar">
								
								{/* èµ„æº */}
								<button onClick={() => addResource('gold', 100)} className="col-span-1 p-2 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-yellow-400 font-bold text-[10px] text-left transition-colors active:scale-95">
									ğŸ’° +100 å…ƒå®
								</button>
								<button onClick={() => addResource('xp', 100)} className="col-span-1 p-2 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-blue-400 font-bold text-[10px] text-left transition-colors active:scale-95">
									âš¡ +100 XP
								</button>
								
								{/* å‡çº§ */}
								<button onClick={handleLevelUp} className="col-span-2 p-2 bg-green-900/20 hover:bg-green-900/40 rounded border border-green-800/50 text-green-400 font-bold text-[10px] flex items-center justify-between group transition-colors active:scale-95">
									<span>ğŸ†™ ç«‹å³å‡çº§ (+1 Level)</span>
									<span className="text-[9px] opacity-50">Auto</span>
								</button>

								{/* ç‰©å“ */}
								<button onClick={fillInventory} className="col-span-2 p-2 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-purple-400 font-bold text-[10px] text-center transition-colors active:scale-95">
									ğŸ’ å¡«å……èƒŒåŒ… (å…¨é“å…·x5)
								</button>

								<div className="col-span-2 h-px bg-slate-700/50 my-1"></div>

								{/* äº‹ä»¶ */}
								<button onClick={() => handleForceEvent()} className="col-span-2 p-2 bg-indigo-900/20 hover:bg-indigo-900/40 rounded border border-indigo-800/50 text-indigo-300 font-bold text-[10px] transition-colors active:scale-95">
									ğŸ² éšæœºè§¦å‘äº‹ä»¶ (å½“å‰çºªå…ƒ)
								</button>
								<div className="col-span-2 grid grid-cols-3 gap-1">
									 <button onClick={() => handleForceEvent('è¿œå¤ä¹‹è·¯')} className="p-1 bg-stone-800 hover:bg-stone-700 rounded text-stone-300 text-[9px] border border-stone-600">è¿œå¤</button>
									 <button onClick={() => handleForceEvent('å‘¨Â·ç¤¼åˆ¶ä¹‹ä¸‹')} className="p-1 bg-emerald-900/30 hover:bg-emerald-900/50 rounded text-emerald-300 text-[9px] border border-emerald-800">å‘¨ç¤¼</button>
									 <button onClick={() => handleForceEvent('å”Â·ç™»ç§‘ä¹‹è·¯')} className="p-1 bg-purple-900/30 hover:bg-purple-900/50 rounded text-purple-300 text-[9px] border border-purple-800">å¤§å”</button>
								</div>

								<div className="col-span-2 h-px bg-slate-700/50 my-1"></div>

								{/* é‡ç½® */}
								<button onClick={handleClearData} className="col-span-2 p-2 bg-red-900/20 hover:bg-red-900/40 rounded border border-red-900/50 text-red-500 font-bold text-[10px] flex items-center justify-center gap-1 transition-colors active:scale-95">
									<Trash2 className="w-3 h-3" /> å½»åº•é‡ç½®æµ‹è¯•å‘˜æ•°æ®
								</button>
							</div>
						</div>
					)}
				</>
			);
		};
		
		// æ–°å¢ä¸€ä¸ªç‹¬ç«‹çš„â€œè¿›è´¡å¼¹çª—â€ç»„ä»¶
		const TributeModal = ({ show, onClose, activeChild, stats, setStats, totalGold, setWheelHistory, profiles }) => {
			const [target, setTarget] = React.useState('');
			const [amount, setAmount] = React.useState('');

			if (!show) return null;

			const otherUsers = (profiles || []).map(p => p.name).filter(name => name !== activeChild);

			const handleTribute = () => {
				const val = parseInt(amount);
				if (!target) return alert('è¯·é€‰æ‹©è¦è¿›è´¡çš„å¯¹è±¡ï¼');
				if (isNaN(val) || val <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›è´¡é‡‘é¢ï¼');
				// ã€ç²¾å‡†å®šä½ã€‘ï¼š2. å°† currentXP æ›¿æ¢ä¸º totalGold
				if (val > totalGold) return alert('ä½™é¢ä¸è¶³ï¼');

				// ã€ç²¾å‡†å®šä½ã€‘ï¼š3. å°†åŸæ¥çš„ setXpHistory æ›¿æ¢ä¸ºè§„èŒƒçš„ setWheelHistory (é‡‘å…ƒå®æµæ°´)
				const historyKey = `${activeChild}-TRIBUTE_OUT-${target}-${Date.now()}`;
				setWheelHistory(prev => ({
					...prev,
					[historyKey]: -val
				}));

				// 2. å°†è¿›è´¡ä¿¡æ¯å†™å…¥ç›®æ ‡ç”¨æˆ·çš„å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­
				setStats(prev => {
					const targetStats = prev[target] || {};
					const pendingTributes = targetStats.pendingTributes || [];
					return {
						...prev,
						[target]: {
							...targetStats,
							pendingTributes: [...pendingTributes, { from: activeChild, amount: val, time: new Date().getTime() }]
						}
					};
				});

				alert(`æˆåŠŸå‘ ${target} è¿›è´¡äº† ${val} è´¢å¯Œï¼`);
				setTarget('');
				setAmount('');
				onClose();
			};

			return (
				<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
					<div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 border-2 border-yellow-400">
						<div className="flex justify-between items-center mb-4">
							<h3 className="text-xl font-bold text-gray-800 flex items-center">ğŸ‘‘ è¿›è´¡</h3>
							<button onClick={onClose} className="text-gray-400 hover:text-gray-600">âœ•</button>
						</div>
						
						<div className="space-y-4">
							<div>
								<label className="block text-sm text-gray-600 mb-1">é€‰æ‹©æ¥æ”¶å¯¹è±¡ï¼š</label>
								<select 
									className="w-full border rounded-lg p-2 bg-gray-50 outline-none focus:border-yellow-500"
									value={target}
									onChange={(e) => setTarget(e.target.value)}
								>
									<option value="">--è¯·é€‰æ‹©--</option>
									{otherUsers.map(user => <option key={user} value={user}>{user}</option>)}
								</select>
							</div>
							<div>
								<label className="block text-sm text-gray-600 mb-1">è¿›è´¡é‡‘é¢ (å½“å‰æ‹¥æœ‰: {totalGold})ï¼š</label>
                        <input 
                            type="number" 
                            min="1" 
                            className="w-full border rounded-lg p-2 bg-gray-50 outline-none focus:border-yellow-500"
                            placeholder="è¾“å…¥æ•°é‡"
                            value={amount}
                            // ã€æ–°å¢ã€‘ï¼šåœ¨æŒ‰ä¸‹é”®ç›˜ç¬é—´æ‹¦æˆªè´Ÿå·(-)ã€å°æ•°ç‚¹(.)å’ŒæŒ‡æ•°(e)
                            onKeyDown={(e) => { 
                                if (e.key === '-' || e.key === '.' || e.key === 'e') {
                                    e.preventDefault(); 
                                }
                            }}
                            // ã€æ–°å¢ã€‘ï¼šå¦‚æœåœ¨ç§»åŠ¨ç«¯é€šè¿‡ç²˜è´´ç­‰æ–¹å¼æ··å…¥äº†è´Ÿå·ï¼Œç›´æ¥è¿‡æ»¤æ‰
                            onChange={(e) => setAmount(e.target.value.replace(/-/g, ''))}
                        />
							</div>
							<button 
								onClick={handleTribute}
								className="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-xl font-bold shadow-lg hover:scale-105 transition-transform"
							>
								ç¡®è®¤è¿›è´¡
							</button>
						</div>
					</div>
				</div>
			);
		};
		
        const App = () => {
			const [activeChild, setActiveChild] = useState('Yoly');
			// æ–°å¢èŠ‚å‡æ—¥æ•°æ®çŠ¶æ€ï¼Œâ€œé¢„æµ‹â€æ•°æ®ï¼ˆåŒ…å«æœªæ¥å‡ å¤©ï¼‰
			const [apiHolidayForecast, setApiHolidayForecast] = useState([]);
			// æ–°å¢ useEffect å¹¶å‘è·å–ä»Šå¤©ã€æ˜å¤©ã€åå¤©çš„æ•°æ®
			useEffect(() => {
				// åœ¨ useEffect å†…éƒ¨å®šä¹‰å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨ä½œç”¨åŸŸæ±¡æŸ“
				const fetchHolidayForecast = async () => {
					try {
						console.log("å¼€å§‹è·å–èŠ‚å‡æ—¥æ•°æ®...");
						const daysToCheck = 3; // æ£€æŸ¥èŒƒå›´ï¼šä»Šå¤© + æœªæ¥2å¤©
						const requests = [];
						const now = new Date();

						for (let i = 0; i < daysToCheck; i++) {
							const date = new Date(now);
							date.setDate(now.getDate() + i);
							
							const year = date.getFullYear();
							const month = String(date.getMonth() + 1).padStart(2, '0');
							const day = String(date.getDate()).padStart(2, '0');
							const dateStr = `${year}-${month}-${day}`;

							// å°† Promise æ¨å…¥æ•°ç»„
							requests.push(
								fetch(`http://timor.tech/api/holiday/info/${dateStr}`)
									.then(res => res.json())
									.catch(err => {
										console.warn("å•ä¸ªæ—¥æœŸè·å–å¤±è´¥:", dateStr, err);
										return null;
									})
							);
						}

						// å¹¶å‘ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
						const results = await Promise.all(requests);
						
						// è¿‡æ»¤å‡ºè·å–æˆåŠŸçš„æœ‰æ•ˆæ•°æ®
						const validData = results.filter(data => data && data.code === 0);
						
						if (validData.length > 0) {
							console.log("èŠ‚å‡æ—¥é¢„æµ‹æ•°æ®è·å–æˆåŠŸ:", validData);
							setApiHolidayForecast(validData);
						}
					} catch (error) {
						console.error("æ— æ³•è·å–èŠ‚å‡æ—¥ä¿¡æ¯:", error);
					}
				};

				// 3. ç«‹å³è°ƒç”¨ä¸Šé¢å®šä¹‰çš„å‡½æ•° (ç¡®ä¿åå­—å®Œå…¨ä¸€è‡´ï¼)
				fetchHolidayForecast(); 

			}, []); // ç©ºä¾èµ–æ•°ç»„ï¼Œç¡®ä¿åªåœ¨ç»„ä»¶åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
			
			// --- 1. æ ¸å¿ƒæ—¶é—´çŠ¶æ€ ---
            const [now, setNow] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // --- 2. å¤©æ°”ç³»ç»Ÿ (æ”¯æŒå®šä½ + è‡ªå®šä¹‰åŸå¸‚ + è‡ªåŠ¨æ›´æ–°) ---
            const [realWeather, setRealWeather] = useState(null);
            const [userCity, setUserCity] = useStickyState('', 'app_user_city_v1');

            useEffect(() => {
                // A. å®šä¹‰è·å–é€»è¾‘
                const executeFetch = () => {
                    // A1. æ ¸å¿ƒè·å–å‡½æ•°
                    const fetchWeatherByCoords = async (lat, lon, cityName = 'æœ¬åœ°') => {
                        try {
                            // æ·»åŠ  &timestamp=${Date.now()} é˜²æ­¢æµè§ˆå™¨ç¼“å­˜è¯·æ±‚
                            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto&timestamp=${Date.now()}`);
                            const data = await res.json();
                            if (data.current_weather) {
                                setRealWeather({
                                    temp: Math.round(data.current_weather.temperature),
                                    code: data.current_weather.weathercode,
                                    isDay: data.current_weather.is_day === 1,
                                    city: cityName
                                });
                            }
                        } catch (e) {
                            console.error("å¤©æ°”è·å–å¤±è´¥:", e);
                        }
                    };

                    // A2. åŸå¸‚ååæŸ¥
                    const fetchWeatherByCityName = async (city) => {
                        try {
                            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=zh&format=json`);
                            const data = await res.json();
                            if (data.results && data.results.length > 0) {
                                const { latitude, longitude, name } = data.results[0];
                                fetchWeatherByCoords(latitude, longitude, name); 
                            }
                        } catch (e) { console.error("åŸå¸‚æŸ¥æ‰¾å¤±è´¥:", e); }
                    };

                    // A3. æ‰§è¡Œåˆ¤æ–­
                    if (userCity && userCity.trim() !== '') {
                        fetchWeatherByCityName(userCity);
                    } else if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                fetchWeatherByCoords(position.coords.latitude, position.coords.longitude, 'æœ¬åœ°');
                            },
                            (error) => { console.log("å®šä½å¤±è´¥"); }
                        );
                    }
                };

                // B. ç«‹å³æ‰§è¡Œä¸€æ¬¡
                executeFetch();

                // C. è®¾ç½®å®šæ—¶å™¨ï¼šæ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ (60 * 60 * 1000 æ¯«ç§’)
                const weatherTimer = setInterval(executeFetch, 30 * 60 * 1000);

                // D. æ¸…ç†å‡½æ•°
                return () => clearInterval(weatherTimer);

            }, [userCity]); // å½“åŸå¸‚æ”¹å˜æ—¶ï¼ŒEffect é‡ç½®ï¼Œå®šæ—¶å™¨ä¹Ÿä¼šé‡ç½®å¹¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
			
			// ã€æ–°å¢ã€‘æ§åˆ¶è¿›è´¡å¼¹çª—æ˜¾ç¤ºéšè—çš„çŠ¶æ€
			const [showTributeModal, setShowTributeModal] = React.useState(false);

			// ã€æ–°å¢ã€‘ç›‘å¬åˆ‡æ¢è´¦æˆ·æ—¶æ˜¯å¦æœ‰å¾…æ¥æ”¶çš„è¿›è´¡
			React.useEffect(() => {
				const currentStats = stats[activeChild] || {};
				const pendingTributes = currentStats.pendingTributes || [];

				if (pendingTributes.length > 0) {
					let totalAmount = 0;
					let fromUsers = new Set();
					pendingTributes.forEach(t => {
						totalAmount += t.amount;
						fromUsers.add(t.from);
					});

					// 1. å¼¹å‡ºæ”¶åˆ°è¿›è´¡çš„é€šçŸ¥
					alert(`ğŸ‰ æƒŠå–œï¼\nä½ æ”¶åˆ°äº†æ¥è‡ªã€${Array.from(fromUsers).join(' å’Œ ')}ã€‘çš„è¿›è´¡ï¼\nå…±è®¡è·å¾—ï¼š${totalAmount} è´¢å¯Œï¼`);

					// 2. å°†é‡‘é¢åŠ åˆ°å½“å‰è´¦å·
					const fromNames = Array.from(fromUsers).join('å’Œ');
					const historyKey = `${activeChild}-TRIBUTE_IN-${fromNames}-${Date.now()}`;
					setWheelHistory(prev => ({
						...prev,
						[historyKey]: totalAmount
					}));

					// 3. æ¸…ç©ºå¾…æ¥æ”¶é˜Ÿåˆ—
					setStats(prev => ({
						...prev,
						[activeChild]: {
							...prev[activeChild],
							pendingTributes: [] 
						}
					}));

					// æ’’èŠ±ç‰¹æ•ˆ
					if (window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
				}
			}, [activeChild, stats]); // ä¾èµ–é¡¹åŒ…å« activeChildï¼Œåˆ‡æ¢è´¦æˆ·å°±ä¼šè§¦å‘
		
			const [viewMode, setViewMode] = useState('calendar'); 
            const [showSettings, setShowSettings] = useState(false);
            const [editingEntry, setEditingEntry] = useState(null);
            const [sortBy, setSortBy] = useState('default'); 
			const [showWheel, setShowWheel] = useState(false);
			const [showWheelChoice, setShowWheelChoice] = useState(false);
			const [wheelType, setWheelType] = useState('gold'); // 'gold' | 'xp'
			const [isDemoWheel, setIsDemoWheel] = useState(false);
			
			const handleSelectWheel = (type) => {
				setShowWheelChoice(false);
				setWheelType(type);
				setShowWheel(true);
				setIsDemoWheel(false);
				setIsExtraReward(false); // è¿™æ˜¯æ—¥å¸¸è§¦å‘ï¼Œä¸æ˜¯é¢å¤–å¥–åŠ±
				setWheelResult(null);
			};
			
			// --- ã€æ–°å¢ã€‘å­¦ä¸šè¿›åº¦çŠ¶æ€ ---
            // ç»“æ„: { ChildName: { math_olympiad: 3 } } è¡¨ç¤ºå®Œæˆäº†ç¬¬3ä¸ªå­¦æœŸ(ç´¢å¼•2)
            const [curriculumProgress, setCurriculumProgress] = useStickyState({}, 'app_curriculum_progress_v1');
			const [xpWheelConfig, setXpWheelConfig] = useStickyState(DEFAULT_XP_WHEEL_CONFIG, 'app_xp_wheel_config');            
			const [isExtraReward, setIsExtraReward] = useState(false); // ç”¨äºæ ‡è®°æ˜¯å¦ä¸ºé¢å¤–å¥–åŠ±
            const [wheelSpinning, setWheelSpinning] = useState(false);
            const [wheelResult, setWheelResult] = useState(null);
            const [pointerRotation, setPointerRotation] = useState(0); 
            const [showAchievements, setShowAchievements] = useState(false);
            const [unlockQueue, setUnlockQueue] = useState([]);
            const [showThemeModal, setShowThemeModal] = useState(false);

            const [showEvilWheel, setShowEvilWheel] = useState(false);
            const [evilWheelSpinning, setEvilWheelSpinning] = useState(false);
            const [evilWheelResult, setEvilWheelResult] = useState(null);
            const [evilPointerRotation, setEvilPointerRotation] = useState(0);
            const [showGoldHistory, setShowGoldHistory] = useState(false);
            const [showXPHistory, setShowXPHistory] = useState(false);
            const [isEvilDemo, setIsEvilDemo] = useState(false);
            
            const [showEvolutionPath, setShowEvolutionPath] = useState(false);
            const [levelUpQueue, setLevelUpQueue] = useState([]);
			// æ§åˆ¶ç»Ÿè®¡å¼¹çª—çš„æ˜¾ç¤º/éšè—
            const [showStats, setShowStats] = useState(false);
            
            const [notifiedLevels, setNotifiedLevels] = useState(() => {
                try { return JSON.parse(localStorage.getItem('app_notified_levels')) || {}; } catch { return {}; }
            });
            useEffect(() => { localStorage.setItem('app_notified_levels', JSON.stringify(notifiedLevels)); }, [notifiedLevels]);

            const [showRandomEvent, setShowRandomEvent] = useState(false);
            const [currentRandomEvent, setCurrentRandomEvent] = useState(null);

            // --- å•†åº—ç›¸å…³çŠ¶æ€ ---
            const [showShop, setShowShop] = useState(false);
			const [shopInitialTab, setShopInitialTab] = useState('buy');

            const scrollContainerRef = useRef(null);
            const todayRef = useRef(null);
            
            const prevLevelRef = useRef(1);

            const [tasks, setTasks] = useStickyState(DEFAULT_TASKS, 'app_tasks_v2');
            const [checkins, setCheckins] = useStickyState({ Yoly: {}, Henry: {} }, 'app_checkins_v2');
            const [wheelConfig, setWheelConfig] = useStickyState(DEFAULT_WHEEL_CONFIG, 'app_wheel_config');
            const [wheelSettings, setWheelSettings] = useStickyState(DEFAULT_WHEEL_SETTINGS, 'app_wheel_settings');
            const [wheelHistory, setWheelHistory] = useStickyState({}, 'app_wheel_history');
            const [xpHistory, setXpHistory] = useStickyState({}, 'app_xp_history');
            const [globalDates, setGlobalDates] = useStickyState({ start: DEFAULT_START_DATE, end: DEFAULT_END_DATE }, 'app_global_dates');
            const [profiles, setProfiles] = useStickyState(DEFAULT_PROFILES, 'app_profiles_v1');
            const [achievements, setAchievements] = useStickyState({}, 'app_achievements_v1');
            const [stats, setStats] = useStickyState({}, 'app_stats_v1');
            const [evilWheelConfig, setEvilWheelConfig] = useStickyState(DEFAULT_EVIL_WHEEL_CONFIG, 'app_evil_wheel_config');
            
            const [randomEventHistory, setRandomEventHistory] = useStickyState({}, 'app_random_event_history');
            const [dailyRandomCounts, setDailyRandomCounts] = useStickyState({}, 'app_daily_random_counts');

            const [inventory, setInventory] = useStickyState({}, 'app_inventory_v1');
            const [activeBuffs, setActiveBuffs] = useStickyState({}, 'app_active_buffs_v1');
            const [redeemedCoupons, setRedeemedCoupons] = useStickyState({}, 'app_coupons_v1');

            // --- æ–°å¢ï¼šå¯†ç ä¸æµ‹è¯•æ¨¡å¼çŠ¶æ€ ---
            const [settingsPassword, setSettingsPassword] = useStickyState('', 'app_settings_password');
            const [isTestMode, setIsTestMode] = useStickyState(false, 'app_test_mode');
            
            // --- æ–°å¢ï¼šè£…å¤‡çŠ¶æ€ ---
            const [equippedGear, setEquippedGear] = useStickyState({}, 'app_equipped_gear_v1');
            
			// ã€æ–°å¢ã€‘å‘¨æœ«ç³»ç»Ÿé…ç½®
            const [weekendSettings, setWeekendSettings] = useStickyState({
                coreThreshold: 80,   // æ ¸å¿ƒä»»åŠ¡è¾¾æ ‡ç™¾åˆ†æ¯”
                dailyThreshold: 50,  // æ—¥å¸¸ä»»åŠ¡è¾¾æ ‡ç™¾åˆ†æ¯”
                guardianPassCount: 0 // ç›‘æŠ¤äººè±å…å¡æ•°é‡
            }, 'app_weekend_settings');

            // ã€æ–°å¢ã€‘ç»“ç®—å¼¹çª—é˜Ÿåˆ— (ç”¨äºæ¬¡æ—¥ç»“ç®—)
            const [settlementState, setSettlementState] = useState(null);
			
            // --- æ–°å¢ï¼šå¤§äº‹çºªç³»ç»Ÿ ---
            const [milestones, setMilestones] = useStickyState([], 'app_milestones_v1');
            const [lastBackupDate, setLastBackupDate] = useStickyState(null, 'app_last_backup_date');
            const [showMilestones, setShowMilestones] = useState(false);
            const [showBackupPanel, setShowBackupPanel] = useState(false);
            
            // --- æ–°å¢ï¼šå…¨å±€ç•™è¨€æ¿ ---
            const [globalMessages, setGlobalMessages] = useStickyState([], 'app_global_messages_v2');

            // --- Effect: å¤„ç†æµ‹è¯•è´¦å·çš„æ·»åŠ ä¸ç§»é™¤ ---
            useEffect(() => {
                if (isTestMode) {
                    // å¦‚æœå¼€å¯æµ‹è¯•æ¨¡å¼ï¼Œä¸”æ²¡æœ‰æµ‹è¯•å‘˜è´¦å·ï¼Œåˆ™æ·»åŠ 
                    if (!profiles.find(p => p.id === 'TESTER')) {
                        const tester = { id: 'TESTER', name: 'æµ‹è¯•å‘˜', theme: 'emerald', avatar: null };
                        setProfiles(prev => [...prev, tester]);
                        setTasks(prev => ({ ...prev, 'æµ‹è¯•å‘˜': [] })); 
                        // ä¸ºæµ‹è¯•å‘˜é¢„å¡«å……æ‰€æœ‰é“å…·
                        const allItems = {};
                        SHOP_ITEMS.forEach(item => { allItems[item.id] = 1; });
                        setInventory(prev => ({ ...prev, 'æµ‹è¯•å‘˜': allItems }));
                    }
                } else {
                    // å¦‚æœå…³é—­æµ‹è¯•æ¨¡å¼ï¼Œä¸”å­˜åœ¨æµ‹è¯•å‘˜è´¦å·ï¼Œåˆ™ç§»é™¤
                    if (profiles.find(p => p.id === 'TESTER')) {
                        setProfiles(prev => prev.filter(p => p.id !== 'TESTER'));
                        // å¦‚æœå½“å‰æ­£å¥½é€‰ä¸­äº†æµ‹è¯•å‘˜ï¼Œåˆ‡å›ç¬¬ä¸€ä¸ªäºº
                        if (activeChild === 'æµ‹è¯•å‘˜' && profiles.length > 0) {
                            setActiveChild(profiles[0].name !== 'æµ‹è¯•å‘˜' ? profiles[0].name : (profiles[1] ? profiles[1].name : ''));
                        }
                    }
                }
            }, [isTestMode, profiles, activeChild]);
			
            const theme = useMemo(() => {
                const profile = profiles.find(p => p.name === activeChild) || profiles[0];
                return COLOR_PALETTES[profile.theme] || COLOR_PALETTES.rose;
            }, [activeChild, profiles]);

            const dates = useMemo(() => getDatesInRange(globalDates.start, globalDates.end), [globalDates]);
            
            const sortedTasks = useMemo(() => {
                const currentTasks = tasks[activeChild] || [];
                if (sortBy === 'default') return currentTasks;
                return [...currentTasks].sort((a, b) => {
                    if (sortBy === 'deadline') {
                        const dateA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
                        const dateB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
                        return dateA - dateB;
                    }
                    if (sortBy === 'reward') return b.reward - a.reward;
                    if (sortBy === 'progress') {
                        const getProgress = (t) => {
                             const record = checkins[activeChild]?.[t.id] || {};
                             const count = Object.keys(record).length;
                             return count / t.targetCount;
                        }
                        return getProgress(b) - getProgress(a);
                    }
                    return 0;
                });
            }, [tasks, activeChild, sortBy, checkins]);

            // --- è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ€»èµ„äº§ (ç‹¬ç«‹äº state ç”¨äºæˆå°±æ£€æŸ¥) ---
            const calculateTotalGold = (cCheckins, cWheelHistory, child, cBuffs) => {
                let total = 0;
                const childBuffs = cBuffs?.[child] || {}; 

                if (tasks[child]) {
                    tasks[child].forEach(task => {
                        const record = cCheckins[child]?.[task.id] || {};
                        const currentCount = Object.keys(record).length;
                        
                        Object.keys(record).forEach(date => {
                            // ã€æ–°å¢ã€‘å¦‚æœè¿™ç¬”æ‰“å¡å·²ç»è®°å½•åœ¨å†å²è´¦å•é‡Œäº†ï¼Œè¿™é‡Œå°±è·³è¿‡ï¼Œé˜²æ­¢é‡å¤è®¡ç®—èµ„äº§
                            const historyKey = `${child}-TASK-${task.id}-${date}`;
                            if (cWheelHistory[historyKey]) return;

                            // ä¸‹é¢æ˜¯å…¼å®¹æ—§æ•°æ®çš„é€»è¾‘
                            let multiplier = 1;
                            // ã€ä¿®æ”¹ã€‘å¢åŠ å¼€å§‹æ—¶é—´åˆ¤æ–­ï¼šæ—¥æœŸå¿…é¡» >= å¼€å§‹æ—¶é—´ ä¸” <= è¿‡æœŸæ—¶é—´
							// (childBuffs.investStart || '1970-01-01') æ˜¯ä¸ºäº†å…¼å®¹æ—§å­˜æ¡£ï¼Œè®©æ—§å¡ä¾ç„¶å¯¹æ—§æ•°æ®ç”Ÿæ•ˆã€‚
							// å¦‚æœä½ æƒ³è®©æ—§å¡å½»åº•å¤±æ•ˆï¼ˆåªå¯¹æ–°ä¹°çš„æœ‰æ•ˆï¼‰ï¼Œå¯ä»¥å°† '1970-01-01' æ”¹ä¸º '2099-12-31'
							if (childBuffs.investMultiplier > 1 && childBuffs.investExpire && date <= childBuffs.investExpire && date >= (childBuffs.investStart || '1970-01-01')) {
								multiplier = childBuffs.investMultiplier;
							}
							total += task.reward * multiplier;
                        });

                        if (currentCount >= task.targetCount) total += task.completedReward; 
                    });
                }
                Object.keys(cWheelHistory).forEach(key => {
                    // æ‰£é™¤å•†åº—æ¶ˆè´¹
                    if (key.startsWith(`${child}-`)) total += cWheelHistory[key];
                });
                return total;
            };

            const totalGold = useMemo(() => {
                // ã€ä¿®æ”¹ã€‘ä¼ å…¥ activeBuffs
                return calculateTotalGold(checkins, wheelHistory, activeChild, activeBuffs);
            }, [checkins, activeChild, tasks, wheelHistory, activeBuffs]); // ã€ä¿®æ”¹ã€‘ä¾èµ–é¡¹å¢åŠ  activeBuffs

            const transactions = useMemo(() => {
                let list = [];
                // 1. ä»»åŠ¡æ‰“å¡å¥–åŠ±ï¼ˆå«æŠ•èµ„å€ç‡ï¼‰
                const childTasks = tasks[activeChild] || [];
                const childBuffs = activeBuffs[activeChild] || {};
                const today = getLocalDateKey(0);
				const childCheckins = checkins[activeChild] || {}; 
                
                childTasks.forEach(task => {
                    const taskRecord = childCheckins[task.id] || {};
                    Object.keys(taskRecord).forEach(date => {
                        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æŠ•èµ„å¡ç”Ÿæ•ˆæœŸå†…
						// ã€æ–°å¢ã€‘å¦‚æœå†å²è´¦å•é‡Œæœ‰è®°å½•ï¼Œè¯´æ˜å·²ç»å›ºåŒ–äº†ï¼Œè¿™é‡Œä¸ç”ŸæˆåŠ¨æ€è®°å½•ï¼Œé˜²æ­¢é‡å¤
                        const historyKey = `${activeChild}-TASK-${task.id}-${date}`;
						if (wheelHistory[historyKey]) return;
						
                        let multiplier = 1;
                        // ã€ä¿®æ”¹ã€‘é€»è¾‘åŒæ­¥ï¼šå»æ‰ date >= todayï¼Œç¡®ä¿å†å²è®°å½•é‡Œçš„åŠ æˆæ˜¾ç¤ºä¸ä¼šæ¶ˆå¤±ã€é€»è¾‘åŒæ­¥ï¼šå¢åŠ å¼€å§‹æ—¶é—´åˆ¤æ–­
                        if (childBuffs.investMultiplier > 1 && childBuffs.investExpire && date <= childBuffs.investExpire && date >= (childBuffs.investStart || '1970-01-01')) {
							multiplier = childBuffs.investMultiplier;
						}
                        const reward = task.reward * multiplier;
                        list.push({ id: `task-${task.id}-${date}`, date: date, name: `æ‰“å¡ï¼š${task.name}${multiplier > 1 ? ` (x${multiplier})` : ''}`, amount: reward, type: 'income' });
                    });
                    const completedDates = Object.keys(taskRecord).sort();
                    if (completedDates.length >= task.targetCount) {
                         const completionDate = completedDates[task.targetCount - 1];
                         list.push({ id: `bonus-${task.id}`, date: completionDate, name: `å®Œèµ›å¥–åŠ±ï¼š${task.name}`, amount: task.completedReward, type: 'income' });
                    }
                });

                Object.entries(wheelHistory).forEach(([key, value]) => {
                    if (!key.startsWith(activeChild)) return;
                    let date, name, type;
                    if (key.includes('EVIL')) {
                        const parts = key.split('-');
                        const ts = parseInt(parts[parts.length - 1]);
                        date = new Date(ts).toISOString().split('T')[0];
                        name = 'é‚ªæ¶å¤§è½¬ç›˜';
                        type = 'expense';
                    } else if (key.includes('EVENT')) {
                        // éšæœºäº‹ä»¶çš„äº¤æ˜“è®°å½•è§£æ
                        const parts = key.split('-');
                        const ts = parseInt(parts[parts.length-1]);
                        date = new Date(ts).toISOString().split('T')[0];
                        const eventId = parts[2];
                        const event = RANDOM_EVENTS.find(e => e.id === eventId);
                        name = event ? `å¥‡é‡(é‡‘å¸)ï¼š${event.title}` : 'æ—¶ç©ºå¥‡é‡';
                        type = 'income';
					} else if (key.includes('EXTRA')) { 
						// å¤„ç†é¢å¤–å¥–åŠ±çš„æ˜¾ç¤º
						const parts = key.split('-');
						const ts = parseInt(parts[parts.length - 1]);
						date = new Date(ts).toISOString().split('T')[0];
						name = 'é¢å¤–æƒŠå–œå¤§è½¬ç›˜å¥–åŠ±'; // è¿™é‡Œå®šä¹‰æ˜ç»†ä¸­æ˜¾ç¤ºçš„åå­—
						type = 'income';
                    } else if (key.includes('SHOP')) {
                         const parts = key.split('-');
                         const itemId = parts[2];
                         const ts = parseInt(parts[parts.length-1]);
                         date = new Date(ts).toISOString().split('T')[0];
                         const item = SHOP_ITEMS.find(i => i.id === itemId);
                         name = item ? `è´­ä¹°ï¼š${item.name}` : 'é›†å¸‚æ¶ˆè´¹';
                         type = 'expense';
                    } else if (key.includes('BOX_GOLD')) {
                         const parts = key.split('-');
                         const ts = parseInt(parts[parts.length-1]);
                         date = new Date(ts).toISOString().split('T')[0];
                         name = 'ç›²ç›’å¤§å¥–';
                         type = 'income';
                    } else if (key.includes('SKIP')) {
                         const parts = key.split('-');
                         const taskId = parts[2];
                         const ts = parseInt(parts[parts.length-1]);
                         date = new Date(ts).toISOString().split('T')[0];
                         const task = (tasks[activeChild]||[]).find(t => t.id === taskId);
                         name = task ? `å…åšé‡‘ç‰Œï¼š${task.name}` : 'å…åšé‡‘ç‰Œå¥–åŠ±';
                         type = 'income';
                    } else if (key.includes('GIFT')) {
                         const parts = key.split('-');
                         const ts = parseInt(parts[parts.length-1]);
                         date = new Date(ts).toISOString().split('T')[0];
                         name = 'æ”¶åˆ°å‹å¥½é‚»é‚¦çº¢åŒ…';
                         type = 'income';
					// ==================== ã€æ–°å¢è¿™ä¸¤æ®µè¿›è´¡è§£æã€‘ ====================
					} else if (key.includes('TRIBUTE_IN')) {
						const parts = key.split('-');
						const fromName = parts[2]; // æå–æ˜¯ä»è°é‚£é‡Œæ”¶åˆ°çš„
						const ts = parseInt(parts[parts.length-1]);
						date = new Date(ts).toISOString().split('T')[0];
						name = `æ”¶åˆ° ${fromName} è¿›è´¡`;
						type = 'income';
					} else if (key.includes('TRIBUTE_OUT')) {
						const parts = key.split('-');
						const targetName = parts[2]; // æå–æ˜¯è¿›è´¡ç»™è°çš„
						const ts = parseInt(parts[parts.length-1]);
						date = new Date(ts).toISOString().split('T')[0];
						name = `å‘ ${targetName} è¿›è´¡`;
						type = 'expense';	 
					// ã€æ–°å¢ã€‘è§£ææ‰“å¡å›ºåŒ–è®°å½•ï¼Œè®©æ˜ç»†æ˜¾ç¤ºæ­£ç¡®çš„åå­—
                    } else if (key.includes('TASK')) {
                         // keyæ ¼å¼: Child-TASK-TaskId-YYYY-MM-DD
                
						 // ã€ä¿®æ”¹ã€‘ç›´æ¥æˆªå–æœ€å10ä½å­—ç¬¦ï¼Œç¡®ä¿æ‹¿åˆ°å®Œæ•´çš„ YYYY-MM-DD
						 const dateStr = key.slice(-10); 
						
						 // ã€ä¼˜åŒ–ã€‘TaskId è·å–é€»è¾‘ä¸åŠ¨ï¼Œæˆ–è€…å¦‚æœä½ æ‹…å¿ƒ TaskId ä¹Ÿæœ‰æ¨ªæ ï¼Œå¯ä»¥ç”¨æ›´ç¨³å¦¥çš„æ­£åˆ™ï¼š
						 // const taskId = key.split('-TASK-')[1].slice(0, -11); 
						 // ä½†ä¸ºäº†æœ€å°æ”¹åŠ¨ï¼ŒåŸæ¥çš„ taskId è·å–é€»è¾‘é€šå¸¸èƒ½ç”¨ï¼ˆå‰ææ˜¯IDé‡Œæ²¡æ¨ªæ ï¼‰
						 const parts = key.split('-');
						 const taskId = parts[2]; 

						 date = dateStr; // ç°åœ¨ date å°±æ˜¯å®Œæ•´çš„ "2026-02-15" äº†
                         const task = (tasks[activeChild]||[]).find(t => t.id === taskId);
                         // è®¡ç®—å€ç‡ç”¨äºæ˜¾ç¤ºï¼šå¦‚æœé‡‘é¢é™¤ä»¥åŸºç¡€å¥–åŠ± > 1ï¼Œè¯´æ˜æœ‰åŠ æˆ
                         let label = task ? `æ‰“å¡ï¼š${task.name}` : 'ä»»åŠ¡æ‰“å¡';
                         if (task && value > task.reward) {
                             const mult = Math.round(value / task.reward);
                             label += ` (x${mult})`;
                         }
                         name = label;
                         type = 'income';
                    } else {
                        date = key.replace(`${activeChild}-`, '');
                        name = 'æƒŠå–œå¤§è½¬ç›˜';
                        type = 'income';
                    }
                    list.push({ id: key, date: date, name: name, amount: value, type: value >= 0 ? 'income' : 'expense' });
                });

                return list.sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [tasks, checkins, wheelHistory, activeChild, activeBuffs]);

            // --- ç»éªŒå€¼è®¡ç®—ä¸å‡çº§é€»è¾‘ ---
            const currentXP = useMemo(() => {
                const child = activeChild;
                let xp = 0;
                
                // 1. æ‰“å¡ç»éªŒ: 10 XP/æ¬¡
                const childCheckins = checkins[child] || {};
                const totalCheckinsCount = Object.values(childCheckins).reduce((sum, taskRecord) => sum + Object.keys(taskRecord).length, 0);
                xp += totalCheckinsCount * 10;
                
                // 2. è´¢å¯Œç»éªŒ: 1 XP/1 é‡‘å…ƒå® (å‡€æ”¶å…¥ï¼Œä¸æ‰£é™¤æ¶ˆè´¹)
                let earnedGold = 0;
                const childTasks = tasks[child] || [];
                childTasks.forEach(task => {
                    const record = childCheckins[task.id] || {};
                    const count = Object.keys(record).length;
                    earnedGold += count * task.reward;
                    if (count >= task.targetCount) earnedGold += task.completedReward; 
                });
                Object.keys(wheelHistory).forEach(key => {
                    // æ’é™¤é‚ªæ¶è½¬ç›˜å’Œå•†åº—æ¶ˆè´¹ï¼Œåªè®¡ç®—æ­£å‘æ”¶ç›Šè½¬åŒ–ä¸ºç»éªŒ
                    if (key.startsWith(`${child}-`) && !key.includes('EVIL') && !key.includes('SHOP') && (wheelHistory[key] > 0)) { 
                        earnedGold += wheelHistory[key];
                    }
                });
                xp += earnedGold; // 1 Gold = 1 XP
                
                // 3. æˆå°±ç»éªŒ
                const childAch = achievements[child] || {};
                Object.keys(childAch).forEach(achId => {
                    const badge = BADGES.find(b => b.id === achId);
                    if (badge) {
                        if (badge.rarity === 'common') xp += 50;
                        else if (badge.rarity === 'rare') xp += 200;
                        else if (badge.rarity === 'epic') xp += 800;
                        else if (badge.rarity === 'legendary') xp += 3000;
                    }
                });

                // 4. çº¯ç»éªŒç±»å¥‡é‡ (æ–°)
                Object.keys(xpHistory).forEach(key => {
                    if (key.startsWith(`${child}-`)) {
                        xp += xpHistory[key];
                    }
                });

                return xp;
            }, [checkins, tasks, wheelHistory, achievements, activeChild, xpHistory]);

            // --- ç»éªŒå€¼æ˜ç»†åˆ—è¡¨ (æ–°) ---
            const xpTransactions = useMemo(() => {
                let list = [];
                const childCheckins = checkins[activeChild] || {};
                const childTasks = tasks[activeChild] || [];
                
                // 1. æ‰“å¡ç»éªŒ
                childTasks.forEach(task => {
                    const taskRecord = childCheckins[task.id] || {};
                    Object.keys(taskRecord).forEach(date => {
                        list.push({ id: `checkin-${task.id}-${date}`, date: date, name: `æ‰“å¡ï¼š${task.name}`, amount: 10 });
                    });
                });

                // 2. è´¢å¯Œè½¬åŒ– (æŒ‰é‡‘å…ƒå®è®°å½•æ˜¾ç¤ºè½¬åŒ–) - ä»…æ˜¾ç¤ºæ”¶å…¥
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        list.push({ id: `xp-wealth-${t.id}`, date: t.date, name: `è´¢å¯Œè½¬åŒ–ï¼š${t.name}`, amount: t.amount });
                    }
                });

                // 3. æˆå°±ç»éªŒ
                const childAch = achievements[activeChild] || {};
                Object.entries(childAch).forEach(([achId, date]) => {
                    const badge = BADGES.find(b => b.id === achId);
                    if (badge) {
                        let amount = 0;
                        if (badge.rarity === 'common') amount = 50;
                        else if (badge.rarity === 'rare') amount = 200;
                        else if (badge.rarity === 'epic') amount = 800;
                        else if (badge.rarity === 'legendary') amount = 3000;
                        list.push({ id: `xp-ach-${achId}`, date: date, name: `è§£é”å¾½ç« ï¼š${badge.name}`, amount: amount });
                    }
                });

                // 4. çº¯XPå¥‡é‡
                Object.entries(xpHistory).forEach(([key, value]) => {
                    if (!key.startsWith(activeChild)) return;
                    let name = 'é¢å¤–ç»éªŒ';
                    const parts = key.split('-');
                    const ts = parseInt(parts[parts.length-1]);
                    const date = new Date(ts).toISOString().split('T')[0];
                    if (key.includes('EVENT')) {
                         const eventId = parts[2];
                         const event = RANDOM_EVENTS.find(e => e.id === eventId);
                         name = event ? `å¥‡é‡ï¼š${event.title}` : 'æ—¶ç©ºå¥‡é‡';
                    } else if (key.includes('BUFF_XP')) {
                         name = 'åŒå€ç¬¦åŠ æˆ';
                    } else if (key.includes('BOX_XP')) {
                         name = 'ç›²ç›’ç»éªŒåŒ…';
                    } else if (key.includes('XP_WHEEL')) { // <--- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸ªåˆ†æ”¯
						 name = 'ç»éªŒå€¼å¤§è½¬ç›˜';
					}
                    list.push({ id: key, date: date, name: name, amount: value });
                });

                return list.sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [transactions, achievements, activeChild, xpHistory, checkins, tasks]);
            
            const currentLevelInfo = getLevelInfo(currentXP);

            // å‡çº§ç›‘å¬é€»è¾‘
            useEffect(() => {
                if (!activeChild) return;
                const levelInfo = getLevelInfo(currentXP);
                const lastNotifiedLevel = notifiedLevels[activeChild] || 0;
                
                if (levelInfo.level > lastNotifiedLevel) {
                    if (lastNotifiedLevel === 0 && levelInfo.level > 1) {
                         // é¦–æ¬¡åŠ è½½ä¸”ç­‰çº§>1ï¼Œé™é»˜æ›´æ–°
                         setNotifiedLevels(prev => ({...prev, [activeChild]: levelInfo.level}));
                    } else if (levelInfo.level > lastNotifiedLevel) {
                         setLevelUpQueue(prev => [...prev, levelInfo]);
                         setNotifiedLevels(prev => ({...prev, [activeChild]: levelInfo.level}));
                         confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
                         
                         // è®°å½•å¤§äº‹çºªï¼šå‡çº§
                         const todayDate = getLocalDateKey(0);
                         setMilestones(prev => [...prev, {
                             id: `levelup-${levelInfo.level}-${Date.now()}`,
                             type: 'levelup',
                             date: todayDate,
                             timestamp: Date.now(),
                             member: activeChild,
                             title: `å‡çº§è‡³ Lv.${levelInfo.level}`,
                             description: `è¿›åŒ–ä¸ºã€Œ${levelInfo.name}ã€ - ${levelInfo.era}`,
                             level: levelInfo.level,
                             era: levelInfo.era,
                             icon: 'â¬†ï¸'
                         }]);
						 // ğŸŸ¢ã€æ–°å¢ã€‘å‡çº§æ—¶ç«‹å³æ£€æŸ¥æˆå°±ï¼
						// è¿™æ ·å½“ currentXP æ›´æ–°å¯¼è‡´è¿›å…¥æ–°çºªå…ƒæ—¶ï¼Œ"æ—¶ä»£é¢†èˆªè€…" ä¼šç«‹å³å¼¹å‡º
						checkAchievements('levelup');
                    }
                }
            }, [currentXP, activeChild]); // ä¾èµ– activeChild ç¡®ä¿åˆ‡æ¢å­©å­æ—¶é€»è¾‘æ­£ç¡®

            const updateStats = (childId, type, value = 1, extraData = {}) => {
					setStats(prev => {
						const childStats = prev[childId] || {};
						const newStats = { ...childStats };

						if (type === 'checkin') {
							// 1. åŸºç¡€æ‰“å¡è®¡æ•°
							newStats.totalCheckins = (newStats.totalCheckins || 0) + 1;
							
							// 2. å­¦ç§‘åˆ†ç±»è®¡æ•° (æ ¹æ®ä»»åŠ¡åè‡ªåŠ¨åˆ¤æ–­)
							const taskName = extraData.taskName || '';
							if (taskName.includes('è¯­æ–‡') || taskName.includes('è¯­')) newStats.subject_chinese = (newStats.subject_chinese || 0) + 1;
							if (taskName.includes('æ•°å­¦') || taskName.includes('æ•°')) newStats.subject_math = (newStats.subject_math || 0) + 1;
							if (taskName.includes('è‹±è¯­') || taskName.includes('è‹±')) newStats.subject_english = (newStats.subject_english || 0) + 1;
							if (taskName.includes('ç§‘å­¦') || taskName.includes('ç§‘')) newStats.subject_science = (newStats.subject_science || 0) + 1;
						
							// 3. å•æ—¥æ‰“å¡é‡ (ç”¨äºâ€œä¸‰å¤´å…­è‡‚â€)
							const todayKey = getLocalDateKey(0);
							const dailyCountKey = `daily_count_${todayKey}`;
							newStats[dailyCountKey] = (newStats[dailyCountKey] || 0) + 1;

							// 4. æ—©èµ·æ‰“å¡ (ç”¨äºâ€œé»æ˜éª‘å£«â€)
							const hour = new Date().getHours();
							if (hour < 7) { // æ—©ä¸Š7ç‚¹å‰
								newStats.early_bird_count = (newStats.early_bird_count || 0) + 1;
							}
						}

						if (type === 'gold_earn') {
							// 5. å•æ—¥æ”¶ç›Š (ç”¨äºâ€œä¸€å¤œæš´å¯Œâ€)
							const todayKey = getLocalDateKey(0);
							const dailyGoldKey = `daily_gold_${todayKey}`;
							newStats[dailyGoldKey] = (newStats[dailyGoldKey] || 0) + value;
							
							// 6. æŠ•èµ„æ”¶ç›Šç»Ÿè®¡
							if (extraData.source === 'invest_bonus') {
								newStats.invest_earnings = (newStats.invest_earnings || 0) + value;
							}
						}

						if (type === 'gold_spend') {
							// 7. ç´¯è®¡æ¶ˆè´¹ (ç”¨äºâ€œæŒ¥é‡‘å¦‚åœŸâ€)
							newStats.total_spent = (newStats.total_spent || 0) + value;
						}

						if (type === 'repair') {
							// 8. è¡¥ç­¾æ¬¡æ•° (ç”¨äºâ€œè¡¥æ•‘å¤§å¸ˆâ€)
							newStats.repair_count = (newStats.repair_count || 0) + 1;
						}

						return { ...prev, [childId]: newStats };
					});
				};
			
			// --- å•†åº—è´­ä¹°é€»è¾‘ (ä¿®å¤ç‰ˆï¼šå¢åŠ å¼¹çª— + å¼ºåˆ¶çŠ¶æ€æ›´æ–°) ---
            const handleBuyItem = (item, finalPrice) => {
                if (totalGold < finalPrice) {
                    alert("ä½™é¢ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼");
                    return;
                }
                
                // 1. æ‰£æ¬¾è®°å½•
                const historyKey = `${activeChild}-SHOP-${item.id}-${Date.now()}`;
                const newWheelHistory = { ...wheelHistory, [historyKey]: -finalPrice };
                setWheelHistory(newWheelHistory); 
                
				// 2. åŸ‹ç‚¹ç»Ÿè®¡
                updateStats(activeChild, 'gold_spend', finalPrice);
				
                // 3. æ”¾å…¥èƒŒåŒ… (ä½¿ç”¨æ·±æ‹·è´ç¡®ä¿ React æ£€æµ‹åˆ°å˜æ›´)
                setInventory(prev => {
                    const currentAll = { ...prev }; // æµ…æ‹·è´ç¬¬ä¸€å±‚
                    const childInv = { ...(currentAll[activeChild] || {}) }; // æµ…æ‹·è´ç¬¬äºŒå±‚
                    
                    // æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶æ•°é‡+1
                    const oldQuantity = childInv[item.id] || 0;
                    childInv[item.id] = oldQuantity + 1;
                    
                    currentAll[activeChild] = childInv;
                    return currentAll;
                });
                
				// ç«‹å³æ£€æŸ¥æ¶ˆè´¹ç±»æˆå°±ï¼ˆä¼ å…¥ newWheelHistory ä»¥ä¾¿åŒ…å«åˆšåˆšè¿™ç¬”æ¶ˆè´¹ï¼‰
				// è¿™æ ·â€œå€¾å®¶è¡äº§â€ã€â€œæŒ¥é‡‘å¦‚åœŸâ€ç­‰æˆå°±å°±ä¼šç«‹åˆ»å¼¹çª—äº†
				checkAchievements('spend', {}, { wheelHistory: newWheelHistory });
					
				// ã€æ–°å¢ã€‘ç‰¹æ®Šå•†å“è‡ªåŠ¨æ¿€æ´»é€»è¾‘
                if (item.type === 'cosmetic_confetti') {
                    // 1. æ¿€æ´»ç‰¹æ•ˆçŠ¶æ€
                    setStats(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            premiumConfetti: true
                        }
                    }));
                    
					// 2. ã€æ–°å¢ã€‘åŒæ—¶ä¹Ÿæ”¾å…¥èƒŒåŒ…ï¼ˆæ•°é‡è®¾ä¸º1ï¼Œç”¨äºå±•ç¤ºï¼‰ï¼Œé˜²æ­¢é‡å¤è´­ä¹°æ£€æµ‹ä¸åˆ°
                    setInventory(prev => {
                        const childInv = prev[activeChild] || {};
                        return {
                            ...prev,
                            [activeChild]: {
                                ...childInv,
                                [item.id]: 1 // å¼ºåˆ¶è®¾ä¸º1ï¼Œä»£è¡¨æ‹¥æœ‰
                            }
                        };
                    });
                    
					// æ’­æ”¾ä¸€æ¬¡ç‰¹æ•ˆä½œä¸ºæ¼”ç¤º
                    fireRoyalSalute();
                    
                    setTimeout(() => {
                        alert(`ğŸ† å°Šè´µçš„çš‡å®¤æˆå‘˜ï¼\n\nâ€œ${item.name}â€å·²è‡ªåŠ¨æ¿€æ´»ï¼\nä»¥åæ¯æ¬¡æ‰“å¡éƒ½å°†è§¦å‘è±ªåç‰¹æ•ˆï¼`);
                    }, 100);
                    return; // ç›´æ¥è¿”å›ï¼Œä¸å†å¼¹é€šç”¨çš„è´­ä¹°æˆåŠŸçª—
                }
				
                // 4. ç‰¹æ•ˆä¸å¼¹çª—æç¤º
                confetti({ particleCount: 50, spread: 40, origin: { y: 0.5 }, colors: ['#fbbf24'] });
                
                // æ–°å¢ï¼šè´­ä¹°æˆåŠŸå¼¹çª—
                setTimeout(() => {
                    alert(`âœ… è´­ä¹°æˆåŠŸï¼\n\nè·å¾—å•†å“ï¼š${item.name}\nèŠ±è´¹å…ƒå®ï¼š${finalPrice}\n\nå·²æ”¾å…¥ã€æˆ‘çš„èƒŒåŒ…ã€‘ï¼Œè¯·å‰å¾€æŸ¥çœ‹æˆ–ä½¿ç”¨ã€‚`);
                }, 100);
            };

            // --- é“å…·ä½¿ç”¨é€»è¾‘ ---
            const handleUseItem = (item) => {
                // 0. è£…é¥°å“é€»è¾‘ï¼šè£…å¤‡/å¸ä¸‹ (ä¸æ¶ˆè€—åº“å­˜)
                // ã€ä¿®æ”¹ã€‘åŠ å…¥ cosmetic_bg
                if (['cosmetic_frame', 'cosmetic_name', 'cosmetic_bg'].includes(item.type)) {
                    setEquippedGear(prev => {
                        const childGear = prev[activeChild] || {};
                        
                        let targetType = '';
                        // æ˜ å°„ type åˆ°å­˜å‚¨ key
                        if (item.type === 'cosmetic_frame') targetType = 'frame';
                        else if (item.type === 'cosmetic_name') targetType = 'nameEffect';
                        else if (item.type === 'cosmetic_bg') targetType = 'background'; // æ–°å¢èƒŒæ™¯ç±»å‹

                        // æ£€æŸ¥å½“å‰ç‚¹å‡»çš„ç‰©å“æ˜¯å¦å·²ç»è£…å¤‡
                        const isCurrentlyEquipped = childGear[targetType] === item.id;
                        
                        return {
                            ...prev,
                            [activeChild]: {
                                ...childGear,
                                // 1. è£…å¤‡/å¸ä¸‹é€»è¾‘ï¼šå¦‚æœå·²è£…å¤‡åˆ™è®¾ä¸º nullï¼Œå¦åˆ™è®¾ä¸º item.id
                                [targetType]: isCurrentlyEquipped ? null : item.id
                                // æ³¨æ„ï¼šèƒŒæ™¯å±‚ç‹¬ç«‹äºå¤´åƒæ¡†å’Œåå­—ç‰¹æ•ˆï¼Œäº’ä¸å†²çªï¼Œæ‰€ä»¥ä¸éœ€è¦é‡ç½® otherType
                            }
                        };
                    });
                    return; 
                }

                // æ¶ˆè€—é“å…· (å¯¹äºéè£…é¥°å“)
                setInventory(prev => {
                    const childInv = prev[activeChild] || {};
                    const newCount = (childInv[item.id] || 0) - 1;
                    if (newCount < 0) return prev;
                    const newInv = { ...childInv, [item.id]: newCount };
                    if (newCount === 0) delete newInv[item.id];
                    return { ...prev, [activeChild]: newInv };
                });

                const today = getLocalDateKey(0);

                // é“å…·æ•ˆæœåˆ†å‘
                if (item.type === 'buff_xp_3') {
                    setActiveBuffs(prev => ({ ...prev, [activeChild]: { ...(prev[activeChild]||{}), xpBoost: 2, xpBoostCount: 3 } }));
                    alert('ğŸŒ¾ åŒå€ä¸°æ”¶ç¬¦å·²ç”Ÿæ•ˆï¼æ¥ä¸‹æ¥çš„3æ¬¡æ‰“å¡å°†è·å¾—åŒå€ç»éªŒï¼');
                } 
                else if (item.type === 'extend_deadline') {
                    const taskName = prompt("è¯·è¾“å…¥è¦å»¶æœŸçš„ä»»åŠ¡åç§°å…³é”®å­—ï¼š");
                    if (taskName) {
                        setTasks(prev => {
                            const newTasks = [...(prev[activeChild]||[])];
                            const taskIndex = newTasks.findIndex(t => t.name.includes(taskName));
                            if (taskIndex !== -1) {
                                const task = newTasks[taskIndex];
                                const currentDeadline = new Date(task.deadline || globalDates.end);
                                currentDeadline.setDate(currentDeadline.getDate() + 1);
                                newTasks[taskIndex] = { ...task, deadline: currentDeadline.toISOString().split('T')[0] };
                                alert(`â³ æˆåŠŸï¼"${task.name}" çš„æˆªæ­¢æ—¥æœŸå·²å»¶é•¿è‡³ ${newTasks[taskIndex].deadline}`);
                                return { ...prev, [activeChild]: newTasks };
                            } else {
                                alert("æœªæ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡ï¼Œé“å…·å·²è¿”è¿˜ï¼ˆè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ¢å¤åº“å­˜ï¼‰ã€‚"); // ç®€åŒ–å¤„ç†
                                return prev; 
                            }
                        });
                    }
                }
                else if (item.type === 'box') {
                    const roll = Math.random();
                    if (roll < 0.4) {
                        const reward = 1;
                        const key = `${activeChild}-BOX_GOLD-${Date.now()}`;
                        const newHistory = { ...wheelHistory, [key]: reward };
                        setWheelHistory(newHistory);
                        checkAchievements('lucky_spin', {}, { wheelHistory: newHistory }); 
                        alert(`ğŸ è°¢è°¢æƒ é¡¾... è·å¾—äº† 1 é‡‘å…ƒå®å®‰æ…°å¥–ã€‚`);
                    } else if (roll < 0.7) {
                        const reward = 20;
                        const key = `${activeChild}-BOX_XP-${Date.now()}`;
                        setXpHistory(prev => ({ ...prev, [key]: reward }));
                        alert(`ğŸ è¿æ°”ä¸é”™ï¼è·å¾—äº† 20 XP ç»éªŒåŒ…ï¼`);
                    } else if (roll < 0.9) {
                        setRedeemedCoupons(prev => ({...prev, [activeChild]: [...(prev[activeChild]||[]), {name: 'ç¥ç§˜å…‘æ¢åˆ¸', icon: 'ğŸ«', date: today}]}));
                        alert(`ğŸ å“‡ï¼å¼€å‡ºäº†é€šç”¨å…‘æ¢åˆ¸ä¸€å¼ ï¼`);
                    } else {
                        const reward = 200;
                        const key = `${activeChild}-BOX_GOLD-${Date.now()}`;
                        const newHistory = { ...wheelHistory, [key]: reward };
                        setWheelHistory(newHistory);
                        checkAchievements('lucky_spin', {}, { wheelHistory: newHistory });
                        alert(`ğŸ‘‘ ä¼ è¯´çº§æ¬§çš‡ï¼å¼€å‡ºäº† 200 é‡‘å…ƒå®ï¼`);
                    }
                }
                else if (item.type === 'real') {
                    setRedeemedCoupons(prev => ({
                        ...prev, 
                        [activeChild]: [...(prev[activeChild]||[]), {name: item.name, icon: item.icon, date: today}]
                    }));
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#34d399'] });
                    alert(`âœ… å·²å…‘æ¢ "${item.name}"ï¼\n\nè¯·åœ¨ã€Œå…‘æ¢è®°å½•ã€ä¸­å‘å®¶é•¿å‡ºç¤ºè¯¥å‡­è¯ã€‚`);
                }
                else if (item.type === 'freeze') {
                    const freezeDate = today;
                    setStats(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            freezeDates: [...((prev[activeChild]?.freezeDates) || []), freezeDate]
                        }
                    }));
                    confetti({ particleCount: 80, spread: 60, colors: ['#60a5fa', '#93c5fd', '#dbeafe'] });
                    alert(`â„ï¸ å†°æ²³ä¸–çºªå›¾è…¾å·²ç”Ÿæ•ˆï¼\n\n${freezeDate} è¿™ä¸€å¤©å°†è¢«å†»ç»“ï¼Œä¸æ‰“å¡ä¹Ÿä¸ä¼šæ–­ç­¾ï¼Œä½†ä¹Ÿæ— æ³•è·å¾—æ”¶ç›Šã€‚`);
                }
                else if (item.type === 'alchemy') {
                    const xpGain = 500;
                    const key = `${activeChild}-ALCHEMY-${Date.now()}`;
                    setXpHistory(prev => ({ ...prev, [key]: xpGain }));
                    confetti({ particleCount: 120, spread: 90, colors: ['#a855f7', '#c084fc', '#e9d5ff'] });
                    alert(`âš—ï¸ ç‚¼é‡‘æœ¯æˆåŠŸï¼\n\nå·²å°†100é‡‘å…ƒå®è½¬åŒ–ä¸º500ç‚¹ç»éªŒå€¼ï¼`);
                }
                else if (item.type === 'lucky_buff') {
                    setActiveBuffs(prev => ({ ...prev, [activeChild]: { ...(prev[activeChild]||{}), luckyBuff: true } }));
                    confetti({ particleCount: 100, spread: 80, colors: ['#22c55e', '#4ade80', '#86efac'] });
                    alert(`ğŸ€ å¹¸è¿åŠ æŒç¬¦å·²ç”Ÿæ•ˆï¼\n\nä¸‹ä¸€æ¬¡è½¬åŠ¨æƒŠå–œå¤§è½¬ç›˜æ—¶ï¼Œå°†å±è”½æœ€ä½æ¡£å¥–åŠ±ï¼Œå¤§å¤§æé«˜ä¸­å¤§å¥–æ¦‚ç‡ï¼`);
                }
                else if (item.type === 'message_board') {
                    const message = prompt("ğŸ“œ ç”²éª¨æ–‡ä¼ ä¹¦\n\nåˆ»ä¸‹ä½ è¦ä¼ é€’çš„ä¿¡æ¯ï¼ˆæœ€å¤š30å­—ï¼‰ï¼Œå…¨éƒ¨æˆå‘˜çš†å¯çœ‹è§ï¼š");
                    if (message && message.trim()) {
                        const newMessage = {
                            id: Date.now(), // å”¯ä¸€ID
                            text: message.trim().slice(0, 30),
                            author: activeChild,
                            expire: Date.now() + 24 * 60 * 60 * 1000, // 24å°æ—¶æœ‰æ•ˆæœŸ
                            timestamp: Date.now()
                        };
                        
                        // æ”¹ä¸ºè¿½åŠ æ¨¡å¼
                        setGlobalMessages(prev => {
                            // è¿‡æ»¤æ‰å·²è¿‡æœŸçš„ï¼ŒåŠ ä¸Šæ–°çš„ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—
                            const validMsgs = (prev || []).filter(m => m.expire > Date.now());
                            return [newMessage, ...validMsgs];
                        });

                        confetti({ particleCount: 60, spread: 50, colors: ['#f59e0b', '#fbbf24', '#8B4513'] });
                        alert(`âœ… ä¼ ä¹¦æˆåŠŸï¼\n\nä½ çš„ä¼ ä¹¦å·²é£å‘é¦–é¡µï¼Œå°†ä¿ç•™24å°æ—¶ã€‚`);
                    } else {
                        alert("å–æ¶ˆäº†ç•™è¨€ï¼Œé“å…·å·²è¿”è¿˜ã€‚");
                        // è¿”è¿˜é“å…·
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                    }
                }             
                else if (item.type === 'parent_help') {
                    setRedeemedCoupons(prev => ({
                        ...prev, 
                        [activeChild]: [...(prev[activeChild]||[]), {name: item.name, icon: item.icon, date: today}]
                    }));
                    confetti({ particleCount: 80, spread: 60, colors: ['#8b5cf6', '#a78bfa'] });
                    alert(`ğŸ–Œï¸ ç¥ç¬”é©¬è‰¯ä½“éªŒåˆ¸å·²æ¿€æ´»ï¼\n\nè¯·åœ¨ã€Œå…‘æ¢è®°å½•ã€ä¸­å‘å®¶é•¿å‡ºç¤ºï¼Œè¯·å®¶é•¿å¸®å¿™å®Œæˆæ‰‹å·¥ä»»åŠ¡çš„éš¾ç‚¹éƒ¨åˆ†ã€‚`);
                }
                else if (item.type === 'parent_monitor') {
                    setRedeemedCoupons(prev => ({
                        ...prev, 
                        [activeChild]: [...(prev[activeChild]||[]), {name: item.name, icon: item.icon, date: today}]
                    }));
                    confetti({ particleCount: 70, spread: 50, colors: ['#eab308', '#facc15'] });
                    alert(`ğŸ“ å­”å¤«å­çš„æˆ’å°ºå·²æ¿€æ´»ï¼\n\nè¯·åœ¨ã€Œå…‘æ¢è®°å½•ã€ä¸­å‘å®¶é•¿å‡ºç¤ºã€‚å¦‚æœå®¶é•¿ä»Šå¤©ç©æ‰‹æœºè¶…è¿‡1å°æ—¶ï¼Œå¯ä»¥è¦æ±‚ç½šæ¬¾10å…ƒã€‚`);
                }
                else if (item.type === 'invest_multiplier') {
                    const multiplier = item.multiplier || 2;
                    const duration = item.duration || 3;
                    const expireDate = new Date();
                    expireDate.setDate(expireDate.getDate() + duration);
                    setActiveBuffs(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            investMultiplier: multiplier,
                            investExpire: getLocalDateKey(item.duration), // ä¿æŒåŸæœ‰é€»è¾‘
							investStart: getLocalDateKey(0) // ã€æ–°å¢ã€‘è®°å½•æŠ•èµ„å¼€å§‹æ—¥æœŸï¼ˆä»Šå¤©ï¼‰
                        }
                    }));
                    confetti({ particleCount: 150, spread: 120, colors: ['#f59e0b', '#fbbf24', '#fcd34d'] });
                    alert(`ğŸ’° ${item.name}å·²ç”Ÿæ•ˆï¼\n\næ¥ä¸‹æ¥${duration}å¤©å†…ï¼Œæ‰€æœ‰ä»»åŠ¡æ‰“å¡å¥–åŠ±å°†å˜ä¸º${multiplier}å€ï¼\nèµ¶ç´§å»æ‰“å¡èµšé’±å§ï¼`);
                }
                else if (item.type === 'help_card') {
                    setRedeemedCoupons(prev => ({
                        ...prev, 
                        [activeChild]: [...(prev[activeChild]||[]), {name: item.name, icon: item.icon, date: today}]
                    }));
                    confetti({ particleCount: 60, spread: 50, colors: ['#06b6d4', '#22d3ee'] });
                    alert(`ğŸ“¦ è¯¸è‘›é”¦å›Šå·²æ¿€æ´»ï¼\n\nè¯·åœ¨ã€Œå…‘æ¢è®°å½•ã€ä¸­å‘å®¶é•¿å‡ºç¤ºã€‚å®¶é•¿å¿…é¡»è€å¿ƒè®²è§£10åˆ†é’Ÿï¼Œä¸”ä¸èƒ½å‘ç«ã€‚`);
                }
                else if (item.type === 'reduce_homework') {
                    setRedeemedCoupons(prev => ({
                        ...prev, 
                        [activeChild]: [...(prev[activeChild]||[]), {name: item.name, icon: item.icon, date: today}]
                    }));
                    confetti({ particleCount: 80, spread: 60, colors: ['#14b8a6', '#2dd4bf'] });
                    alert(`âœ‚ï¸ å¬å†™è±å…åˆ¸å·²æ¿€æ´»ï¼\n\nè¯·åœ¨ã€Œå…‘æ¢è®°å½•ã€ä¸­å‘å®¶é•¿å‡ºç¤ºã€‚ä»Šå¤©çš„å¬å†™ä»»åŠ¡é‡å‡åŠï¼`);
                }
                else if (item.type === 'cosmetic_confetti') {
                    setStats(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            premiumConfetti: true
                        }
                    }));
                    confetti({ particleCount: 200, spread: 160, colors: ['#fbbf24', '#f59e0b', '#dc2626', '#7c3aed'] });
                    alert(`ğŸ† çš‡å®¶ç¤¼ç‚®ç‰¹æ•ˆå·²æ°¸ä¹…å‡çº§ï¼\n\nä»ç°åœ¨èµ·ï¼Œæ¯æ¬¡æ‰“å¡éƒ½å°†äº«å—é‡‘å¸é›¨å’Œæ˜Ÿæ˜Ÿçš„æ··åˆç‰¹æ•ˆï¼`);
                }
                else if (item.type === 'cosmetic_theme') {
                    setStats(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            unlockedThemes: [...((prev[activeChild]?.unlockedThemes) || []), item.id]
                        }
                    }));
                    confetti({ particleCount: 150, spread: 120, colors: ['#06b6d4', '#ec4899', '#8b5cf6'] });
                    alert(`ğŸŒƒ ${item.name}å·²è§£é”ï¼\n\nè¯·åœ¨è®¾ç½®ä¸­åˆ‡æ¢ä¸»é¢˜ã€‚`);
                }
                else if (item.type === 'unlock_theme') {
                    setStats(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            unlockedThemes: [...((prev[activeChild]?.unlockedThemes) || []), 'dunhuang']
                        }
                    }));
                    confetti({ particleCount: 200, spread: 140, colors: ['#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'] });
                    alert(`ğŸ—ºï¸ ä¸ç»¸ä¹‹è·¯å¯»å®å›¾å·²è§£é”ï¼\n\nã€Œè¥¿åŸŸæ•¦ç…Œã€éšè—ä¸»é¢˜å·²å¼€å¯ï¼Œè¯·åœ¨è®¾ç½®ä¸­åˆ‡æ¢ã€‚`);
                }
                else if (item.type === 'challenge') {
                    const otherChild = activeChild === 'Yoly' ? 'Henry' : 'Yoly';
                    const challengeText = prompt(`âš”ï¸ è¯·è¾“å…¥æŒ‘æˆ˜å†…å®¹ï¼ˆä¾‹å¦‚ï¼šâ€œè°å…ˆå®Œæˆä»Šå¤©çš„æ•°å­¦ç²¾å‡†å­¦â€ï¼‰ï¼š`);
                    if (challengeText && challengeText.trim()) {
                        setStats(prev => ({
                            ...prev,
                            activeChallenge: {
                                text: challengeText.trim(),
                                initiator: activeChild,
                                opponent: otherChild,
                                timestamp: Date.now()
                            }
                        }));
                        confetti({ particleCount: 100, spread: 80, colors: ['#ef4444', '#f97316'] });
                        alert(`âš”ï¸ æŒ‘æˆ˜å·²å‘èµ·ï¼\n\nå‘${otherChild}å‘èµ·æŒ‘æˆ˜ï¼šâ€œ${challengeText.trim()}â€\nè¯·å®¶é•¿è£åˆ¤ï¼Œèµ¢å®¶å°†è·å¾—100å…ƒå®å¥–åŠ±ï¼`);
                    } else {
                        alert("å–æ¶ˆäº†æŒ‘æˆ˜ï¼Œé“å…·å·²è¿”è¿˜ã€‚");
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                    }
                }
                else if (item.type === 'silence') {
                    const otherChild = activeChild === 'Yoly' ? 'Henry' : 'Yoly';
                    const expireTime = Date.now() + 10 * 60 * 1000; // 10åˆ†é’Ÿ
                    setStats(prev => ({
                        ...prev,
                        silenceTarget: { target: otherChild, expire: expireTime, by: activeChild }
                    }));
                    confetti({ particleCount: 60, spread: 50, colors: ['#6366f1', '#818cf8'] });
                    alert(`ğŸ¤« é™éŸ³å¡å·²ç”Ÿæ•ˆï¼\n\n${otherChild}å¿…é¡»å®‰é™10åˆ†é’Ÿï¼Œä¸èƒ½è¯´è¯å’Œåˆ¶é€ å™ªéŸ³ã€‚\nè¯·å®¶é•¿ç›‘ç£æ‰§è¡Œã€‚`);
                }
                else if (item.type === 'undo') {
                    // 1. æŸ¥æ‰¾æœ€è¿‘çš„ä¸€æ¡è´­ä¹°è®°å½• (SHOP ç±»å‹)
                    // å°†å†å²è®°å½•æŒ‰æ—¶é—´å€’åºæ’åˆ—
                    const historyKeys = Object.keys(wheelHistory).sort((a, b) => {
                        const timeA = parseInt(a.split('-').pop());
                        const timeB = parseInt(b.split('-').pop());
                        return timeB - timeA; 
                    });

                    // æ‰¾åˆ°å±äºå½“å‰å­©å­çš„æœ€è¿‘ä¸€æ¡è´­ä¹°è®°å½•
                    const lastShopKey = historyKeys.find(k => k.startsWith(`${activeChild}-SHOP-`));

                    if (!lastShopKey) {
                        alert("âŒ æ— æ³•æ’¤é”€ï¼šæœ€è¿‘æ²¡æœ‰è´­ä¹°è®°å½•ï¼Œæˆ–è€…è®°å½•å·²ä¸¢å¤±ã€‚");
                        // å¤±è´¥è¿”è¿˜é“å…·
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    // è§£æè®°å½•ï¼šactiveChild-SHOP-itemId-timestamp
                    const parts = lastShopKey.split('-');
                    const targetItemId = parts[2];
                    const targetItem = SHOP_ITEMS.find(i => i.id === targetItemId);
                    const cost = Math.abs(wheelHistory[lastShopKey]); // è·å–å½“æ—¶èŠ±è´¹çš„é‡‘é¢

                    // 2. æ£€æŸ¥è¯¥ç‰©å“æ˜¯å¦è¿˜åœ¨èƒŒåŒ…é‡Œ (å¦‚æœå·²ç»ç”¨äº†å°±ä¸èƒ½åæ‚”)
                    if (!inventory[activeChild] || !inventory[activeChild][targetItemId] || inventory[activeChild][targetItemId] <= 0) {
                        alert(`âŒ æ— æ³•æ’¤é”€ï¼šä½ è´­ä¹°çš„ "${targetItem ? targetItem.name : 'æœªçŸ¥ç‰©å“'}" å·²ç»ä¸åœ¨èƒŒåŒ…ä¸­äº†ï¼ˆå¯èƒ½å·²è¢«ä½¿ç”¨ï¼‰ã€‚\n\nåæ‚”è¯æ°´åªèƒ½æ’¤é”€â€œä¹°é”™ä½†æ²¡ç”¨â€çš„æ“ä½œã€‚`);
                        // å¤±è´¥è¿”è¿˜é“å…·
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    // 3. æ‰§è¡Œæ’¤é”€
                    if (confirm(`â®ï¸ ç¡®å®šè¦æ’¤é”€è´­ä¹° "${targetItem ? targetItem.name : 'æœªçŸ¥å•†å“'}" å—ï¼Ÿ\n\næ‰§è¡Œåï¼š\n1. é€€è¿˜ ${cost} é‡‘å…ƒå®\n2. ä»èƒŒåŒ…æ”¶å›è¯¥å•†å“\n3. æ¶ˆè€— 1 ç“¶åæ‚”è¯æ°´`)) {
                         
                         const newHistory = { ...wheelHistory };
                         
                         // --- æ ¸å¿ƒä¿®æ”¹å¼€å§‹ ---
                         // æ—§é€»è¾‘ï¼šç›´æ¥åˆ é™¤è®°å½• (delete newHistory[lastShopKey])
                         // æ–°é€»è¾‘ï¼šä¿ç•™è®°å½•ä½†æ”¹åï¼ˆé˜²æ­¢å†æ¬¡è¢«æ’¤é”€ï¼‰ï¼Œå¹¶å¢åŠ é€€æ¬¾è®°å½•
                         
                         // 1. å°†åŸè´­ä¹°è®°å½•æ ‡è®°ä¸ºâ€œå·²æ’¤é”€å†å²â€ (SHOP -> SHOP_REVOKED)
                         // è¿™æ ·å®ƒè¿˜åœ¨åˆ—è¡¨é‡Œï¼Œä½†åæ‚”è¯æ°´ä¸ä¼šå†æ‰«æåˆ°å®ƒï¼Œä¸”é‡‘é¢ç»´æŒè´Ÿæ•°
                         const revokedKey = lastShopKey.replace('-SHOP-', '-SHOP_REVOKED-');
                         delete newHistory[lastShopKey]; // åˆ é™¤æ—§é”®
                         newHistory[revokedKey] = -cost; // å†™å…¥æ–°é”®ï¼Œä¿æŒè´Ÿå€¼
                         
                         // 2. æ–°å¢ä¸€ç¬”é€€æ¬¾è®°å½• (ç±»å‹ä¸º REFUNDï¼Œæ˜¾ç¤ºæ­£æ•°)
                         // æ ¼å¼ï¼šchild-REFUND-itemId-timestamp
                         // è¿™æ ·æ˜ç»†é‡Œä¼šæ˜¾ç¤ºè¯¥å•†å“çš„å›¾æ ‡ï¼Œé‡‘é¢ä¸ºç»¿è‰² +cost
                         const refundKey = `${activeChild}-REFUND-${targetItemId}-${Date.now()}`;
                         newHistory[refundKey] = cost;
                         // --- æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---

                         setWheelHistory(newHistory);

                         // B. ä»èƒŒåŒ…ç§»é™¤è¯¥å•†å“ (ä¿æŒä¸å˜)
                         setInventory(prev => {
                            const currentAll = { ...prev };
                            const childInv = { ...(currentAll[activeChild] || {}) };
                            
                            const newCount = (childInv[targetItemId] || 0) - 1;
                            if (newCount <= 0) delete childInv[targetItemId];
                            else childInv[targetItemId] = newCount;

                            currentAll[activeChild] = childInv;
                            return currentAll;
                         });

                         alert(`âœ… æ’¤é”€æˆåŠŸï¼\nå·²ç”Ÿæˆé€€æ¬¾è®°å½•ï¼š+${cost} é‡‘å…ƒå®ã€‚`);
                    } else {
                         // ç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œè¿”è¿˜åæ‚”è¯æ°´
                         setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                    }
                }
				else if (item.type === 'undo_advanced') {
                    // 1. è·å–èƒŒåŒ…ä¸­é™¤äº†â€œé«˜çº§åæ‚”è¯æ°´â€ä»¥å¤–çš„æ‰€æœ‰ç‰©å“
                    const currentInv = inventory[activeChild] || {};
                    const returnableItems = Object.keys(currentInv).filter(k => k !== item.id);

                    if (returnableItems.length === 0) {
                        alert("ğŸ’ èƒŒåŒ…é‡Œç©ºç©ºå¦‚ä¹Ÿï¼ˆé™¤äº†è¿™ç“¶è¯æ°´ï¼‰ï¼Œæ²¡æœ‰å¯é€€çš„å•†å“ï¼");
                        // è¿”è¿˜è¯æ°´
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    // 2. æ„å»ºé€‰æ‹©åˆ—è¡¨ä¾›ç”¨æˆ·è¾“å…¥
                    const itemListStr = returnableItems.map((id, index) => {
                        const itemDef = SHOP_ITEMS.find(i => i.id === id);
                        return `${index + 1}. ${itemDef ? itemDef.name : id} (æ‹¥æœ‰: ${currentInv[id]})`;
                    }).join('\n');

                    const choice = prompt(`ğŸ· è¯·è¾“å…¥ä½ è¦é€€è´§çš„å•†å“ã€åºå·ã€‘ï¼š\n\n${itemListStr}`);
                    
                    // 3. å¤„ç†ç”¨æˆ·è¾“å…¥
                    if (choice === null) { // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    const index = parseInt(choice) - 1;
                    if (isNaN(index) || index < 0 || index >= returnableItems.length) {
                        alert("âŒ è¾“å…¥æ— æ•ˆï¼Œæ“ä½œå·²å–æ¶ˆã€‚");
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    const targetItemId = returnableItems[index];
                    const targetItemDef = SHOP_ITEMS.find(i => i.id === targetItemId);

                    // 4. æŸ¥æ‰¾è¯¥å•†å“æœ€è¿‘çš„è´­ä¹°è®°å½• (ä¸ºäº†ç¡®å®šé€€å¤šå°‘é’±)
                    const historyKeys = Object.keys(wheelHistory).sort((a, b) => {
                        const timeA = parseInt(a.split('-').pop());
                        const timeB = parseInt(b.split('-').pop());
                        return timeB - timeA;
                    });
                    // æ ¼å¼: activeChild-SHOP-itemId-timestamp
                    const targetKey = historyKeys.find(k => k.startsWith(`${activeChild}-SHOP-${targetItemId}-`));

                    if (!targetKey) {
                        alert(`âŒ æ— æ³•é€€æ¬¾ï¼š\nå•†å“ "${targetItemDef ? targetItemDef.name : targetItemId}" æ²¡æœ‰è´­ä¹°è®°å½•ã€‚\n\nå¯èƒ½æ¥æºï¼šæŠ½å¥–è·å¾—ã€ç³»ç»Ÿèµ é€æˆ–æ‰‹åŠ¨æ·»åŠ ã€‚\né«˜çº§åæ‚”è¯æ°´åªèƒ½é€€è¿˜ã€é€šè¿‡å•†åº—è´­ä¹°ã€‘çš„å•†å“ã€‚`);
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                        return;
                    }

                    const refundAmount = Math.abs(wheelHistory[targetKey]);

                    // 5. æœ€ç»ˆç¡®è®¤
                    if (confirm(`ğŸ’° ç¡®å®šè¦é€€æ‰ 1 ä¸ª "${targetItemDef ? targetItemDef.name : targetItemId}" å—ï¼Ÿ\n\næ‰§è¡Œåï¼š\n1. é€€è¿˜ ${refundAmount} é‡‘å…ƒå®\n2. ä»èƒŒåŒ…ç§»é™¤è¯¥å•†å“\n3. æ¶ˆè€—æ­¤é«˜çº§åæ‚”è¯æ°´`)) {
                        
                        const newHistory = { ...wheelHistory };

                        // --- æ ¸å¿ƒä¿®æ”¹å¼€å§‹ ---
                        // 1. å°†åŸè´­ä¹°è®°å½•æ ‡è®°ä¸ºâ€œå·²æ’¤é”€å†å²â€
                        const revokedKey = targetKey.replace('-SHOP-', '-SHOP_REVOKED-');
                        delete newHistory[targetKey];
                        newHistory[revokedKey] = -refundAmount;

                        // 2. æ–°å¢ä¸€ç¬”é€€æ¬¾è®°å½•
                        // è¿™é‡Œæˆ‘ä»¬åœ¨ ID åé¢åŠ ä¸ªå°æ ‡è®°ï¼Œæˆ–è€…ç›´æ¥ç”¨ targetItemIdï¼Œè¿™æ ·èƒ½æ˜¾ç¤ºå‡ºæ˜¯é€€äº†å“ªä¸ªå•†å“
                        const refundKey = `${activeChild}-REFUND-${targetItemId}-${Date.now()}`;
                        newHistory[refundKey] = refundAmount;
                        // --- æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---
                        
                        setWheelHistory(newHistory);

                        // B. ä»èƒŒåŒ…ç§»é™¤ç›®æ ‡å•†å“ (ä¿æŒä¸å˜)
                        setInventory(prev => {
                            const currentAll = { ...prev };
                            const childInv = { ...(currentAll[activeChild] || {}) };
                            
                            const newCount = (childInv[targetItemId] || 0) - 1;
                            if (newCount <= 0) delete childInv[targetItemId];
                            else childInv[targetItemId] = newCount;

                            currentAll[activeChild] = childInv;
                            return currentAll;
                        });

                        alert(`âœ… é€€è´§æˆåŠŸï¼\nå·²ç”Ÿæˆé€€æ¬¾è®°å½•ï¼š+${refundAmount} é‡‘å…ƒå®ã€‚`);
                    } else {
                        // ç”¨æˆ·åœ¨æœ€åä¸€æ­¥å–æ¶ˆ
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            return { ...prev, [activeChild]: { ...childInv, [item.id]: (childInv[item.id] || 0) + 1 } };
                        });
                    }
                }
            };

            // ä½¿ç”¨è¡¥ç­¾å¡
            const useRepairCard = (entry) => {
                if ((inventory[activeChild]?.['item_fire'] || 0) > 0) {
                     // æ¶ˆè€—
                     setInventory(prev => {
                        const childInv = prev[activeChild] || {};
                        const newCount = (childInv['item_fire'] || 0) - 1;
                        const newInv = { ...childInv, 'item_fire': newCount };
                        if (newCount <= 0) delete newInv['item_fire'];
                        return { ...prev, [activeChild]: newInv };
                    });
                    // è¡¥ç­¾ (è®¾ä¸º1åˆ†é’Ÿè¡¨ç¤ºå·²å®Œæˆä½†åŒºåˆ«äºæ­£å¸¸æ‰“å¡)
                    saveCheckin(1);
					// ã€æ–°å¢ï¼šåŸ‹ç‚¹è®°å½•è¡¥ç­¾ã€‘
                    updateStats(activeChild, 'repair', 1);
                    alert("ğŸ”¥ è¡¥ç­¾æˆåŠŸï¼å¸Œæœ›é‡ç‡ƒï¼");
					// ğŸŸ¢ã€æ–°å¢ã€‘ç«‹å³æ£€æŸ¥æˆå°±
					checkAchievements('repair');
                }
            };

            // ä½¿ç”¨è·³è¿‡å¡
            const useSkipCard = (task) => {
                 if ((inventory[activeChild]?.['item_skip'] || 0) > 0) {
                      setInventory(prev => {
                        const childInv = prev[activeChild] || {};
                        const newCount = (childInv['item_skip'] || 0) - 1;
                        const newInv = { ...childInv, 'item_skip': newCount };
                        if (newCount <= 0) delete newInv['item_skip'];
                        return { ...prev, [activeChild]: newInv };
                    });
                    // è®¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„å®Œæˆæ ‡è®°
                    const today = getLocalDateKey(0);
                    const newCheckins = { ...checkins };
                    const childData = newCheckins[activeChild] || {};
                    const taskData = childData[task.id] || {};
                    newCheckins[activeChild] = { ...childData, [task.id]: { ...taskData, [today]: 'å…' } };
                    setCheckins(newCheckins);
                    
                    // ç»™å¥–åŠ± (ä»»åŠ¡å¥–åŠ± + é¢å¤–åŠ æˆæ— éœ€å¤„ç†)
                    const key = `${activeChild}-SKIP-${task.id}-${Date.now()}`;
                    const newHistory = { ...wheelHistory, [key]: task.reward };
                    setWheelHistory(newHistory);
                    
                    checkAchievements('checkin', {}, { checkins: newCheckins, wheelHistory: newHistory });
                    alert(`ğŸ“œ å·²ä½¿ç”¨é‡‘ç‰Œå…é™¤ä»Šæ—¥ "${task.name}" ä»»åŠ¡ï¼Œå¥–åŠ±å·²å‘æ”¾ï¼`);
                 }
            };

            // --- å…¨èƒ½ç‰ˆæˆå°±æ£€æŸ¥ç³»ç»Ÿ v3.1 (ä¿®å¤æ•°æ®ç»“æ„é”™è¯¯) ---
            const checkAchievements = (triggerType, context = {}, extraData = {}) => {
                // ã€ä¿®å¤1ã€‘é»˜è®¤å€¼æ”¹ä¸º {} (å¯¹è±¡)ï¼Œè€Œä¸æ˜¯ [] (æ•°ç»„)
                const currentAchievements = achievements[activeChild] || {};
                
                const newUnlocked = [];
                const queue = [];

                // è¾…åŠ©ï¼šæ™ºèƒ½è¯†åˆ«ä»»åŠ¡å­¦ç§‘
                const getTaskSubject = (taskName) => {
					if (!taskName) return 'other';
					const name = taskName.toLowerCase(); // ç»Ÿä¸€è½¬å°å†™ä»¥ä¾¿åŒ¹é…è‹±æ–‡
					
					// 1. æ•°å­¦ç±»ï¼šæ–°å¢â€œå¥¥æ•°â€ã€â€œåŸ¹ä¼˜â€ã€â€œæ€ç»´â€
					if (/æ•°|ç®—|é€»è¾‘|å¥¥|åŸ¹ä¼˜|æ€ç»´/.test(name)) return 'math';
					
					// 2. è‹±è¯­ç±»ï¼šã€å…³é”®ä¿®å¤ã€‘æåˆ°è¯­æ–‡å‰é¢ï¼é˜²æ­¢â€œèƒŒå•è¯â€è¢«è¯¯åˆ¤ä¸ºè¯­æ–‡
					// æ–°å¢ï¼šRaz, En, å¬åŠ›, å£è¯­
					if (/è‹±|å•è¯|è¯|è¯‘|å¬åŠ›|å£è¯­|raz|en|english/.test(name)) return 'english';
					
					// 3. ç§‘å­¦ç±»ï¼šã€æ‰©å……ã€‘æ–°å¢ ç”Ÿ(ç”Ÿç‰©), åœ°(åœ°ç†), ç¨‹(ç¼–ç¨‹), æœºå™¨(æœºå™¨äºº), ç™¾ç§‘
					if (/ç§‘|å®éªŒ|ç‰©ç†|åŒ–|ç”Ÿ|åœ°|ç¨‹|æœºå™¨|ç™¾ç§‘|stem/.test(name)) return 'science';
					
					// 4. è¯­æ–‡ç±»ï¼šæ”¾åˆ°åé¢
					// æ–°å¢ï¼šå¤è¯—, ç»ƒå­—
					if (/è¯­|æ–‡|è¯»|èƒŒ|å†™å­—|å¤è¯—|ç»ƒå­—/.test(name)) return 'chinese';
					
					// 5. è‰ºæœ¯ç±»ï¼šæ–°å¢ æ£‹, ä¹¦(ä¹¦æ³•)
					if (/çµç¶|ç´|ç”»|éŸ³|æ£‹|ä¹¦|èˆ|ç¾/.test(name)) return 'art';
					
					return 'other';
				};

                // å‡†å¤‡æ•°æ®
                const today = getLocalDateKey(0);
                const history = extraData.wheelHistory || wheelHistory; 
                const currentCheckins = extraData.checkins || checkins; 
                const childCheckins = currentCheckins[activeChild] || {};
                
                // ç»Ÿè®¡å„ç±»æ•°æ®
                let totalCheckinCount = 0;
                let subjectCounts = { math: 0, chinese: 0, english: 0, science: 0, art: 0 };
                let consecutiveDays = 0;
                let maxGapDays = 0; 
                
                const sortedDates = [];
                Object.entries(childCheckins).forEach(([taskId, dates]) => {
                    const count = Object.keys(dates).length;
                    totalCheckinCount += count;
                    
                    const taskName = (tasks[activeChild]?.find(t => t.id === taskId)?.name) || '';
                    const subject = getTaskSubject(taskName);
                    if (subjectCounts[subject] !== undefined) subjectCounts[subject] += count;

                    Object.keys(dates).forEach(d => sortedDates.push(d));
                });

                const uniqueDates = [...new Set(sortedDates)].sort();
                if (uniqueDates.length > 0) {
                    let streak = 0;
                    let tempStreak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const d1 = new Date(uniqueDates[i-1]);
                        const d2 = new Date(uniqueDates[i]);
                        const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24)); 
                        
                        if (diffDays === 1) {
                            tempStreak++;
                        } else {
                            if (diffDays > maxGapDays) maxGapDays = diffDays;
                            streak = Math.max(streak, tempStreak);
                            tempStreak = 1;
                        }
                    }
                    consecutiveDays = Math.max(streak, tempStreak);
                }

                // ã€ä¿®å¤2ã€‘åˆ¤å®šé€»è¾‘ä¿®æ”¹ï¼šæ£€æŸ¥å¯¹è±¡keyæ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸æ˜¯ç”¨ .includes
                const tryUnlock = (badgeId) => {
                    // currentAchievements[badgeId] ä¸ºçœŸè¡¨ç¤ºå·²æ‹¥æœ‰
                    if (!currentAchievements[badgeId] && !newUnlocked.includes(badgeId)) {
                        const badgeInfo = BADGES.find(b => b.id === badgeId);
                        if (badgeInfo) {
                            newUnlocked.push(badgeId);
                            queue.push({ id: badgeId, ...badgeInfo });
                        }
                    }
                };

                // ... (ä¸­é—´çš„åˆ¤å®šé€»è¾‘ä¿æŒä¸å˜) ...
                // ==================== 1. æ¯…åŠ›ç±» ====================
                if (totalCheckinCount >= 1) tryUnlock('first_blood'); 
                if (totalCheckinCount >= 10) tryUnlock('perfect_10'); 
                if (totalCheckinCount >= 100) tryUnlock('steeled'); 
                if (totalCheckinCount >= 300) tryUnlock('accumulation'); 
                
                if (consecutiveDays >= 7) tryUnlock('persistence'); 
                if (consecutiveDays >= 14) tryUnlock('iron_will'); 
                if (consecutiveDays >= 25) tryUnlock('marathon'); 
				// --- æ–°å¢ï¼šå‘¨æœ«æˆ˜å£«åˆ¤å®š ---
				// context.currentWeekendStreak æ˜¯ä» saveCheckin ä¼ è¿‡æ¥çš„ï¼Œæˆ–è€…æ˜¯ä» stats è¯»å–çš„å…œåº•å€¼
				const activeWeekendStreak = context.currentWeekendStreak || (stats[activeChild]?.weekendStreak) || 0;
				if (activeWeekendStreak >= 2) tryUnlock('weekend_warrior');

                if (maxGapDays > 3 && triggerType === 'checkin') tryUnlock('return_king');

                if (triggerType === 'checkin') {
                    const hour = new Date().getHours();
                    if (hour < 7) tryUnlock('dawn_knight'); 
                    if (context.currentEarlyStreak >= 3) tryUnlock('early_bird'); 
                    if (hour >= 23 || hour === 0) tryUnlock('midnight'); 
                }
				// è¡¥æ•‘å¤§å¸ˆ
				if ((stats[activeChild]?.repair_count || 0) >= 5) tryUnlock('repair_master');

                // ==================== 2. ç²¾é€šç±» ====================
                if (subjectCounts.chinese >= 20) tryUnlock('chinese_master');
                if (subjectCounts.chinese >= 50) tryUnlock('literary_giant');
                if (subjectCounts.chinese >= 100) tryUnlock('literary_grandmaster');
                
                if (subjectCounts.math >= 20) tryUnlock('math_whiz');
                if (subjectCounts.math >= 50) tryUnlock('logic_master');
                if (subjectCounts.math >= 100) tryUnlock('math_god');
                
                if (subjectCounts.english >= 20) tryUnlock('english_ace');
                if (subjectCounts.english >= 50) tryUnlock('translation_master');
                if (subjectCounts.english >= 100) tryUnlock('language_lord');
                
                if (subjectCounts.science >= 20) tryUnlock('science_star');
                if (subjectCounts.science >= 50) tryUnlock('future_inventor');
                if (subjectCounts.science >= 100) tryUnlock('science_titan');

                if (subjectCounts.art >= 20) tryUnlock('artist');

                if (subjectCounts.chinese >= 50 && subjectCounts.math >= 50 && subjectCounts.english >= 50) {
                    tryUnlock('polymath');
                }

                let todayTaskCount = 0;
                Object.values(childCheckins).forEach(dates => {
                    if (dates[today]) todayTaskCount++;
                });
                if (todayTaskCount >= 10) tryUnlock('six_arms');
               
			    // ä»Šæ—¥äº‹ä»Šæ—¥æ¯•
				const activeDailyTasks = (tasks[activeChild] || []).filter(t => 
					(!t.startDate || today >= t.startDate) && 
					(!t.deadline || today <= t.deadline)
				);
				// åªæœ‰å½“ä»»åŠ¡åˆ—è¡¨ä¸ä¸ºç©ºï¼Œä¸”æ¯ä¸€ä¸ªä»»åŠ¡åœ¨ childCheckins ä¸­éƒ½æœ‰ä»Šæ—¥è®°å½•æ—¶ï¼Œæ‰è§£é”
				if (activeDailyTasks.length > 0 && activeDailyTasks.every(t => childCheckins[t.id]?.[today])) {
					tryUnlock('daily_done');
				}
				
				// å¤šé¢æ‰‹ (all_rounder): ä¸€å‘¨å†…3ä¸ªä»»åŠ¡å„å®Œæˆ5æ¬¡
				if (triggerType === 'checkin') {
					const recent7Days = [];
					for(let i=0; i<7; i++) recent7Days.push(getLocalDateKey(-i));
					
					let taskCounts7Days = {};
					Object.entries(childCheckins).forEach(([tid, dates]) => {
						let c = 0;
						recent7Days.forEach(d => { if(dates[d]) c++; });
						if (c >= 5) taskCounts7Days[tid] = c;
					});
					if (Object.keys(taskCounts7Days).length >= 3) tryUnlock('all_rounder');
				}
				
				// é—ªç”µå¿«æ‰‹ã€å­¦æœ‰æ‰€æˆã€
				const myTasks = tasks[activeChild] || [];
				myTasks.forEach(t => {
					const record = childCheckins[t.id] || {};
					const count = Object.keys(record).length;
					
					// å­¦æœ‰æ‰€æˆ (accomplished)
					if (count >= t.targetCount) {
						tryUnlock('accomplished');
						
						// é—ªç”µå¿«æ‰‹ (lightning): æå‰3å¤©å®Œæˆ
						if (t.deadline) {
							const finishDateStr = Object.keys(record).sort()[t.targetCount - 1]; // å®Œæˆçš„é‚£ä¸€å¤©
							if (finishDateStr) {
								const dead = new Date(t.deadline);
								const fin = new Date(finishDateStr);
								const diffTime = dead - fin;
								const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
								if (diffDays >= 3) tryUnlock('lightning');
							}
						}
					}
				});

                // ==================== 3. è´¢å¯Œç±» ====================
                const currentStats = extraData.stats?.[activeChild] || stats[activeChild] || { totalGold: 0, history: [] };
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é‡æ–°è®¡ç®— totalGoldï¼Œå› ä¸º stats å¯èƒ½ä¸æ˜¯æœ€æ–°çš„
                // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨è®¡ç®—å‡½æ•°
                // const realTotalGold = calculateTotalGold(currentCheckins, history, activeChild);
                
                if (totalGold >= 100) tryUnlock('first_pot');
                if (totalGold >= 1000) tryUnlock('tycoon');
                if (totalGold >= 5000) tryUnlock('wealthy');
                if (totalGold >= 2000) tryUnlock('midas_touch'); 
                
				// ç‰¹æ®Šæˆå°±ï¼šä¸€å¤œæš´å¯Œ (å•æ—¥è·å¾—è¶…è¿‡100å…ƒå®)
                // ã€ä¿®æ­£ã€‘å…¨å†å²å›æº¯æ£€æŸ¥ï¼Œè€Œä¸ä»…ä»…æ£€æŸ¥ä»Šå¤©
                
                // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰å‘ç”Ÿè¿‡å˜åŠ¨çš„æ—¥æœŸ
                const activeDates = new Set();
                const cCheckins = checkins[activeChild] || {};
                
                // ä»æ‰“å¡è®°å½•æ”¶é›†æ—¥æœŸ
                Object.values(cCheckins).forEach(record => {
                    Object.keys(record).forEach(date => activeDates.add(date));
                });
                // ä»è½¬ç›˜è®°å½•æ”¶é›†æ—¥æœŸ (è§£ææ—¶é—´æˆ³)
                Object.keys(wheelHistory).forEach(key => {
                    if (key.startsWith(`${activeChild}-`)) {
                        const parts = key.split('-');
                        const timestamp = parseInt(parts[parts.length - 1]);
                        if (!isNaN(timestamp)) {
                            // ç»Ÿä¸€è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼
                            const dateStr = new Date(timestamp).toLocaleDateString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g, '-');
                            activeDates.add(dateStr);
                        }
                    }
                });

                // ç¬¬äºŒæ­¥ï¼šéå†æ¯ä¸€å¤©ï¼Œé‡æ–°è®¡ç®—å½“å¤©çš„æ€»æ”¶å…¥
                let maxDailyIncome = 0;
                const cBuffs = activeBuffs[activeChild] || {}; // è·å–æŠ•èµ„å¡çŠ¶æ€

                activeDates.forEach(date => {
                    let dailyTotal = 0;

                    // A. è®¡ç®—è¯¥æ—¥ä»»åŠ¡æ”¶å…¥ (å«æŠ•èµ„å¡ç¿»å€é€»è¾‘)
                    const cTasks = tasks[activeChild] || [];
                    cTasks.forEach(task => {
                        const record = cCheckins[task.id] || {};
                        if (record[date]) { // å¦‚æœè¿™ä¸€å¤©å®Œæˆäº†è¯¥ä»»åŠ¡
                            let multiplier = 1;
                            // æ ¸å¿ƒä¿®æ­£ï¼šæ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æŠ•èµ„å¡æœ‰æ•ˆæœŸå†…
                            if (cBuffs.investMultiplier > 1 && cBuffs.investExpire && date <= cBuffs.investExpire) {
                                multiplier = cBuffs.investMultiplier;
                            }
                            dailyTotal += task.reward * multiplier;
                        }
                    });

                    // B. è®¡ç®—è¯¥æ—¥è½¬ç›˜/äº‹ä»¶æ”¶å…¥
                    Object.keys(wheelHistory).forEach(key => {
                        if (key.startsWith(`${activeChild}-`)) {
                            const parts = key.split('-');
                            const timestamp = parseInt(parts[parts.length - 1]);
                            if (!isNaN(timestamp)) {
                                const keyDate = new Date(timestamp).toLocaleDateString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g, '-');
                                if (keyDate === date) {
                                    dailyTotal += wheelHistory[key];
                                }
                            }
                        }
                    });

                    // æ›´æ–°å†å²æœ€å¤§å•æ—¥æ”¶å…¥
                    if (dailyTotal > maxDailyIncome) maxDailyIncome = dailyTotal;
                });

                // ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æˆå°±
                if (maxDailyIncome >= 100 && !currentAchievements['overnight_rich']) tryUnlock('overnight_rich');
				
                // æ¶ˆè´¹ç±»æˆå°±ï¼šæŒ¥é‡‘å¦‚åœŸåŠæ‹“å±•
				// ã€ä¿®æ­£ä¸æ‹“å±•ã€‘å…¨æ–¹ä½åˆ†ææ¶ˆè´¹è¡Œä¸º
				let totalSpent = 0;
				let spendCount = 0;
				let maxSingleSpend = 0;
				
				// ğŸŸ¢ ä¿®æ”¹åï¼šä½¿ç”¨ history å˜é‡ï¼ˆç¡®ä¿è¯»å–åˆ°æœ€æ–°çš„è´­ä¹°è®°å½•ï¼‰
				Object.keys(history).forEach(key => {
					// ç­›é€‰å½“å‰å­©å­çš„è®°å½•ï¼Œä¸”é‡‘é¢å°äº0 (è¡¨ç¤ºæ¶ˆè´¹)
					if (key.startsWith(`${activeChild}-`) && history[key] < 0) {
						const amount = Math.abs(history[key]); // å–ç»å¯¹å€¼
						totalSpent += amount; // ç´¯è®¡æ€»é¢
						spendCount++; // ç´¯è®¡æ¬¡æ•°
						if (amount > maxSingleSpend) {
							maxSingleSpend = amount;// è®°å½•æœ€å¤§å•ç¬”æ¶ˆè´¹
						}
					}
				});

                // A. ç´¯è®¡é‡‘é¢ç±»
                if (totalSpent >= 500 && !currentAchievements['big_spender']) tryUnlock('big_spender');
                if (totalSpent >= 2000 && !currentAchievements['money_bags']) tryUnlock('money_bags');
                if (totalSpent >= 5000 && !currentAchievements['whale_player']) tryUnlock('whale_player'); // æ–°å¢
                if (totalSpent >= 10000 && !currentAchievements['market_owner']) tryUnlock('market_owner'); // æ–°å¢

                // B. æ¶ˆè´¹æ¬¡æ•°ç±»
                if (spendCount >= 10 && !currentAchievements['shopaholic']) tryUnlock('shopaholic');
                if (spendCount >= 50 && !currentAchievements['hand_chopper']) tryUnlock('hand_chopper'); // æ–°å¢
                if (spendCount >= 100 && !currentAchievements['cart_clearer']) tryUnlock('cart_clearer'); // æ–°å¢

                // C. å•ç¬”é‡‘é¢ç±»
                if (maxSingleSpend >= 100 && !currentAchievements['high_roller']) tryUnlock('high_roller');
                if (maxSingleSpend >= 300 && !currentAchievements['diamond_hands']) tryUnlock('diamond_hands'); // æ–°å¢
                if (maxSingleSpend >= 800 && !currentAchievements['bankruptcy']) tryUnlock('bankruptcy'); // æ–°å¢

                if (triggerType === 'lucky_spin') tryUnlock('lucky_star');
				
				// æŠ•èµ„è¾¾äºº (investment_guru): ç»Ÿè®¡é¢å¤–æ”¶ç›Š
				let extraInvestIncome = 0;
				Object.keys(history).forEach(key => {
					if (key.startsWith(`${activeChild}-TASK-`)) {
						const parts = key.split('-');
						const taskId = parts[2];
						const task = myTasks.find(t => t.id === taskId);
						const amount = history[key];
						// å¦‚æœå®é™…è·å¾—é‡‘é¢ > åŸºç¡€å¥–åŠ±ï¼Œè¯´æ˜åƒåˆ°äº†æŠ•èµ„å¡å€ç‡
						if (task && amount > task.reward) {
							extraInvestIncome += (amount - task.reward);
						}
					}
				});
				if (extraInvestIncome >= 500) tryUnlock('investment_guru');

                // ==================== 4. æ¢ç´¢ç±» ====================
                if (triggerType === 'open_settings') tryUnlock('curious');
                // å‹çº¿å¤§å¸ˆåªæœ‰åœ¨æ‰“å¡è§¦å‘ï¼Œä¸”æ»¡è¶³å‹çº¿æ¡ä»¶ï¼Œä¸”ç¡®å®è§¦å‘äº†è½¬ç›˜æ—¶æ‰è§£é”
				if (triggerType === 'checkin' && context.isDeadlineClose) tryUnlock('deadline_master');
				
                // ä¸»é¢˜æ”¶è—å®¶ï¼šå¿…é¡»å‡‘é½æ‰€æœ‰ä¸»é¢˜é¢œè‰²æ‰å‘æ”¾
				if (triggerType === 'theme') {
					// è·å–æœ€æ–°çš„ç»Ÿè®¡æ•°æ®ä¸­çš„å·²ç”¨ä¸»é¢˜åˆ—è¡¨
					const currentStats = extraData.stats?.[activeChild] || stats[activeChild] || {};
					const usedThemes = currentStats.usedThemes || [];
					// åªæœ‰ä½“éªŒè¿‡çš„ä¸»é¢˜æ•°é‡è¾¾åˆ°æ€»ä¸»é¢˜æ•°ï¼ˆCOLOR_PALETTESçš„é”®å€¼æ•°é‡ï¼‰æ—¶ï¼Œæ‰è§£é”æˆå°±
					if (usedThemes.length >= Object.keys(COLOR_PALETTES).length) {
						tryUnlock('collector');
					}
				}

				// åŒå­æ˜Ÿ (gemini): ä¸¤äººåŒæ—¥è§£é”åŒä¸ªé«˜çº§æˆå°±
				// éå†æœ¬æ¬¡æ–°è§£é”çš„æˆå°±
				newUnlocked.forEach(badgeId => {
					const badge = BADGES.find(b => b.id === badgeId);
					if (badge && (badge.rarity === 'epic' || badge.rarity === 'legendary')) {
						// æ£€æŸ¥å…¶ä»–å®¶åº­æˆå‘˜
						profiles.forEach(p => {
							if (p.name !== activeChild) {
								const otherAch = achievements[p.name] || {};
								// å¦‚æœå¯¹æ–¹ä¹Ÿåœ¨"ä»Šå¤©"è§£é”äº†è¿™ä¸ªæˆå°±
								if (otherAch[badgeId] === today) {
									tryUnlock('gemini');
								}
							}
						});
					}
				});
				
				// è€ƒå¤å­¦å®¶ (archaeologist): ç¬¬ä¸€å¤©æ‰“å¡
				if (globalDates?.start) {
					const startStr = globalDates.start; 
					let hasFirstDay = false;
					Object.values(childCheckins).forEach(rec => {
						if (rec[startStr]) hasFirstDay = true;
					});
					if (hasFirstDay) tryUnlock('archaeologist');
				}
				
				// é€‰æ‹©å›°éš¾ç—‡ (indecisive)
				if (triggerType === 'theme_close_no_change') tryUnlock('indecisive');

				// ==================== ã€æ–°å¢ã€‘å­¦ä¸šç›®æ ‡ç±» (Curriculum) ====================
                // æ£€æŸ¥å­¦ä¸šè¿›åº¦
                const childProgress = extraData.curriculumProgress?.[activeChild] || curriculumProgress?.[activeChild] || {};
                
                Object.values(CURRICULUM_CONFIG).forEach(subject => {
                    // è·å–å½“å‰ç§‘ç›®å·²å®Œæˆçš„æœ€é«˜å­¦æœŸç´¢å¼• (0-11)
                    // å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸º -1 (è¡¨ç¤ºæœªå¼€å§‹)
                    const completedIndex = childProgress[subject.id] !== undefined ? childProgress[subject.id] : -1;
                    
                    // éå†è¯¥ç§‘ç›®çš„æ‰€æœ‰å¾½ç« 
                    subject.badges.forEach((badgeId, index) => {
                        // å¦‚æœå½“å‰å®Œæˆè¿›åº¦ >= å¾½ç« å¯¹åº”çš„å­¦æœŸç´¢å¼•ï¼Œåˆ™è§£é”
                        if (completedIndex >= index) {
                            tryUnlock(badgeId);
                        }
                    });
                });

                // ==================== 5. è£è€€ç±» (Meta Badges) ====================
                // ã€ä¿®å¤3ã€‘æ­£ç¡®è®¡ç®—å¾½ç« æ€»æ•° (Object.keys)
                const currentIds = Object.keys(currentAchievements);
                const totalBadges = currentIds.length + newUnlocked.length;
                
                const allUnlockedIds = [...currentIds, ...newUnlocked];
                const countRarity = (rarity) => allUnlockedIds.filter(id => BADGES.find(b => b.id === id)?.rarity === rarity).length;
                
                if (totalBadges >= 5) tryUnlock('bronze_collector');
                if (countRarity('rare') >= 5) tryUnlock('silver_master');
                if (countRarity('epic') >= 5) tryUnlock('golden_legend');
                
                const persevBadges = BADGES.filter(b => b.category === 'æ¯…åŠ›').map(b => b.id);
                const hasAllPersev = persevBadges.length > 0 && persevBadges.every(id => allUnlockedIds.includes(id));
                if (hasAllPersev) tryUnlock('perseverance_incarnate');

                const masteryBadges = BADGES.filter(b => b.category === 'ç²¾é€š').map(b => b.id);
                const hasAllMastery = masteryBadges.length > 0 && masteryBadges.every(id => allUnlockedIds.includes(id));
                if (hasAllMastery) tryUnlock('grandmaster');

				// ==================== 6. çºªå…ƒä¸ç­‰çº§ç±» (æ–°å¢) ====================
				// è·å–å½“å‰ç­‰çº§ä¿¡æ¯ (ä¾èµ–å¤–éƒ¨ currentXP)
				// æ³¨æ„ï¼šè™½ç„¶ currentXP åœ¨æœ¬æ¬¡æ¸²æŸ“å‘¨æœŸå¯èƒ½å°šæœªæ›´æ–°ï¼Œä½†é…åˆä¸‹æ–¹çš„ useEffect è¡¥æ•‘æœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿è§¦å‘
				const curLevelInfo = getLevelInfo(currentXP); 
				if (curLevelInfo.era === 'å”Â·ç™»ç§‘ä¹‹è·¯') tryUnlock('era_pioneer');

                // ==================== æ‰§è¡Œæ›´æ–° ====================
                if (newUnlocked.length > 0) {
                    // ã€ä¿®å¤4ã€‘ä¿å­˜æ—¶ï¼Œå°†æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼ { id: date }
                    const newBadgesObj = {};
                    newUnlocked.forEach(id => {
                        newBadgesObj[id] = today;
                    });

                    setAchievements(prev => ({
                        ...prev,
                        [activeChild]: {
                            ...(prev[activeChild] || {}),
                            ...newBadgesObj
                        }
                    }));
                    
                    const newMilestones = newUnlocked.map(badgeId => {
                        const b = BADGES.find(i => i.id === badgeId);
                        return {
                            id: `achieve-${badgeId}-${Date.now()}`,
                            type: 'achievement',
                            date: today,
                            timestamp: Date.now(),
                            member: activeChild,
                            title: `è§£é”æˆå°±ï¼š${b.name}`,
                            description: b.desc,
                            icon: 'ğŸ†'
                        };
                    });
                    setMilestones(prev => [...prev, ...newMilestones]);

                    setUnlockQueue(prev => [...prev, ...queue]);
                    
                    confetti({
                        particleCount: 200,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: ['#FFD700', '#FFA500']
                    });
                }
            };
			
			//å¤§äº‹çºªæ•°æ®æ ¸å¯¹ä¸è¡¥å…¨åŠŸèƒ½
			const handleSyncMilestones = () => {
				let addedCount = 0;
				const newMilestones = [...milestones];
				const existingIds = new Set(milestones.map(m => m.id));

				// 1. ä»ç»éªŒæ˜ç»† (xpHistory) ä¸­æ ¸å¯¹
				Object.keys(xpHistory).forEach(key => {
					// æ ¼å¼: ChildName-EVENT-ID-Timestamp æˆ– ChildName-ACHIEVEMENT-ID-Timestamp
					const parts = key.split('-');
					if (parts.length >= 3) {
						const type = parts[1]; // EVENT æˆ– ACHIEVEMENT
						const id = parts[2];
						const timestamp = parseInt(parts[parts.length - 1]);
						const member = parts[0];
						const date = new Date(timestamp).toISOString().split('T')[0];

						if (type === 'EVENT') {
							const milestoneId = `event-${id}-${timestamp}`;
							if (!existingIds.has(milestoneId)) {
								const event = RANDOM_EVENTS.find(e => e.id === id);
								newMilestones.push({
									id: milestoneId,
									type: 'event',
									date: date,
									timestamp: timestamp,
									member: member,
									title: `å¥‡é‡ï¼š${event ? event.title : 'æœªçŸ¥äº‹ä»¶'}`,
									description: `è·å¾— ${xpHistory[key]} XP`,
									icon: 'âœ¨'
								});
								existingIds.add(milestoneId);
								addedCount++;
							}
						} else if (type === 'ACHIEVEMENT') {
							const milestoneId = `achievement-${id}-${timestamp}`;
							if (!existingIds.has(milestoneId)) {
								const badge = ALL_ACHIEVEMENTS.find(a => a.id === id);
								newMilestones.push({
									id: milestoneId,
									type: 'achievement',
									date: date,
									timestamp: timestamp,
									member: member,
									title: `è§£é”æˆå°±ï¼š${badge ? badge.name : 'æœªçŸ¥æˆå°±'}`,
									description: badge ? badge.desc : 'å†å²æˆå°±è®°å½•',
									icon: 'ğŸ†'
								});
								existingIds.add(milestoneId);
								addedCount++;
							}
						}
					}
				});

				// 2. ä»é‡‘å…ƒå®æ˜ç»† (wheelHistory) ä¸­æ ¸å¯¹ (é’ˆå¯¹éšæœºäº‹ä»¶å¥–åŠ±å…ƒå®çš„æƒ…å†µ)
				Object.keys(wheelHistory).forEach(key => {
					const parts = key.split('-');
					if (parts.length >= 3 && parts[1] === 'EVENT') {
						const id = parts[2];
						const timestamp = parseInt(parts[parts.length - 1]);
						const milestoneId = `event-${id}-${timestamp}`;
						if (!existingIds.has(milestoneId)) {
							const event = RANDOM_EVENTS.find(e => e.id === id);
							newMilestones.push({
								id: milestoneId,
								type: 'event',
								date: new Date(timestamp).toISOString().split('T')[0],
								timestamp: timestamp,
								member: parts[0],
								title: `å¥‡é‡ï¼š${event ? event.title : 'æœªçŸ¥äº‹ä»¶'}`,
								description: `è·å¾— ${wheelHistory[key]} å…ƒå®`,
								icon: 'âœ¨'
							});
							existingIds.add(milestoneId);
							addedCount++;
						}
					}
				});

				if (addedCount > 0) {
					setMilestones(newMilestones.sort((a, b) => b.timestamp - a.timestamp));
					alert(`âœ… æ ¸å¯¹å®Œæˆï¼\n\næˆåŠŸä»å†å²æ˜ç»†ä¸­æ‰¾å›å¹¶è¡¥å…¨äº† ${addedCount} æ¡å¤§äº‹çºªè®°å½•ã€‚`);
				} else {
					alert(`â„¹ï¸ æ ¸å¯¹å®Œæˆï¼\n\nå¤§äº‹çºªè®°å½•ä¸æ˜ç»†æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€è°ƒæ•´ã€‚`);
				}
			};
			
			// --- æ–°å¢ï¼šä¿®å¤èƒŒåŒ…åŠŸèƒ½ (ä»è´¦å•æ‰¾å›ä¸¢å¤±å•†å“) ---
            const handleFixInventory = () => {
                const history = wheelHistory;
                const currentInv = inventory[activeChild] || {};
                const boughtCounts = {};

                // 1. æ‰«ææ‰€æœ‰è´­ä¹°è®°å½•ï¼Œç»Ÿè®¡åº”æœ‰æ€»æ•°
                Object.keys(history).forEach(key => {
                    if (key.startsWith(`${activeChild}-SHOP-`)) {
                        const itemId = key.split('-')[2];
                        boughtCounts[itemId] = (boughtCounts[itemId] || 0) + 1;
                    }
                });

                // 2. å¯¹æ¯”èƒŒåŒ…ï¼Œæ‰¾å‡ºæ˜æ˜¾ç¼ºå¤±çš„ (èƒŒåŒ…æ•°é‡ä¸º0ï¼Œä½†æœ‰è´­ä¹°è®°å½•çš„)
                // æ³¨æ„ï¼šè¿™é‡Œé‡‡å–ä¿å®ˆç­–ç•¥ï¼Œåªæ¢å¤èƒŒåŒ…é‡Œå®Œå…¨æ²¡æœ‰çš„ã€‚å¦‚æœèƒŒåŒ…é‡Œæœ‰1ä¸ªä½†ä¹°è¿‡5ä¸ªï¼Œå¯èƒ½æ˜¯ç”¨äº†ï¼Œæš‚ä¸è‡ªåŠ¨æ¢å¤ä»¥å…åˆ·ç‰©å“ã€‚
                let updates = {};
                let restoreMsg = [];
                
                Object.keys(boughtCounts).forEach(itemId => {
                    const currentCount = currentInv[itemId] || 0;
                    const boughtCount = boughtCounts[itemId];
                    
                    // é€»è¾‘ï¼šå¦‚æœæˆ‘æœ‰è´­ä¹°è®°å½•ï¼Œä½†èƒŒåŒ…é‡Œæ˜¯0ï¼Œæå¤§å¯èƒ½æ˜¯å› ä¸ºBUGä¸¢å¤±äº†
                    // æ¢å¤æ•°é‡ = è´­ä¹°æ€»æ•° (å‡è®¾éƒ½æ²¡ç”¨è¿‡ï¼Œæˆ–è€…å®å¯å¤šç»™ä¹Ÿä¸èƒ½å°‘ç»™)
                    if (currentCount === 0 && boughtCount > 0) {
                         updates[itemId] = boughtCount;
                         const itemDef = SHOP_ITEMS.find(i => i.id === itemId);
                         restoreMsg.push(`${itemDef ? itemDef.name : itemId} x${boughtCount}`);
                    }
                });

                if (Object.keys(updates).length > 0) {
                    setInventory(prev => {
                        const currentAll = { ...prev };
                        const childInv = { ...(currentAll[activeChild] || {}) };
                        
                        Object.entries(updates).forEach(([id, count]) => {
                            childInv[id] = count;
                        });
                        
                        currentAll[activeChild] = childInv;
                        return currentAll;
                    });
                    alert(`ğŸ”§ ä¿®å¤æˆåŠŸï¼\n\nç³»ç»Ÿæ£€æµ‹åˆ°ä½ æœ‰è´­ä¹°è®°å½•ä½†èƒŒåŒ…ä¸ºç©ºï¼Œå·²è¡¥å‘ä»¥ä¸‹å•†å“ï¼š\n\n${restoreMsg.join('\n')}`);
                } else {
                    alert("âœ… èƒŒåŒ…æ£€æŸ¥å®Œæ¯•ã€‚\n\næœªå‘ç°æ˜æ˜¾çš„ä¸¢å¤±è®°å½• (ç³»ç»Ÿåªè¡¥å‘èƒŒåŒ…ä¸­æ•°é‡ä¸º0ä½†æœ‰è´­ä¹°è®°å½•çš„å•†å“)ã€‚\n\nå¦‚æœç¡®å®è¿˜æœ‰é—®é¢˜ï¼Œè¯·å°è¯•é‡æ–°è´­ä¹°ä¸€æ¬¡ä»¥æ¿€æ´»æ•°æ®ã€‚");
                }
            };
			
			// --- ã€æ–°å¢ã€‘å‹çº¿å¤§å¸ˆæˆå°±è‡ªåŠ¨è¡¥æ¼æœºåˆ¶ ---
			useEffect(() => {
				const checkRetroactiveDeadline = () => {
					const today = getLocalDateKey(0);
					
					// 1. æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²è§¦å‘è¿‡è½¬ç›˜ (é‡‘å¸è½¬ç›˜ æˆ– ç»éªŒè½¬ç›˜)
					const goldKey = `${activeChild}-${today}`;
					const xpKey = `${activeChild}-XP_WHEEL-${today}`;
					const isWheelTriggeredToday = wheelHistory[goldKey] || xpHistory[xpKey];
					
					// 2. æ£€æŸ¥æ˜¯å¦å·²æ‹¥æœ‰è¯¥æˆå°±
					const currentAch = achievements[activeChild] || {};
					const hasDeadlineMaster = currentAch['deadline_master'];
					
					// 3. è§¦å‘æ¡ä»¶ï¼šä»Šå¤©è§¦å‘äº†è½¬ç›˜ + è¿˜æ²¡æœ‰è¿™ä¸ªæˆå°±
					if (isWheelTriggeredToday && !hasDeadlineMaster) {
						// é˜²æ­¢åˆ·æ–°é¡µé¢é‡å¤å¼¹çª—ï¼Œä½¿ç”¨ sessionStorage æ ‡è®°æœ¬æ¬¡ä¼šè¯å·²æ£€æŸ¥
						const sessionKey = `checked_deadline_v2_${activeChild}_${today}`;
						if (sessionStorage.getItem(sessionKey)) return;
						
						// å»¶è¿Ÿ 1.5ç§’ æ‰§è¡Œï¼Œé¿å…å’Œé¡µé¢åŠ è½½å†²çª
						setTimeout(() => {
							// æ ‡è®°å·²æ£€æŸ¥
							sessionStorage.setItem(sessionKey, 'true');
							
							// å¼¹å‡ºè¯¢é—®æ¡† (å› ä¸ºæ— æ³•è·å–ç²¾ç¡®æ—¶é—´ï¼Œéœ€äººå·¥ç¡®è®¤)
							const confirmed = window.confirm(
								"ğŸ›¡ï¸ ã€æˆå°±è¡¥æ¼åŠ©æ‰‹ã€‘\n\næ£€æµ‹åˆ°å­©å­ä»Šæ—¥å·²å®Œæˆä»»åŠ¡å¹¶è§¦å‘å¤§è½¬ç›˜ï¼Œä½†æœªè·å¾—ã€Œå‹çº¿å¤§å¸ˆã€æˆå°±ã€‚\n\nç”±äºç³»ç»Ÿæœªèƒ½è®°å½•å†å²ç²¾ç¡®æ—¶é—´ï¼Œè¯·äººå·¥ç¡®è®¤ï¼š\nå­©å­æ˜¯å¦æ˜¯åœ¨æˆªæ­¢æ—¶é—´å‰ 5 åˆ†é’Ÿå†…å®Œæˆçš„ï¼Ÿ\n\nå¦‚æœæ˜¯ (å—Bugå½±å“æœªè§¦å‘)ï¼Œè¯·ç‚¹å‡»ã€ç¡®å®šã€‘ç«‹å³è¡¥å‘ã€‚"
							);
							
							if (confirmed) {
								// è°ƒç”¨æˆå°±æ£€æŸ¥å‡½æ•°ï¼Œå¼ºåˆ¶ä¼ å…¥ isDeadlineClose=true
								// æ³¨æ„ï¼šæ ¹æ®ä¹‹å‰çš„ä¿®å¤ï¼Œè¿™ä¸ªå‚æ•°æ˜¯åœ¨ç¬¬äºŒä¸ªå‚æ•° context ä¸­
								checkAchievements('checkin', { 
									isWheelTriggered: true, 
									isDeadlineClose: true // æ ¸å¿ƒï¼šå‘Šè¯‰ç³»ç»Ÿæ»¡è¶³æ—¶é—´æ¡ä»¶
								}, {});
								
								alert("âœ… å·²æˆåŠŸè¡¥å‘ã€Œå‹çº¿å¤§å¸ˆã€æˆå°±ï¼");
							}
						}, 1500);
					}
				};
				
				checkRetroactiveDeadline();
			// ä¾èµ–é¡¹ï¼šå½“å†å²è®°å½•ã€æˆå°±æˆ–å½“å‰å­©å­å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥
			}, [wheelHistory, xpHistory, achievements, activeChild]);
			
            useEffect(() => {
                const profile = profiles.find(p => p.name === activeChild);
                if (profile) {
                    setStats(prev => {
                        const childStats = prev[activeChild] || {};
                        const usedThemes = childStats.usedThemes || [];
                      if (!usedThemes.includes(profile.theme)) {
                            return { ...prev, [activeChild]: { ...childStats, usedThemes: [...usedThemes, profile.theme] } };
                        }
                        return prev;
                    });
                    setTimeout(() => checkAchievements('theme'), 500);
					
					// ã€æ–°å¢ã€‘å»¶è¿Ÿ1ç§’åå¼ºåˆ¶æ£€æŸ¥ä¸€æ¬¡æ‰“å¡ç±»æˆå°±ï¼Œä»¥è§¦å‘â€œç¿»è¯‘å¤§å¸ˆâ€ç­‰æ¼æ‰çš„å¥–åŠ±
					setTimeout(() => checkAchievements('checkin'), 1000);
                }
            }, [activeChild, profiles]);

			// ã€æ–°å¢ã€‘æµ‹è¯•ç»“ç®—åŠŸèƒ½çš„å‡½æ•°
            // ã€ä¿®æ­£ç‰ˆã€‘æµ‹è¯•ç»“ç®—åŠŸèƒ½çš„å‡½æ•° (åŸºäºçœŸå®æ•°æ®è®¡ç®—)
            const handleTestSettlement = () => {
                // 1. è·å–å½“å‰æ•°æ®
                const childTasks = tasks[activeChild] || [];
                const childCheckins = checkins[activeChild] || {};
                const todayKey = getLocalDateKey(0);

                // 2. åˆ†ç±»ç»Ÿè®¡
                const coreTasks = childTasks.filter(t => t.type === 'core');
                const dailyTasks = childTasks.filter(t => t.type !== 'core');

                // 3. è®¡ç®—è¿›åº¦å·¥å…·å‡½æ•°
                const calc = (list) => {
                    if (!list || list.length === 0) return { percent: 0 };
                    // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰æ‰“å¡è®°å½•
                    const completed = list.filter(t => childCheckins[t.id]?.[todayKey]).length;
                    return { percent: Math.round((completed / list.length) * 100) };
                };

                const coreStats = calc(coreTasks);
                const dailyStats = calc(dailyTasks);

                // 4. åˆ¤å®šç»“æœ
                let type = 'fail';
                const coreThreshold = weekendSettings.coreThreshold || 80;
                const dailyThreshold = weekendSettings.dailyThreshold || 50;

                const coreMet = coreStats.percent >= coreThreshold;
                const dailyMet = dailyStats.percent >= dailyThreshold;

                // å®Œç¾æ¡ä»¶ï¼šä¸¤é¡¹éƒ½100%ï¼Œä¸”å¿…é¡»æœ‰ä»»åŠ¡ï¼ˆé˜²æ­¢0ä»»åŠ¡åˆ·å®Œç¾ï¼‰
                if (coreStats.percent === 100 && dailyStats.percent === 100 && coreTasks.length > 0) {
                    type = 'perfect';
                } else if (coreMet && dailyMet) {
                    type = 'pass';
                }

                // 5. å¼¹å‡ºç»“æœ
                setSettlementState({
                    type: type,
                    coreStats,
                    dailyStats,
                    reward: type === 'perfect' ? 100 : (type === 'pass' ? 60 : 0)
                });
                setShowSettings(false); // å…³é—­è®¾ç½®å¼¹çª—
            };

            // ä¿®æ”¹ï¼šéœ€è¦å¯†ç éªŒè¯æ‰èƒ½æ‰“å¼€è®¾ç½®
            const handleOpenSettings = () => {
                if (settingsPassword) {
                    const input = prompt("è¯·è¾“å…¥å®¶é•¿å¯†ç ï¼š");
                    if (input !== settingsPassword) {
                        alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•è¿›å…¥è®¾ç½®é¡µé¢ã€‚");
                        return;
                    }
                }
                setShowSettings(true);
                checkAchievements('settings'); 
            };
            
            const scrollToToday = () => {
                if (todayRef.current && scrollContainerRef.current) {
                    const container = scrollContainerRef.current;
                    const element = todayRef.current;
                    const offsetLeft = element.offsetLeft;
                    const containerWidth = container.clientWidth;
                    const elementWidth = element.clientWidth;
                    container.scrollTo({ left: offsetLeft - containerWidth / 2 + elementWidth / 2, behavior: 'smooth' });
                }
            };

            const todayFragmentStats = useMemo(() => {
                const today = getLocalDateKey(0);
                const childTasks = tasks[activeChild] || [];
                const activeTasks = childTasks.filter(t => !t.startDate || today >= t.startDate);
                let completedCount = 0;
                activeTasks.forEach(t => { if (checkins[activeChild]?.[t.id]?.[today]) completedCount++; });
                let requiredCount = 0;
                if (wheelSettings.thresholdType === 'percent') requiredCount = Math.ceil(activeTasks.length * (wheelSettings.thresholdValue / 100));
                else requiredCount = wheelSettings.thresholdValue;
                if (requiredCount < 1) requiredCount = 1;
                return { completed: completedCount, required: requiredCount };
            }, [tasks, activeChild, checkins, wheelSettings]);

            const checkWheelTrigger = (currentCheckins, child) => {
				const today = getLocalDateKey(0);
				const now = new Date();
				if (now.getHours() >= wheelSettings.deadlineHour) return; 

				// æ£€æŸ¥è¿™ä¸¤ç§å†å²è®°å½•ï¼Œå¦‚æœä»Šå¤©å·²ç»è½¬è¿‡ä»»æ„ä¸€ç§ï¼Œå°±ä¸å†è‡ªåŠ¨è§¦å‘ï¼ˆæˆ–è€…æ˜¯æ ¹æ®éœ€æ±‚ï¼Œä¸¤è€…äº’æ–¥ï¼‰
				// å‡è®¾é€»è¾‘æ˜¯ï¼šæ¯å¤©è§¦å‘ä¸€æ¬¡å¤§æ»¡è´¯ï¼Œå¯ä»¥é€‰æ‹©é‡‘å¸æˆ–XP
				const goldKey = `${child}-${today}`;
				const xpKey = `${child}-XP_WHEEL-${today}`;

				if (wheelHistory[goldKey] || xpHistory[xpKey]) return; // ä»Šå¤©å·²ç»æ‹¿è¿‡å¤§æ»¡è´¯å¥–åŠ±äº†

				const childTasks = tasks[child] || [];
				const activeTasks = childTasks.filter(t => !t.startDate || today >= t.startDate);
				let completedCount = 0;
				activeTasks.forEach(t => { if (currentCheckins[child]?.[t.id]?.[today]) completedCount++; });

				let requiredCount = wheelSettings.thresholdType === 'percent' ? Math.ceil(activeTasks.length * (wheelSettings.thresholdValue / 100)) : wheelSettings.thresholdValue;
				if (requiredCount < 1) requiredCount = 1;

				if (completedCount >= requiredCount) {
					setTimeout(() => {
						// è§¦å‘é€‰æ‹©å¼¹çª—
						setShowWheelChoice(true);
						confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 } });
					}, 500);
				}
			};
            
            // --- ä¼˜åŒ–åçš„éšæœºäº‹ä»¶è§¦å‘é€»è¾‘ ---
            const checkRandomEventTrigger = (childName, isFuture, currentCheckins) => {
                const today = getLocalDateKey(0);
                const dailyKey = `${childName}-${today}`;
                const dailyCount = dailyRandomCounts[dailyKey] || 0;

                // 1. æ¯æ—¥ä¸Šé™æ£€æŸ¥ (å»ºè®®ä» 8 æé«˜åˆ° 20ï¼Œæˆ–è€…æš‚æ—¶æ³¨é‡Šæ‰)
                if (dailyCount >= 20) {
                    console.log("ä»Šæ—¥éšæœºäº‹ä»¶æ¬¡æ•°å·²è¾¾ä¸Šé™");
                    return;
                }

                // 2. æ¦‚ç‡åˆ¤å®šä¼˜åŒ–
                // åŸä»£ç æ˜¯ 0.4ï¼Œå»ºè®®æ”¹ä¸º 0.8 (80%) æˆ–è€… 1.0 (100% æµ‹è¯•ç”¨)
                let probability = 0.8; 
                
                if (!isFuture) {
                    // é€»è¾‘ä¼˜åŒ–ï¼šåªè¦ä»Šå¤©è§¦å‘å°‘äº 5 æ¬¡ï¼Œéƒ½ç»™é«˜æ¦‚ç‡
                    if (dailyCount < 5) {
                        const childTasks = tasks[childName] || [];
                        const activeTasks = childTasks.filter(t => !t.startDate || today >= t.startDate);
                        const totalActive = activeTasks.length;
                        
                        let completedCount = 0;
                        activeTasks.forEach(t => { if (currentCheckins[childName]?.[t.id]?.[today]) completedCount++; });
                        
                        const slotsAfterThis = totalActive - completedCount;

                        // å‰©ä½™ä»»åŠ¡è¶Šå°‘ï¼Œæ¦‚ç‡è¶Šé«˜
                        if (slotsAfterThis === 0) {
                            probability = 1.0; // æœ€åä¸€é¡¹ä»»åŠ¡å¿…å‡º
                        } else if (slotsAfterThis <= 2) {
                            probability = 0.9; // å¿«åšå®Œæ—¶ 90%
                        } else {
                            probability = 0.7; // å¹³æ—¶ 70%
                        }
                    } else {
                        // è¶…è¿‡5æ¬¡åï¼Œæ¦‚ç‡é™ä½ï¼Œä½†ä¸è¦å¤ªä½
                        probability = 0.5; 
                    }
                }

                console.log(`å°è¯•è§¦å‘éšæœºäº‹ä»¶: å½“å‰æ¦‚ç‡ ${probability}, ä»Šæ—¥å·²è§¦å‘ ${dailyCount} æ¬¡`);

                const isLucky = Math.random() < probability;
                if (!isLucky) {
                    console.log("è¿æ°”ä¸ä½³ï¼Œæœªå‘½ä¸­æ¦‚ç‡");
                    return;
                }

                const levelInfo = getLevelInfo(currentXP);
                const currentEra = levelInfo.era;

                const childHistory = randomEventHistory[childName] || [];
                
                // 3. ç­›é€‰å¯ç”¨äº‹ä»¶
                const availableEvents = RANDOM_EVENTS.filter(event => {
                    // çºªå…ƒå¿…é¡»åŒ¹é…
                    if (event.era !== currentEra) return false;
                    
                    // ç­‰çº§å¿…é¡»è¾¾æ ‡
                    const minLevel = LEVELS.find(l => l.name === event.minLevelName);
                    // å¦‚æœæ‰¾ä¸åˆ°ç­‰çº§å®šä¹‰ï¼Œæˆ–è€…å½“å‰ç­‰çº§å°äºéœ€æ±‚ç­‰çº§ï¼Œåˆ™ä¸è§¦å‘
                    if (!minLevel || levelInfo.level < minLevel.level) return false;
                    
                    // å”¯ä¸€äº‹ä»¶ä¸èƒ½é‡å¤è§¦å‘
                    if (event.type === 'unique' && childHistory.includes(event.id)) return false;
                    
                    return true;
                });

                console.log(`å½“å‰çºªå…ƒ: ${currentEra}, å¯ç”¨äº‹ä»¶æ•°: ${availableEvents.length}`);

                if (availableEvents.length === 0) {
                    console.log("æ²¡æœ‰å¯ç”¨çš„éšæœºäº‹ä»¶ï¼ˆå¯èƒ½æ˜¯ç­‰çº§ä¸è¶³æˆ–äº‹ä»¶å·²è€—å°½ï¼‰");
                    // ã€å¯é€‰ã€‘è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªä¿åº•äº‹ä»¶ï¼Œé˜²æ­¢ç©å®¶å¤±æœ›
                    return;
                }

                const selectedEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];

                setTimeout(() => {
                    setCurrentRandomEvent(selectedEvent);
                    setShowRandomEvent(true);
                    setDailyRandomCounts(prev => ({...prev, [dailyKey]: dailyCount + 1}));
                    if (selectedEvent.type === 'unique') {
                        setRandomEventHistory(prev => ({
                            ...prev, 
                            [childName]: [...(prev[childName] || []), selectedEvent.id]
                        }));
                    }
                }, 800); 
            };
			
            const handleClaimRandomReward = () => {
                if (!currentRandomEvent) return;
                
                if (currentRandomEvent.rewardType === 'gold') {
                    const key = `${activeChild}-EVENT-${currentRandomEvent.id}-${Date.now()}`;
                    setWheelHistory(prev => ({ ...prev, [key]: currentRandomEvent.rewardValue }));
                } else {
                    const key = `${activeChild}-EVENT-${currentRandomEvent.id}-${Date.now()}`;
                    setXpHistory(prev => ({ ...prev, [key]: currentRandomEvent.rewardValue }));
                }
                
                // è®°å½•å¤§äº‹çºªï¼šéšæœºäº‹ä»¶
                const todayDate = getLocalDateKey(0);
                setMilestones(prev => [...prev, {
                    id: `event-${currentRandomEvent.id}-${Date.now()}`,
                    type: 'event',
                    date: todayDate,
                    timestamp: Date.now(),
                    member: activeChild,
                    title: `å¥‡é‡ï¼š${currentRandomEvent.title}`,
                    description: `è·å¾—${currentRandomEvent.rewardValue}${currentRandomEvent.rewardType === 'gold' ? 'å…ƒå®' : 'XP'}`,
                    reward: currentRandomEvent.rewardValue,
                    rewardType: currentRandomEvent.rewardType,
                    icon: 'âœ¨'
                }]);

                setShowRandomEvent(false);
                setCurrentRandomEvent(null);
                confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 }, colors: ['#a855f7', '#fbbf24'] });
            };

            const handleCellClick = (taskId, date) => {
                const task = tasks[activeChild].find(t => t.id === taskId);
                if (task.startDate && date < task.startDate) return; 
                if (task.deadline && date > task.deadline) return;
                const childData = checkins[activeChild] || {};
                const taskData = childData[taskId] || {};
                const duration = taskData[date];
                setEditingEntry({ taskId, date, duration: duration || '', isNew: duration === undefined });
            };

            // saveCheckin function updated to include buffs and shop logic
            const saveCheckin = (duration) => {
				// --- ã€æ–°å¢ã€‘å…¨èƒ½æ•°æ®ç»Ÿè®¡æ›´æ–°å‡½æ•° ---
								
                if (!editingEntry) return;
                if (!duration || isNaN(duration) || parseInt(duration) <= 0) return; 
                
                const newCheckins = { ...checkins };
                const childData = newCheckins[activeChild] || {};
                const taskData = childData[editingEntry.taskId] || {}; 
                
                // è®¾ç½®æ‰“å¡æ—¶é—´ï¼ˆæ”¯æŒè¡¥ç­¾ï¼‰
                newCheckins[activeChild] = { ...childData, [editingEntry.taskId]: { ...taskData, [editingEntry.date]: parseInt(duration) } };
                setCheckins(newCheckins);
                setEditingEntry(null);

				// ã€æ–°å¢ï¼šåŸ‹ç‚¹è®°å½•æ‰“å¡ã€‘
                const currentTask = (tasks[activeChild] || []).find(t => t.id === editingEntry.taskId);
                if (currentTask) {
                    // 1. è®¡ç®—å½“å‰æ—¶åˆ»çš„çœŸå®å€ç‡
                    let multiplier = 1;
                    const childBuffs = activeBuffs[activeChild] || {};
                    // åˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆçš„æŠ•èµ„å¡ï¼ˆåªè¦æ²¡è¿‡æœŸï¼Œä¸”å€ç‡>1ï¼‰
                    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ getLocalDateKey(0) ç¡®ä¿è·Ÿä»Šå¤©çš„æ—¥æœŸåšæ¯”è¾ƒ
                    const today = getLocalDateKey(0);
                    // åªè¦å½“å‰æ—¥æœŸåœ¨æœ‰æ•ˆæœŸå†…ï¼Œå°±åº”ç”¨å€ç‡ã€‚
                    // ä¿®å¤é€»è¾‘ï¼šä¸å†ä¾èµ– editingEntry.dateï¼Œè€Œæ˜¯ä¾èµ–â€œæ“ä½œå‘ç”Ÿæ—¶â€çš„ buff çŠ¶æ€ã€‚
                    // ä½†è€ƒè™‘åˆ°è¡¥ç­¾å¡ï¼ˆitem_fireï¼‰ï¼Œå¦‚æœè¡¥ç­¾çš„æ˜¯è¿‡å»ï¼Œåº”è¯¥äº«å—â€œé‚£ä¸€å¤©çš„Buffâ€å—ï¼Ÿ
                    // é€šå¸¸é€»è¾‘æ˜¯ï¼šåªæœ‰Buffç”Ÿæ•ˆæœŸé—´è¿›è¡Œçš„æ“ä½œæ‰ç®—ã€‚
                    // ç®€å•èµ·è§ï¼Œåªè¦ç°åœ¨Buffæ²¡è¿‡æœŸï¼Œè¿™ç¬”æ‰“å¡å°±äº«å—åŠ æˆã€‚
                    if (childBuffs.investMultiplier > 1 && childBuffs.investExpire && today <= childBuffs.investExpire) {
                        multiplier = childBuffs.investMultiplier;
                    }

                    // 2. è®¡ç®—å›ºåŒ–å¥–åŠ±é‡‘é¢
                    const finalReward = currentTask.reward * multiplier;

                    // 3. å†™å…¥å†å²è´¦å• (å®ç°å¿«ç…§)
                    // Key æ ¼å¼: Child-TASK-TaskId-Date
                    const historyKey = `${activeChild}-TASK-${editingEntry.taskId}-${editingEntry.date}`;
                    setWheelHistory(prev => ({
                        ...prev,
                        [historyKey]: finalReward
                    }));

                    // 4. åŸ‹ç‚¹ç»Ÿè®¡ (ä¿æŒåŸæœ‰é€»è¾‘ï¼Œç¨ä½œå‚æ•°è°ƒæ•´)
                    updateStats(activeChild, 'checkin', 1, { taskName: currentTask.name });
                    
                    if (multiplier > 1) {
                        updateStats(activeChild, 'gold_earn', finalReward, { source: 'invest_bonus' });
                    } else {
                        updateStats(activeChild, 'gold_earn', finalReward, { source: 'task' });
                    }
                }

                // --- å¤„ç†åŒå€ç»éªŒBuff ---
                const childBuffs = activeBuffs[activeChild] || {};
                if (childBuffs.xpBoost > 0 && childBuffs.xpBoostCount > 0) {
                    const extraXP = 10 * (childBuffs.xpBoost - 1); // åŸºç¡€10XPï¼Œé¢å¤–åŠ æˆ
                    const key = `${activeChild}-BUFF_XP-${Date.now()}`;
                    setXpHistory(prev => ({ ...prev, [key]: extraXP }));
                    
                    setActiveBuffs(prev => ({
                        ...prev, 
                        [activeChild]: { 
                            ...childBuffs, 
                            xpBoostCount: childBuffs.xpBoostCount - 1,
                            xpBoost: childBuffs.xpBoostCount - 1 <= 0 ? 0 : childBuffs.xpBoost 
                        }
                    }));
                }

				const currentTasks = tasks[activeChild] || [];
                const task = currentTasks.find(t => t.id === editingEntry.taskId);
                if (!task) return; // æ‰¾ä¸åˆ°ä»»åŠ¡å°±é€€å‡º

                const today = getLocalDateKey(0);
                const now = new Date();
                
                // --- æ–°å¢å˜é‡ï¼šç”¨äºæš‚å­˜è®¡ç®—å‡ºçš„è¿ç»­å¤©æ•°ï¼Œä¼ ç»™ checkAchievements ---
				let currentEarlyStreak = 0; 

				if (editingEntry.date === today && now.getHours() < 9) {
					// 1. è·å–æ˜¨å¤©çš„æ—¥æœŸå­—ç¬¦ä¸²
					const yesterday = getLocalDateKey(-1);
					// 2. è·å–å½“å‰ä¿å­˜çš„çŠ¶æ€
					const childStats = stats[activeChild] || {};
					const lastDate = childStats.earlyBirdLastDate;
					const currentStreak = childStats.earlyBirdStreak || 0;

					// 3. è®¡ç®—æ–°çš„è¿ç»­å¤©æ•°
					if (lastDate === yesterday) {
						currentEarlyStreak = currentStreak + 1; // è¿ç»­äº†
					} else if (lastDate === today) {
						currentEarlyStreak = currentStreak;     // ä»Šå¤©å·²ç»è®°è¿‡äº†ï¼Œä¿æŒä¸å˜
					} else {
						currentEarlyStreak = 1;                 // ä¸­æ–­äº†ï¼Œé‡ç½®ä¸º1
					}

					setStats(prev => {
						const cStats = prev[activeChild] || {};
						return { 
							...prev, 
							[activeChild]: { 
								...cStats, 
								earlyBirdCount: (cStats.earlyBirdCount || 0) + 1,
								// --- æ–°å¢ï¼šä¿å­˜è¿ç»­è®°å½• ---
								earlyBirdStreak: currentEarlyStreak,
								earlyBirdLastDate: today
							} 
						};
					});
				}
				// --- æ–°å¢ï¼šå‘¨æœ«è¿ç»­æ‰“å¡è®¡ç®—é€»è¾‘ ---
				const dayOfWeek = now.getDay();
				const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // 0æ˜¯å‘¨æ—¥ï¼Œ6æ˜¯å‘¨å…­
				let currentWeekendStreak = 0;

				if (isWeekend && editingEntry.date === today) {
					const childStats = stats[activeChild] || {};
					const lastDateStr = childStats.lastWeekendDate;
					const recordedStreak = childStats.weekendStreak || 0;

					if (!lastDateStr) {
						// ç¬¬ä¸€æ¬¡å‘¨æœ«æ‰“å¡
						currentWeekendStreak = 1;
					} else {
						const lastDate = new Date(lastDateStr);
						const currDate = new Date(today);
						const diffTime = Math.abs(currDate - lastDate);
						const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

						if (diffDays < 5) {
							// é—´éš”å°äº5å¤©ï¼Œè¯´æ˜è¿˜åœ¨åŒä¸€ä¸ªå‘¨æœ«ï¼ˆä¾‹å¦‚æ˜¨å¤©å‘¨å…­æ‰“äº†ï¼Œä»Šå¤©å‘¨æ—¥åˆæ‰“ï¼‰ï¼Œè¿èƒœä¿æŒä¸å˜
							currentWeekendStreak = recordedStreak;
						} else if (diffDays >= 5 && diffDays <= 9) {
							// é—´éš”5-9å¤©ï¼Œè¯´æ˜æ˜¯ç›¸é‚»çš„ä¸¤ä¸ªå‘¨æœ«ï¼ˆä¾‹å¦‚ä¸Šå‘¨æ—¥åˆ°è¿™å‘¨å…­æ˜¯6å¤©ï¼‰ï¼Œè¿èƒœ+1
							currentWeekendStreak = recordedStreak + 1;
						} else {
							// é—´éš”å¤ªä¹…ï¼Œæ–­äº†ï¼Œé‡ç½®ä¸º1
							currentWeekendStreak = 1;
						}
					}

					// æ›´æ–°ç»Ÿè®¡æ•°æ®
					if (currentWeekendStreak !== (childStats.weekendStreak || 0) || today !== lastDateStr) {
						setStats(prev => ({
							...prev,
							[activeChild]: {
								...(prev[activeChild] || {}),
								weekendStreak: currentWeekendStreak,
								lastWeekendDate: today
							}
						}));
					}
				}
				
                let isWheelTriggered = false;
                if (editingEntry.date === today && now.getHours() < wheelSettings.deadlineHour) {
                    const historyKey = `${activeChild}-${today}`;
                    if (!wheelHistory[historyKey]) {
                        const activeTasks = (tasks[activeChild]||[]).filter(t => !t.startDate || today >= t.startDate);
                        let completedCount = 0;
                        activeTasks.forEach(t => { if (newCheckins[activeChild]?.[t.id]?.[today]) completedCount++; });
                        let requiredCount = wheelSettings.thresholdType === 'percent' ? Math.ceil(activeTasks.length * (wheelSettings.thresholdValue / 100)) : wheelSettings.thresholdValue;
                        if (requiredCount < 1) requiredCount = 1;
                        if (completedCount >= requiredCount) {
                            isWheelTriggered = true;
                        }
                    }
                }		

                // ä¼ å…¥æ–°çš„ checkins ç¡®ä¿æˆå°±åˆ¤æ–­å‡†ç¡®
                checkAchievements('checkin', { isWheelTriggered, currentEarlyStreak, currentWeekendStreak, isDeadlineClose }, { checkins: newCheckins });
                
                // æ£€æµ‹æ‰“å¡é‡Œç¨‹ç¢‘
                const totalCheckins = Object.values(newCheckins[activeChild] || {}).reduce((sum, taskRecord) => sum + Object.keys(taskRecord).length, 0);
                const milestoneCheckins = [10, 50, 100, 200];
                milestoneCheckins.forEach(count => {
                    const milestoneId = `milestone-checkin-${count}-${activeChild}`;
                    const alreadyRecorded = milestones.some(m => m.id === milestoneId);
                    if (!alreadyRecorded && totalCheckins >= count) {
                        setMilestones(prev => [...prev, {
                            id: milestoneId,
                            type: 'milestone',
                            date: today,
                            timestamp: Date.now(),
                            member: activeChild,
                            title: `æ‰“å¡é‡Œç¨‹ç¢‘ï¼š${count}æ¬¡`,
                            description: `ç´¯è®¡å®Œæˆ${count}æ¬¡ä»»åŠ¡æ‰“å¡`,
                            icon: 'ğŸ¯'
                        }]);
                    }
                });
                
                // æ£€æµ‹è´¢å¯Œé‡Œç¨‹ç¢‘
                const currentGold = calculateTotalGold(newCheckins, wheelHistory, activeChild);
                const milestoneGold = [500, 1000, 5000];
                milestoneGold.forEach(amount => {
                    const milestoneId = `milestone-gold-${amount}-${activeChild}`;
                    const alreadyRecorded = milestones.some(m => m.id === milestoneId);
                    if (!alreadyRecorded && currentGold >= amount) {
                        setMilestones(prev => [...prev, {
                            id: milestoneId,
                            type: 'milestone',
                            date: today,
                            timestamp: Date.now(),
                            member: activeChild,
                            title: `è´¢å¯Œé‡Œç¨‹ç¢‘ï¼š${amount}å…ƒå®`,
                            description: `ç´¯è®¡èµ„äº§è¾¾åˆ°${amount}å…ƒå®`,
                            icon: 'ğŸ’°'
                        }]);
                    }
                });

                const isFuture = editingEntry.date > today;
                const isToday = editingEntry.date === today;

				// --- æ–°å¢ï¼šå‹çº¿å¤§å¸ˆé€»è¾‘åˆ¤å®š ---
				// --- ã€æ–°å¢/ä¿®æ”¹ã€‘å‹çº¿å¤§å¸ˆåˆ¤å®šé€»è¾‘ (åŠ¨æ€è¯»å–è®¾ç½®) ---
                let isDeadlineClose = false;
                
                // å¿…é¡»æ»¡è¶³ï¼šæ˜¯ä»Šå¤© + è§¦å‘äº†è½¬ç›˜ + å½“å‰æ—¶é—´åœ¨æˆªæ­¢æ—¶é—´å‰
                if (isToday && isWheelTriggered) {
                    const deadline = new Date();
                    
                    // ã€å…³é”®ç‚¹ã€‘è¿™é‡Œç›´æ¥è¯»å– wheelSettings.deadlineHour
                    // æ— è®ºç”¨æˆ·è®¾ç½®æˆ 18:00 è¿˜æ˜¯ 21:00ï¼Œè¿™é‡Œéƒ½ä¼šå®æ—¶è·å–æœ€æ–°å€¼
                    deadline.setHours(wheelSettings.deadlineHour, 0, 0, 0);
                    
                    const nowTime = new Date();
                    // è®¡ç®—å·®å€¼ï¼ˆæ¯«ç§’ -> åˆ†é’Ÿï¼‰
                    const diffMins = (deadline - nowTime) / (1000 * 60);
                    
                    // åˆ¤å®šæ¡ä»¶ï¼šè·ç¦»æˆªæ­¢æ—¶é—´ [0, 5] åˆ†é’Ÿå†…
                    if (diffMins >= 0 && diffMins <= 5) {
                        isDeadlineClose = true;
                    }
                }

				// ã€ä¿®æ”¹ã€‘æ‰“å¡ç‰¹æ•ˆé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æ‹¥æœ‰çš‡å®¶ç¤¼ç‚®
                const hasRoyalSalute = stats[activeChild]?.premiumConfetti;
                
                if (hasRoyalSalute) {
                    fireRoyalSalute(); // è§¦å‘é«˜çº§ç‰¹æ•ˆ
                } else {
                    // æ™®é€šç‰¹æ•ˆ
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); 
                }
				
				// å¢åŠ  isNew åˆ¤æ–­ï¼Œé˜²æ­¢ä¿®æ”¹æ—§è®°å½•æ—¶é‡å¤è§¦å‘äº‹ä»¶
				if (editingEntry.isNew) {
					if (isToday) {
						if (isWheelTriggered) {
							checkWheelTrigger(newCheckins, activeChild);
						} else {
							checkRandomEventTrigger(activeChild, false, newCheckins);
						}
					} else if (isFuture) {
						checkRandomEventTrigger(activeChild, true, newCheckins);
					}
				}
				checkAchievements(activeChild, newCheckins, tasks[activeChild]);
            };

            const spinWheel = () => {
                if (wheelSpinning) return;
                setWheelSpinning(true);
                
                // 1. ç¡®å®šé…ç½® (ç”¨äºæ¸²æŸ“çš„å®Œæ•´é…ç½®ï¼Œç”¨äºè®¡ç®—è§’åº¦)
                const currentConfig = wheelType === 'xp' ? xpWheelConfig : wheelConfig;

                // 2. å¹¸è¿åŠ æŒç¬¦é€»è¾‘ (é€»è¾‘é…ç½®ï¼Œç”¨äºè®¡ç®—æ¦‚ç‡)
                const childBuffs = activeBuffs[activeChild] || {};
                let modifiedWheelConfig = currentConfig;
                // ä»…åœ¨é‡‘å…ƒå®è½¬ç›˜ä¸”æœ‰BUFFæ—¶ç”Ÿæ•ˆ
                if (wheelType === 'gold' && childBuffs.luckyBuff) {
                    const minReward = Math.min(...currentConfig.map(item => item.value));
                    modifiedWheelConfig = currentConfig.map(item => {
                        if (item.value === minReward) { return { ...item, weight: 0 }; }
                        return item;
                    });
                    setActiveBuffs(prev => ({...prev, [activeChild]: { ...(prev[activeChild] || {}), luckyBuff: false }}));
                }
                
                // 3. æŠ½å¥–ç®—æ³•
                const totalWeight = modifiedWheelConfig.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                let selectedItem = modifiedWheelConfig[0];
                for (let i = 0; i < modifiedWheelConfig.length; i++) {
                    if (random < modifiedWheelConfig[i].weight) { selectedItem = modifiedWheelConfig[i]; break; }
                    random -= modifiedWheelConfig[i].weight;
                }
                
                // 4. è§’åº¦è®¡ç®— ã€å…³é”®ä¿®å¤ã€‘
                // å¿…é¡»ä½¿ç”¨ currentConfig (æ¸²æŸ“ç”¨çš„é…ç½®) æ¥æŸ¥æ‰¾åŸå§‹ç´¢å¼•
                const originalIndex = currentConfig.findIndex(item => item.id === selectedItem.id);
                
                // è®¡ç®—æ¯ä¸ªæ‰‡åŒºçš„è§’åº¦
                const segmentAngle = 360 / currentConfig.length;
                // ç›®æ ‡è§’åº¦ï¼šæŒ‡å‘è¯¥æ‰‡åŒºçš„ä¸­å¿ƒ
                const targetBaseAngle = (originalIndex * segmentAngle) + (segmentAngle / 2);
                
                // æ·»åŠ éšæœºåç§» (åœ¨æ‰‡åŒºå®½åº¦çš„ 80% èŒƒå›´å†…æ³¢åŠ¨ï¼Œé¿å…æŒ‡åˆ°åˆ†å‰²çº¿ä¸Š)
                const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.8);
                
                // è®¡ç®—æœ€çŸ­æ—‹è½¬è·ç¦»ï¼šä¿è¯é¡ºæ—¶é’ˆæ—‹è½¬
                const currentRotationMod = pointerRotation % 360;
                let distance = targetBaseAngle - currentRotationMod;
                if (distance < 0) distance += 360; 
                
                // æœ€ç»ˆè§’åº¦ = å½“å‰è§’åº¦ + å¤šè½¬5åœˆ(1800åº¦) + è¡¥é½åˆ°ç›®æ ‡çš„è·ç¦» + éšæœºåç§»
                const finalAngle = pointerRotation + 1800 + distance + randomOffset;
                
                setPointerRotation(finalAngle);

                setTimeout(() => {
                    setWheelResult(selectedItem);
                    setWheelSpinning(false);
                    
                    // 5. ç»“ç®—é€»è¾‘ ã€å…³é”®ä¿®å¤ï¼šä¸¥æ ¼åˆ¤æ–­éæ¼”ç¤ºæ¨¡å¼ã€‘
                    if (!isDemoWheel) {
                        const today = getLocalDateKey(0);
                        
                        if (wheelType === 'xp') {
                            // --- XP è½¬ç›˜é€»è¾‘ ---
                            let historyKey = isExtraReward ? `${activeChild}-EXTRA_XP-${Date.now()}` : `${activeChild}-XP_WHEEL-${Date.now()}`;
                            setXpHistory(prev => ({ ...prev, [historyKey]: selectedItem.value }));                                       
                        } else {
                            // --- é‡‘å…ƒå® è½¬ç›˜é€»è¾‘ ---
                            let historyKey = isExtraReward ? `${activeChild}-EXTRA-${Date.now()}` : `${activeChild}-${today}`;
                            const newHistory = { ...wheelHistory, [historyKey]: selectedItem.value };
                            setWheelHistory(newHistory);
                            
                            const maxReward = Math.max(...wheelConfig.map(i => i.value));
                            if (selectedItem.value === maxReward) { checkAchievements('lucky_spin', { maxReward, winValue: selectedItem.value }, { wheelHistory: newHistory }); } 
                            else { checkAchievements('spin', {}, { wheelHistory: newHistory }); }
                        }
                    }
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }, 3000); 
            };
			
            const handleLaunchEvilWheel = () => {
                setShowSettings(false); 
                setIsEvilDemo(false);
                setShowEvilWheel(true);
                setEvilWheelResult(null);
            };

            const handleTestEvilWheel = () => {
                setIsEvilDemo(true);
                setShowEvilWheel(true);
                setEvilWheelResult(null);
            };

			// å¯åŠ¨é¢å¤–å¥–åŠ±è½¬ç›˜
			const handleLaunchExtraWheel = (type = 'gold', isDemo = false) => {
                // åªæœ‰åœ¨â€œéæ¼”ç¤ºâ€ï¼ˆå³æ­£å¼å‘æ”¾é¢å¤–å¥–åŠ±ï¼‰æ—¶æ‰å…³é—­è®¾ç½®çª—å£
                // æ¼”ç¤ºæ¨¡å¼ä¸‹ï¼Œä¿ç•™è®¾ç½®çª—å£ï¼Œè®©è½¬ç›˜è¦†ç›–åœ¨ä¸Šé¢
                if (!isDemo) setShowSettings(false); 
                
                setIsDemoWheel(isDemo);  
                setIsExtraReward(!isDemo); 
                setWheelType(type); // ç¡®ä¿æ­£ç¡®è®¾ç½®æ˜¯ gold è¿˜æ˜¯ xp
                setShowWheel(true);
                setWheelResult(null);
            };

            const spinEvilWheel = () => {
                if (evilWheelSpinning) return;
                setEvilWheelSpinning(true);
                const totalWeight = evilWheelConfig.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                let selectedItem = evilWheelConfig[0];
                let selectedIndex = 0;
                for (let i = 0; i < evilWheelConfig.length; i++) {
                    if (random < evilWheelConfig[i].weight) { selectedItem = evilWheelConfig[i]; selectedIndex = i; break; }
                    random -= evilWheelConfig[i].weight;
                }
                const segmentAngle = 360 / evilWheelConfig.length;
                const targetBaseAngle = (selectedIndex * segmentAngle) + (segmentAngle / 2);
                const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.6);
                const finalAngle = evilPointerRotation + 1800 + (targetBaseAngle - (evilPointerRotation % 360)) + randomOffset;
                setEvilPointerRotation(finalAngle);
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰é’é“œç›¾
                    const hasShield = (inventory[activeChild]?.['item_shield'] || 0) > 0;
                    let resultItem = { ...selectedItem, usedShield: false };

                    if (!isEvilDemo && hasShield && selectedItem.value < 0) {
                        // æ¶ˆè€—ç›¾ç‰Œ
                        setInventory(prev => {
                            const childInv = prev[activeChild] || {};
                            const newCount = (childInv['item_shield'] || 0) - 1;
                            const newInv = { ...childInv, 'item_shield': newCount };
                            if (newCount <= 0) delete newInv['item_shield'];
                            return { ...prev, [activeChild]: newInv };
                        });
                        resultItem.usedShield = true;
                        resultItem.value = 0; // æƒ©ç½šå½’é›¶
                    } else if (!isEvilDemo) {
                         const key = `${activeChild}-EVIL-${Date.now()}`;
                         setWheelHistory(prev => ({ ...prev, [key]: selectedItem.value }));
                    }

                    setEvilWheelResult(resultItem);
                    setEvilWheelSpinning(false);
                }, 3000); 
            };

            const removeCheckin = () => {
                if (!editingEntry) return;
				// ã€æ–°å¢ã€‘åŒæ­¥åˆ é™¤å›ºåŒ–çš„é‡‘å¸è´¦å•
                const historyKey = `${activeChild}-TASK-${editingEntry.taskId}-${editingEntry.date}`;
                if (wheelHistory[historyKey]) {
                    setWheelHistory(prev => {
                        const newHistory = { ...prev };
                        delete newHistory[historyKey];
                        return newHistory;
                    });
                }

                setCheckins(prev => {
                    const childData = prev[activeChild] || {};
                    const taskData = childData[editingEntry.taskId] || {};
                    const newTaskData = { ...taskData };
                    delete newTaskData[editingEntry.date];
                    return { ...prev, [activeChild]: { ...childData, [editingEntry.taskId]: newTaskData } };
                });
                setEditingEntry(null);
            };

            const handleAddTask = () => {
                const newTask = { id: `task_${Date.now()}`, name: 'æ–°ä»»åŠ¡', reward: 1, targetCount: 10, completedReward: 20, deadline: globalDates.end, startDate: globalDates.start, targetGoal: '' };
                setTasks(prev => ({ ...prev, [activeChild]: [...(prev[activeChild]||[]), newTask] }));
            };

            const handleDeleteTask = (taskId) => {
                if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
                setTasks(prev => ({ ...prev, [activeChild]: prev[activeChild].filter(t => t.id !== taskId) }));
            };

            const updateTaskSetting = (taskId, field, value) => {
                setTasks(prev => ({ ...prev, [activeChild]: prev[activeChild].map(t => t.id === taskId ? { ...t, [field]: value } : t) }));
            };

            const handleAddProfile = () => {
                const name = prompt("è¯·è¾“å…¥æ–°å­©å­çš„åå­—ï¼š");
                if (name && !profiles.find(p => p.name === name)) {
                    setProfiles([...profiles, { id: name, name, theme: 'sky', avatar: null }]);
                    setTasks(prev => ({...prev, [name]: []}));
                } else if (name) alert("åå­—å·²å­˜åœ¨");
            };
			
			// --- ã€æ–°å¢ã€‘åˆ é™¤æˆå‘˜é€»è¾‘ ---
            const deleteProfile = (profileId) => {
                if (profiles.length <= 1) {
                    alert("âš ï¸ è‡³å°‘ä¿ç•™ä¸€åæˆå‘˜ï¼Œæ— æ³•åˆ é™¤ï¼");
                    return;
                }
                
                if (confirm("ğŸš¨ è­¦å‘Šï¼šåˆ é™¤ä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦åˆ é™¤è¿™ä½æˆå‘˜å—ï¼Ÿ\nåˆ é™¤åï¼Œè¯¥æˆå‘˜çš„æ‰€æœ‰æ•°æ®ï¼ˆæˆå°±ã€ç­‰çº§ã€èƒŒåŒ…ã€è¿›åº¦ï¼‰éƒ½å°†æ°¸ä¹…ä¸¢å¤±ã€‚")) {
                    const newProfiles = profiles.filter(p => p.id !== profileId);
                    setProfiles(newProfiles);
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„å­©å­ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
                    if (activeChild === profileId) {
                        setActiveChild(newProfiles[0].id);
                    }
                }
            };

            const handleAvatarUpload = (e, profileId) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 2 * 1024 * 1024) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡"); return; }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_SIZE = 150; let width = img.width; let height = img.height; if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                        setProfiles(prev => prev.map(p => p.id === profileId ? { ...p, avatar: dataUrl } : p));
                    }; img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const updateProfileTheme = (profileId, themeId) => {
                setProfiles(prev => prev.map(p => p.id === profileId ? { ...p, theme: themeId } : p));
            };
            
			// --- ã€æ–°å¢ã€‘æ›´æ–°å­©å­å¹´çº§ ---
            const updateProfileGrade = (profileId, grade) => {
                setProfiles(prev => prev.map(p => p.id === profileId ? { ...p, grade: grade } : p));
            };

            // --- ã€æ–°å¢ã€‘å®¶é•¿æ ¸é”€å­¦ä¸šç›®æ ‡ ---
            const handleVerifyCurriculum = (childId, subjectId, levelIndex) => {
                // 1. æ›´æ–°è¿›åº¦çŠ¶æ€
                const newProgress = { ...curriculumProgress };
                if (!newProgress[childId]) newProgress[childId] = {};
                
                // åªæœ‰å½“æ–°çš„å±‚çº§æ¯”æ—§çš„é«˜æ—¶æ‰æ›´æ–° (é˜²æ­¢å›é€€)
                const currentLevel = newProgress[childId][subjectId] !== undefined ? newProgress[childId][subjectId] : -1;
                
                if (levelIndex > currentLevel) {
                    newProgress[childId][subjectId] = levelIndex;
                    setCurriculumProgress(newProgress);
                    
                    // 2. è§¦å‘æˆå°±æ£€æŸ¥
                    // ä¼ å…¥æ–°çš„ progress æ•°æ®ä»¥ç¡®ä¿å®æ—¶æ€§
                    checkAchievements('curriculum_verify', { curriculumProgress: newProgress });
                    
                    // 3. ç‰¹æ•ˆåé¦ˆ
                    const subjectName = CURRICULUM_CONFIG[subjectId].name;
                    const levelName = CURRICULUM_CONFIG[subjectId].getSemesterName(levelIndex);
                    
                    confetti({ particleCount: 200, spread: 150, origin: { y: 0.6 }, colors: ['#4f46e5', '#818cf8', '#c7d2fe'] });
                    alert(`ğŸ“ æ­å–œï¼\n\n${childId} å®Œæˆäº†ã€Š${subjectName}ã€‹- ${levelName}ï¼\n\næ–°çš„æˆå°±å‹‹ç« å·²è§£é”ï¼Œè¯·å‰å¾€æˆå°±å¢™æŸ¥çœ‹ï¼`);
                    
                    // 4. è®°å½•å¤§äº‹çºª
                    const todayDate = getLocalDateKey(0);
                    setMilestones(prev => [...prev, {
                        id: `curriculum-${subjectId}-${levelIndex}-${Date.now()}`,
                        type: 'milestone',
                        date: todayDate,
                        timestamp: Date.now(),
                        member: childId,
                        title: `å­¦ä¸šé‡Œç¨‹ç¢‘ï¼š${subjectName}`,
                        description: `å®Œæˆé˜¶æ®µç›®æ ‡ï¼š${levelName}`,
                        icon: 'ğŸ“'
                    }]);
                }
            };
			
            const handleChangeTheme = (themeId) => {
                const activeProfile = profiles.find(p => p.name === activeChild);
                if (activeProfile) { 
                    updateProfileTheme(activeProfile.id, themeId);
                    setStats(prev => {
                        const childStats = prev[activeChild] || {};
                        const usedThemes = childStats.usedThemes || [];
                        if (!usedThemes.includes(themeId)) {
                            const newStats = { ...prev, [activeChild]: { ...childStats, usedThemes: [...usedThemes, themeId] } };
                            checkAchievements('theme', {}, { stats: newStats });
                            return newStats;
                        }
                        return prev;
                    });
                }
                setShowThemeModal(false);
            };
            
            const handleCloseThemeModal = (cancelled) => {
                setShowThemeModal(false);
                if (cancelled) {
                     checkAchievements('theme_close_no_change');
                }
            };

            const closeNotification = () => {
                setUnlockQueue(prev => prev.slice(1));
            };
            
            const closeLevelUp = () => {
                setLevelUpQueue(prev => prev.slice(1));
            };

            const canSpinLuckyWheel = useMemo(() => {
                const today = getLocalDateKey(0);
                const now = new Date();
                if (now.getHours() >= wheelSettings.deadlineHour) return false;
                
                const goldKey = `${activeChild}-${today}`;
                const xpKey = `${activeChild}-XP_WHEEL-${today}`;
                
                // åªè¦ä»Šå¤©è¿˜æ²¡é¢†è¿‡ï¼ˆé‡‘å¸ æˆ– XPï¼‰ï¼Œå°±å¯ä»¥ç‚¹
                if (wheelHistory[goldKey] || xpHistory[xpKey]) return false; 
                
                return todayFragmentStats.completed >= todayFragmentStats.required;
            }, [activeChild, wheelHistory, xpHistory, todayFragmentStats, wheelSettings]);
            
            // è£…å¤‡æ•ˆæœæ£€æŸ¥
            const childGear = equippedGear[activeChild] || {};
            const activeFrame = childGear.frame;
            const activeNameEffect = childGear.nameEffect;

			// è·å–å½“å‰å­©å­è£…å¤‡çš„èƒŒæ™¯ ID
            const activeBg = equippedGear[activeChild]?.background;
			
			const hasActiveBg = !!activeBg;
			
            return (
                <div className={`min-h-screen ${hasActiveBg ? 'bg-transparent' : theme.softBg} font-sans pb-24 transition-colors duration-500`}>
				  {/* --- æ–°å¢ï¼šæ²‰æµ¸å¼åŠ¨æ€èƒŒæ™¯å±‚ --- */}
				  <AtmosphereLayer type={activeBg} />
                  
				  {/* --- æœ€ç»ˆä¿®æ­£ç‰ˆ Headerï¼šä¿ç•™å˜è‰²èƒŒæ™¯ + å åŠ å¤©æ°”ç‰¹æ•ˆ --- */}
                  {(() => {
                      const holiday = getHolidayInfo(now);
                      let weather = getWeatherInfo(now); // è·å–å¤©æ°”
                      const headerTheme = getHeaderTheme(now, holiday); // è·å–åŸæœ¬çš„æ˜ŸæœŸ/èŠ‚æ—¥èƒŒæ™¯ä¸»é¢˜
                      // ã€ä¿®æ”¹ 2ã€‘æ’å…¥è¿™æ®µä¸¢å¤±çš„é€»è¾‘ (ç”¨äºåŠ è½½çœŸå®å¤©æ°”)
                      if (realWeather) {
                          const realType = convertWMOToType(realWeather.code);
                          let finalType = realType;
                          // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯çœŸå®æ•°æ®çš„â€œæ™´å¤©â€ï¼Œä½†å½“å‰æ˜¯æ™šä¸Šï¼Œå¼ºåˆ¶è½¬ä¸º clear_night
                          if (finalType === 'sunny' && !realWeather.isDay) {
                              finalType = 'clear_night';
                          }

                          // é‡æ–°å®šä¹‰æ˜ å°„è¡¨ (å› ä¸º getWeatherInfo é‡Œçš„é‚£ä¸ªæ˜¯å±€éƒ¨çš„)
                          const weatherMap = {
                              sunny: { icon: 'â˜€ï¸', text: 'æ™´æœ—', animation: 'sunny-effect', bg: 'from-blue-400 via-sky-400 to-cyan-300' },
                              clear_night: { icon: 'ğŸŒ™', text: 'æ™´å¤œ', animation: 'starry-effect', bg: 'from-slate-900 via-indigo-900 to-slate-800' },
                              cloudy: { icon: 'â˜ï¸', text: 'å¤šäº‘', animation: 'cloudy-effect', bg: 'from-slate-400 via-gray-400 to-slate-300' },
                              rainy: { icon: 'ğŸŒ§ï¸', text: 'å°é›¨', animation: 'rainy-effect', bg: 'from-slate-700 via-slate-600 to-gray-500' },
                              snowy: { icon: 'â„ï¸', text: 'ä¸‹é›ª', animation: 'snowy-effect', bg: 'from-indigo-100 via-blue-100 to-white' }
                          };

                          if (weatherMap[finalType]) {
                              weather = {
                                  ...weatherMap[finalType], // ç»§æ‰¿å›¾æ ‡å’ŒåŠ¨ç”»
                                  temp: realWeather.temp,   // ä½¿ç”¨çœŸå®æ¸©åº¦
                                  city: realWeather.city    // ã€é‡è¦ã€‘ä¼ å…¥åŸå¸‚å
                              };
                          }
                      }					  
                      const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                      const dateStr = now.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                      const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                      const weekStr = weekDays[now.getDay()];

                      return (
                        // 1. èƒŒæ™¯è‰²ï¼šå®Œå…¨ä½¿ç”¨ headerTheme.gradient (åŸæ¥çš„æ¯æ—¥/èŠ‚æ—¥å˜è‰²)ï¼Œä¸ä½¿ç”¨å¤©æ°”çš„ bg
                        <header className={`sticky top-0 z-30 transition-all duration-1000 ease-in-out bg-gradient-to-r ${headerTheme.gradient} shadow-lg overflow-hidden`}>
                            
							{/* æ’å…¥å¤œå¹•é®ç½©å±‚ */}
							{/* é€»è¾‘ï¼šå¦‚æœæ˜¯æ™šä¸Š (APIåˆ¤æ–­ æˆ– æœ¬åœ°æ—¶é—´åˆ¤æ–­)ï¼Œå°±è¦†ç›–ä¸€å±‚åŠé€æ˜æ·±è‰² */}
							{((realWeather && !realWeather.isDay) || (!realWeather && (now.getHours() >= 18 || now.getHours() < 6))) && (
								<div className="absolute inset-0 bg-slate-900/50 pointer-events-none z-0 transition-opacity duration-1000"></div>
							)}
							
                            {/* 2. å¤©æ°”ç‰¹æ•ˆå±‚ï¼šå åŠ åœ¨å˜è‰²èƒŒæ™¯ä¹‹ä¸Š (å¦‚æœæ˜¯é‡å¤§èŠ‚æ—¥ï¼Œä¸ºäº†è§†è§‰å¹²æ‰°å°‘ï¼Œå¯é€‰ä¸æ˜¾ç¤ºæˆ–åªæ˜¾ç¤ºè½»å¾®çš„) */}
                            {/* è¿™é‡Œæˆ‘ä»¬ä¿ç•™ç‰¹æ•ˆï¼Œå› ä¸ºæ‚¨å¸Œæœ›çœ‹åˆ°åŠ¨ç”»ã€‚CSS åŠ¨ç”»å±‚æœ¬èº«æ˜¯é€æ˜çš„ï¼Œåªæœ‰é›¨æ»´/é›ªèŠ±å¯è§ */}
                            <WeatherEffects type={weather.animation} />
                            
                            {/* 3. é€šç”¨çº¹ç†å±‚ */}
                            <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] mix-blend-overlay"></div>
                            <div className="absolute bottom-0 left-0 w-full h-px bg-black/10"></div>
                            
                            {/* å®¹å™¨ */}
                            <div className="relative z-10 max-w-[1600px] mx-auto px-4 py-2">
                              <div className="flex flex-col lg:grid lg:grid-cols-[1fr_auto_1fr] items-center gap-4">
                                
                                {/* å·¦ä¾§ï¼šç”¨æˆ·å¡ç‰‡ (ä¿æŒä¸å˜) */}
                                <div className="w-full min-w-0 overflow-x-auto no-scrollbar order-2 lg:order-1 lg:justify-self-start py-2">
                                   <div className="flex gap-4 items-center h-36 px-2 justify-center lg:justify-start">
                                    {profiles.map(profile => {
                                         // ... (ä¿æŒåŸæœ‰çš„ profile é€»è¾‘ä¸å˜ï¼Œç›´æ¥å¤ç”¨ä¹‹å‰çš„ä»£ç ) ...
                                         let profileXP = 0;
                                         if (profile.name === activeChild) { profileXP = currentXP; } 
                                         else {
                                            if (profile.id === 'TESTER') profileXP = 40000;
                                            else {
                                                const childCheckins = checkins[profile.name] || {};
                                                const totalCheckinsCount = Object.values(childCheckins).reduce((sum, taskRecord) => sum + Object.keys(taskRecord).length, 0);
                                                profileXP += totalCheckinsCount * 10;
                                            }
                                         }
                                         const isActive = activeChild === profile.name;
                                         const pLevelInfo = isActive ? currentLevelInfo : getLevelInfo(profileXP);
                                         const pNextLvl = getNextLevelInfo(pLevelInfo.level);
                                         const percent = pNextLvl ? Math.min(100, Math.round((profileXP - pLevelInfo.xp) / (pNextLvl.xp - pLevelInfo.xp) * 100)) : 100;
                                         const eraColor = ERA_COLORS[pLevelInfo.era] || ERA_COLORS['è¿œå¤ä¹‹è·¯'];
                                         const pGear = equippedGear[profile.name] || {};
                                         const pF = pGear.frame;
                                         const pNE = pGear.nameEffect;
                                         let pFrameClass = pF ? pF.replace('_', '-') : '';
                                         let pNameEffectClass = pNE ? pNE.replace('effect_name_', 'name-effect-') : '';
                                         const isPeonyEquipped = pF === 'frame_peony';
                                         const isBronzeEquipped = pF === 'frame_bronze';
                                         const avatarFireRingClass = pNameEffectClass === 'name-effect-fire' ? 'avatar-fire-ring' : '';

                                         return (
                                          <button
                                            key={profile.id}
                                            onClick={() => setActiveChild(profile.name)}
                                            className={`relative group transition-all duration-500 ease-out flex-shrink-0 
                                                ${isActive 
                                                  ? `w-48 shadow-2xl scale-105 z-10 rounded-2xl 
                                                     ${(isPeonyEquipped || isBronzeEquipped) ? 'bg-transparent' : 
                                                       `bg-gradient-to-br from-white to-${COLOR_PALETTES[profile.theme]?.id}-50 border-2 ${COLOR_PALETTES[profile.theme]?.border} animate-border-flow`
                                                     }`
                                                  : `w-16 h-16 rounded-full bg-white/90 hover:bg-white hover:scale-110 hover:shadow-lg opacity-80 hover:opacity-100 
                                                     ${isPeonyEquipped ? 'frame-peony' : isBronzeEquipped ? 'frame-bronze-glow rounded-full' : 'border-2 border-white/50'}`
                                                }`}
                                            >
                                                {isActive && isPeonyEquipped && <div className="peony-bg-layer"></div>}
                                                {isActive && isBronzeEquipped && <div className="bronze-bg-layer"></div>}
                                                {isActive ? (
                                                    <div className="p-3 flex flex-col items-center w-full relative">
                                                    <div className={`mb-1 px-2 py-0.5 rounded-full text-[10px] font-black text-white shadow-sm bg-gradient-to-r ${ERA_INFOS[pLevelInfo.era].textGradient} flex items-center gap-1 absolute -top-3 left-1/2 -translate-x-1/2 whitespace-nowrap z-20 border border-white`}>
                                                        <span>Lv.{pLevelInfo.level}</span>
                                                        <span>{pLevelInfo.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 mb-2 mt-2 w-full">
                                                        <div className={`relative ${isPeonyEquipped ? '' : pFrameClass} ${avatarFireRingClass} rounded-full transition-all duration-300`}>
                                                            {profile.avatar ? <img src={profile.avatar} className="w-8 h-8 rounded-full object-cover shadow-sm ring-2 ring-white shrink-0" /> : <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs text-white font-bold shadow-sm ring-2 ring-white shrink-0 ${COLOR_PALETTES[profile.theme]?.primaryBg || 'bg-gray-400'}`}>{profile.name[0]}</div>}
                                                        </div>
                                                        <div className={`font-bold text-sm truncate flex-1 text-left ${pNameEffectClass} ${isBronzeEquipped ? 'text-amber-100 text-shadow' : 'text-gray-800'}`}>{profile.name}</div>
                                                    </div>
                                                    <div onClick={(e) => { e.stopPropagation(); setShowXPHistory(true); }} className="w-full h-4 bg-gray-100 rounded-full overflow-hidden shadow-inner relative cursor-pointer hover:ring-2 hover:ring-offset-1 hover:ring-blue-100">
                                                        <div className={`h-full ${eraColor.bar} transition-all duration-1000 ease-out`} style={{width: `${percent}%`}}></div>
                                                        <div className="absolute inset-0 flex items-center justify-center text-[9px] font-black text-white z-10 tracking-wider drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">{Math.floor(profileXP)} / {pNextLvl ? pNextLvl.xp : 'âˆ'}</div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center overflow-hidden rounded-full">
                                                    {profile.avatar ? <img src={profile.avatar} className="w-full h-full object-cover" /> : <div className={`w-full h-full flex items-center justify-center text-xl text-gray-500 font-bold`}>{profile.name[0]}</div>}
                                                </div>
                                            )}
                                          </button>
                                        );
                                    })}
                                    <button onClick={handleAddProfile} className="w-12 h-12 rounded-full border-2 border-dashed border-white/40 flex items-center justify-center text-white/60 hover:bg-white/20 hover:border-white/80 hover:text-white transition-all transform hover:scale-105">+</button>
                                  </div>
                                </div>

                                {/* ä¸­é—´ï¼šæ—¶é—´æ˜¾ç¤º (ç»å¯¹å±…ä¸­) + å¤©æ°”ä¿¡æ¯ */}
                                <div className="order-1 lg:order-2 lg:justify-self-center flex flex-col items-center justify-center group cursor-default flex-shrink-0 mx-4">
                                    <div className={`text-4xl lg:text-5xl font-mono font-black tracking-widest ${headerTheme.text} drop-shadow-md flex items-center gap-4`}>
                                        <span className="opacity-90">{timeStr}</span>
                                    </div>
                                    <div className={`flex items-center gap-3 text-sm font-bold ${headerTheme.text} opacity-90 mt-1`}>
                                        <span>{dateStr}</span>
                                        {/* å¤©æ°”ä¿¡æ¯èƒ¶å›Š */}
                                        <span className="flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full border border-white/20 backdrop-blur-sm shadow-sm transition-all hover:bg-white/20">
											{/* æ˜¾ç¤ºåŸå¸‚å (å¦‚æœæœ‰) */}
											<span className="font-bold text-amber-100 text-xs tracking-wider">
												{weather.city || (userCity ? userCity : 'å®šä½ä¸­')}
											</span>
											
											<span className="w-px h-3 bg-white/30 mx-0.5"></span>
											
											<span className="animate-pulse filter drop-shadow-sm">{weather.icon}</span>
											<span className="font-medium text-white">{weather.text}</span>
											<span className="text-xs text-white/90 border-l border-white/30 pl-1.5 ml-0.5 font-mono">{weather.temp}Â°C</span>
										</span>

                                        {holiday ? (
                                            <span className="px-2 py-0.5 bg-white/20 backdrop-blur rounded-full border border-white/40 animate-pulse flex items-center gap-1 shadow-lg">
                                                <span>{headerTheme.icon}</span>
                                                <span>{holiday.name}</span>
                                            </span>
                                        ) : null}
                                    </div>
                                </div>
                                
                                {/* å³ä¾§ï¼šåŠŸèƒ½æŒ‰é’®å²› (ä¿æŒä¸å˜) */}
                                <div className="w-full lg:w-auto order-3 lg:justify-self-end flex justify-center lg:justify-end overflow-x-auto no-scrollbar">
                                   <div className="flex items-center gap-1 bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/20 shadow-inner text-white">
                                      <button onClick={() => setShowEvolutionPath(true)} className="p-2 rounded-xl hover:bg-white/20 transition-all active:scale-95 relative" title="è¿›åŒ–ä¹‹è·¯"><span className="text-xl filter drop-shadow-sm">ğŸ“ˆ</span>{levelUpQueue.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 border border-white rounded-full animate-ping"></span>}</button>
                                      <button onClick={() => setShowAchievements(true)} className="p-2 rounded-xl hover:bg-white/20 transition-all active:scale-95 relative" title="æˆå°±å¢™"><span className="text-xl filter drop-shadow-sm">ğŸ†</span>{unlockQueue.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 border border-white rounded-full animate-ping"></span>}</button>
                                      <button onClick={() => setShowMilestones(true)} className="p-2 rounded-xl hover:bg-white/20 transition-all active:scale-95" title="å¤§äº‹çºª"><span className="text-xl filter drop-shadow-sm">ğŸ“œ</span></button>
                                      <button onClick={() => setShowStats(true)} className="p-2 rounded-xl hover:bg-white/20 transition-all active:scale-95" title="å­¦ä¹ æ•°æ®ç»Ÿè®¡"><span className="text-xl filter drop-shadow-sm">ğŸ“Š</span></button>
                                      <div className="w-px h-5 bg-white/20 mx-1"></div>
                                      <button onClick={() => { setShopInitialTab('buy'); setShowShop(true); }} className="p-2 rounded-xl hover:bg-white/20 transition-all active:scale-95 relative" title="æ—¶ç©ºé›†å¸‚"><div className="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold px-1 rounded-full animate-bounce shadow-sm border border-white/30">NEW</div><span className="text-xl filter drop-shadow-sm">ğŸª</span></button>
                                      <div onClick={() => canSpinLuckyWheel && setShowWheelChoice(true)} className={`hidden xl:flex flex-col items-center justify-center mx-1 px-2 py-0.5 rounded-lg border cursor-pointer h-9 transition-colors ${canSpinLuckyWheel ? 'bg-amber-400/80 border-amber-200 animate-pulse text-black' : 'bg-transparent border-transparent hover:bg-white/10 text-white'}`}><div className="flex items-center gap-1"><span className="text-xs">ğŸ§©</span><span className="text-xs font-black">{todayFragmentStats.completed}/{todayFragmentStats.required}</span></div></div>
                                      <div className="flex items-center gap-1 mx-2 cursor-pointer hover:bg-white/10 p-1 rounded transition-colors" onClick={() => setShowGoldHistory(true)}><Coins className="w-4 h-4 text-yellow-300 drop-shadow-sm" /><span className="text-sm font-black text-yellow-100">{totalGold}</span></div>
                                      <div className="w-px h-5 bg-white/20 mx-1"></div>
                                      <button onClick={() => setShowThemeModal(true)} className="p-2 rounded-xl hover:bg-white/20 transition-all" title="åˆ‡æ¢ä¸»é¢˜"><span className="text-xl">ğŸ¨</span></button>
                                      <button onClick={handleOpenSettings} className="p-2 rounded-xl hover:bg-white/20 transition-all" title="è®¾ç½®"><span className="text-xl">ğŸ› ï¸</span></button>
                                   </div>
                                </div>
                              </div>
                            </div>
                        </header>
                      );
                  })()}

                  <main className="max-w-5xl mx-auto px-4 py-8">
				    {/* æ–°å¢ï¼šå‘¨æœ«ä»ªè¡¨ç›˜ */}
					<WeekendDashboard 
						tasks={tasks} 
						checkins={checkins} 
						activeChild={activeChild} 
						settings={weekendSettings}
						theme={theme}
					/>
                    {/* --- å‡çº§ç‰ˆï¼šç”²éª¨æ–‡ä¼ ä¹¦å±•ç¤ºåŒº --- */}
                    {globalMessages && globalMessages.filter(m => m.expire > Date.now()).length > 0 && (
                      <div className="mb-8 oracle-container rounded-2xl p-1 shadow-lg relative animate-in slide-in-from-top-4 duration-700">
                        {/* è£…é¥°èƒŒæ™¯ */}
                        <div className="oracle-bg-pattern"></div>
                        
                        {/* æ ‡é¢˜æ  */}
                        <div className="relative z-10 flex items-center justify-between px-4 py-2 bg-black/20 backdrop-blur-sm border-b border-white/10">
                            <h3 className="text-amber-500 font-black flex items-center gap-2 text-sm tracking-widest uppercase">
                                <span className="text-xl">ğŸ¢</span> 
                                <span style={{textShadow: '0 0 10px #d97706'}}>ç”²éª¨æ–‡ä¼ ä¹¦</span>
                            </h3>
                            <span className="text-[10px] text-amber-200/60 font-mono">
                                {globalMessages.filter(m => m.expire > Date.now()).length} æ¡åˆ»å½•ç”Ÿæ•ˆä¸­
                            </span>
                        </div>

                        {/* æ¶ˆæ¯æ¨ªå‘æ»šåŠ¨å®¹å™¨ */}
                        <div className="relative z-10 p-4 overflow-x-auto no-scrollbar flex gap-4 items-stretch">
                            {globalMessages
                                .filter(m => m.expire > Date.now()) // åªæ˜¾ç¤ºæœªè¿‡æœŸçš„
                                .sort((a, b) => b.timestamp - a.timestamp) // æœ€æ–°çš„åœ¨å‰
                                .map(msg => (
                                    <div key={msg.id} className="oracle-bone-card rounded-lg p-4 min-w-[240px] max-w-[280px] flex flex-col justify-between group shrink-0">
                                        <div>
                                            <div className="flex items-center gap-2 mb-3 border-b border-gray-400/20 pb-2">
                                                <div className="w-6 h-6 rounded-full bg-amber-800 text-amber-100 flex items-center justify-center text-xs font-bold border border-amber-600">
                                                    {msg.author[0]}
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs font-bold text-amber-900">{msg.author}</span>
                                                    <span className="text-[9px] text-gray-500">{new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} åˆ»å½•</span>
                                                </div>
                                            </div>
                                            <p className="text-base font-serif leading-relaxed oracle-text-glow break-words">
                                                â€œ{msg.text}â€
                                            </p>
                                        </div>
                                        
                                        <div className="mt-3 flex justify-between items-end">
                                            <div className="text-[9px] text-gray-400 italic">
                                                {Math.ceil((msg.expire - Date.now()) / (1000 * 60 * 60))}h åé£åŒ–
                                            </div>
                                            {/* åªæœ‰ä½œè€…è‡ªå·±æˆ–æµ‹è¯•å‘˜å¯ä»¥åˆ é™¤ */}
                                            {(activeChild === msg.author || activeChild === 'æµ‹è¯•å‘˜') && (
                                                <button 
                                                    onClick={() => {
                                                        if(confirm('ç¡®å®šè¦æ“¦é™¤è¿™æ¡ä¼ ä¹¦å—ï¼Ÿ')) {
                                                            setGlobalMessages(prev => prev.filter(m => m.id !== msg.id));
                                                        }
                                                    }}
                                                    className="text-gray-400 hover:text-red-600 transition-colors p-1"
                                                    title="æ“¦é™¤"
                                                >
                                                    <Trash2 className="w-3 h-3" />
                                                </button>
                                            )}
                                        </div>

                                        {/* æ‚¬æµ®æ—¶çš„å¾®ç²’å­ç‰¹æ•ˆ (çº¯CSSè£…é¥°) */}
                                        <div className="ember" style={{left: '20%', bottom: '10%', animation: 'ember-float 2s infinite'}}></div>
                                        <div className="ember" style={{left: '70%', bottom: '20%', animation: 'ember-float 3s infinite 1s'}}></div>
                                    </div>
                            ))}
                        </div>
                      </div>
                    )}
                    {/* ... (Existing main content: Sort, Grid, Calendar - same logic) ... */}
                    {viewMode === 'calendar' ? null : (
                        <div className="flex items-center justify-end mb-4 gap-2 text-xs font-bold text-gray-500">
                            <span className="flex items-center gap-1"><SortDesc className="w-3 h-3" /> æ’åº:</span>
                            {['default', 'deadline', 'progress', 'reward'].map(type => (<button key={type} onClick={() => setSortBy(type)} className={`px-3 py-1 rounded-full transition-all ${sortBy === type ? `${theme.primaryBg} text-white shadow-sm` : 'bg-white hover:bg-gray-100'}`}>{{'default': 'é»˜è®¤', 'deadline': 'æˆªæ­¢æ—¥æœŸ', 'progress': 'è¿›åº¦', 'reward': 'å¥–åŠ±'}[type]}</button>))}
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-10">
                      {sortedTasks.map(task => (
                          <TaskCard key={task.id} task={task} checkins={checkins} activeChild={activeChild} globalDates={globalDates} theme={theme} inventory={inventory[activeChild]||{}} onUseSkipCard={useSkipCard} equippedGear={equippedGear} />
                      ))}
                      <button onClick={handleOpenSettings} className="border-2 border-dashed border-gray-300/60 rounded-2xl p-4 flex flex-col items-center justify-center text-gray-400 hover:border-gray-400 hover:text-gray-600 hover:bg-white/50 transition-all min-h-[180px] group">
                          <div className="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Plus className="w-6 h-6 text-gray-400" /></div>
                          <span className="text-sm font-bold">æ·»åŠ æ–°ä»»åŠ¡</span>
                      </button>
                    </div>

                    <div className="bg-white/70 backdrop-blur-md rounded-3xl border border-white/50 shadow-xl overflow-hidden">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white/50">
                           <h2 className="text-lg font-bold text-gray-700 flex items-center gap-2"><CalendarIcon className={`w-5 h-5 ${theme.primary}`} /> æ‰“å¡è®°å½•</h2>
                           <div className="flex bg-gray-100 rounded-lg p-1 text-xs font-bold items-center">
                              {viewMode === 'calendar' && <button onClick={scrollToToday} className="mr-2 px-2 py-1.5 text-gray-400 hover:text-gray-600 hover:bg-white rounded-md transition-all flex items-center gap-1" title="å®šä½åˆ°ä»Šå¤©"><Locate className="w-4 h-4" /></button>}
                              <button onClick={() => setViewMode('today')} className={`px-3 py-1.5 rounded-md transition-all ${viewMode === 'today' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>ä»Šæ—¥</button>
                              <button onClick={() => setViewMode('calendar')} className={`px-3 py-1.5 rounded-md transition-all ${viewMode === 'calendar' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>æœ¬æœˆ</button>
                           </div>
                        </div>

                        {viewMode === 'calendar' ? (
                          <div className="overflow-x-auto pb-2" ref={scrollContainerRef}>
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="bg-gray-50/50">
                                  <th className="p-3 text-left min-w-[120px] sticky left-0 bg-gray-50 z-10 font-bold text-gray-400 pl-6 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">ä»»åŠ¡åç§°</th>
                                  {dates.map(date => {
                                    const d = new Date(date);
                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                    const isToday = date === getLocalDateKey(0);
                                    return (
                                      <th key={date} ref={isToday ? todayRef : null} className={`p-2 min-w-[48px] text-center font-bold text-xs ${isWeekend ? 'text-red-400' : 'text-gray-400'} ${isToday ? `${theme.primary} bg-white rounded-t-lg shadow-sm border-t-2 border-current` : ''}`}>
                                        {d.getMonth() + 1}/{d.getDate()}
                                      </th>
                                    );
                                  })}
                                </tr>
                              </thead>
                              <tbody>
                                {(tasks[activeChild] || []).map((task, idx) => (
                                  <tr key={task.id} className={`border-b border-gray-50 hover:bg-white/80 transition-colors ${idx % 2 === 0 ? 'bg-transparent' : 'bg-gray-50/30'}`}>
                                    <td className="p-3 sticky left-0 bg-white/95 backdrop-blur z-10 font-bold text-gray-700 border-r border-gray-100 shadow-[4px_0_10px_-4px_rgba(0,0,0,0.05)] pl-6">{task.name}</td>
                                    {dates.map(date => {
                                      const record = checkins[activeChild]?.[task.id]?.[date];
                                      const isChecked = record !== undefined;
                                      const isSkipped = record === 'å…';
                                      const isToday = getLocalDateKey(0) === date;
                                      const isBeforeStart = task.startDate && date < task.startDate;
                                      const isAfterEnd = task.deadline && date > task.deadline;
                                      return (
                                        <td key={date} className={`p-2 text-center ${isToday ? 'bg-white shadow-y' : ''}`}>
                                          <button onClick={() => handleCellClick(task.id, date)} disabled={isBeforeStart || isAfterEnd} className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all mx-auto duration-300 ${(isBeforeStart || isAfterEnd) ? 'bg-gray-100/50 text-gray-200 cursor-not-allowed' : isSkipped ? 'bg-indigo-100 text-indigo-500 shadow-sm' : isChecked ? `${theme.primaryBg} text-white shadow-md shadow-${theme.id}-200 scale-100` : `bg-gray-100 text-gray-300 hover:bg-gray-200 hover:scale-110`}`}>
                                            {(isBeforeStart || isAfterEnd) ? <span className="text-[10px]">â€¢</span> : (isSkipped ? <span className="text-xs font-bold">å…</span> : isChecked ? <CheckCircle2 className="w-5 h-5" /> : <div className="w-1.5 h-1.5 rounded-full bg-gray-300"></div>)}
                                          </button>
                                        </td>
                                      );
                                    })}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        ) : (
                          <div className="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                              {(tasks[activeChild] || []).map(task => {
                                  const today = getLocalDateKey(0);
                                  const record = checkins[activeChild]?.[task.id]?.[today];
                                  const isChecked = record !== undefined;
                                  const isBeforeStart = task.startDate && today < task.startDate;
                                  const isAfterEnd = task.deadline && today > task.deadline;
                                  if (isBeforeStart || isAfterEnd) return null; 
                                  return (
                                      <div key={task.id} onClick={() => handleCellClick(task.id, today)} className={`p-4 rounded-2xl border cursor-pointer flex items-center justify-between transition-all group ${isChecked ? `bg-white border-${theme.id}-200 shadow-md` : 'bg-gray-50 border-gray-100 hover:bg-white hover:shadow-sm'}`}>
                                          <div className="flex items-center gap-4">
                                              <div className={`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${isChecked ? theme.lightBg : 'bg-white'}`}>{isChecked ? <CheckCircle2 className={`w-6 h-6 ${theme.primary}`} /> : <div className="w-6 h-6 rounded-full border-2 border-gray-200 group-hover:border-gray-300"></div>}</div>
                                              <div><div className={`font-bold text-lg ${isChecked ? 'text-gray-800' : 'text-gray-500'}`}>{task.name}</div><div className="text-xs text-amber-500 font-bold flex items-center gap-1"><Coins className="w-3 h-3" /> +{task.reward}</div></div>
                                          </div>
                                          {isChecked && <div className={`text-2xl font-black ${theme.primary}`}>{record}<span className="text-sm font-medium opacity-50 ml-1">åˆ†é’Ÿ</span></div>}
                                      </div>
                                  )
                              })}
                          </div>
                        )}
                    </div>
                  </main>

                  <ShopNPC onClick={() => { setShopInitialTab('buy'); setShowShop(true); }} currentEra={currentLevelInfo.era} />
					{/* æˆ‘çš„èƒŒåŒ…æ‚¬æµ®æŒ‰é’® */}
					<button 
						onClick={() => {
							setShopInitialTab('inventory');
							setShowShop(true);
						}}
						className="fixed bottom-4 right-4 z-[90] w-14 h-14 rounded-full bg-gradient-to-tr from-amber-400 to-orange-500 border-2 border-white shadow-lg flex items-center justify-center text-2xl transform transition-transform hover:scale-110 group"
						title="æˆ‘çš„èƒŒåŒ…"
					>
						ğŸ’
						{/* å¦‚æœèƒŒåŒ…é‡Œæœ‰ä¸œè¥¿ï¼Œå³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ªå‘¼å¸çº¢ç‚¹ä½œä¸ºæç¤º */}
						{Object.keys(inventory[activeChild] || {}).length > 0 && (
							<span className="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center">
								<span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
								<span className="relative inline-flex rounded-full h-3 w-3 bg-red-500 border border-white"></span>
							</span>
						)}
					</button>

                  <WheelModal 
					showWheel={showWheel} 
					wheelResult={wheelResult} 
					// æ£€æŸ¥æ˜¯å¦å·²ç»èµ¢è¿‡ï¼šé‡‘å¸æŸ¥ wheelHistoryï¼ŒXPæŸ¥ xpHistory
					alreadyWon={(isDemoWheel || isExtraReward) ? null : (
						wheelType === 'xp' 
						? xpHistory[`${activeChild}-XP_WHEEL-${getLocalDateKey(0)}`] 
						: wheelHistory[`${activeChild}-${getLocalDateKey(0)}`]
					)}
					theme={theme} 
					// æ ¹æ®ç±»å‹ä¼ ä¸åŒçš„é…ç½®
					wheelConfig={wheelType === 'xp' ? xpWheelConfig : wheelConfig} 
					pointerRotation={pointerRotation} 
					isDemoWheel={isDemoWheel} 
					setShowWheel={setShowWheel} 
					setWheelResult={setWheelResult} 
					spinWheel={spinWheel} 
					wheelSpinning={wheelSpinning} 
					isExtraReward={isExtraReward}
					wheelType={wheelType} // æ–°å¢ prop
				  />
                  <SettingsModal 
                    showSettings={showSettings} 
                    setShowSettings={setShowSettings} 
                    theme={theme} 
                    globalDates={globalDates} 
                    setGlobalDates={setGlobalDates} 
                    profiles={profiles} 
                    handleAddProfile={handleAddProfile} 
					deleteProfile={deleteProfile} // <--- ã€æ–°å¢ã€‘åˆ é™¤æˆå‘˜
                    handleAvatarUpload={handleAvatarUpload} 
                    updateProfileTheme={updateProfileTheme} 
                    wheelSettings={wheelSettings} 
                    setWheelSettings={setWheelSettings}
					xpWheelConfig={xpWheelConfig}
					setXpWheelConfig={setXpWheelConfig}					
                    wheelConfig={wheelConfig} 
                    setWheelConfig={setWheelConfig} 
                    setIsDemoWheel={setIsDemoWheel} 
                    setShowWheel={setShowWheel} 
                    setWheelResult={setWheelResult} 
                    activeChild={activeChild} 
                    tasks={tasks} 
                    handleDeleteTask={handleDeleteTask} 
                    updateTaskSetting={updateTaskSetting} 
                    handleAddTask={handleAddTask} 
                    evilWheelConfig={evilWheelConfig}
                    setEvilWheelConfig={setEvilWheelConfig}
                    onLaunchEvilWheel={handleLaunchEvilWheel}
                    onTestEvilWheel={handleTestEvilWheel}
					onLaunchExtraWheel={(type, isDemo) => handleLaunchExtraWheel(type, isDemo)}
                    settingsPassword={settingsPassword}
                    setSettingsPassword={setSettingsPassword}
                    isTestMode={isTestMode}
                    setIsTestMode={setIsTestMode}
					setShowMilestones={setShowMilestones}
					setShowBackupPanel={setShowBackupPanel}
					handleSyncMilestones={handleSyncMilestones}
					onFixInventory={handleFixInventory}
					weekendSettings={weekendSettings}
                    setWeekendSettings={setWeekendSettings}
					handleTestSettlement={handleTestSettlement}
					userCity={userCity}
                    setUserCity={setUserCity}
					updateProfileGrade={updateProfileGrade} // ä¼ é€’å¹´çº§æ›´æ–°å‡½æ•°
                    curriculumProgress={curriculumProgress} // ä¼ é€’è¿›åº¦æ•°æ®
                    handleVerifyCurriculum={handleVerifyCurriculum} // ä¼ é€’æ ¸é”€å‡½æ•°
                  />

                  {/* å•†åº—å¼¹çª— */}
                  <ShopModal
                      show={showShop}
                      onClose={() => setShowShop(false)}
					  initialTab={shopInitialTab}
                      theme={theme}
                      totalGold={totalGold}
                      currentEra={currentLevelInfo.era}
                      onBuy={handleBuyItem}
                      onUse={handleUseItem}
                      inventory={inventory[activeChild]||{}}
                      activeBuffs={activeBuffs[activeChild]||{}}
                      redeemedCoupons={redeemedCoupons[activeChild]||[]}
                      equippedGear={equippedGear}
					  stats={stats}
                      activeChild={activeChild}
					  holidayForecast={apiHolidayForecast}
					  setShowTributeModal={setShowTributeModal}
                  />
				  
				  <WheelChoiceModal 
					  show={showWheelChoice} 
					  onClose={() => setShowWheelChoice(false)} 
					  onSelect={handleSelectWheel} 
				  />

                  <TimeEntryModal editingEntry={editingEntry} tasks={tasks} activeChild={activeChild} removeCheckin={removeCheckin} setEditingEntry={setEditingEntry} saveCheckin={saveCheckin} theme={theme} inventory={inventory[activeChild]||{}} useRepairCard={useRepairCard} />
                  <AchievementWallModal 
                      show={showAchievements} 
                      onClose={() => setShowAchievements(false)} 
                      achievements={achievements[activeChild] || {}} 
                      theme={theme} 
                      checkins={checkins}
                      tasks={tasks}
                      activeChild={activeChild}
                      wheelHistory={wheelHistory}
                      stats={stats}
					  totalGold={totalGold}
                  />
                  <AchievementNotification unlockQueue={unlockQueue} onClose={closeNotification} />
                  <MilestonesModal show={showMilestones} onClose={() => setShowMilestones(false)} milestones={milestones} profiles={profiles} theme={theme} />
                  <BackupPanel show={showBackupPanel} onClose={() => setShowBackupPanel(false)} theme={theme} />
				  {/* ç»Ÿè®¡å›¾è¡¨å¼¹çª— */}
                  <StatsModal show={showStats} onClose={() => setShowStats(false)} checkins={checkins} tasks={tasks} activeChild={activeChild} theme={theme} />
                  {/* ã€æ–°å¢ã€‘å‘¨æœ«ç»“ç®—å¼¹çª— */}
                  <WeekendSettlementModal 
                        state={settlementState} 
                        onClose={() => setSettlementState(null)} 
                        settings={weekendSettings}
                        onUseExemption={() => {
                            setWeekendSettings(prev => ({...prev, guardianPassCount: (prev.guardianPassCount || 0) - 1}));
                            setSettlementState(null);
                            alert("ğŸ›¡ï¸ è±å…æˆåŠŸï¼è¿èƒœè®°å½•å·²æ¢å¤ã€‚");
                        }}
                  />
				  <ThemeSelectionModal show={showThemeModal} onClose={handleCloseThemeModal} currentTheme={theme} onSelectTheme={handleChangeTheme} />
                  <EvilWheelModal 
                    show={showEvilWheel} 
                    onClose={() => setShowEvilWheel(false)} 
                    wheelConfig={evilWheelConfig} 
                    pointerRotation={evilPointerRotation} 
                    spinWheel={spinEvilWheel} 
                    wheelSpinning={evilWheelSpinning} 
                    result={evilWheelResult}
                    isDemo={isEvilDemo}
                  />
                  <GoldHistoryModal 
                    show={showGoldHistory} 
                    onClose={() => setShowGoldHistory(false)} 
                    transactions={transactions}
                    theme={theme}
                  />
                  <XPHistoryModal 
                    show={showXPHistory} 
                    onClose={() => setShowXPHistory(false)} 
                    xpTransactions={xpTransactions}
                    theme={theme}
                  />
                  <EvolutionPathModal
                    show={showEvolutionPath}
                    onClose={() => setShowEvolutionPath(false)}
                    currentXP={currentXP}
                    theme={theme}
                  />
                  <LevelUpNotification
                    show={levelUpQueue.length > 0}
                    onClose={closeLevelUp}
                    levelInfo={levelUpQueue[0]}
                  />
                  <RandomEventModal
                    show={showRandomEvent}
                    eventData={currentRandomEvent}
                    onClose={handleClaimRandomReward}
                    theme={theme}
                  />

				  <TesterDashboard 
					activeChild={activeChild}
					currentXP={currentXP}
					setXpHistory={setXpHistory}
					setWheelHistory={setWheelHistory}
					checkAchievements={checkAchievements} // æ³¨æ„ï¼šè¿™é‡Œä¼ é€’å‡½æ•°å¼•ç”¨
					tasks={tasks}
					checkins={checkins}
					setCheckins={setCheckins}
					setShowRandomEvent={setShowRandomEvent}
					setCurrentRandomEvent={setCurrentRandomEvent}
					achievements={achievements}
					setInventory={setInventory}
					setAchievements={setAchievements}
					setMilestones={setMilestones}
					setNotifiedLevels={setNotifiedLevels}
					setActiveBuffs={setActiveBuffs}
                    setEquippedGear={setEquippedGear}
                    setStats={setStats}
					wheelHistory={wheelHistory} 
					setCurriculumProgress={setCurriculumProgress}
                    setRedeemedCoupons={setRedeemedCoupons}
                    setRandomEventHistory={setRandomEventHistory}
				  />
				  
				  {/* ã€æ–°å¢ã€‘æŒ‚è½½è¿›è´¡å¼¹çª— */}
                  <TributeModal 
                      show={showTributeModal}
                      onClose={() => setShowTributeModal(false)}
                      activeChild={activeChild}
                      stats={stats}
                      setStats={setStats}
                      totalGold={totalGold}
                      setWheelHistory={setWheelHistory}
					  profiles={profiles}
                  />				  

                  <div className="fixed bottom-0 w-full bg-white/60 backdrop-blur-md border-t border-white/20 p-2 text-center text-[10px] text-gray-400 z-10">
                     æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ° (æµè§ˆå™¨ç¼“å­˜) v2.7 æµ‹è¯•å‘˜ä¼˜åŒ–ç‰ˆ
                  </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
